@model List<Simone.Models.Favorito>
@using System.Globalization
@{
    ViewData["Title"] = "Mis Favoritos";
    var culture = new CultureInfo("es-EC");
}

<section class="container-xl px-3 px-md-4 my-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
        <h2 class="m-0 fw-bold">Mis Productos Favoritos</h2>
        @if (Model?.Any() == true)
        {
            <div class="text-muted small">Tienes <strong id="favCount">@Model.Count</strong> @((Model.Count == 1) ? "producto" : "productos")</div>
        }
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5">
            <i class="far fa-heart fa-3x text-secondary mb-3"></i>
            <h5 class="mb-2">No has agregado productos a favoritos aún</h5>
            <a asp-controller="Compras" asp-action="Catalogo" class="btn btn-primary mt-2">
                <i class="fas fa-bag-shopping me-2"></i>Explorar productos
            </a>
        </div>
    }
    else
    {
        <div class="products-grid">
            @foreach (var fav in Model)
            {
                var p = fav.Producto;
                if (p == null) { continue; }
                var disponible = p.Stock > 0;
                var esNuevo = p.FechaAgregado > DateTime.UtcNow.AddDays(-30);

                <article class="product-card">
                    <a asp-controller="Compras" asp-action="VerProducto" asp-route-productoID="@p.ProductoID" class="product-link">
                        <div class="product-image-container">
                            <img src="@(string.IsNullOrWhiteSpace(p.ImagenPath) ? Url.Content("~/images/placeholder-product.png") : p.ImagenPath)"
                                 class="product-image"
                                 alt="@p.Nombre"
                                 onerror="this.onerror=null;this.src='@Url.Content("~/images/placeholder-product.png")';" />
                            @if (esNuevo)
                            {
                                <div class="product-badge">Nuevo</div>
                            }
                            @if (!disponible)
                            {
                                <div class="out-of-stock-badge">Agotado</div>
                            }
                        </div>

                        <div class="product-info">
                            <h3 class="product-title" title="@p.Nombre">@p.Nombre</h3>
                            <div class="product-price">@p.PrecioVenta.ToString("C", culture)</div>

                            <div class="product-colors">
                                @if (!string.IsNullOrWhiteSpace(p.Color))
                                {
                                    <span class="color-option" title="@p.Color" style="background-color:@p.Color;"></span>
                                }
                                <span class="color-option" style="background-color:#000"></span>
                                <span class="color-option" style="background-color:#D4AF37"></span>
                            </div>
                        </div>
                    </a>

                    <!-- Quitar de favoritos (mismo botón flotante del catálogo) -->
                    <form method="post" asp-controller="Favoritos" asp-action="Toggle" class="wishlist-form" data-product-id="@p.ProductoID">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@p.ProductoID" />
                        <button type="submit" class="wishlist-btn active" title="Quitar de favoritos">
                            <i class="fas fa-heart"></i>
                        </button>
                    </form>

                    <!-- Añadir al carrito -->
                    @if (disponible)
                    {
                        <form asp-controller="Compras" asp-action="AnadirAlCarrito" method="post" class="add-to-cart-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="ProductoID" value="@p.ProductoID" />
                            <input type="hidden" name="Cantidad" value="1" />
                            <button type="submit" class="add-to-cart-btn">
                                <i class="fas fa-shopping-bag"></i> Añadir al carrito
                            </button>
                        </form>
                    }
                    else
                    {
                        <button class="add-to-cart-btn" disabled>
                            <i class="fas fa-times-circle"></i> No hay stock
                        </button>
                    }
                </article>
            }
        </div>
    }
</section>

<style>
    /* ======= Paleta y base (idéntico al catálogo) ======= */
    :root {
        --primary-dark: #2C2C2C;
        --primary-light: #FFFFFF;
        --accent-pink: #E8B4B8;
        --accent-pink-dark: #D49A9F;
        --accent-purple: #8A6B8F;
        --accent-gold: #D4AF37;
        --light-beige: #F8F4F0;
        --medium-gray: #E8E8E8;
        --dark-gray: #5A5A5A;
        --text-color: #5A5A5A;
        --text-light: #8A8A8A;
        --shadow-color: rgba(0,0,0,.08);
        --shadow-hover: rgba(0,0,0,.15);
    }

    body {
        background-color: var(--light-beige);
    }

    /* ======= Grid como el catálogo ======= */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
        gap: 30px
    }

    /* ======= Card de producto ======= */
    .product-card {
        background: var(--primary-light);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 5px 15px var(--shadow-color);
        transition: transform .4s ease, box-shadow .4s ease;
        position: relative
    }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px var(--shadow-hover)
        }

    .product-link {
        text-decoration: none;
        color: inherit;
        display: block
    }

    .product-image-container {
        position: relative;
        padding-top: 120%;
        overflow: hidden
    }

    .product-image {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform .7s ease
    }

    .product-card:hover .product-image {
        transform: scale(1.08)
    }

    .product-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: var(--accent-gold);
        color: var(--primary-dark);
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        z-index: 1
    }

    .out-of-stock-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #e74c3c;
        color: var(--primary-light);
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        z-index: 1
    }

    /* Wishlist flotante (idéntico al catálogo) */
    .wishlist-form {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 2
    }

    .wishlist-btn {
        background-color: rgba(255,255,255,.9);
        border: none;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,.1);
        transition: all .3s ease
    }

        .wishlist-btn:hover {
            background: #fff;
            transform: scale(1.1)
        }

        .wishlist-btn i {
            font-size: 18px;
            color: var(--accent-pink)
        }

    .product-info {
        padding: 20px
    }

    .product-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .product-price {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent-purple);
        margin-bottom: 15px
    }

    .product-colors {
        display: flex;
        gap: 8px;
        margin-bottom: 15px
    }

    .color-option {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1px solid var(--medium-gray);
        cursor: pointer;
        transition: transform .2s
    }

        .color-option:hover {
            transform: scale(1.2)
        }

    .add-to-cart-form {
        margin-top: -6px
    }

    .add-to-cart-btn {
        width: 100%;
        padding: 14px;
        background: var(--accent-pink);
        color: #fff;
        border: none;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all .3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px
    }

        .add-to-cart-btn:hover {
            background: var(--accent-purple)
        }

        .add-to-cart-btn[disabled] {
            background: #ccc;
            color: #888;
            cursor: not-allowed
        }

    /* Responsive (usar @@ en Razor) */
    @@media (max-width:1100px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill,minmax(220px,1fr))
        }
    }

    @@media (max-width:768px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
            gap: 20px
        }
    }

    @@media (max-width:576px) {
        .products-grid {
            grid-template-columns: 1fr
        }
    }
</style>

<!-- Iconos / tipografías -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          // Toggle de favoritos (AJAX) y remover card
          document.querySelectorAll('form.wishlist-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const card = form.closest('.product-card');
              const data = new FormData(form);
              try{
                const res = await fetch(form.action || form.getAttribute('action') || '/Favoritos/Toggle', {
                  method: 'POST',
                  headers: { 'X-Requested-With': 'XMLHttpRequest' },
                  body: data
                });
                if(!res.ok) throw new Error('HTTP '+res.status);
                const json = await res.json();
                // Controlador devuelve { esFavorito: false } cuando se quita
                if(json && (json.esFavorito === false || json.ok === true)){
                  card.style.opacity = .0; card.style.transform = 'translateY(6px)';
                  setTimeout(() => {
                    card.remove();
                    actualizarContador();
                    if(!document.querySelector('.product-card')){
                      mostrarVacio();
                    }
                  }, 160);
                }
              }catch(err){ console.error(err); alert('No se pudo actualizar tus favoritos.'); }
            });
          });

          function actualizarContador(){
            const cnt = document.getElementById('favCount');
            if(cnt) cnt.textContent = document.querySelectorAll('.product-card').length;
          }
          function mostrarVacio(){
            const container = document.querySelector('.products-grid')?.parentElement;
            if(!container) return;
            container.innerHTML = `
              <div class="text-center py-5">
                <i class="far fa-heart fa-3x text-secondary mb-3"></i>
                <h5 class="mb-2">No has agregado productos a favoritos aún</h5>
                <a href="/Compras/Catalogo" class="btn btn-primary mt-2">
                  <i class="fas fa-bag-shopping me-2"></i>Explorar productos
                </a>
              </div>`;
          }
        });
    </script>
}
