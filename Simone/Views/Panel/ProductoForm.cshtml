@using System.Globalization
@using Simone.Models
@{
    ViewData["Title"] = ViewBag.Producto != null ? "Editar Producto" : "Añadir Producto";

    var producto = ViewBag.Producto as Producto;
    var categorias = ViewBag.Categorias as IEnumerable<Categorias> ?? Enumerable.Empty<Categorias>();
    var proveedores = ViewBag.Proveedores as IEnumerable<Proveedores> ?? Enumerable.Empty<Proveedores>();
    var subcatsSrc = (IEnumerable<Subcategorias>)(
        ViewBag.Subcategorias as IEnumerable<Subcategorias> ??
        ViewBag.subcategorias as IEnumerable<Subcategorias> ??
        new List<Subcategorias>()
    );

    var variantesInit = (ViewBag.Variantes as IEnumerable<ProductoVariante>)?.ToList() ?? new List<ProductoVariante>();
    var hasVariantesInit = variantesInit.Any();

    var galListTop = ViewBag.Galeria as IEnumerable<string>;
    int imgCountInit = galListTop?.Count() ?? (string.IsNullOrWhiteSpace(producto?.ImagenPath) ? 0 : 1);

    var culture = CultureInfo.CreateSpecificCulture("es-EC");

    decimal minVarPrice = 0m, maxVarPrice = 0m;
    if (hasVariantesInit && variantesInit.Any())
    {
        minVarPrice = variantesInit.Min(v => (v.PrecioVenta ?? 0m));
        maxVarPrice = variantesInit.Max(v => (v.PrecioVenta ?? 0m));
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/ProductoForm.css" asp-append-version="true" />
}

<div class="container" id="productoFormContainer">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-box-open" aria-hidden="true"></i>
            <h1>@ViewData["Title"]</h1>
        </div>
        <a class="back-btn" asp-controller="Panel" asp-action="Productos" aria-label="Volver a lista de productos">
            <i class="fas fa-arrow-left" aria-hidden="true"></i> Volver a Productos
        </a>
    </div>

    <!-- Alertas -->
    @if (TempData["Ok"] != null)
    {
        <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle" aria-hidden="true"></i>
            <span>@TempData["Ok"]</span>
        </div>
    }
    @if (TempData["Err"] != null)
    {
        <div class="alert alert-error" role="alert">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
            <span>@TempData["Err"]</span>
        </div>
    }

    <div class="product-form-container">
        <!-- MAIN FORM -->
        <div class="form-main">
            <form method="post"
                  asp-controller="Panel"
                  asp-action="@(producto != null ? "EditarProducto" : "AnadirProducto")"
                  enctype="multipart/form-data"
                  id="productoForm"
                  novalidate>

                @Html.AntiForgeryToken()
                @if (producto != null)
                {
                    <input type="hidden" name="productoID" value="@producto.ProductoID" />
                }

                <!-- Información Básica -->
                <section class="form-section" aria-labelledby="sec-basic">
                    <header class="section-header">
                        <h2 class="section-title" id="sec-basic">
                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                            Información Básica
                        </h2>
                        <span class="section-badge" id="productTypeBadge">
                            @(hasVariantesInit ? "Con Variantes" : "Producto Simple")
                        </span>
                    </header>
                    <div class="section-content">
                        <div class="form-grid">
                            <!-- Nombre -->
                            <div class="form-group">
                                <label class="form-label required" for="Nombre">Nombre del Producto</label>
                                <input class="form-input"
                                       id="Nombre"
                                       name="nombreProducto"
                                       type="text"
                                       maxlength="120"
                                       required
                                       autocomplete="off"
                                       placeholder="Ej. Camiseta de algodón"
                                       value="@(producto?.Nombre ?? "")"
                                       aria-required="true"
                                       aria-describedby="NombreError" />
                                <div class="form-error" id="NombreError" role="alert"></div>
                            </div>

                            <!-- Marca -->
                            <div class="form-group">
                                <label class="form-label required" for="Marca">Marca</label>
                                <input class="form-input"
                                       id="Marca"
                                       name="marca"
                                       type="text"
                                       maxlength="80"
                                       required
                                       autocomplete="off"
                                       placeholder="Ej. Nike, Adidas"
                                       value="@(producto?.Marca ?? "")"
                                       aria-required="true"
                                       aria-describedby="MarcaError" />
                                <div class="form-error" id="MarcaError" role="alert"></div>
                            </div>

                            <!-- Categoría -->
                            <div class="form-group">
                                <label class="form-label required" for="Categoria">Categoría</label>
                                <select class="form-select"
                                        id="Categoria"
                                        name="categoriaID"
                                        required
                                        aria-required="true"
                                        aria-describedby="CategoriaError">
                                    <option value="">Seleccione una categoría</option>
                                    @foreach (var c in categorias)
                                    {
                                        <option value="@c.CategoriaID"
                                                selected="@(producto != null && producto.CategoriaID == c.CategoriaID ? "selected" : null)">
                                            @c.Nombre
                                        </option>
                                    }
                                </select>
                                <div class="form-error" id="CategoriaError" role="alert"></div>
                            </div>

                            <!-- Subcategoría -->
                            <div class="form-group">
                                <label class="form-label required" for="Subcategoria">Subcategoría</label>
                                <select class="form-select"
                                        id="Subcategoria"
                                        name="subcategoriaID"
                                        required
                                        aria-required="true"
                                        aria-describedby="SubcategoriaError subcategoriaNote">
                                    <option value="">Seleccione una subcategoría</option>
                                    @if (producto != null)
                                    {
                                        foreach (var s in subcatsSrc.Where(x => x.CategoriaID == producto.CategoriaID))
                                        {
                                            <option value="@s.SubcategoriaID"
                                                    selected="@(producto.SubcategoriaID == s.SubcategoriaID ? "selected" : null)">
                                                @s.NombreSubcategoria
                                            </option>
                                        }
                                    }
                                </select>
                                <div class="form-note" id="subcategoriaNote">Seleccione primero una categoría</div>
                                <div class="form-error" id="SubcategoriaError" role="alert"></div>
                            </div>

                            <!-- Proveedor -->
                            <div class="form-group">
                                <label class="form-label" for="Proveedor">Proveedor <span class="optional-label">(Opcional)</span></label>
                                <select class="form-select"
                                        id="Proveedor"
                                        name="proveedorID"
                                        aria-describedby="ProveedorHelp">
                                    <option value="">Sin proveedor / N/A</option>
                                    @foreach (var p in proveedores)
                                    {
                                        <option value="@p.ProveedorID"
                                                selected="@(producto != null && producto.ProveedorID == p.ProveedorID ? "selected" : null)">
                                            @p.NombreProveedor
                                        </option>
                                    }
                                </select>
                                <small id="ProveedorHelp" class="form-text text-muted">
                                    Selecciona un proveedor solo si este producto viene de un proveedor externo.
                                </small>
                            </div>

                            <!-- Precio Compra -->
                            <div class="form-group">
                                <label class="form-label required" for="PrecioCompra">Precio de Compra (USD)</label>
                                <input class="form-input"
                                       id="PrecioCompra"
                                       name="precioCompra"
                                       type="number"
                                       step="0.01"
                                       min="0.01"
                                       required
                                       lang="en"
                                       inputmode="decimal"
                                       value="@(producto != null ? producto.PrecioCompra.ToString("0.00", CultureInfo.InvariantCulture) : "")"
                                       aria-required="true"
                                       aria-describedby="PrecioCompraError" />
                                <div class="form-error" id="PrecioCompraError" role="alert"></div>
                            </div>

                            <!-- Precio Venta -->
                            <div class="form-group">
                                <label class="form-label required" for="PrecioVenta">Precio de Venta (USD)</label>
                                <input class="form-input"
                                       id="PrecioVenta"
                                       name="precioVenta"
                                       type="number"
                                       step="0.01"
                                       min="0.01"
                                       required
                                       lang="en"
                                       inputmode="decimal"
                                       value="@(producto != null ? producto.PrecioVenta.ToString("0.00", CultureInfo.InvariantCulture) : "")"
                                       aria-required="true"
                                       aria-describedby="pvMargin PrecioVentaError" />
                                <div class="form-note" id="pvMargin" aria-live="polite"></div>
                                <div class="form-error" id="PrecioVentaError" role="alert"></div>
                            </div>

                            <!-- Color (solo sin variantes) -->
                            <div class="form-group base-only">
                                <label class="form-label" for="Color">Color</label>
                                <input class="form-input"
                                       id="Color"
                                       name="color"
                                       type="text"
                                       maxlength="40"
                                       autocomplete="off"
                                       placeholder="Ej. Negro, Azul, Rojo"
                                       value="@(producto?.Color ?? "")" />
                            </div>

                            <!-- Talla (solo sin variantes) -->
                            <div class="form-group base-only">
                                <label class="form-label" for="Talla">Talla</label>
                                <input class="form-input"
                                       id="Talla"
                                       name="talla"
                                       type="text"
                                       maxlength="40"
                                       autocomplete="off"
                                       placeholder="Ej. S, M, L, XL"
                                       value="@(producto?.Talla ?? "")" />
                            </div>

                            <!-- Stock (solo sin variantes) -->
                            <div class="form-group base-only">
                                <label class="form-label required" for="Stock">Stock</label>
                                <input class="form-input"
                                       id="Stock"
                                       name="stock"
                                       type="number"
                                       min="0"
                                       step="1"
                                       required
                                       inputmode="numeric"
                                       value="@(producto?.Stock.ToString() ?? "0")"
                                       aria-required="true"
                                       aria-describedby="StockError" />
                                <div class="form-error" id="StockError" role="alert"></div>
                            </div>

                            <!-- Descripción -->
                            <div class="form-group form-grid-full">
                                <label class="form-label required" for="Descripcion">Descripción</label>
                                <textarea class="form-textarea"
                                          id="Descripcion"
                                          name="descripcion"
                                          maxlength="500"
                                          required
                                          placeholder="Describe características, materiales y beneficios"
                                          aria-required="true"
                                          aria-describedby="DescripcionError charCountNote">@(producto?.Descripcion ?? "")</textarea>
                                <div class="form-error" id="DescripcionError" role="alert"></div>
                                <div class="form-note" id="charCountNote" style="text-align:right;" aria-live="polite">
                                    <span id="charCount">@(producto?.Descripcion?.Length ?? 0)</span>/500 caracteres
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Imágenes -->
                <section class="form-section" aria-labelledby="sec-images">
                    <header class="section-header">
                        <h2 class="section-title" id="sec-images">
                            <i class="fas fa-images" aria-hidden="true"></i>
                            Imágenes del Producto
                        </h2>
                        <span class="section-badge" id="imageCountBadge" aria-live="polite">
                            @imgCountInit/8 imágenes
                        </span>
                    </header>
                    <div class="section-content">
                        <div class="image-upload-area"
                             id="imageUploadArea"
                             role="button"
                             tabindex="0"
                             aria-label="Área para subir imágenes. Haga clic o arrastre archivos aquí.">
                            <i class="fas fa-cloud-arrow-up" aria-hidden="true"></i>
                            <p>Arrastra y suelta las imágenes aquí</p>
                            <span>o haz clic para seleccionar archivos</span>

                            <input type="file"
                                   id="Imagenes"
                                   name="Imagenes"
                                   accept="image/jpeg,image/png,image/webp,image/gif"
                                   multiple
                                   style="display:none"
                                   aria-label="Seleccionar archivos de imagen" />

                            <input type="file"
                                   id="ImagenLegacy"
                                   name="imagen"
                                   accept="image/jpeg,image/png,image/webp,image/gif"
                                   style="display:none"
                                   aria-label="Imagen principal (legacy)" />

                            <input type="hidden" id="ImagenPrincipalIndex" name="ImagenPrincipalIndex" value="0" />
                            <input type="hidden" id="ExistingImagenPath" name="existingImagenPath" value="@(ViewBag.Portada ?? producto?.ImagenPath ?? "")" />
                            <input type="hidden" id="ImagenesIgnore" name="ImagenesIgnore" />

                            <div class="image-hint">
                                <i class="fas fa-circle-info" aria-hidden="true"></i>
                                Hasta 8 imágenes (.jpg, .jpeg, .png, .webp, .gif · máx 8MB c/u). La portada se marca con ★.
                            </div>

                            <div id="imgAlert" class="form-error" style="display:none" role="alert" aria-live="assertive"></div>

                            <div class="progress-bar" id="uploadProgress" style="display:none;" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-fill" id="progressFill" aria-valuenow="0"></div>
                            </div>
                        </div>

                        <div id="galeria" class="gallery-preview" role="list" aria-live="polite" aria-label="Galería de imágenes del producto">
                            @if (galListTop != null && galListTop.Any())
                            {
                                var portada = ViewBag.Portada as string ?? producto?.ImagenPath ?? "";
                                foreach (var url in galListTop)
                                {
                                    var isCover = string.Equals(portada, url, StringComparison.OrdinalIgnoreCase);
                                    <div class="image-thumbnail" data-existing="1" data-url="@url" role="listitem">
                                        @if (isCover)
                                        {
                                            <span class="image-badge">Principal</span>
                                        }
                                        <img src="@url" alt="Imagen del producto" loading="lazy" />
                                        <div class="image-actions">
                                            <button type="button"
                                                    class="image-btn @(isCover ? "active" : "")"
                                                    data-action="cover"
                                                    data-url="@url"
                                                    title="Marcar como principal"
                                                    aria-label="Marcar imagen como principal">
                                                <i class="fas fa-star" aria-hidden="true"></i>
                                            </button>
                                            <button type="button"
                                                    class="image-btn"
                                                    data-action="delete"
                                                    data-url="@url"
                                                    title="Eliminar imagen"
                                                    aria-label="Eliminar imagen">
                                                <i class="fas fa-trash" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else if (!string.IsNullOrWhiteSpace(producto?.ImagenPath))
                            {
                                <div class="image-thumbnail" data-existing="1" data-url="@producto.ImagenPath" role="listitem">
                                    <span class="image-badge">Principal</span>
                                    <img src="@producto.ImagenPath" alt="Imagen actual del producto" loading="lazy" />
                                    <div class="image-actions">
                                        <button type="button"
                                                class="image-btn active"
                                                data-action="cover"
                                                data-url="@producto.ImagenPath"
                                                title="Marcar como principal"
                                                aria-label="Marcar imagen como principal">
                                            <i class="fas fa-star" aria-hidden="true"></i>
                                        </button>
                                        <button type="button"
                                                class="image-btn"
                                                data-action="delete"
                                                data-url="@producto.ImagenPath"
                                                title="Eliminar imagen"
                                                aria-label="Eliminar imagen">
                                            <i class="fas fa-trash" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </section>

                <!-- Variantes -->
                <section class="form-section" aria-labelledby="sec-variants">
                    <header class="section-header">
                        <h2 class="section-title" id="sec-variants">
                            <i class="fas fa-layer-group" aria-hidden="true"></i>
                            Variantes del Producto
                        </h2>
                        <span class="section-badge" id="variantCountBadge" aria-live="polite">
                            @(hasVariantesInit? variantesInit.Count + " variantes" : "0 variantes")
                        </span>
                    </header>
                    <div class="section-content">
                        <div class="toggle-section">
                            <label class="toggle-switch" for="chkVariantes">
                                <input type="checkbox"
                                       id="chkVariantes"
                                       @(hasVariantesInit ? "checked" : "")
                                       aria-label="Activar sistema de variantes" />
                                <span class="toggle-slider" aria-hidden="true"></span>
                            </label>
                            <span class="toggle-label">Activar variantes (Color × Talla)</span>
                            <span class="form-note">Con variantes, ingresa el <strong>precio final</strong> por combinación.</span>
                        </div>

                        <div id="boxVariantes" style="display:@(hasVariantesInit ? "block" : "none");">
                            <div class="form-grid">
                                <!-- Colores -->
                                <div class="form-group">
                                    <label class="form-label" for="inpColores">Colores</label>
                                    <input class="form-input"
                                           id="inpColores"
                                           type="text"
                                           autocomplete="off"
                                           placeholder="Negro, Vino, Marrón"
                                           aria-describedby="coloresNote" />
                                    <div class="form-note" id="coloresNote">Separa con comas o Enter.</div>
                                    <div class="tags-container" id="tagsColores" role="list" aria-label="Colores agregados">
                                        @if (hasVariantesInit)
                                        {
                                            @foreach (var color in variantesInit.Select(v => v.Color).Distinct())
                                            {
                                                <span class="tag" role="listitem">
                                                    @color
                                                    <button type="button"
                                                            class="tag-remove"
                                                            data-tag-type="color"
                                                            aria-label="Eliminar color @color">
                                                        <i class="fas fa-times" aria-hidden="true"></i>
                                                    </button>
                                                    <input type="hidden" name="Colores" value="@color" />
                                                </span>
                                            }
                                        }
                                    </div>
                                </div>

                                <!-- Tallas -->
                                <div class="form-group">
                                    <label class="form-label" for="inpTallas">Tallas</label>
                                    <input class="form-input"
                                           id="inpTallas"
                                           type="text"
                                           autocomplete="off"
                                           placeholder="S, M, L, XL"
                                           aria-describedby="tallasNote" />
                                    <div class="form-note" id="tallasNote">Separa con comas o Enter.</div>
                                    <div class="tags-container" id="tagsTallas" role="list" aria-label="Tallas agregadas">
                                        @if (hasVariantesInit)
                                        {
                                            @foreach (var talla in variantesInit.Select(v => v.Talla).Distinct())
                                            {
                                                <span class="tag" role="listitem">
                                                    @talla
                                                    <button type="button"
                                                            class="tag-remove"
                                                            data-tag-type="talla"
                                                            aria-label="Eliminar talla @talla">
                                                        <i class="fas fa-times" aria-hidden="true"></i>
                                                    </button>
                                                    <input type="hidden" name="Tallas" value="@talla" />
                                                </span>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Reglas de precio -->
                            <div class="price-rules">
                                <div class="price-rule">
                                    <label class="toggle-switch" for="chkPrecioGlobal">
                                        <input type="checkbox" id="chkPrecioGlobal" aria-label="Aplicar un solo precio a todas las variantes" />
                                        <span class="toggle-slider" aria-hidden="true"></span>
                                    </label>
                                    <span class="toggle-label">Un solo precio para todas</span>
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <input class="form-input price-rule-input"
                                               id="inpPrecioGlobal"
                                               type="number"
                                               step="0.01"
                                               min="0"
                                               lang="en"
                                               placeholder="0.00"
                                               disabled
                                               inputmode="decimal"
                                               aria-label="Precio global para todas las variantes" />
                                        <button type="button"
                                                class="btn btn-success"
                                                id="btnApplyGlobal"
                                                disabled
                                                aria-label="Aplicar precio global">
                                            Aplicar
                                        </button>
                                    </div>
                                </div>

                                <div class="price-rule">
                                    <label class="toggle-switch" for="chkPrecioPorTalla">
                                        <input type="checkbox" id="chkPrecioPorTalla" aria-label="Aplicar mismo precio por talla" />
                                        <span class="toggle-slider" aria-hidden="true"></span>
                                    </label>
                                    <span class="toggle-label">Mismo precio por talla</span>
                                </div>
                                <div id="boxPrecioPorTalla" style="display:none;margin-top:8px;" role="group" aria-label="Precios por talla"></div>
                            </div>

                            <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:16px;flex-wrap:wrap;">
                                <button type="button"
                                        class="btn btn-primary"
                                        id="btnGen"
                                        aria-label="Generar tabla de combinaciones">
                                    <i class="fas fa-table" aria-hidden="true"></i> Generar combinaciones
                                </button>
                                <button type="button"
                                        class="btn btn-secondary"
                                        id="btnClearVars"
                                        title="Limpiar todas las variantes"
                                        aria-label="Limpiar todas las variantes">
                                    <i class="fas fa-eraser" aria-hidden="true"></i> Limpiar
                                </button>
                            </div>

                            <!-- Tabla de variantes -->
                            <div class="variants-table-container" role="region" aria-label="Tabla de variantes">
                                <table class="variants-table" id="tblVars" aria-live="polite">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="min-width:120px">Color</th>
                                            <th scope="col" style="min-width:120px">Talla</th>
                                            <th scope="col" style="min-width:130px">Precio (USD)</th>
                                            <th scope="col" style="min-width:120px">Stock</th>
                                            <th scope="col" style="width:80px">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (hasVariantesInit)
                                        {
                                            foreach (var variante in variantesInit)
                                            {
                                                <tr>
                                                    <td>
                                                        <input type="hidden" name="VarColor" value="@variante.Color" />
                                                        <span>@variante.Color</span>
                                                    </td>
                                                    <td>
                                                        <input type="hidden" name="VarTalla" value="@variante.Talla" />
                                                        <span>@variante.Talla</span>
                                                    </td>
                                                    <td>
                                                        <input class="variant-input"
                                                               name="VarPrecio"
                                                               type="number"
                                                               step="0.01"
                                                               min="0.01"
                                                               lang="en"
                                                               inputmode="decimal"
                                                               value="@((variante.PrecioVenta ?? 0m).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture))"
                                                               required
                                                               aria-label="Precio para @variante.Color @variante.Talla" />
                                                    </td>
                                                    <td>
                                                        <input class="variant-input"
                                                               name="VarStock"
                                                               type="number"
                                                               step="1"
                                                               min="0"
                                                               inputmode="numeric"
                                                               value="@variante.Stock"
                                                               required
                                                               aria-label="Stock para @variante.Color @variante.Talla" />
                                                    </td>
                                                    <td>
                                                        <div class="variant-actions">
                                                            <button type="button"
                                                                    class="image-btn"
                                                                    data-action="remove-variant"
                                                                    title="Eliminar variante"
                                                                    aria-label="Eliminar variante @variante.Color @variante.Talla">
                                                                <i class="fas fa-trash" aria-hidden="true"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                                <div class="form-note"
                                     id="noteVars"
                                     style="padding:16px;text-align:center;@(hasVariantesInit ? "display:none" : "")">
                                    No hay variantes generadas.
                                </div>
                            </div>

                            <!-- Resumen de variantes -->
                            <div id="variantSummary"
                                 style="display:@(hasVariantesInit ? "block" : "none");margin-top:16px;padding:16px;background:#f8fafc;border-radius:var(--radius-sm);"
                                 role="region"
                                 aria-label="Resumen de variantes">
                                <h3 style="margin-bottom:12px;font-size:14px;font-weight:600;">Resumen de Variantes</h3>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                                    <div class="summary-item">
                                        <span>Total de combinaciones:</span>
                                        <span class="summary-value" id="summaryTotal" aria-live="polite">@(hasVariantesInit? variantesInit.Count: 0)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Stock total:</span>
                                        <span class="summary-value" id="summaryStock" aria-live="polite">@(hasVariantesInit? variantesInit.Sum(v => v.Stock) : 0)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Precio mínimo:</span>
                                        <span class="summary-value" id="summaryMinPrice" aria-live="polite">@minVarPrice.ToString("C2", culture)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Precio máximo:</span>
                                        <span class="summary-value" id="summaryMaxPrice" aria-live="polite">@maxVarPrice.ToString("C2", culture)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </form>
        </div>

        <!-- SIDEBAR -->
        <aside class="form-sidebar" aria-label="Panel de acciones">
            <!-- Acciones -->
            <div class="action-card">
                <h3 class="action-title">Acciones</h3>
                <div class="form-actions">
                    <button class="btn btn-primary"
                            id="btnSubmit"
                            type="submit"
                            form="productoForm"
                            aria-label="Guardar producto">
                        <i class="fas fa-floppy-disk" aria-hidden="true"></i>
                        Guardar Producto
                    </button>
                    <a asp-controller="Panel"
                       asp-action="Productos"
                       class="btn btn-secondary"
                       aria-label="Cancelar y volver">
                        <i class="fas fa-times" aria-hidden="true"></i>
                        Cancelar
                    </a>
                </div>
                <div class="form-note" style="margin-top:12px;text-align:center;">
                    <i class="fas fa-clock" aria-hidden="true"></i>
                    <span id="lastSaved" aria-live="polite">No guardado</span>
                </div>
            </div>

            <!-- Vista Previa -->
            <div class="action-card">
                <h3 class="action-title">Vista Previa</h3>
                <div class="form-note">
                    <div class="summary-item">
                        <span>Tipo:</span>
                        <span class="summary-value" id="previewType">@(hasVariantesInit ? "Con Variantes" : "Producto Simple")</span>
                    </div>
                    <div class="summary-item">
                        <span>Stock total:</span>
                        <span class="summary-value" id="previewStock" aria-live="polite">@(producto?.Stock ?? 0) unidades</span>
                    </div>
                    <div class="summary-item">
                        <span>Precio final:</span>
                        <span class="summary-value" id="previewPrice" aria-live="polite">
                            @((producto?.PrecioVenta ?? 0m).ToString("C2", culture))
                        </span>
                    </div>
                    <div class="summary-item">
                        <span>Margen:</span>
                        <span class="summary-value" id="previewMargin" aria-live="polite">
                            @(((producto?.PrecioVenta ?? 0m) - (producto?.PrecioCompra ?? 0m)).ToString("C2", culture))
                        </span>
                    </div>
                    <div class="summary-item">
                        <span>Imágenes:</span>
                        <span class="summary-value" id="previewImages" aria-live="polite">@imgCountInit</span>
                    </div>
                </div>
            </div>

            <!-- Errores de validación -->
            <div class="action-card" id="validationCard" style="display:none;" role="alert" aria-live="assertive">
                <h3 class="action-title" style="color:var(--error);">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    Errores de Validación
                </h3>
                <div class="form-note">
                    <ul id="validationErrors" style="color:var(--error);font-size:13px;padding-left:16px;"></ul>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Data para JavaScript -->
<script id="formData" type="application/json">
    @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
        hasVariants = hasVariantesInit,
                                subcategorias = subcatsSrc.Select(s => new { s.SubcategoriaID, s.NombreSubcategoria, s.CategoriaID }),
                                imageCount = imgCountInit
                }))
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="~/js/ProductoForm.js" asp-append-version="true"></script>
}
