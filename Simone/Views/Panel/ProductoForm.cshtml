@using System.Globalization
@using Simone.Models
@{
    ViewData["Title"] = ViewBag.Producto != null ? "Editar Producto" : "Añadir Producto";

    var producto = ViewBag.Producto as Producto;
    var categorias = ViewBag.Categorias as IEnumerable<Categorias> ?? Enumerable.Empty<Categorias>();
    var proveedores = ViewBag.Proveedores as IEnumerable<Proveedores> ?? Enumerable.Empty<Proveedores>();
    var subcatsSrc = (IEnumerable<Subcategorias>)(
        ViewBag.Subcategorias as IEnumerable<Subcategorias> ??
        ViewBag.subcategorias as IEnumerable<Subcategorias> ??
        new List<Subcategorias>()
    );

    // Variantes existentes
    var variantesInit = (ViewBag.Variantes as IEnumerable<ProductoVariante>)?.ToList() ?? new List<ProductoVariante>();
    var hasVariantesInit = variantesInit.Any();

    // Galería
    var galListTop = ViewBag.Galeria as IEnumerable<string>;
    int imgCountInit = galListTop?.Count() ?? (string.IsNullOrWhiteSpace(producto?.ImagenPath) ? 0 : 1);

    var culture = CultureInfo.CreateSpecificCulture("es-EC");
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">

<style>
    :root {
        --primary: #7c3aed;
        --primary-light: #8b5cf6;
        --primary-dark: #6d28d9;
        --secondary: #f8fafc;
        --accent: #e879f9;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --surface: #fff;
        --border: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --shadow-sm: 0 1px 2px 0 rgba(0,0,0,.05);
        --shadow: 0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
        --radius: 12px;
        --radius-sm: 8px;
        --transition: all .2s ease-in-out
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    body {
        font-family: 'Inter',system-ui,-apple-system,sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background: #f8fafc
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding: 16px 0
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary)
    }

        .page-title i {
            color: var(--primary);
            font-size: 28px
        }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition)
    }

        .back-btn:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary)
        }

    .product-form-container {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 24px
    }

    .form-section {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 24px
    }

    .section-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(90deg,#f8fafc,#fff);
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px
    }

        .section-title i {
            color: var(--primary)
        }

    .section-badge {
        background: var(--primary);
        color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px
    }

    .section-content {
        padding: 20px
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2,1fr);
        gap: 16px
    }

    .form-grid-full {
        grid-column: 1 / -1
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px
    }

    .form-label {
        font-weight: 500;
        font-size: 14px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 4px
    }

    .required::after {
        content: "*";
        color: var(--error);
        margin-left: 2px
    }

    .form-input, .form-select, .form-textarea {
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 14px;
        background: var(--surface);
        transition: var(--transition);
        width: 100%
    }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124,58,237,.1)
        }

        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(239,68,68,.1)
        }

    .form-textarea {
        min-height: 120px;
        resize: vertical
    }

    .form-note {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px
    }

    .form-error {
        font-size: 12px;
        color: var(--error);
        margin-top: 4px;
        display: none
    }

    .input-has-error {
        border-color: var(--error) !important
    }

    .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #f1f5f9;
        border: 1px solid var(--border);
        border-radius: 9999px;
        padding: 6px 10px;
        font-size: 12px
    }

        .pill i {
            font-size: 12px
        }

    /* Imágenes */
    .image-upload-area {
        border: 2px dashed var(--border);
        border-radius: var(--radius-sm);
        background: #f8fafc;
        padding: 32px 20px;
        text-align: center;
        transition: var(--transition);
        cursor: pointer;
        position: relative
    }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(124,58,237,.02)
        }

        .image-upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(124,58,237,.05)
        }

        .image-upload-area i {
            font-size: 40px;
            color: var(--text-muted);
            margin-bottom: 12px
        }

    .gallery-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
        gap: 16px;
        margin-top: 16px
    }

    .image-thumbnail {
        position: relative;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--border);
        aspect-ratio: 1/1;
        transition: var(--transition)
    }

        .image-thumbnail:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg)
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

    .image-actions {
        position: absolute;
        bottom: 8px;
        right: 8px;
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: var(--transition)
    }

    .image-thumbnail:hover .image-actions {
        opacity: 1
    }

    .image-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: rgba(255,255,255,.9);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow-sm)
    }

        .image-btn:hover {
            background: var(--surface);
            color: var(--primary);
            transform: translateY(-1px)
        }

        .image-btn.active {
            background: var(--primary);
            color: #fff
        }

    .image-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--primary);
        color: #fff;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600
    }

    .image-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 8px
    }

    /* Variantes */
    .toggle-section {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding: 16px;
        background: #f8fafc;
        border-radius: var(--radius-sm)
    }

    .toggle-label {
        font-weight: 500;
        color: var(--text-primary)
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px
    }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #cbd5e1;
        transition: var(--transition);
        border-radius: 34px
    }

        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: #fff;
            transition: var(--transition);
            border-radius: 50%
        }

    input:checked + .toggle-slider {
        background: var(--primary)
    }

        input:checked + .toggle-slider:before {
            transform: translateX(24px)
        }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        font-size: 13px;
        color: var(--text-primary);
        transition: var(--transition)
    }

        .tag:hover {
            background: #e2e8f0
        }

    .tag-remove {
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        transition: var(--transition)
    }

        .tag-remove:hover {
            background: var(--error);
            color: #fff
        }

    .variants-table-container {
        overflow-x: auto;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        margin-top: 16px;
        max-height: 400px;
        overflow-y: auto
    }

    .variants-table {
        width: 100%;
        border-collapse: collapse
    }

        .variants-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0
        }

        .variants-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px
        }

        .variants-table tr:last-child td {
            border-bottom: none
        }

        .variants-table tr:hover td {
            background: rgba(124,58,237,.02)
        }

    .variant-actions {
        display: flex;
        gap: 8px
    }

    .variant-input {
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 13px;
        width: 100%;
        transition: var(--transition)
    }

        .variant-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(124,58,237,.1)
        }

        .variant-input.error {
            border-color: var(--error)
        }

    .price-rules {
        background: #f8fafc;
        border-radius: var(--radius-sm);
        padding: 16px;
        margin-bottom: 16px
    }

    .price-rule {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        padding: 12px;
        background: #fff;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border)
    }

        .price-rule:last-child {
            margin-bottom: 0
        }

    .price-rule-input {
        width: 120px !important
    }

    .form-sidebar {
        position: sticky;
        top: 24px;
        height: fit-content
    }

    .action-card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 24px
    }

    .action-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary)
    }

    .form-actions {
        display: flex;
        flex-direction: column;
        gap: 12px
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 16px;
        border: none;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none
    }

    .btn-primary {
        background: var(--primary);
        color: #fff
    }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow)
        }

    .btn-secondary {
        background: #f1f5f9;
        color: var(--text-primary);
        border: 1px solid var(--border)
    }

        .btn-secondary:hover {
            background: #e2e8f0
        }

    .btn-success {
        background: var(--success);
        color: #fff
    }

        .btn-success:hover {
            background: #059669
        }

    .btn:disabled {
        opacity: .6;
        cursor: not-allowed;
        transform: none !important
    }

    .alert {
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .alert-success {
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        color: #065f46
    }

    .alert-error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        transition: width .3s ease;
        width: 0%
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border)
    }

        .summary-item:last-child {
            border-bottom: none
        }

    @@media (max-width:1024px) {
        .product-form-container {
            grid-template-columns: 1fr
        }

        .form-sidebar {
            position: static
        }
    }

    @@media (max-width:768px) {
        .form-grid {
            grid-template-columns: 1fr
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px
        }

        .toggle-section {
            flex-direction: column;
            align-items: flex-start
        }
    }

    .loading {
        opacity: .6;
        pointer-events: none
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite
    }

    @@keyframes spin {
        0% {
            transform: rotate(0)
        }

        100% {
            transform: rotate(360deg)
        }
    }

    .validation-error {
        border: 1px solid var(--error) !important;
        box-shadow: 0 0 0 3px rgba(239,68,68,.1) !important
    }
</style>

<div class="container">
    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-box-open"></i>
            <h1>@ViewData["Title"]</h1>
        </div>
        <a class="back-btn" asp-controller="Panel" asp-action="Productos">
            <i class="fas fa-arrow-left"></i> Volver a Productos
        </a>
    </div>

    @if (TempData["Ok"] != null)
    {
        <div class="alert alert-success"><i class="fas fa-check-circle"></i>@TempData["Ok"]</div>
    }
    @if (TempData["Err"] != null)
    {
        <div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i>@TempData["Err"]</div>
    }

    <div class="product-form-container">
        <!-- MAIN -->
        <div class="form-main">
            <form method="post"
                  asp-controller="Panel"
                  asp-action="@(producto != null ? "EditarProducto" : "AnadirProducto")"
                  enctype="multipart/form-data"
                  id="productoForm"
                  novalidate
                  onsubmit="return validateForm()">

                @Html.AntiForgeryToken()
                @if (producto != null)
                {
                    <input type="hidden" name="productoID" value="@producto.ProductoID" />
                }

                <!-- Información Básica -->
                <div class="form-section" aria-labelledby="sec-basic">
                    <div class="section-header">
                        <h2 class="section-title" id="sec-basic"><i class="fas fa-info-circle"></i>Información Básica</h2>
                        <span class="section-badge" id="productTypeBadge">@(hasVariantesInit ? "Con Variantes" : "Producto Simple")</span>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label required" for="Nombre">Nombre del Producto</label>
                                <input class="form-input" id="Nombre" name="nombreProducto" maxlength="120" required
                                       placeholder="Ej. Camiseta de algodón" value="@(producto?.Nombre ?? "")"
                                       data-validation="required" />
                                <div class="form-error" id="NombreError">El nombre del producto es requerido</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="Marca">Marca</label>
                                <input class="form-input" id="Marca" name="marca" maxlength="80" required
                                       placeholder="Ej. Nike, Adidas" value="@(producto?.Marca ?? "")"
                                       data-validation="required" />
                                <div class="form-error" id="MarcaError">La marca es requerida</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="Categoria">Categoría</label>
                                <select class="form-select" id="Categoria" name="categoriaID" required data-validation="required">
                                    <option value="">Seleccione una categoría</option>
                                    @foreach (var c in categorias)
                                    {
                                        <option value="@c.CategoriaID"
                                                selected="@(producto != null && producto.CategoriaID == c.CategoriaID ? "selected" : null)">
                                            @c.Nombre
                                        </option>
                                    }
                                </select>

                                <div class="form-error" id="CategoriaError">La categoría es requerida</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="Subcategoria">Subcategoría</label>
                                <select class="form-select" id="Subcategoria" name="subcategoriaID" required data-validation="required">
                                    <option value="">Seleccione una subcategorría</option>
                                    @if (producto != null)
                                    {
                                        foreach (var s in subcatsSrc.Where(x => x.CategoriaID == producto.CategoriaID))
                                        {
                                            <option value="@s.SubcategoriaID"
                                                    selected="@(producto.SubcategoriaID == s.SubcategoriaID ? "selected" : null)">
                                                @s.NombreSubcategoria
                                            </option>
                                        }
                                    }
                                </select>
                                <div class="form-note" id="subcategoriaNote">Seleccione primero una categoría</div>
                                <div class="form-error" id="SubcategoriaError">La subcategoría es requerida</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="Proveedor">Proveedor</label>
                                <select class="form-select" id="Proveedor" name="proveedorID" required data-validation="required">
                                    <option value="">Seleccione un proveedor</option>
                                    @foreach (var p in proveedores)
                                    {
                                        <option value="@p.ProveedorID"
                                                selected="@(producto != null && producto.ProveedorID == p.ProveedorID ? "selected" : null)">
                                            @p.NombreProveedor
                                        </option>
                                    }
                                </select>

                                <div class="form-error" id="ProveedorError">El proveedor es requerido</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="PrecioCompra">Precio de Compra</label>
                                <input class="form-input" id="PrecioCompra" name="precioCompra" type="number" step="0.01" min="0.01" required
                                       value="@(producto != null ? producto.PrecioCompra.ToString("0.00", CultureInfo.InvariantCulture) : "")"
                                       data-validation="required,number,min:0.01" />
                                <div class="form-error" id="PrecioCompraError">El precio de compra debe ser mayor a 0</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="PrecioVenta">Precio de Venta</label>
                                <input class="form-input" id="PrecioVenta" name="precioVenta" type="number" step="0.01" min="0.01" required
                                       value="@(producto != null ? producto.PrecioVenta.ToString("0.00", CultureInfo.InvariantCulture) : "")"
                                       data-validation="required,number,min:0.01" />
                                <div class="form-note" id="pvMargin" aria-live="polite"></div>
                                <div class="form-error" id="PrecioVentaError">El precio de venta debe ser mayor a 0</div>
                            </div>

                            <div class="form-group base-only">
                                <label class="form-label" for="Color">Color</label>
                                <input class="form-input" id="Color" name="color" maxlength="40"
                                       placeholder="Ej. Negro, Azul, Rojo" value="@(producto?.Color ?? "")" />
                            </div>

                            <div class="form-group base-only">
                                <label class="form-label" for="Talla">Talla</label>
                                <input class="form-input" id="Talla" name="talla" maxlength="40"
                                       placeholder="Ej. S, M, L, XL" value="@(producto?.Talla ?? "")" />
                            </div>

                            <div class="form-group base-only">
                                <label class="form-label required" for="Stock">Stock</label>
                                <input class="form-input" id="Stock" name="stock" type="number" min="0" step="1" required
                                       value="@(producto?.Stock.ToString() ?? "0")"
                                       data-validation="required,number,min:0" />
                                <div class="form-error" id="StockError">El stock debe ser 0 o mayor</div>
                            </div>

                            <div class="form-group form-grid-full">
                                <label class="form-label required" for="Descripcion">Descripción</label>
                                <textarea class="form-textarea" id="Descripcion" name="descripcion" maxlength="500" required
                                          placeholder="Describe características, materiales y beneficios"
                                          data-validation="required">@(producto?.Descripcion ?? "")</textarea>
                                <div class="form-error" id="DescripcionError">La descripción es requerida</div>
                                <div class="form-note" style="text-align:right;">
                                    <span id="charCount">@(producto?.Descripcion?.Length ?? 0)</span>/500 caracteres
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imágenes -->
                <div class="form-section" aria-labelledby="sec-images">
                    <div class="section-header">
                        <h2 class="section-title" id="sec-images"><i class="fas fa-images"></i>Imágenes del Producto</h2>
                        <span class="section-badge" id="imageCountBadge">@imgCountInit/8 imágenes</span>
                    </div>
                    <div class="section-content">
                        <div class="image-upload-area" id="imageUploadArea" tabindex="0">
                            <i class="fas fa-cloud-arrow-up"></i>
                            <p>Arrastra y suelta las imágenes aquí</p>
                            <span>o haz clic para seleccionar archivos</span>

                            <input type="file" id="Imagenes" name="Imagenes" accept="image/jpeg,image/png,image/webp,image/gif" multiple style="display:none" />
                            <input type="file" id="ImagenLegacy" name="imagen" accept="image/jpeg,image/png,image/webp,image/gif" style="display:none" />

                            <input type="hidden" id="ImagenPrincipalIndex" name="ImagenPrincipalIndex" value="0" />
                            <input type="hidden" id="ExistingImagenPath" name="existingImagenPath" value="@(ViewBag.Portada ?? producto?.ImagenPath ?? "")" />
                            <input type="hidden" id="ImagenesIgnore" name="ImagenesIgnore" />

                            <div class="image-hint"><i class="fas fa-circle-info"></i> Hasta 8 imágenes (.jpg, .jpeg, .png, .webp, .gif · máx 8MB c/u). La portada se marca con ★.</div>
                            <div id="imgAlert" class="form-error" style="display:none"></div>
                            <div class="progress-bar" id="uploadProgress" style="display:none;">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>

                        <div id="galeria" class="gallery-preview" aria-live="polite">
                            @if (galListTop != null && galListTop.Any())
                            {
                                var portada = ViewBag.Portada as string ?? producto?.ImagenPath ?? "";
                                foreach (var url in galListTop)
                                {
                                    var isCover = string.Equals(portada, url, StringComparison.OrdinalIgnoreCase);
                                    <div class="image-thumbnail" data-existing="1" data-url="@url">
                                        @if (isCover)
                                        {
                                            <span class="image-badge">Principal</span>
                                        }
                                        <img src="@url" alt="Imagen del producto" loading="lazy" />
                                        <div class="image-actions">
                                            <button type="button" class="image-btn @(isCover ? "active" : "")"
                                                    onclick="markExistingCover(this, '@url')"
                                                    title="Marcar como principal">
                                                <i class="fas fa-star"></i>
                                            </button>
                                            <button type="button" class="image-btn"
                                                    onclick="flagExistingRemoval(this, '@url')"
                                                    title="Eliminar imagen">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else if (!string.IsNullOrWhiteSpace(producto?.ImagenPath))
                            {
                                <div class="image-thumbnail" data-existing="1" data-url="@producto.ImagenPath">
                                    <span class="image-badge">Principal</span>
                                    <img src="@producto.ImagenPath" alt="Imagen actual del producto" loading="lazy" />
                                    <div class="image-actions">
                                        <button type="button" class="image-btn active"
                                                onclick="markExistingCover(this, '@producto.ImagenPath')"
                                                title="Marcar como principal">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button" class="image-btn"
                                                onclick="flagExistingRemoval(this, '@producto.ImagenPath')"
                                                title="Eliminar imagen">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Variantes -->
                @{
                    decimal minVarPrice = 0m, maxVarPrice = 0m;
                    if (hasVariantesInit && variantesInit.Any())
                    {
                        minVarPrice = variantesInit.Min(v => (v.PrecioVenta ?? 0m));
                        maxVarPrice = variantesInit.Max(v => (v.PrecioVenta ?? 0m));
                    }
                }
                <div class="form-section" aria-labelledby="sec-variants">
                    <div class="section-header">
                        <h2 class="section-title" id="sec-variants"><i class="fas fa-layer-group"></i>Variantes del Producto</h2>
                        <span class="section-badge" id="variantCountBadge">@(hasVariantesInit? variantesInit.Count + " variantes" : "0 variantes")</span>
                    </div>
                    <div class="section-content">
                        <div class="toggle-section">
                            <label class="toggle-switch">
                                <input type="checkbox" id="chkVariantes" @(hasVariantesInit ? "checked" : "") />
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Activar variantes (Color × Talla)</span>
                            <span class="form-note">Con variantes, ingresa el <strong>precio final</strong> por combinación.</span>
                        </div>

                        <div id="boxVariantes" style="display:@(hasVariantesInit ? "block" : "none");">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="inpColores">Colores</label>
                                    <input class="form-input" id="inpColores" placeholder="Negro, Vino, Marrón" />
                                    <div class="form-note">Separa con comas o Enter.</div>
                                    <div class="tags-container" id="tagsColores">
                                        @if (hasVariantesInit)
                                        {
                                            @foreach (var color in variantesInit.Select(v => v.Color).Distinct())
                                            {
                                                <span class="tag">
                                                    @color
                                                    <button type="button" class="tag-remove" onclick="removeTag(this, 'color')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <input type="hidden" name="Colores" value="@color" />
                                                </span>
                                            }
                                        }
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="inpTallas">Tallas</label>
                                    <input class="form-input" id="inpTallas" placeholder="S, M, L, XL" />
                                    <div class="form-note">Separa con comas o Enter.</div>
                                    <div class="tags-container" id="tagsTallas">
                                        @if (hasVariantesInit)
                                        {
                                            @foreach (var talla in variantesInit.Select(v => v.Talla).Distinct())
                                            {
                                                <span class="tag">
                                                    @talla
                                                    <button type="button" class="tag-remove" onclick="removeTag(this, 'talla')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <input type="hidden" name="Tallas" value="@talla" />
                                                </span>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="price-rules">
                                <div class="price-rule">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="chkPrecioGlobal" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Un solo precio para todas</span>
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <input class="form-input price-rule-input" id="inpPrecioGlobal" type="number" step="0.01" min="0" placeholder="0.00" disabled />
                                        <button type="button" class="btn btn-success" id="btnApplyGlobal" disabled>Aplicar</button>
                                    </div>
                                </div>

                                <div class="price-rule">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="chkPrecioPorTalla" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Mismo precio por talla</span>
                                </div>
                                <div id="boxPrecioPorTalla" style="display:none;margin-top:8px;"></div>
                            </div>

                            <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:16px;flex-wrap:wrap;">
                                <button type="button" class="btn btn-primary" id="btnGen"><i class="fas fa-table"></i> Generar combinaciones</button>
                                <button type="button" class="btn btn-secondary" id="btnClearVars" title="Limpiar"><i class="fas fa-eraser"></i> Limpiar</button>
                            </div>

                            <div class="variants-table-container">
                                <table class="variants-table" id="tblVars" aria-live="polite">
                                    <thead>
                                        <tr>
                                            <th style="min-width:120px">Color</th>
                                            <th style="min-width:120px">Talla</th>
                                            <th style="min-width:130px">Precio</th>
                                            <th style="min-width:120px">Stock</th>
                                            <th style="width:80px">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (hasVariantesInit)
                                        {
                                            foreach (var variante in variantesInit)
                                            {
                                                <tr>
                                                    <td>
                                                        <input type="hidden" name="VarColor" value="@variante.Color" />
                                                        <span>@variante.Color</span>
                                                    </td>
                                                    <td>
                                                        <input type="hidden" name="VarTalla" value="@variante.Talla" />
                                                        <span>@variante.Talla</span>
                                                    </td>
                                                    <td>
                                                        <input class="variant-input"
                                                               name="VarPrecio"
                                                               type="number"
                                                               step="0.01"
                                                               min="0.01"
                                                               value="@((variante.PrecioVenta ?? 0m).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture))"
                                                               required />
                                                    </td>
                                                    <td>
                                                        <input class="variant-input" name="VarStock" type="number" step="1" min="0" value="@variante.Stock" required />
                                                    </td>
                                                    <td>
                                                        <div class="variant-actions">
                                                            <button type="button" class="image-btn" title="Eliminar" onclick="removeVariant(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                                <div class="form-note" id="noteVars" style="padding:16px;text-align:center;@(hasVariantesInit ? "display:none" : "")">
                                    No hay variantes generadas.
                                </div>
                            </div>

                            <div id="variantSummary" style="display:@(hasVariantesInit ? "block" : "none");margin-top:16px;padding:16px;background:#f8fafc;border-radius:var(--radius-sm);">
                                <h4 style="margin-bottom:12px;font-size:14px;font-weight:600;">Resumen de Variantes</h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                                    <div class="summary-item">
                                        <span>Total de combinaciones:</span>
                                        <span class="summary-value" id="summaryTotal">@(hasVariantesInit? variantesInit.Count: 0)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Stock total:</span>
                                        <span class="summary-value" id="summaryStock">@(hasVariantesInit? variantesInit.Sum(v => v.Stock) : 0)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Precio mínimo:</span>
                                        <span class="summary-value" id="summaryMinPrice">@minVarPrice.ToString("C2", culture)</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Precio máximo:</span>
                                        <span class="summary-value" id="summaryMaxPrice">@maxVarPrice.ToString("C2", culture)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>

        <!-- SIDEBAR -->
        <div class="form-sidebar">
            <div class="action-card">
                <h3 class="action-title">Acciones</h3>
                <div class="form-actions">
                    <button class="btn btn-primary" id="btnSubmit" type="submit" form="productoForm">
                        <i class="fas fa-floppy-disk"></i>Guardar Producto
                    </button>
                    <a asp-controller="Panel" asp-action="Productos" class="btn btn-secondary">
                        <i class="fas fa-times"></i>Cancelar
                    </a>
                </div>
                <div class="form-note" style="margin-top:12px;text-align:center;">
                    <i class="fas fa-clock"></i> <span id="lastSaved">No guardado</span>
                </div>
            </div>

            <div class="action-card">
                <h3 class="action-title">Vista Previa</h3>
                <div class="form-note">
                    <div class="summary-item">
                        <span>Tipo:</span>
                        <span class="summary-value" id="previewType">@(hasVariantesInit ? "Con Variantes" : "Producto Simple")</span>
                    </div>
                    <div class="summary-item">
                        <span>Stock total:</span>
                        <span class="summary-value" id="previewStock">@(producto?.Stock ?? 0) unidades</span>
                    </div>
                    <div class="summary-item">
                        <span>Precio final:</span>
                        <span class="summary-value" id="previewPrice">
                            @((producto?.PrecioVenta ?? 0m).ToString("C2", culture))
                        </span>
                    </div>
                    <div class="summary-item">
                        <span>Margen:</span>
                        <span class="summary-value" id="previewMargin">
                            @(((producto?.PrecioVenta ?? 0m) - (producto?.PrecioCompra ?? 0m)).ToString("C2", culture))
                        </span>
                    </div>
                    <div class="summary-item">
                        <span>Imágenes:</span>
                        <span class="summary-value" id="previewImages">@imgCountInit</span>
                    </div>
                </div>
            </div>

            <div class="action-card" id="validationCard" style="display:none;">
                <h3 class="action-title" style="color:var(--error);">
                    <i class="fas fa-exclamation-triangle"></i> Errores de Validación
                </h3>
                <div class="form-note">
                    <ul id="validationErrors" style="color:var(--error);font-size:13px;padding-left:16px;"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        "use strict";

        // ---------- Helpers ----------
        const $ = id => document.getElementById(id);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const toNum = (x) => {
            const s = (x ?? "").toString().replace(/\s+/g, "").replace(/\.(?=\d{3}(?:\D|$))/g, "").replace(/,(?=\d{1,2}(?:\D|$))/g, ".");
            const n = parseFloat(s);
            return Number.isFinite(n) ? n : 0;
        };
        const fmtUSD = n => new Intl.NumberFormat("es-EC", { style: "currency", currency: "USD", minimumFractionDigits: 2 }).format(n || 0);
        const debounce = (fn, ms = 120) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        const toast = (t, kind = "info", ms = 3600) => {
            const bg = { info:"linear-gradient(135deg,var(--primary),var(--primary-light))", success:"linear-gradient(135deg,var(--success),#34d399)", warning:"linear-gradient(135deg,var(--warning),#fbbf24)", error:"linear-gradient(135deg,var(--error),#f87171)" }[kind];
            Toastify({ text:t, duration:ms, gravity:"top", position:"right", stopOnFocus:true, style:{ background:bg } }).showToast();
        };

        const STATE = {
            hasVariants: @(hasVariantesInit ? "true" : "false"),
            isSubmitting: false,
            validationErrors: [],
            objectUrls: new Set(),
            subcategorias: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                            subcatsSrc.Select(s => new { s.SubcategoriaID, s.NombreSubcategoria, s.CategoriaID })
                    ))
    };

        document.addEventListener("DOMContentLoaded", () => {
            initializeForm();
            setupEventListeners();
            updatePreview();
        });

        function initializeForm() {
            initializeSubcategories();
            initializePricing();
            initializeImages();
            initializeVariants();
            initializeValidation();
            hookFormSubmit();
        }

        // ---------- Subcategorías ----------
        function initializeSubcategories() {
            const selCat = $("Categoria"), selSub = $("Subcategoria");
            if (!selCat || !selSub) return;

            const fillSubs = (catId) => {
                selSub.innerHTML = '<option value="">Seleccione una subcategoría</option>';
                const note = $("subcategoriaNote");

                if (!catId) {
                    selSub.disabled = true;
                    if (note) note.style.display = "block";
                    return;
                }

                const list = STATE.subcategorias.filter(x => x.CategoriaID == catId);
                for (const s of list) {
                    const o = document.createElement("option");
                    o.value = s.SubcategoriaID;
                    o.textContent = s.NombreSubcategoria;
                    selSub.appendChild(o);
                }

                selSub.disabled = list.length === 0;
                if (note) note.style.display = list.length === 0 ? "block" : "none";

                if (list.length === 0) {
                    toast("No hay subcategorías para esta categoría", "warning");
                }
            };

            const currentCat = parseInt(selCat.value || "0", 10);
            if (currentCat) fillSubs(currentCat);

            selCat.addEventListener("change", e => {
                fillSubs(parseInt(e.target.value || "0", 10));
                validateField(selCat);
            });
            selSub.addEventListener("change", () => validateField(selSub));
        }

        // ---------- Precios ----------
        function initializePricing() {
            const pc = $("PrecioCompra"), pv = $("PrecioVenta"), pvMargin = $("pvMargin");

            const refresh = () => {
                const a = toNum(pc.value), b = toNum(pv.value);
                if (!STATE.hasVariants) {
                    const ok = b > a;
                    pvMargin.textContent = `Margen vs compra: ${fmtUSD(b - a)} ${ok ? "" : "(insuficiente)"}`;
                    pvMargin.style.color = ok ? "var(--text-muted)" : "var(--error)";
                } else {
                    pvMargin.textContent = "Con variantes, ingresa el precio final por combinación.";
                    pvMargin.style.color = "var(--text-muted)";
                }
                updatePreview();
            };

            ["input", "change", "blur"].forEach(ev => {
                pc.addEventListener(ev, debounce(refresh, 80));
                pv.addEventListener(ev, debounce(refresh, 80));
            });

            refresh();
        }

        // ---------- Imágenes ----------
        function initializeImages() {
            const MAX_FILES = 8, MAX_MB = 8;
            const ALLOWED_TYPES = ["image/jpeg", "image/png", "image/webp", "image/gif"];
            const gal = $("galeria"), uploadArea = $("imageUploadArea"), filesInput = $("Imagenes");
            const portadaIdx = $("ImagenPrincipalIndex"), ignoreInput = $("ImagenesIgnore"), imgAlert = $("imgAlert");
            const imageCountBadge = $("imageCountBadge"), progressBar = $("uploadProgress"), progressFill = $("progressFill");

            let files = [];
            let removedExisting = new Set();

            const showError = (message) => {
                if (imgAlert) {
                    imgAlert.textContent = message;
                    imgAlert.style.display = "block";
                    setTimeout(() => imgAlert.style.display = "none", 5000);
                }
            };

            const validateFile = (file) => {
                if (!ALLOWED_TYPES.includes(file.type)) {
                    showError("Formato de archivo no permitido. Use JPEG, PNG, WebP o GIF.");
                    return false;
                }
                if (file.size > MAX_MB * 1024 * 1024) {
                    showError(`El archivo es demasiado grande. Máximo ${MAX_MB}MB por imagen.`);
                    return false;
                }
                return true;
            };

            const updateImageCount = () => {
                const existingCount = $$('#galeria .image-thumbnail[data-existing="1"]:not(.removed)').length;
                const newCount = files.length;
                const total = existingCount + newCount;

                if (imageCountBadge) {
                    imageCountBadge.textContent = `${total}/${MAX_FILES} imágenes`;
                }

                const preview = $("previewImages");
                if (preview) preview.textContent = total;

                return total;
            };

            const createImageThumbnail = (file, isNew = true) => {
                const card = document.createElement("div");
                card.className = "image-thumbnail";
                if (isNew) card.dataset.new = "1";

                const img = document.createElement("img");
                const url = URL.createObjectURL(file);
                STATE.objectUrls.add(url);
                img.src = url;
                img.alt = "Vista previa de imagen";
                img.loading = "lazy";

                const actions = document.createElement("div");
                actions.className = "image-actions";

                const starBtn = document.createElement("button");
                starBtn.type = "button";
                starBtn.className = "image-btn";
                starBtn.innerHTML = '<i class="fas fa-star"></i>';
                starBtn.title = "Marcar como principal";
                starBtn.onclick = () => markAsCover(card, isNew);

                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "image-btn";
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = "Eliminar imagen";
                deleteBtn.onclick = () => removeImage(card, isNew, url);

                actions.appendChild(starBtn);
                actions.appendChild(deleteBtn);
                card.appendChild(img);
                card.appendChild(actions);

                return card;
            };

            const markAsCover = (card, isNew) => {
                $$('.image-badge').forEach(badge => badge.remove());
                $$('.image-btn.active').forEach(btn => btn.classList.remove('active'));

                const badge = document.createElement("span");
                badge.className = "image-badge";
                badge.textContent = "Principal";
                card.appendChild(badge);

                const starBtn = card.querySelector('.image-btn');
                if (starBtn) starBtn.classList.add('active');

                if (isNew) {
                    const index = $$('#galeria .image-thumbnail[data-new="1"]').indexOf(card);
                    if (portadaIdx) portadaIdx.value = index;
                } else {
                    const url = card.dataset.url;
                    if ($("ExistingImagenPath")) $("ExistingImagenPath").value = url;
                }
            };

            const removeImage = (card, isNew, url) => {
                if (!confirm("¿Está seguro de que desea eliminar esta imagen?")) return;

                if (isNew) {
                    const index = $$('#galeria .image-thumbnail[data-new="1"]').indexOf(card);
                    files.splice(index, 1);
                    if (url) {
                        URL.revokeObjectURL(url);
                        STATE.objectUrls.delete(url);
                    }
                } else {
                    card.classList.add('removed');
                    removedExisting.add(card.dataset.url);
                    if (ignoreInput) {
                        ignoreInput.value = JSON.stringify(Array.from(removedExisting));
                    }
                }

                card.remove();
                updateImageCount();
            };

            const handleFileSelection = (fileList) => {
                const newFiles = Array.from(fileList).filter(validateFile);
                const currentCount = updateImageCount();
                const availableSlots = MAX_FILES - currentCount;

                if (availableSlots <= 0) {
                    showError(`Límite de ${MAX_FILES} imágenes alcanzado.`);
                    return;
                }

                const filesToAdd = newFiles.slice(0, availableSlots);
                if (filesToAdd.length === 0) return;

                if (progressBar && progressFill) {
                    progressBar.style.display = "block";
                    progressFill.style.width = "0%";
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 30;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(interval);
                            setTimeout(() => progressBar.style.display = "none", 500);
                        }
                        progressFill.style.width = progress + "%";
                    }, 100);
                }

                files.push(...filesToAdd);
                filesToAdd.forEach(file => gal.appendChild(createImageThumbnail(file, true)));
                updateImageCount();

                const dt = new DataTransfer();
                files.forEach(f => dt.items.add(f));
                filesInput.files = dt.files;
            };

            uploadArea.addEventListener("click", () => filesInput.click());
            uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("drag-over"); });
            uploadArea.addEventListener("dragleave", () => { uploadArea.classList.remove("drag-over"); });
            uploadArea.addEventListener("drop", (e) => { e.preventDefault(); uploadArea.classList.remove("drag-over"); handleFileSelection(e.dataTransfer.files); });
            filesInput.addEventListener("change", (e) => { handleFileSelection(e.target.files); e.target.value = ""; });

            window.addEventListener("beforeunload", () => { STATE.objectUrls.forEach(url => URL.revokeObjectURL(url)); STATE.objectUrls.clear(); });
            updateImageCount();
        }

        // Funciones globales para imágenes existentes
        window.markExistingCover = (btn, url) => {
            const card = btn.closest('.image-thumbnail'); if (!card) return;
            $$('.image-badge').forEach(badge => badge.remove());
            $$('.image-btn.active').forEach(btn => btn.classList.remove('active'));
            const badge = document.createElement("span"); badge.className = "image-badge"; badge.textContent = "Principal"; card.appendChild(badge);
            btn.classList.add('active');
            if ($("ExistingImagenPath")) { $("ExistingImagenPath").value = url; }
            if ($("ImagenPrincipalIndex")) { $("ImagenPrincipalIndex").value = "-1"; }
        };

        window.flagExistingRemoval = (btn, url) => {
            const card = btn.closest('.image-thumbnail');
            if (!card || !confirm("¿Está seguro de que desea eliminar esta imagen?")) return;
            card.classList.add('removed'); card.style.opacity = "0.4";
            const ignoreInput = $("ImagenesIgnore");
            if (ignoreInput) {
                let removed = [];
                try { removed = JSON.parse(ignoreInput.value || "[]"); } catch (e) { removed = []; }
                removed.push(url);
                ignoreInput.value = JSON.stringify(removed);
            }
        };

        // ---------- Variantes ----------
        function initializeVariants() {
            const box = $("boxVariantes"), chk = $("chkVariantes");
            if (!box || !chk) return;

            const baseOnly = $$(".base-only"), badge = $("productTypeBadge");

            const toggleVariants = () => {
                const on = chk.checked;
                STATE.hasVariants = on;
                box.style.display = on ? "block" : "none";
                baseOnly.forEach(x => x.style.display = on ? "none" : "flex");

                if (badge) badge.textContent = on ? "Con Variantes" : "Producto Simple";

                const previewType = $("previewType");
                if (previewType) previewType.textContent = on ? "Con Variantes" : "Producto Simple";

                updatePreview();
            };

            chk.addEventListener("change", toggleVariants);

            const inpCol = $("inpColores"), inpTal = $("inpTallas");
            const tagsCol = $("tagsColores"), tagsTal = $("tagsTallas");

            const addTag = (value, container, type) => {
                if (!value.trim()) return;
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.innerHTML = `
                    ${value.trim()}
                    <button type="button" class="tag-remove" onclick="removeTag(this, '${type}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <input type="hidden" name="${type === 'color' ? 'Colores' : 'Tallas'}" value="${value.trim()}" />
                `;
                container.appendChild(tag);
            };

            const handleTagInput = (input, container, type) => {
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === ",") {
                        e.preventDefault(); addTag(input.value, container, type); input.value = ""; updateVariantCount();
                    }
                });
                input.addEventListener("blur", () => {
                    if (input.value.trim()) { addTag(input.value, container, type); input.value = ""; updateVariantCount(); }
                });
            };

            handleTagInput(inpCol, tagsCol, 'color');
            handleTagInput(inpTal, tagsTal, 'talla');

            const btnGen = $("btnGen"), btnClear = $("btnClearVars");
            const tb = $("tblVars")?.querySelector("tbody"), note = $("noteVars");
            if (btnGen) { btnGen.addEventListener("click", generateCombinations); }
            if (btnClear) {
                btnClear.addEventListener("click", () => {
                    if (!confirm("¿Está seguro de que desea limpiar todas las variantes?")) return;
                    if (tb) tb.innerHTML = "";
                    if (note) note.style.display = "block";
                    $("variantSummary").style.display = "none";
                    updateVariantCount();
                });
            }

            // Reglas de precio (opcional)
            const chkGlobal = $("chkPrecioGlobal"), inpGlobal = $("inpPrecioGlobal"), btnApplyGlobal = $("btnApplyGlobal");
            if (chkGlobal && inpGlobal && btnApplyGlobal) {
                chkGlobal.addEventListener("change", () => {
                    inpGlobal.disabled = !chkGlobal.checked;
                    btnApplyGlobal.disabled = !chkGlobal.checked;
                });
                btnApplyGlobal.addEventListener("click", () => {
                    const price = toNum(inpGlobal.value);
                    if (price <= 0) { toast("Ingrese un precio válido para aplicar", "warning"); return; }
                    $$("input[name='VarPrecio']").forEach(i => i.value = price.toFixed(2));
                    updateVariantSummary(); toast("Precio aplicado a todas las variantes", "success");
                });
            }

            const chkPorTalla = $("chkPrecioPorTalla"), boxPorTalla = $("boxPrecioPorTalla");
            if (chkPorTalla && boxPorTalla) {
                chkPorTalla.addEventListener("change", () => {
                    boxPorTalla.style.display = chkPorTalla.checked ? "block" : "none";
                    if (chkPorTalla.checked) {
                        // Render inputs por talla
                        const tallas = $$('#tagsTallas .tag input').map(i => i.value);
                        boxPorTalla.innerHTML = "";
                        tallas.forEach(t => {
                            const row = document.createElement("div");
                            row.style.display = "flex"; row.style.alignItems = "center"; row.style.gap = "8px"; row.style.marginBottom = "8px";
                            row.innerHTML = `<span style="min-width:80px;">${t}</span><input type="number" step="0.01" class="form-input price-rule-input" data-talla="${t}" placeholder="0.00" />`;
                            boxPorTalla.appendChild(row);
                        });
                        // Aplicar
                        const apply = document.createElement("button");
                        apply.type = "button"; apply.className = "btn btn-success"; apply.textContent = "Aplicar";
                        apply.style.marginTop = "8px";
                        apply.onclick = () => {
                            const map = {};
                            $$("input[data-talla]").forEach(i => { const v = toNum(i.value); if (v > 0) map[i.getAttribute("data-talla")] = v; });
                            $$("tr").forEach(tr => {
                                const talla = tr.querySelector('input[name="VarTalla"]')?.value;
                                const priceInput = tr.querySelector('input[name="VarPrecio"]');
                                if (talla && map[talla] && priceInput) priceInput.value = map[talla].toFixed(2);
                            });
                            updateVariantSummary(); toast("Precios aplicados por talla", "success");
                        };
                        boxPorTalla.appendChild(apply);
                    }
                });
            }

            updateVariantCount();
        }

        window.removeTag = (btn, type) => {
            const tag = btn.closest('.tag'); if (tag) tag.remove(); updateVariantCount();
        };

        function generateCombinations() {
            const colors = $$('#tagsColores .tag input').map(input => input.value);
            const sizes = $$('#tagsTallas .tag input').map(input => input.value);
            const tb = $("tblVars")?.querySelector("tbody");
            const note = $("noteVars");
            if (!tb) return;
            if (colors.length === 0 || sizes.length === 0) { toast("Agregue al menos un color y una talla", "warning"); return; }
            tb.innerHTML = "";
            colors.forEach(color => {
                sizes.forEach(size => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td><input type="hidden" name="VarColor" value="${color}" /><span>${color}</span></td>
                        <td><input type="hidden" name="VarTalla" value="${size}" /><span>${size}</span></td>
                        <td><input class="variant-input" name="VarPrecio" type="number" step="0.01" min="0.01" placeholder="0.00" required oninput="validateVariantInput(this)" /></td>
                        <td><input class="variant-input" name="VarStock" type="number" step="1" min="0" placeholder="0" required oninput="validateVariantInput(this)" /></td>
                        <td><div class="variant-actions"><button type="button" class="image-btn" title="Eliminar" onclick="removeVariant(this)"><i class="fas fa-trash"></i></button></div></td>
                    `;
                    tb.appendChild(tr);
                });
            });
            if (note) note.style.display = "none";
            $("variantSummary").style.display = "block";
            updateVariantCount();
            updateVariantSummary();
            toast(`${colors.length * sizes.length} combinaciones generadas`, "success");
        }

        window.removeVariant = (btn) => {
            const tr = btn.closest('tr');
            if (tr && confirm("¿Eliminar esta variante?")) {
                tr.remove();
                updateVariantCount();
                updateVariantSummary();
                const remaining = $("tblVars")?.querySelectorAll("tbody tr").length || 0;
                if (remaining === 0) { $("noteVars").style.display = "block"; $("variantSummary").style.display = "none"; }
            }
        };

        window.validateVariantInput = (input) => {
            const value = toNum(input.value);
            const min = toNum(input.getAttribute("min") || 0);
            if (value < min) { input.classList.add("error"); } else { input.classList.remove("error"); }
            updateVariantSummary();
        };

        function updateVariantCount() {
            const count = $("tblVars")?.querySelectorAll("tbody tr").length || 0;
            const badge = $("variantCountBadge");
            if (badge) badge.textContent = `${count} variante${count !== 1 ? 's' : ''}`;
        }

        function updateVariantSummary() {
            const rows = $("tblVars")?.querySelectorAll("tbody tr") || [];
            const summary = $("variantSummary");
            if (rows.length === 0) { if (summary) summary.style.display = "none"; return; }
            let totalStock = 0; let minPrice = Infinity; let maxPrice = 0;
            rows.forEach(row => {
                const priceInput = row.querySelector('input[name="VarPrecio"]');
                const stockInput = row.querySelector('input[name="VarStock"]');
                const price = toNum(priceInput?.value);
                const stock = toNum(stockInput?.value);
                totalStock += stock;
                if (price > 0) { minPrice = Math.min(minPrice, price); maxPrice = Math.max(maxPrice, price); }
            });
            if ($("summaryTotal")) $("summaryTotal").textContent = rows.length;
            if ($("summaryStock")) $("summaryStock").textContent = totalStock;
            if ($("summaryMinPrice")) $("summaryMinPrice").textContent = fmtUSD(minPrice === Infinity ? 0 : minPrice);
            if ($("summaryMaxPrice")) $("summaryMaxPrice").textContent = fmtUSD(maxPrice);
            if (summary) summary.style.display = "block";
            const previewStock = $("previewStock");
            if (previewStock) previewStock.textContent = `${totalStock} unidades`;
        }

        // ---------- Validación ----------
        function initializeValidation() {
            const desc = $("Descripcion"), cc = $("charCount");
            if (desc && cc) {
                desc.addEventListener("input", debounce(() => {
                    const length = desc.value.length;
                    cc.textContent = length;
                    cc.style.color = length > 500 ? "var(--error)" : "var(--text-muted)";
                    validateField(desc);
                }, 100));
            }

            $$("[data-validation]").forEach(field => {
                field.addEventListener("blur", () => validateField(field));
                field.addEventListener("input", () => {
                    field.classList.remove("input-has-error", "error");
                    const errorEl = $(field.id + "Error");
                    if (errorEl) errorEl.style.display = "none";
                });
            });
        }

        function validateField(field) {
            const rules = field.getAttribute("data-validation") || "";
            const value = (field.value || "").trim();
            const errorEl = $(field.id + "Error");
            let isValid = true;
            let message = "";

            if (rules.includes("required") && !value) {
                isValid = false; message = errorEl?.textContent || "Este campo es requerido";
            } else if (rules.includes("number") && value) {
                const num = toNum(value);
                if (isNaN(num)) { isValid = false; message = "Debe ser un número válido"; }
                else if (rules.includes("min:0.01") && num < 0.01) { isValid = false; message = "Debe ser mayor a 0"; }
                else if (rules.includes("min:0") && num < 0) { isValid = false; message = "Debe ser mayor o igual a 0"; }
            }

            if (isValid) { field.classList.remove("input-has-error", "error"); if (errorEl) errorEl.style.display = "none"; }
            else { field.classList.add("input-has-error", "error"); if (errorEl) { errorEl.textContent = message; errorEl.style.display = "block"; } }
            return isValid;
        }

        function showValidationErrors() {
            const card = $("validationCard"), list = $("validationErrors");
            if (!card || !list) return;
            list.innerHTML = "";
            STATE.validationErrors.forEach(error => { const li = document.createElement("li"); li.textContent = error; list.appendChild(li); });
            card.style.display = STATE.validationErrors.length > 0 ? "block" : "none";
            const firstError = document.querySelector(".input-has-error, .error");
            if (firstError) { firstError.scrollIntoView({ behavior: "smooth", block: "center" }); firstError.focus(); }
        }

        // ---------- Preview ----------
        function updatePreview() {
            const pc = toNum($("PrecioCompra")?.value), pv = toNum($("PrecioVenta")?.value);
            const stock = STATE.hasVariants ? (toNum($("summaryStock")?.textContent || 0)) : toNum($("Stock")?.value);
            const finalPrice = pv; // sin +15%
            const margin = finalPrice - pc;
            if ($("previewPrice")) $("previewPrice").textContent = fmtUSD(finalPrice);
            if ($("previewMargin")) $("previewMargin").textContent = fmtUSD(margin);
            if ($("previewStock")) $("previewStock").textContent = `${stock} unidades`;
            if ($("lastSaved")) $("lastSaved").textContent = `Editado: ${new Date().toLocaleTimeString()}`;
        }

        // ---------- Envío ----------
        function validateForm() {
            if (STATE.isSubmitting) { toast("El formulario ya se está enviando...", "warning"); return false; }
            STATE.validationErrors = [];

            // Básicos
            $$("[data-validation]").forEach(field => {
                if (!validateField(field)) {
                    const label = field.previousElementSibling?.textContent?.replace('*', '')?.trim() || field.name;
                    STATE.validationErrors.push(`${label} es requerido o inválido`);
                }
            });

            // Precio vs compra (producto simple)
            if (!STATE.hasVariants) {
                const pc = toNum($("PrecioCompra")?.value), pv = toNum($("PrecioVenta")?.value);
                if (!(pv > pc)) {
                    STATE.validationErrors.push("El precio de venta debe ser mayor al precio de compra");
                    $("PrecioVenta")?.classList.add("input-has-error","error");
                }
            }

            // Variantes
            if (STATE.hasVariants) {
                const variantRows = $("tblVars")?.querySelectorAll("tbody tr") || [];
                if (variantRows.length === 0) {
                    STATE.validationErrors.push("Debe agregar al menos una variante cuando las variantes están activadas");
                } else {
                    let hasErrors = false;
                    variantRows.forEach(row => {
                        const priceInput = row.querySelector('input[name="VarPrecio"]');
                        const stockInput = row.querySelector('input[name="VarStock"]');
                        if (!priceInput?.value || toNum(priceInput.value) <= 0) { priceInput?.classList.add("error"); hasErrors = true; }
                        if (!stockInput?.value || toNum(stockInput.value) < 0) { stockInput?.classList.add("error"); hasErrors = true; }
                    });
                    if (hasErrors) { STATE.validationErrors.push("Algunas variantes tienen precios o stocks inválidos"); }
                }
            }

            // Imágenes: al menos una
            const imageCount = $$('#galeria .image-thumbnail:not(.removed)').length;
            if (imageCount === 0) { STATE.validationErrors.push("Debe agregar al menos una imagen"); }

            if (STATE.validationErrors.length > 0) { showValidationErrors(); toast("Corrija los errores antes de enviar el formulario", "error"); return false; }

            // Preparar envío
            STATE.isSubmitting = true;
            const btn = $("btnSubmit");
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner spinner"></i> Guardando...'; }
            $$("input[type='number']").forEach(input => { if (input.value) { input.value = input.value.replace(",", "."); } });
            if (!STATE.hasVariants) { $$("input[name^='Var']").forEach(input => input.remove()); }
            toast("Guardando producto...", "info");
            return true;
        }

        function hookFormSubmit() {
            const form = $("productoForm");
            if (!form) return;
            form.addEventListener("submit", (e) => {
                if (!validateForm()) {
                    e.preventDefault();
                    STATE.isSubmitting = false;
                    const btn = $("btnSubmit");
                    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-floppy-disk"></i> Guardar Producto'; }
                }
            });
        }

        // ---------- Event Listeners ----------
        function setupEventListeners() {
            setInterval(() => {
                if (document.activeElement?.form === $("productoForm")) {
                    const lastSaved = $("lastSaved");
                    if (lastSaved) { lastSaved.textContent = `Auto-guardado: ${new Date().toLocaleTimeString()}`; }
                }
            }, 30000);

            window.addEventListener("beforeunload", (e) => {
                const form = $("productoForm");
                if (form && form.checkValidity && !form.checkValidity()) {
                    e.preventDefault(); e.returnValue = "";
                }
            });

            if (window.innerWidth < 768) {
                $$(".form-input, .form-select, .form-textarea").forEach(input => {
                    input.addEventListener("focus", function() { this.scrollIntoView({ behavior: "smooth", block: "center" }); });
                });
            }

            $$("#Nombre, #Marca, #Stock, #PrecioCompra, #PrecioVenta").forEach(input => {
                input.addEventListener("input", debounce(updatePreview, 200));
            });
        }
    </script>
}
