@using System.Globalization
@{
    ViewData["Title"] = ViewBag.Producto != null ? "Editar Producto" : "Añadir Producto";
    var producto = ViewBag.Producto; // dinámico: producto?.Propiedad
}

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root{
        --primary-light:#fff;--accent-purple:#4B0082;--light-gray:#F8F8F8;--medium-gray:#E0E0E0;--dark-gray:#333;--text:#333;--danger:#dc3545
    }
    body{font-family:'Montserrat',sans-serif;background:#f5f5f7;color:var(--text)}
    h1,h2,h3,h4,h5,h6{font-family:'Playfair Display',serif;font-weight:600}
    .form-container{max-width:900px;margin:2rem auto;padding:0 15px}
    .form-card{background:#fff;border-radius:12px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .form-header{display:flex;align-items:center;margin-bottom:2rem;color:var(--accent-purple)}
    .form-header i{font-size:1.8rem;margin-right:1rem}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.5rem}
    .form-group.full{grid-column:span 2}
    .form-label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--dark-gray)}
    .form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;border:1px solid var(--medium-gray);border-radius:8px;font-size:1rem;transition:.2s}
    .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent-purple);box-shadow:0 0 0 3px rgba(75,0,130,.1);outline:0}
    .image-upload{display:flex;flex-direction:column;gap:1rem}
    .image-preview{width:150px;height:150px;object-fit:cover;border-radius:8px;border:1px solid var(--medium-gray)}
    .no-image{width:150px;height:150px;background:var(--light-gray);border-radius:8px;display:grid;place-items:center;color:#777}
    .file-input{display:none}
    .file-label{background:var(--light-gray);padding:.5rem 1rem;border-radius:6px;cursor:pointer;display:inline-flex;gap:.5rem;align-items:center}
    .file-label:hover{background:var(--medium-gray)}
    .error-msg{color:var(--danger);font-size:.85rem;display:none}
    .submit-btn{background:linear-gradient(135deg,var(--accent-purple),#5E2D8C);color:#fff;border:0;padding:.9rem 1.6rem;border-radius:30px;font-weight:700;cursor:pointer;grid-column:span 2}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(75,0,130,.25)}
    @@media (max-width:768px){.form-grid{grid-template-columns:1fr}.submit-btn{grid-column:span 1}}
</style>

<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <i class="fas fa-box-open"></i>
            <h2>@ViewData["Title"]</h2>
        </div>

        <form class="form-grid" method="post"
              asp-controller="Panel"
              asp-action="@(producto != null ? "EditarProducto" : "AnadirProducto")"
              enctype="multipart/form-data" id="productoForm">
            @Html.AntiForgeryToken()

            @if (producto != null)
            {
                <input type="hidden" name="productoID" value="@producto.ProductoID" />
            }

            <!-- Nombre -->
            <div class="form-group">
                <label for="Nombre" class="form-label">Nombre</label>
                <input type="text" name="nombreProducto" id="Nombre" class="form-input"
                       placeholder="Nombre del producto" required value="@(producto != null ? (string)producto.Nombre : "")" />
            </div>

            <!-- Descripción -->
            <div class="form-group full">
                <label for="Descripcion" class="form-label">Descripción</label>
                <textarea name="descripcion" id="Descripcion" class="form-textarea" rows="4" required>@(producto != null ? (string)producto.Descripcion : "")</textarea>
            </div>

            <!-- Talla -->
            <div class="form-group">
                <label for="Talla" class="form-label">Talla</label>
                <input type="text" name="talla" id="Talla" class="form-input"
                       placeholder="Ej. S, M, L, 38, XL…" required value="@(producto != null ? (string)producto.Talla : "")" />
            </div>

            <!-- Color -->
            <div class="form-group">
                <label for="Color" class="form-label">Color</label>
                <input type="text" name="color" id="Color" class="form-input"
                       placeholder="Color del producto" required value="@(producto != null ? (string)producto.Color : "")" />
            </div>

            <!-- Marca -->
            <div class="form-group">
                <label for="Marca" class="form-label">Marca</label>
                <input type="text" name="marca" id="Marca" class="form-input"
                       placeholder="Marca del producto" required value="@(producto != null ? (string)producto.Marca : "")" />
            </div>

            <!-- Precio Compra -->
            <div class="form-group">
                <label for="PrecioCompra" class="form-label">Precio de Compra</label>
                <input type="number" name="precioCompra" id="PrecioCompra" class="form-input"
                       placeholder="0.00" step="0.01" min="0" inputmode="decimal" data-decimal="true"
                       value="@(producto != null ? ((decimal)producto.PrecioCompra).ToString("0.##", CultureInfo.InvariantCulture) : "")" />
            </div>

            <!-- Precio Venta -->
            <div class="form-group">
                <label for="PrecioVenta" class="form-label">Precio de Venta</label>
                <input type="number" name="precioVenta" id="PrecioVenta" class="form-input"
                       placeholder="0.00" step="0.01" min="0" inputmode="decimal" data-decimal="true"
                       value="@(producto != null ? ((decimal)producto.PrecioVenta).ToString("0.##", CultureInfo.InvariantCulture) : "")" />
            </div>

            <!-- Categoría -->
            <div class="form-group">
                <label for="Categoria" class="form-label">Categoría</label>
                <select name="categoriaID" id="Categoria" class="form-select" required>
                    <option value="">Seleccione una categoría</option>
                    @if (ViewBag.Categorias != null)
                    {
                        foreach (var c in ViewBag.Categorias)
                        {
                            <option value="@c.CategoriaID"
                                    selected="@( (ViewBag.Producto != null && ViewBag.Producto.CategoriaID == c.CategoriaID) ? "selected" : null )">
                                @c.Nombre
                            </option>
                        }
                    }
                </select>
            </div>

            <!-- Subcategoría -->
            <div class="form-group">
                <label for="Subcategoria" class="form-label">Subcategoría</label>
                <select name="subcategoriaID" id="Subcategoria" class="form-select" required>
                    <option value="">Seleccione una subcategoría</option>
                    @if (ViewBag.Producto != null && ViewBag.Subcategorias != null)
                    {
                        foreach (var s in ViewBag.Subcategorias)
                        {
                            if (s.CategoriaID == ViewBag.Producto.CategoriaID)
                            {
                                <option value="@s.SubcategoriaID"
                                        selected="@( (ViewBag.Producto.SubcategoriaID == s.SubcategoriaID) ? "selected" : null )">
                                    @s.NombreSubcategoria
                                </option>
                            }
                        }
                    }
                </select>
            </div>

            <!-- Proveedor -->
            <div class="form-group">
                <label for="Proveedor" class="form-label">Proveedor</label>
                <select name="proveedorID" id="Proveedor" class="form-select" required>
                    <option value="">Seleccione un proveedor</option>
                    @if (ViewBag.Proveedores != null)
                    {
                        foreach (var p in ViewBag.Proveedores)
                        {
                            <option value="@p.ProveedorID"
                                    selected="@( (ViewBag.Producto != null && ViewBag.Producto.ProveedorID == p.ProveedorID) ? "selected" : null )">
                                @p.NombreProveedor
                            </option>
                        }
                    }
                </select>
            </div>


            <!-- Stock -->
            <div class="form-group">
                <label for="Stock" class="form-label">Stock</label>
                <input type="number" name="stock" id="Stock" class="form-input" min="0" step="1"
                       placeholder="0" value="@(producto != null ? ((int)producto.Stock).ToString(CultureInfo.InvariantCulture) : "")" />
            </div>

            <!-- Imagen -->
            <div class="form-group full">
                <label class="form-label">Imagen del Producto</label>
                <div class="image-upload">
                    @if (producto != null && !string.IsNullOrEmpty((string)producto.ImagenPath))
                    {
                        <img src="@producto.ImagenPath" alt="Imagen actual" class="image-preview" id="imagePreview" />
                        <input type="hidden" name="existingImagenPath" value="@producto.ImagenPath" />
                    }
                    else
                    {
                        <div class="no-image" id="imagePreview">No hay imagen seleccionada</div>
                    }

                    <input type="file" name="imagen" id="Imagen" class="file-input" accept="image/*">
                    <label for="Imagen" class="file-label"><i class="fas fa-camera"></i> @(producto!=null?"Cambiar imagen":"Seleccionar imagen")</label>
                    <small class="error-msg" id="error-msg">El archivo debe ser menor o igual a 2MB.</small>
                </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="submit-btn">
                <i class="fas @(producto!=null?"fa-save":"fa-plus") me-2"></i>
                @(producto!=null?"Guardar Cambios":"Añadir Producto")
            </button>
        </form>
    </div>
</div>

@section Scripts{
<script>
// ---------- Subcategorías dinámicas ----------
document.addEventListener('DOMContentLoaded', () => {
    const categoria = document.getElementById('Categoria');
    const subcategoria = document.getElementById('Subcategoria');

    const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Subcategorias ?? new object[0]));
    const currentSubId = @((producto!=null ? (int)producto.SubcategoriaID : 0));

    function get(obj, ...keys){ for(const k of keys){ if(obj && k in obj) return obj[k]; } return undefined; }

    function renderSubs(catId){
        subcategoria.innerHTML = '<option value="">Seleccione una subcategoría</option>';
        const list = (data || []).filter(s => (get(s,'CategoriaID','categoriaID')) == catId);
        if(list.length===0){
            const opt=document.createElement('option');opt.value='';opt.textContent='No hay subcategorías disponibles';subcategoria.appendChild(opt);subcategoria.disabled=true;return;
        }
        list.forEach(s=>{
            const id = get(s,'SubcategoriaID','subcategoriaID');
            const name = get(s,'NombreSubcategoria','nombreSubcategoria');
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            if (currentSubId && id === currentSubId) opt.selected = true;
            subcategoria.appendChild(opt);
        });
        subcategoria.disabled=false;
    }

    if (categoria && categoria.value) renderSubs(parseInt(categoria.value,10));
    categoria?.addEventListener('change', e => {
        renderSubs(parseInt(e.target.value || '0',10));
    });
});

// ---------- Previsualización imagen + validación 2MB ----------
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('Imagen');
    const error = document.getElementById('error-msg');
    const MAX = 2 * 1024 * 1024;

    input?.addEventListener('change', function(){
        const file = this.files?.[0];
        if(!file) return;
        error.style.display = 'none';
        if(file.size > MAX){
            error.style.display = 'block'; this.value=''; return;
        }
        const reader = new FileReader();
        reader.onload = e=>{
            const prev = document.getElementById('imagePreview');
            if(prev.tagName === 'IMG') prev.src = e.target.result;
            else{
                const img = document.createElement('img');
                img.src = e.target.result; img.className='image-preview'; img.id='imagePreview';
                prev.replaceWith(img);
            }
        };
        reader.readAsDataURL(file);
    });
});

// ---------- Normalización de decimales (evita 10 -> 1000) ----------
document.getElementById('productoForm')?.addEventListener('submit', () => {
    document.querySelectorAll('input[type="number"][data-decimal="true"]').forEach(i=>{
        if(i.value) i.value = i.value.replace(',', '.'); // estandariza al formato que espera el servidor
    });
});
</script>
}
