@using Microsoft.AspNetCore.Mvc.Rendering
@model Simone.Models.Producto
@{
    // Modelo o ViewBag.Producto (al editar)
    var producto = Model ?? (ViewBag.Producto as Simone.Models.Producto);

    var categorias = ViewBag.Categorias as List<Simone.Models.Categorias> ?? new();
    var proveedores = ViewBag.Proveedores as List<Simone.Models.Proveedores> ?? new();
    var subcategorias = ViewBag.Subcategorias as List<Simone.Models.Subcategorias> ?? new();

    var variantes = ViewBag.Variantes as List<Simone.Models.ProductoVariante> ?? new();
    var galeria = ViewBag.Galeria as List<string> ?? new();
    var portada = ViewBag.Portada as string;

    bool isEdit = (producto?.ProductoID ?? 0) > 0;
    bool usarVariantes = (producto?.TieneVariantes ?? false) || variantes.Any();
    ViewData["Title"] = isEdit ? "Editar Producto" : "Añadir Producto";

    // Subcats filtradas para la categoría elegida (útil al abrir en "Editar")
    var subcatsForSelectedCat = (producto?.CategoriaID > 0)
        ? subcategorias.Where(s => s.CategoriaID == producto.CategoriaID).ToList()
        : new List<Simone.Models.Subcategorias>();
}

<div class="container-fluid">
    <h2 class="mb-3">@ViewData["Title"]</h2>

    <form asp-action="@(isEdit ? "EditarProducto" : "AnadirProducto")"
          method="post" enctype="multipart/form-data" id="producto-form">
        @Html.AntiForgeryToken()

        @if (isEdit)
        {
            <input type="hidden" name="productoID" value="@producto!.ProductoID" />
        }

        <div class="row">
            <div class="col-md-8">
                <!-- Información Básica -->
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0">Información Básica</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" for="nombreProducto">Nombre del Producto *</label>
                            <input class="form-control" id="nombreProducto" name="nombreProducto"
                                   value="@producto?.Nombre" required maxlength="160">
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="descripcion">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3">@producto?.Descripcion</textarea>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label" for="marca">Marca</label>
                                <input class="form-control" id="marca" name="marca" value="@producto?.Marca" maxlength="80">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="precioCompra">Precio de Compra *</label>
                                <input type="number" inputmode="decimal" step="0.01" min="0"
                                       class="form-control" id="precioCompra" name="precioCompra"
                                       value="@(producto?.PrecioCompra.ToString(System.Globalization.CultureInfo.InvariantCulture))" required>
                            </div>
                            <div class="col-md-4" id="wrap-precio-venta" style="@(usarVariantes ? "display:none" : "")">
                                <label class="form-label" for="precioVenta">Precio de Venta *</label>
                                <input type="number" inputmode="decimal" step="0.01" min="0"
                                       class="form-control" id="precioVenta" name="precioVenta"
                                       value="@(producto?.PrecioVenta.ToString(System.Globalization.CultureInfo.InvariantCulture))"
                                       @(usarVariantes ? "disabled" : "required")>
                            </div>
                        </div>

                        <!-- Toggle variantes -->
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="UsarVariantes" @(usarVariantes ? "checked" : null)>
                            <label class="form-check-label" for="UsarVariantes">Gestionar por variantes (Color/Talla)</label>
                            <small class="text-muted d-block">Si activas variantes, el precio/stock se toma por variante y el producto base no requiere talla/color.</small>
                        </div>

                        <!-- Campos de producto simple -->
                        <div class="row g-3 mt-2" id="wrap-simple" style="@(usarVariantes ? "display:none" : "")">
                            <div class="col-md-4">
                                <label class="form-label" for="talla">Talla</label>
                                <input class="form-control" id="talla" name="talla" value="@producto?.Talla" @(usarVariantes ? "disabled" : null)>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="color">Color</label>
                                <input class="form-control" id="color" name="color" value="@producto?.Color" @(usarVariantes ? "disabled" : null)>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label" for="stock">Stock *</label>
                                <input type="number" min="0" class="form-control" id="stock" name="stock"
                                       value="@(producto?.Stock ?? 0)" @(usarVariantes ? "disabled" : "required")>
                            </div>
                        </div>

                        <!-- Variantes -->
                        <div id="variantes-container" class="card mt-3" style="@(usarVariantes ? "" : "display:none")">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Variantes</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-agregar-variante">Agregar variante</button>
                            </div>
                            <div class="card-body">
                                <div id="variantes-list">
                                    @if (variantes.Any())
                                    {
                                        foreach (var v in variantes)
                                        {
                                            <div class="variante-item card mb-3">
                                                <div class="card-body">
                                                    <div class="row g-2">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Color *</label>
                                                            <input class="form-control" name="VarColor" value="@v.Color" required>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Talla *</label>
                                                            <input class="form-control" name="VarTalla" value="@v.Talla" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label">Precio Venta *</label>
                                                            <input type="number"
                                                                   inputmode="decimal"
                                                                   step="0.01"
                                                                   min="0"
                                                                   class="form-control"
                                                                   name="VarPrecioVenta"
                                                                   value="@((producto?.PrecioVenta)?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")"
                                                                   required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label">Stock *</label>
                                                            <input type="number" min="0" class="form-control" name="VarStock" value="@v.Stock" required>
                                                        </div>
                                                        <div class="col-md-2 d-flex align-items-end">
                                                            <button type="button" class="btn btn-outline-danger w-100 btn-quitar-variante">Quitar</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                                <small class="text-muted">Evita duplicados de combinación Color/Talla. El sistema valida y no permite precios ≤ precio de compra.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imágenes -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="card-title mb-0">Imágenes (máx. 8)</h5>
                        <small class="text-muted"><span id="img-count">@galeria.Count</span>/8</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" for="Imagenes">Subir Imágenes</label>
                            <input type="file" class="form-control" id="Imagenes" name="Imagenes" multiple accept="image/*">
                            <small class="text-muted">Puedes seleccionar varias imágenes.</small>
                        </div>

                        <div id="imagenes-preview" class="row">
                            @if (galeria.Any())
                            {
                                for (int i = 0; i < galeria.Count; i++)
                                {
                                    <div class="col-md-3 mb-3 imagen-preview-item" data-url="@galeria[i]" data-is-new="0">
                                        <div class="card">
                                            <img src="@galeria[i]" class="card-img-top" style="height:150px;object-fit:cover;">
                                            <div class="card-body p-2 d-flex flex-column gap-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                           name="existingImagenPath" value="@galeria[i]"
                                                           @(string.Equals(portada, galeria[i], System.StringComparison.OrdinalIgnoreCase) ? "checked" : null)>
                                                    <label class="form-check-label">Principal</label>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-danger btn-eliminar-imagen">Eliminar</button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- LADO DERECHO -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0">Categorías y Proveedor</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" for="categoriaID">Categoría *</label>
                            <select class="form-control" id="categoriaID" name="categoriaID" asp-for="CategoriaID"
                                    asp-items="@(new SelectList(categorias, "CategoriaID", "Nombre", producto?.CategoriaID))" required>
                                <option value="">Seleccione una categoría</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="subcategoriaID">Subcategoría *</label>
                            <select class="form-control" id="subcategoriaID" name="subcategoriaID" data-selected="@producto?.SubcategoriaID" required
                                    asp-items="@(new SelectList(subcatsForSelectedCat, "SubcategoriaID", "NombreSubcategoria", producto?.SubcategoriaID))">
                                <option value="">Seleccione una subcategoría</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="proveedorID">Proveedor *</label>
                            <select class="form-control" id="proveedorID" name="proveedorID" asp-for="ProveedorID"
                                    asp-items="@(new SelectList(proveedores, "ProveedorID", "NombreProveedor", producto?.ProveedorID))" required>
                                <option value="">Seleccione un proveedor</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Guardar Producto</button>
            <a asp-action="Productos" class="btn btn-secondary">Cancelar</a>
        </div>

        <input type="hidden" name="ImagenesIgnore" id="ImagenesIgnore" value="[]" />
        <!-- Para nuevas imágenes como portada (índice relativo a NUEVAS) -->
        <input type="hidden" name="ImagenPrincipalIndex" id="ImagenPrincipalIndex" value="-1" />
    </form>
</div>

@section Scripts {
    <script>
        (function () {
            // ===== Variantes ON/OFF =====
            function toggleVariantesUI(on) {
                if (on) {
                    $('#variantes-container').show();
                    $('#wrap-precio-venta, #wrap-simple').hide();
                    $('#precioVenta, #stock, #talla, #color').prop('disabled', true).prop('required', false);
                } else {
                    $('#variantes-container').hide();
                    $('#wrap-precio-venta, #wrap-simple').show();
                    $('#precioVenta, #stock').prop('disabled', false).prop('required', true);
                    $('#talla, #color').prop('disabled', false);
                }
            }
            $('#UsarVariantes').on('change', function () {
                toggleVariantesUI($(this).is(':checked'));
            });
            toggleVariantesUI($('#UsarVariantes').is(':checked'));

            // ===== Agregar / quitar variante =====
            $('#btn-agregar-variante').on('click', function () {
                const tpl = `
                <div class="variante-item card mb-3">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label">Color *</label>
                                <input class="form-control" name="VarColor" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Talla *</label>
                                <input class="form-control" name="VarTalla" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Precio Venta *</label>
                                <input type="number" inputmode="decimal" step="0.01" min="0" class="form-control" name="VarPrecioVenta" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Stock *</label>
                                <input type="number" min="0" class="form-control" name="VarStock" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-danger w-100 btn-quitar-variante">Quitar</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                $('#variantes-list').append(tpl);
            });
            $(document).on('click', '.btn-quitar-variante', function () {
                $(this).closest('.variante-item').remove();
            });

            // ===== Imágenes =====
            let imagenesIgnore = [];                 // URLs existentes a eliminar
            const $imagenesInput = $('#Imagenes');
            const fileMap = new Map();              // uid -> File (mantiene orden de inserción)
            let uidSeq = 0;

            function updateFileInputFromMap() {
                const dt = new DataTransfer();
                for (const f of fileMap.values()) dt.items.add(f);
                $imagenesInput[0].files = dt.files;
            }

            function updateImgCount() {
                const count = $('#imagenes-preview .imagen-preview-item').length;
                $('#img-count').text(count);
            }

            function reindexNewImageRadios() {
                const $newItems = $('#imagenes-preview .imagen-preview-item[data-is-new="1"]');
                $newItems.each(function (idx) {
                    $(this).find('input[type=radio][name=ImagenPrincipalIndex]').val(idx);
                });
                // Si no hay nueva seleccionada, y ninguna existente marcada, poner -1
                if ($('input[name="ImagenPrincipalIndex"]:checked').length === 0 &&
                    $('input[name="existingImagenPath"]:checked').length === 0) {
                    $('#ImagenPrincipalIndex').val(-1);
                }
            }

            // Carga nuevas imágenes
            $imagenesInput.on('change', function () {
                const files = Array.from(this.files || []);
                const $preview = $('#imagenes-preview');
                const current = $preview.children().length;

                if (current + files.length > 8) {
                    alert('No puede exceder 8 imágenes.');
                    // Restaurar a los que ya estaban en el Map (sin los recién seleccionados)
                    updateFileInputFromMap();
                    return;
                }

                files.forEach((file) => {
                    // Si ya está (mismo objeto), sáltalo
                    if ([...fileMap.values()].includes(file)) return;

                    const uid = 'f' + (++uidSeq);
                    fileMap.set(uid, file);

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const card = `
                        <div class="col-md-3 mb-3 imagen-preview-item" data-is-new="1" data-uid="${uid}">
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" style="height:150px;object-fit:cover;">
                                <div class="card-body p-2 d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="ImagenPrincipalIndex" value="0">
                                        <label class="form-check-label">Principal</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-imagen">Eliminar</button>
                                </div>
                            </div>
                        </div>`;
                        $preview.append(card);
                        reindexNewImageRadios();
                        updateImgCount();
                    };
                    reader.readAsDataURL(file);
                });

                // Refrescar input real a partir del Map (para poder eliminar antes de enviar)
                updateFileInputFromMap();
            });

            // Elegir principal nueva
            $(document).on('change', 'input[name="ImagenPrincipalIndex"]', function () {
                // Nada que hacer: el value ya está reindexado por DOM
            });

            // Elegir principal existente
            $(document).on('change', 'input[name="existingImagenPath"]', function () {
                // Desmarcar selección de nuevas (para evitar ambigüedad visual)
                $('input[name="ImagenPrincipalIndex"]').prop('checked', false);
                $('#ImagenPrincipalIndex').val(-1);
            });

            // Eliminar imagen (nueva o existente)
            $(document).on('click', '.btn-eliminar-imagen', function () {
                const $item = $(this).closest('.imagen-preview-item');
                const isNew = $item.attr('data-is-new') === '1';
                const url = $item.attr('data-url');

                if (isNew) {
                    const uid = $item.attr('data-uid');
                    if (uid && fileMap.has(uid)) {
                        fileMap.delete(uid);
                        updateFileInputFromMap();
                    }
                } else if (url) {
                    // Existe en servidor -> agregar a ignore
                    imagenesIgnore.push(url);
                    $('#ImagenesIgnore').val(JSON.stringify(imagenesIgnore));
                }

                // Si era portada, limpiar radios
                if ($item.find('input[type=radio]:checked').length) {
                    $('input[name="ImagenPrincipalIndex"]').prop('checked', false);
                    $('input[name="existingImagenPath"]').prop('checked', false);
                    $('#ImagenPrincipalIndex').val(-1);
                }

                $item.remove();
                reindexNewImageRadios();
                updateImgCount();
            });

            // ===== Subcategorías por categoría (AJAX) =====
            function fillSubcats(catId, selected) {
                const $sub = $('#subcategoriaID');
                $sub.empty().append('<option value="">Seleccione una subcategoría</option>');
                if (!catId) return;

                $.get('@Url.Action("GetSubcategoriasByCategoria", "Panel")', { categoriaID: catId }, function (data) {
                    $.each(data, function (_, item) {
                        const $opt = $('<option/>', { value: item.value, text: item.text });
                        if (selected && String(item.value) === String(selected)) $opt.attr('selected', 'selected');
                        $sub.append($opt);
                    });
                });
            }
            $('#categoriaID').on('change', function () {
                fillSubcats($(this).val(), null);
            });
            // Si abrimos en edición y el select de subcats está vacío, cargarlo
            (function initSubcatsOnLoad() {
                const catVal = $('#categoriaID').val();
                const selected = $('#subcategoriaID').data('selected');
                if (catVal && $('#subcategoriaID option').length <= 1) {
                    fillSubcats(catVal, selected);
                }
            })();
        })();
    </script>
}
