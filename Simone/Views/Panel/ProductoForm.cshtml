<div class="ui container mt-5">
    <div class="ui segment">
        @if (ViewBag.Producto != null)
        {
            <h2 class="ui header">
                <i class="box icon"></i>
                <div class="content">Editar Producto</div>
            </h2>
            <form class="ui form" method="post" asp-controller="Panel" asp-action="EditarProducto"
                enctype="multipart/form-data">

                <!-- ID -->
                <input type="hidden" name="productoID" value="@ViewBag.Producto.ProductoID" />

                <!-- Nombre -->
                <div class="field">
                    <label for="Nombre">Nombre</label>
                    <input type="text" name="nombreProducto" id="Nombre" placeholder="Nombre del producto" required
                        value="@ViewBag.Producto.Nombre" />
                </div>

                <!-- Descripcion -->
                <div class="field">
                    <label for="Descripcion">Descripción</label>
                    <textarea name="descripcion" id="Descripcion" placeholder="Descripción del producto" rows="3" required>
                    @ViewBag.Producto.Descripcion
                    </textarea>
                </div>

                <!-- Talla -->
                <div class="field">
                    <label for="Talla">Talla</label>
                    <input type="text" name="talla" id="Talla" placeholder="Tamaño del producto" required
                        value="@ViewBag.Producto.Talla" />
                </div>

                <!-- Color -->
                <div class="field">
                    <label for="Color">Color</label>
                    <input type="text" name="color" id="Color" placeholder="Color del producto" required
                        value="@ViewBag.Producto.Color" />
                </div>

                <!-- Marca -->
                <div class="field">
                    <label for="Marca">Marca</label>
                    <input type="text" name="marca" id="Marca" placeholder="Marca del producto" required
                        value="@ViewBag.Producto.Marca" />
                </div>

                <!-- PrecioCompra -->
                <div class="field">
                    <label for="PrecioCompra">Precio de Compra</label>
                    <input type="text" name="precioCompra" id="PrecioCompra" placeholder="Precio de compra"
                        value="@ViewBag.Producto.PrecioCompra" step="0.01" required />
                </div>

                <!-- PrecioVenta -->
                <div class="field">
                    <label for="PrecioVenta">Precio de Venta</label>
                    <input type="text" name="precioVenta" id="PrecioVenta" placeholder="Precio de venta" required
                        value="@ViewBag.Producto.PrecioVenta" step="0.01" />
                </div>

                <!-- Categoria -->
                <div class="field">
                    @if (ViewBag.Categorias.Count > 0)
                    {
                        <label for="Categoria">Categoría</label>
                        <select name="categoriaID" id="Categoria" class="ui dropdown" required>
                            <option value="">Seleccione una categoría</option>
                            @foreach (var categoria in ViewBag.Categorias)
                            {
                                <option value="@categoria.CategoriaID">@categoria.Nombre</option>
                            }
                        </select>
                    }
                    else
                    {
                        <select name="categoria" id="Categoria" class="ui dropdown" disabled required>
                            <option value="">No hay categorias disponibles</option>
                        </select>
                    }
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var selectedCategoryID = '@ViewBag.Producto.CategoriaID';
                        var dropdown = document.getElementById("Categoria");
                        var options = dropdown.querySelectorAll('option');
                        options.forEach(function (option) {
                            if (option.getAttribute('value') === selectedCategoryID) {
                                option.selected = true;
                            }
                        });
                    });
                </script>

                <!-- Subcategoria -->
                <div class="field">
                    <label for="Subcategoria">Subcategoría</label>
                    <select name="subcategoriaID" id="Subcategoria" class="ui dropdown" required>
                        <option value="">Seleccione una subcategoria</option>
                        @foreach (var subcategoria in ViewBag.Subcategorias)
                        {
                            if (subcategoria.CategoriaID == ViewBag.Producto.CategoriaID)
                            {
                                <option value="@subcategoria.SubcategoriaID">@subcategoria.NombreSubcategoria</option>
                            }

                        }
                    </select>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var selectedSubCategoryID = '@ViewBag.Producto.SubcategoriaID';
                        var dropdown = document.getElementById("Subcategoria");
                        var options = dropdown.querySelectorAll('option');
                        options.forEach(function (option) {
                            if (option.getAttribute('value') === selectedSubCategoryID) {
                                option.selected = true;
                            }
                        });
                    });
                </script>

                <!-- Proveedor -->
                <div class="field">
                    @if (ViewBag.Proveedores.Count > 0)
                    {
                        <label for="Proveedor">Proveedor</label>
                        <select name="proveedorID" id="Proveedor" class="ui dropdown" required>
                            <option value="">Seleccione un proveedor</option>
                            @foreach (var proveedor in ViewBag.Proveedores)
                            {
                                <option value="@proveedor.ProveedorID">@proveedor.NombreProveedor</option>
                            }
                        </select>
                    }
                    else
                    {
                        <select name="proveedorID" id="Proveedor" class="ui dropdown" disabled required>
                            <option value="">No hay proveedores disponibles</option>
                        </select>
                    }
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var selectedProveedorID = '@ViewBag.Producto.ProveedorID';
                        var dropdown = document.getElementById("Proveedor");
                        var options = dropdown.querySelectorAll('option');
                        options.forEach(function (option) {
                            if (option.getAttribute('value') === selectedProveedorID) {
                                option.selected = true;
                            }
                        });
                    });
                </script>

                <!-- Stock -->
                <div class="field">
                    <label for="Stock">Stock</label>
                    <input type="number" name="stock" id="Stock" placeholder="Cantidad en stock" required
                        value="@ViewBag.Producto.Stock" />
                </div>

                <div class="field">
                    <label for="Imagen">Imagen del Producto</label>

                    <!-- Show existing image preview -->
                    @if (!string.IsNullOrEmpty(ViewBag.Producto?.ImagenPath))
                    {
                        <div>
                            <img src="@ViewBag.Producto.ImagenPath" alt="Imagen actual"
                                style="max-height: 150px; display: block; margin-bottom: 10px;" />
                        </div>
                    }

                    <input type="file" name="imagen" id="Imagen" accept="image/*" />
                    <small id="error-msg" style="color: red; display: none;">
                        El archivo debe ser menor o igual a 2MB.
                    </small>

                    <!-- Hidden input to hold current image path -->
                    <input type="hidden" name="existingImagenPath" value="@ViewBag.Producto?.ImagenPath" />
                </div>

                <script>
                    const inputFile = document.getElementById('Imagen');
                    const errorMsg = document.getElementById('error-msg');
                    const maxSizeMB = 2;
                    const maxSizeBytes = maxSizeMB * 1024 * 1024;

                    inputFile.addEventListener('change', () => {
                        errorMsg.style.display = 'none';
                        const file = inputFile.files[0];
                        if (file && file.size > maxSizeBytes) {
                            errorMsg.style.display = 'inline';
                            inputFile.value = ''; // Reset the input
                            alert(`El archivo es demasiado grande. El tamaño máximo permitido es ${maxSizeMB}MB.`);
                        }
                    });
                </script>


                <!-- Submit Button -->
                <button type="submit" class="ui blue button">Editar Producto</button>
            </form>
        }
        else
        {
            <h2 class="ui header">
                <i class="box icon"></i>
                <div class="content">Añadir Producto</div>
            </h2>
            <form class="ui form" method="post" asp-controller="Panel" asp-action="AnadirProducto"
                enctype="multipart/form-data">

                <!-- Nombre -->
                <div class="field">
                    <label for="Nombre">Nombre</label>
                    <input type="text" name="nombreProducto" id="Nombre" placeholder="Nombre del producto" required />
                </div>

                <!-- Descripcion -->
                <div class="field">
                    <label for="Descripcion">Descripción</label>
                    <textarea name="descripcion" id="Descripcion" placeholder="Descripción del producto" rows="3"
                    required></textarea>
                </div>

                <!-- Talla -->
                <div class="field">
                    <label for="Talla">Talla</label>
                    <input type="text" name="talla" id="Talla" placeholder="Tamaño del producto" required />
                </div>

                <!-- Color -->
                <div class="field">
                    <label for="Color">Color</label>
                    <input type="text" name="color" id="Color" placeholder="Color del producto" required />
                </div>

                <!-- Marca -->
                <div class="field">
                    <label for="Marca">Marca</label>
                    <input type="text" name="marca" id="Marca" placeholder="Marca del producto" required />
                </div>

                <!-- PrecioCompra -->
                <div class="field">
                    <label for="PrecioCompra">Precio de Compra</label>
                    <input type="text" name="precioCompra" id="PrecioCompra" placeholder="Precio de compra" step="0.01"
                        required />
                </div>

                <!-- PrecioVenta -->
                <div class="field">
                    <label for="PrecioVenta">Precio de Venta</label>
                    <input type="text" name="precioVenta" id="PrecioVenta" placeholder="Precio de venta" step="0.01"
                        required />
                </div>

                <!-- Categoria -->
                <div class="field">
                    @if (ViewBag.Categorias.Count > 0)
                    {
                        <label for="Categoria">Categoría</label>
                        <select name="categoriaID" id="Categoria" class="ui dropdown" required>
                            <option value="">Seleccione una categoría</option>
                            @foreach (var categoria in ViewBag.Categorias)
                            {
                                <option value="@categoria.CategoriaID">@categoria.Nombre</option>
                            }
                        </select>
                    }
                    else
                    {
                        <select name="categoriaID" id="Categoria" class="ui dropdown" disabled required>
                            <option value="">No hay categorías disponibles</option>
                        </select>
                    }
                </div>

                <!-- Subcategoria -->
                <div class="field">
                    <label for="Subcategoria">Subcategoría</label>
                    <select name="subcategoriaID" id="Subcategoria" class="ui dropdown" required>
                        <option value="">Seleccione una subcategoria</option>
                    </select>
                </div>

                <!-- Proveedor -->
                <div class="field">
                    @if (ViewBag.Proveedores.Count > 0)
                    {
                        <label for="Proveedor">Proveedor</label>
                        <select name="proveedorID" id="Proveedor" class="ui dropdown" required>
                            <option value="">Seleccione un proveedor</option>
                            @foreach (var proveedor in ViewBag.Proveedores)
                            {
                                <option value="@proveedor.ProveedorID">@proveedor.NombreProveedor</option>
                            }
                        </select>
                    }
                    else
                    {
                        <select name="proveedorID" id="Proveedor" class="ui dropdown" disabled required>
                            <option value="">No hay proveedores disponibles</option>
                        </select>
                    }
                </div>

                <!-- Stock -->
                <div class="field">
                    <label for="Stock">Stock</label>
                    <input type="number" name="stock" id="Stock" placeholder="Cantidad en stock" required />
                </div>

                <!-- Image Upload Field -->
                <div class="field">
                    <label for="Imagen">Imagen del Producto</label>
                    <input type="file" name="imagen" id="Imagen" accept="image/*" />
                    <small id="error-msg" style="color: red; display: none;">El archivo debe ser menor o igual a
                        2MB.</small>
                </div>

                <script>
                    const inputFile = document.getElementById('Imagen');
                    const errorMsg = document.getElementById('error-msg');
                    const maxSizeMB = 2;
                    const maxSizeBytes = maxSizeMB * 1024 * 1024;

                    inputFile.addEventListener('change', () => {
                        errorMsg.style.display = 'none';
                        const file = inputFile.files[0];
                        if (file && file.size > maxSizeBytes) {
                            errorMsg.style.display = 'inline';
                            inputFile.value = ''; // Reset the input
                            alert(`El archivo es demasiado grande. El tamaño máximo permitido es ${maxSizeMB}MB.`);
                        }
                    });
                </script>

                <!-- Submit Button -->
                <button type="submit" class="ui green button">Añadir Producto</button>


            </form>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Ensure subcategorias is always an array, even if ViewBag.Subcategorias is null or empty
            const subcategorias = @Json.Serialize(ViewBag.Subcategorias); // Correct way to embed subcategorias as a JS object

            const categoriaDropdown = document.getElementById("Categoria");
            const subcategoriaDropdown = document.getElementById("Subcategoria");

            // Function to filter subcategories based on the selected category
            function filterSubcategoriasByCategoria(categoriaID) {
                // Filter subcategories by CategoriaID
                const filteredSubcategorias = subcategorias.filter(subcategoria => subcategoria.categoriaID == Number(categoriaID));

                // Clear the current options in Subcategoria dropdown
                subcategoriaDropdown.innerHTML = '<option value="">Seleccione una subcategoría</option>';

                // Add filtered subcategories to Subcategoria dropdown
                filteredSubcategorias.forEach(subcategoria => {
                    const option = document.createElement("option");
                    option.value = subcategoria.subcategoriaID;
                    option.textContent = subcategoria.nombreSubcategoria;
                    subcategoriaDropdown.appendChild(option);
                });

                // Enable the Subcategoria dropdown if there are options, or disable it if no options are available
                subcategoriaDropdown.disabled = filteredSubcategorias.length === 0;
            }

            // When Categoria changes, filter the subcategories
            if (categoriaDropdown && subcategoriaDropdown) {
                categoriaDropdown.addEventListener("change", function () {
                    const selectedCategoriaID = this.value;

                    // Only filter if a valid category is selected
                    if (selectedCategoriaID) {
                        filterSubcategoriasByCategoria(selectedCategoriaID);
                    } else {
                        // Reset the subcategory dropdown when no category is selected
                        subcategoriaDropdown.innerHTML = '<option value="">Seleccione una subcategoría</option>';
                        subcategoriaDropdown.disabled = true;
                    }
                });
            }
        });

        function validatePriceInput(event) {
            const input = event.target;

            const validNumberPattern = /^\d+(,\d+)?$/;

            if (!validNumberPattern.test(input.value)) {
                event.preventDefault();
                alert(`Por favor, ingrese un número válido para el precio.`);
                input.value = "";
            }
        }

        document.getElementById("PrecioCompra").addEventListener("change", validatePriceInput);
        document.getElementById("PrecioVenta").addEventListener("change", validatePriceInput);


    </script>

}