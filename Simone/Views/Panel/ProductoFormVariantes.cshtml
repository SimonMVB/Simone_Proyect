@using Microsoft.AspNetCore.Mvc.Rendering
@model Simone.Models.Producto
@{
    var producto = Model ?? (ViewBag.Producto as Simone.Models.Producto);
    var categorias = ViewBag.Categorias as List<Simone.Models.Categorias> ?? new();
    var proveedores = ViewBag.Proveedores as List<Simone.Models.Proveedores> ?? new();
    var subcategorias = ViewBag.Subcategorias as List<Simone.Models.Subcategorias> ?? new();
    var variantes = ViewBag.Variantes as List<Simone.Models.ProductoVariante> ?? new();

    var galeria = ViewBag.Galeria as List<string> ?? new();
    var portada = ViewBag.Portada as string;

    bool isEdit = (producto?.ProductoID ?? 0) > 0;
    ViewData["Title"] = isEdit ? "Editar Producto (Variantes)" : "Añadir Producto (Variantes)";

    var subcatsForSelectedCat = (producto?.CategoriaID > 0)
        ? subcategorias.Where(s => s.CategoriaID == producto.CategoriaID).ToList()
        : new List<Simone.Models.Subcategorias>();

    // Formateo local (coma) para inputs de texto
    string FormatPrice(decimal? price)
    {
        var culture = new System.Globalization.CultureInfo("es-EC");
        return price.HasValue ? price.Value.ToString("0.##", culture) : "";
    }
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">@ViewData["Title"]</h2>
        <a asp-action="Productos" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>

    <form asp-action="@(isEdit ? "EditarProducto" : "AnadirProducto")"
          method="post" enctype="multipart/form-data" id="producto-form">
        @Html.AntiForgeryToken()

        @if (isEdit)
        {
            <input type="hidden" name="productoID" value="@producto!.ProductoID" />
        }

        <div class="row">
            <!-- COLUMNA IZQUIERDA -->
            <div class="col-lg-8">
                <!-- Información Básica -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Información Básica
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-semibold" for="nombreProducto">Nombre del Producto *</label>
                            <input class="form-control form-control-lg" id="nombreProducto" name="nombreProducto"
                                   value="@producto?.Nombre" required maxlength="160"
                                   placeholder="Ingrese el nombre del producto">
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold" for="descripcion">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="4"
                                      placeholder="Describa las características del producto">@producto?.Descripcion</textarea>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold" for="marca">Marca</label>
                                <input class="form-control" id="marca" name="marca" value="@producto?.Marca" maxlength="80"
                                       placeholder="Marca del producto">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold" for="precioCompra">Precio de Compra *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" inputmode="decimal" pattern="^\d+([,\.]\d{1,2})?$"
                                           class="form-control decimal-input" id="precioCompra" name="precioCompra"
                                           value="@FormatPrice(producto?.PrecioCompra)" required
                                           placeholder="0,00">
                                </div>
                                <small class="text-muted">Puedes usar coma o punto; se guardará como <b>,</b>.</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Precio de Venta (Automático)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input class="form-control bg-light" value="Mínimo de las variantes" disabled>
                                </div>
                                <small class="text-muted">Se calculará como el precio más bajo entre las variantes.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variantes -->
                <div class="card shadow-sm mb-4" id="variantes-container">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-layer-group me-2"></i>Variantes (Color / Talla / Precio / Stock)
                        </h5>
                        <button type="button" class="btn btn-sm btn-dark" id="btn-agregar-variante">
                            <i class="fas fa-plus me-1"></i>Agregar Variante
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="variantes-list">
                            @if (variantes.Any())
                            {
                                foreach (var v in variantes.OrderBy(x => x.Color).ThenBy(x => x.Talla))
                                {
                                    <div class="variante-item card mb-3 border">
                                        <div class="card-body">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-md-3">
                                                    <label class="form-label fw-semibold">Color *</label>
                                                    <input class="form-control" name="VarColor" value="@v.Color" required
                                                           placeholder="Ej: Rojo, Azul">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label fw-semibold">Talla *</label>
                                                    <input class="form-control" name="VarTalla" value="@v.Talla" required
                                                           placeholder="Ej: S, M, L">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label fw-semibold">Precio Venta *</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="text" inputmode="decimal" pattern="^\d+([,\.]\d{1,2})?$"
                                                               class="form-control decimal-input"
                                                               name="VarPrecioVenta" value="@FormatPrice(v.PrecioVenta)" required
                                                               placeholder="0,00">
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label fw-semibold">Stock *</label>
                                                    <input type="number" min="0" class="form-control" name="VarStock"
                                                           value="@v.Stock" required placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-danger w-100 btn-quitar-variante">
                                                        <i class="fas fa-trash me-1"></i>Quitar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <div class="alert alert-info mt-3">
                            <div class="d-flex">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <small class="fw-semibold d-block">Información importante:</small>
                                    <small>
                                        • El precio del producto = <b>mínimo</b> de las variantes.<br>
                                        • El stock del producto = <b>suma</b> de stocks de variantes.<br>
                                        • Puedes tipear con <b>,</b> o <b>.</b>; se normaliza a <b>,</b> al guardar.<br>
                                        • Evita duplicados Color/Talla.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Imágenes -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-images me-2"></i>Imágenes del Producto
                        </h5>
                        <small class="text-light"><span id="img-count">@galeria.Count</span>/8 imágenes</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-semibold" for="Imagenes">Subir Imágenes</label>
                            <input type="file" class="form-control" id="Imagenes" name="Imagenes" multiple accept="image/*">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Puedes seleccionar varias imágenes. Formatos: JPG, PNG, GIF. Máximo 8 imágenes.
                            </div>
                        </div>

                        <div id="imagenes-preview" class="row g-3">
                            @if (galeria.Any())
                            {
                                for (int i = 0; i < galeria.Count; i++)
                                {
                                    <div class="col-xl-3 col-lg-4 col-md-6 mb-3 imagen-preview-item" data-url="@galeria[i]" data-is-new="0">
                                        <div class="card h-100 border">
                                            <div class="position-relative">
                                                <img src="@galeria[i]" class="card-img-top" style="height:180px;object-fit:cover;">
                                                <div class="position-absolute top-0 end-0 m-2">
                                                    <span class="badge bg-primary">Existente</span>
                                                </div>
                                            </div>
                                            <div class="card-body p-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                           name="existingImagenPath" value="@galeria[i]"
                                                           @(string.Equals(portada, galeria[i], System.StringComparison.OrdinalIgnoreCase) ? "checked" : "")>
                                                    <label class="form-check-label fw-semibold">Establecer como principal</label>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-transparent border-top-0">
                                                <button type="button" class="btn btn-sm btn-outline-danger w-100 btn-eliminar-imagen">
                                                    <i class="fas fa-trash me-1"></i>Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA -->
            <div class="col-lg-4">
                <!-- Categorías y Proveedor -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tags me-2"></i>Categorías y Proveedor
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="categoriaID">Categoría *</label>
                            <select class="form-select" id="categoriaID" name="categoriaID" asp-for="CategoriaID"
                                    asp-items="@(new SelectList(categorias, "CategoriaID", "Nombre", producto?.CategoriaID))" required>
                                <option value="">Seleccione una categoría</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="subcategoriaID">Subcategoría *</label>
                            <select class="form-select" id="subcategoriaID" name="subcategoriaID" data-selected="@producto?.SubcategoriaID" required
                                    asp-items="@(new SelectList(subcatsForSelectedCat, "SubcategoriaID", "NombreSubcategoria", producto?.SubcategoriaID))">
                                <option value="">Seleccione una subcategoría</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="proveedorID">Proveedor *</label>
                            <select class="form-select" id="proveedorID" name="proveedorID" asp-for="ProveedorID"
                                    asp-items="@(new SelectList(proveedores, "ProveedorID", "NombreProveedor", producto?.ProveedorID))" required>
                                <option value="">Seleccione un proveedor</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>Acciones
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Guardar Producto
                            </button>
                            <a asp-action="Productos" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campos ocultos para producto simple (no usados en variantes) -->
        <input type="hidden" name="talla" value="" />
        <input type="hidden" name="color" value="" />
        <input type="hidden" name="stock" value="0" />
        <input type="hidden" name="precioVenta" value="0" />

        <input type="hidden" name="ImagenesIgnore" id="ImagenesIgnore" value="[]" />
        <input type="hidden" name="ImagenPrincipalIndex" id="ImagenPrincipalIndex" value="-1" />
    </form>
</div>

@section Scripts {
    <script>
        (function () {
            // ===== Normalización a COMA para cultura ES =====
            // Acepta entradas con . o , y las convierte a coma, eliminando separadores de miles.
            function toCommaDecimal(raw) {
                if (raw == null) return "";
                let s = String(raw).trim();
                if (!s) return "";
                s = s.replace(/[^\d,\.]/g, "");            // solo dígitos y separadores
                const lastComma = s.lastIndexOf(",");
                const lastDot   = s.lastIndexOf(".");
                if (lastComma === -1 && lastDot === -1) return s; // entero

                const decSep = (lastComma > lastDot) ? "," : ".";
                if (decSep === ",") {
                    s = s.replace(/\./g, "");              // puntos como miles
                    const parts = s.split(",");
                    return parts.length > 1 ? (parts[0] + "," + parts.slice(1).join("")) : s;
                } else {
                    s = s.replace(/,/g, "");               // comas como miles
                    const parts = s.split(".");
                    return parts.length > 1 ? (parts[0] + "," + parts.slice(1).join("")) : s;
                }
            }

            function normalizeForm($form) {
                // Precio de compra
                const $pc = $form.find('#precioCompra');
                if ($pc.length) $pc.val(toCommaDecimal($pc.val()));

                // Precios de variantes
                $form.find('input[name="VarPrecioVenta"]').each(function () {
                    this.value = toCommaDecimal(this.value);
                });
            }

            // Normaliza al enviar
            $('#producto-form').on('submit', function () {
                normalizeForm($(this));
            });

            // UX: normaliza al salir de cada campo
            $(document).on("blur", '#precioCompra, input[name="VarPrecioVenta"]', function () {
                this.value = toCommaDecimal(this.value);
            });

            // ===== Variantes: agregar/quitar =====
            function varianteTpl() {
                return `
                <div class="variante-item card mb-3 border">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Color *</label>
                                <input class="form-control" name="VarColor" required placeholder="Ej: Rojo, Azul">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Talla *</label>
                                <input class="form-control" name="VarTalla" required placeholder="Ej: S, M, L">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Precio Venta *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" inputmode="decimal" pattern="^\\d+([,\\.]\\d{1,2})?$"
                                           class="form-control" name="VarPrecioVenta" required placeholder="0,00">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Stock *</label>
                                <input type="number" min="0" class="form-control" name="VarStock" required placeholder="0">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger w-100 btn-quitar-variante">
                                    <i class="fas fa-trash me-1"></i>Quitar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            if ($('#variantes-list .variante-item').length === 0) {
                $('#variantes-list').append(varianteTpl());
            }

            $('#btn-agregar-variante').on('click', function () {
                $('#variantes-list').append(varianteTpl());
            });

            $(document).on('click', '.btn-quitar-variante', function () {
                $(this).closest('.variante-item').remove();
            });

            // ===== Gestión de Imágenes (igual que antes) =====
            let imagenesIgnore = [];
            const $imagenesInput = $('#Imagenes');
            const fileMap = new Map();
            let uidSeq = 0;

            function updateFileInputFromMap() {
                const dt = new DataTransfer();
                for (const f of fileMap.values()) dt.items.add(f);
                $imagenesInput[0].files = dt.files;
            }

            function updateImgCount() {
                const count = $('#imagenes-preview .imagen-preview-item').length;
                $('#img-count').text(count);
            }

            function reindexNewImageRadios() {
                const $newItems = $('#imagenes-preview .imagen-preview-item[data-is-new="1"]');
                $newItems.each(function (idx) {
                    $(this).find('input[type=radio][name=ImagenPrincipalIndex]').val(idx);
                });

                if ($('input[name="ImagenPrincipalIndex"]:checked').length === 0 &&
                    $('input[name="existingImagenPath"]:checked').length === 0) {
                    $('#ImagenPrincipalIndex').val(-1);
                }
            }

            $imagenesInput.on('change', function () {
                const files = Array.from(this.files || []);
                const $preview = $('#imagenes-preview');
                const current = $preview.children().length;

                if (current + files.length > 8) {
                    alert('No puede exceder 8 imágenes.');
                    updateFileInputFromMap();
                    return;
                }

                files.forEach((file) => {
                    if ([...fileMap.values()].includes(file)) return;

                    const uid = 'f' + (++uidSeq);
                    fileMap.set(uid, file);

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const card = `
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-3 imagen-preview-item" data-is-new="1" data-uid="${uid}">
                            <div class="card h-100 border">
                                <div class="position-relative">
                                    <img src="${e.target.result}" class="card-img-top" style="height:180px;object-fit:cover;">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-success">Nueva</span>
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="ImagenPrincipalIndex" value="0">
                                        <label class="form-check-label fw-semibold">Establecer como principal</label>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top-0">
                                    <button type="button" class="btn btn-sm btn-outline-danger w-100 btn-eliminar-imagen">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>`;
                        $preview.append(card);
                        reindexNewImageRadios();
                        updateImgCount();
                    };
                    reader.readAsDataURL(file);
                });

                updateFileInputFromMap();
            });

            $(document).on('change', 'input[name="ImagenPrincipalIndex"]', function () {});
            $(document).on('change', 'input[name="existingImagenPath"]', function () {
                $('input[name="ImagenPrincipalIndex"]').prop('checked', false);
                $('#ImagenPrincipalIndex').val(-1);
            });

            $(document).on('click', '.btn-eliminar-imagen', function () {
                const $item = $(this).closest('.imagen-preview-item');
                const isNew = $item.attr('data-is-new') === '1';
                const url = $item.attr('data-url');

                if (isNew) {
                    const uid = $item.attr('data-uid');
                    if (uid && fileMap.has(uid)) {
                        fileMap.delete(uid);
                        updateFileInputFromMap();
                    }
                } else if (url) {
                    imagenesIgnore.push(url);
                    $('#ImagenesIgnore').val(JSON.stringify(imagenesIgnore));
                }

                if ($item.find('input[type=radio]:checked').length) {
                    $('input[name="ImagenPrincipalIndex"]').prop('checked', false);
                    $('input[name="existingImagenPath"]').prop('checked', false);
                    $('#ImagenPrincipalIndex').val(-1);
                }

                $item.remove();
                reindexNewImageRadios();
                updateImgCount();
            });

            // ===== Subcategorías por categoría (AJAX) =====
            function fillSubcats(catId, selected) {
                const $sub = $('#subcategoriaID');
                $sub.empty().append('<option value="">Seleccione una subcategoría</option>');
                if (!catId) return;

                $.get('@Url.Action("GetSubcategoriasByCategoria", "Panel")', { categoriaID: catId }, function (data) {
                    $.each(data, function (_, item) {
                        const $opt = $('<option/>', { value: item.value, text: item.text });
                        if (selected && String(item.value) === String(selected)) $opt.attr('selected', 'selected');
                        $sub.append($opt);
                    });
                });
            }

            $('#categoriaID').on('change', function () { fillSubcats($(this).val(), null); });

            (function initSubcatsOnLoad() {
                const catVal = $('#categoriaID').val();
                const selected = $('#subcategoriaID').data('selected');
                if (catVal && $('#subcategoriaID option').length <= 1) {
                    fillSubcats(catVal, selected);
                }
            })();
        })();
    </script>
}
