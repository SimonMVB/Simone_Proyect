@*
    ══════════════════════════════════════════════════════════════════════════
    Partial View: _AtributosDinamicos.cshtml
    Ubicación: Views/Panel/_AtributosDinamicos.cshtml
    
    ATRIBUTOS DINÁMICOS PARA PRODUCTOS
    Sistema tipo Amazon/MercadoLibre - Campos personalizados por categoría
    
    CARACTERÍSTICAS:
    - Carga automática de atributos según categoría seleccionada
    - Soporte para múltiples tipos de campo (text, number, select, multiselect, checkbox, color, date)
    - Agrupación visual de atributos
    - Validación de campos obligatorios
    - Modo edición con pre-carga de valores existentes
    - Compatible con ProductoForm.js
    
    ADAPTADO PARA: PanelController
    Versión: 2.0 - Corregido y Mejorado
    ══════════════════════════════════════════════════════════════════════════
*@

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- SECCIÓN: ATRIBUTOS DINÁMICOS POR CATEGORÍA -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<section class="form-section" id="atributosDinamicosSection" style="display: none;" aria-labelledby="sec-atributos">
    <header class="section-header">
        <h2 class="section-title" id="sec-atributos">
            <i class="fas fa-tags" aria-hidden="true"></i>
            Atributos de la Categoría
        </h2>
        <span class="section-badge" id="atributosCountBadge" aria-live="polite">
            0 atributos
        </span>
    </header>

    <div class="section-content">
        <!-- Estado de carga -->
        <div id="atributosLoading" class="text-center" style="padding: 2rem; display: none;">
            <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary); margin-bottom: 1rem;"></i>
            <p style="color: var(--text-muted); margin: 0;">Cargando atributos de la categoría...</p>
        </div>

        <!-- Mensaje cuando no hay atributos -->
        <div id="atributosEmpty" class="text-center" style="padding: 2rem; display: none;">
            <i class="fas fa-info-circle fa-2x" style="color: var(--text-muted); margin-bottom: 1rem;"></i>
            <p style="color: var(--text-muted); margin: 0;">Esta categoría no tiene atributos configurados.</p>
        </div>

        <!-- Contenedor de campos dinámicos -->
        <div id="atributosDinamicosContent" class="form-grid">
            <!-- Los campos se generan dinámicamente aquí -->
        </div>
    </div>
</section>

<!-- ════════════════════════════════════════════════════════════════════════ -->
<!-- JAVASCRIPT: SISTEMA DE ATRIBUTOS DINÁMICOS -->
<!-- ════════════════════════════════════════════════════════════════════════ -->
<script>
    (function() {
        'use strict';

        // ══════════════════════════════════════════════════════════════════════
        // CONFIGURACIÓN Y ESTADO
        // ══════════════════════════════════════════════════════════════════════

        const AtributosDinamicos = {
            // Estado
            atributos: [],
            valores: {},
            categoriaActual: null,
            initialized: false,

            // Elementos DOM (se inicializan después)
            elements: {
                section: null,
                content: null,
                loading: null,
                empty: null,
                badge: null,
                categoriaSelect: null
            },

            // URLs de API
            urls: {
                obtenerAtributos: '@Url.Action("ObtenerAtributosPorCategoria", "Panel")',
                obtenerValores: '@Url.Action("ObtenerValoresAtributos", "Panel")'
            },

            // ══════════════════════════════════════════════════════════════════
            // INICIALIZACIÓN
            // ══════════════════════════════════════════════════════════════════

            init: function() {
                if (this.initialized) return;

                // Cachear elementos DOM
                this.elements.section = document.getElementById('atributosDinamicosSection');
                this.elements.content = document.getElementById('atributosDinamicosContent');
                this.elements.loading = document.getElementById('atributosLoading');
                this.elements.empty = document.getElementById('atributosEmpty');
                this.elements.badge = document.getElementById('atributosCountBadge');
                this.elements.categoriaSelect = document.getElementById('categoriaID');

                if (!this.elements.categoriaSelect) {
                    console.warn('[AtributosDinamicos] Select de categoría no encontrado');
                    return;
                }

                // Event listener para cambio de categoría
                this.elements.categoriaSelect.addEventListener('change', (e) => {
                    const categoriaId = parseInt(e.target.value) || 0;
                    this.onCategoriaChange(categoriaId);
                });

                // Si ya hay una categoría seleccionada, cargar sus atributos
                const categoriaInicial = parseInt(this.elements.categoriaSelect.value) || 0;
                if (categoriaInicial > 0) {
                    this.onCategoriaChange(categoriaInicial);
                }

                // Cargar valores existentes si estamos en modo edición
                this.cargarValoresExistentes();

                this.initialized = true;
                console.log('[AtributosDinamicos] Inicializado correctamente ✓');
            },

            // ══════════════════════════════════════════════════════════════════
            // EVENTO: CAMBIO DE CATEGORÍA
            // ══════════════════════════════════════════════════════════════════

            onCategoriaChange: function(categoriaId) {
                if (!categoriaId || categoriaId === 0) {
                    this.ocultarSeccion();
                    return;
                }

                if (categoriaId === this.categoriaActual) {
                    return; // Ya está cargada
                }

                this.categoriaActual = categoriaId;
                this.cargarAtributos(categoriaId);
            },

            // ══════════════════════════════════════════════════════════════════
            // CARGAR ATRIBUTOS VÍA AJAX
            // ══════════════════════════════════════════════════════════════════

            cargarAtributos: function(categoriaId) {
                this.mostrarCargando();

                fetch(`${this.urls.obtenerAtributos}?categoriaId=${categoriaId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.atributos) {
                        this.atributos = data.atributos;

                        if (this.atributos.length > 0) {
                            this.renderizarAtributos();
                            this.aplicarValoresExistentes();
                            this.mostrarContenido();
                        } else {
                            this.mostrarVacio();
                        }
                    } else {
                        console.error('[AtributosDinamicos] Error:', data.mensaje || 'Error desconocido');
                        this.mostrarVacio();
                    }
                })
                .catch(error => {
                    console.error('[AtributosDinamicos] Error de conexión:', error);
                    this.mostrarError('Error al conectar con el servidor');
                });
            },

            // ══════════════════════════════════════════════════════════════════
            // CARGAR VALORES EXISTENTES (MODO EDICIÓN)
            // ══════════════════════════════════════════════════════════════════

            cargarValoresExistentes: function() {
                // Buscar el ProductoID en el formulario (modo edición)
                const productoIdInput = document.querySelector('input[name="productoID"]');
                if (!productoIdInput || !productoIdInput.value) {
                    return; // No estamos en modo edición
                }

                const productoId = parseInt(productoIdInput.value);
                if (!productoId) return;

                fetch(`${this.urls.obtenerValores}?productoId=${productoId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.valores) {
                        this.valores = data.valores;
                        console.log('[AtributosDinamicos] Valores cargados para edición:', Object.keys(this.valores).length);

                        // Si ya hay atributos renderizados, aplicar valores
                        if (this.atributos.length > 0) {
                            this.aplicarValoresExistentes();
                        }
                    }
                })
                .catch(error => {
                    console.warn('[AtributosDinamicos] No se pudieron cargar valores existentes:', error);
                });
            },

            // ══════════════════════════════════════════════════════════════════
            // RENDERIZAR CAMPOS DE ATRIBUTOS
            // ══════════════════════════════════════════════════════════════════

            renderizarAtributos: function() {
                if (!this.elements.content) return;

                // Agrupar atributos por grupo
                const grupos = {};
                this.atributos.forEach(attr => {
                    const grupo = attr.grupo || 'General';
                    if (!grupos[grupo]) {
                        grupos[grupo] = [];
                    }
                    grupos[grupo].push(attr);
                });

                let html = '';

                Object.keys(grupos).forEach((grupo, index) => {
                    // Separador entre grupos
                    if (index > 0) {
                        html += '<div class="form-grid-full" style="margin: 1.5rem 0; border-top: 1px solid var(--border-color);"></div>';
                    }

                    // Título del grupo
                    html += `
                        <div class="form-grid-full" style="margin-bottom: 0.5rem;">
                            <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--primary); margin: 0;">
                                <i class="fas fa-layer-group" style="margin-right: 0.5rem;"></i>
                                ${this.escapeHtml(grupo)}
                            </h3>
                        </div>
                    `;

                    // Campos del grupo
                    grupos[grupo].forEach(attr => {
                        html += this.renderizarCampo(attr);
                    });
                });

                this.elements.content.innerHTML = html;
                this.actualizarBadge();
            },

            // ══════════════════════════════════════════════════════════════════
            // RENDERIZAR UN CAMPO INDIVIDUAL
            // ══════════════════════════════════════════════════════════════════

            renderizarCampo: function(attr) {
                const fieldName = `atributo_${attr.atributoId}`;
                const fieldId = `atributo_${attr.atributoId}`;
                const isRequired = attr.obligatorio;

                let fieldHtml = '';

                switch (attr.tipoCampo) {
                    case 'text':
                        fieldHtml = `
                            <input type="text"
                                   class="form-input"
                                   id="${fieldId}"
                                   name="${fieldName}"
                                   maxlength="500"
                                   placeholder="${this.escapeHtml(attr.descripcion || 'Ingrese ' + attr.nombre)}"
                                   ${isRequired ? 'required' : ''} />
                        `;
                        break;

                    case 'number':
                        fieldHtml = `
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number"
                                       class="form-input"
                                       id="${fieldId}"
                                       name="${fieldName}"
                                       step="0.01"
                                       ${attr.valorMinimo ? `min="${attr.valorMinimo}"` : ''}
                                       ${attr.valorMaximo ? `max="${attr.valorMaximo}"` : ''}
                                       ${isRequired ? 'required' : ''} />
                                ${attr.unidad ? `<span class="form-note" style="white-space: nowrap;">${this.escapeHtml(attr.unidad)}</span>` : ''}
                            </div>
                        `;
                        break;

                    case 'select':
                        let options = '<option value="">-- Seleccionar --</option>';
                        if (attr.opciones && Array.isArray(attr.opciones)) {
                            attr.opciones.forEach(opt => {
                                options += `<option value="${this.escapeHtml(opt)}">${this.escapeHtml(opt)}</option>`;
                            });
                        }
                        fieldHtml = `
                            <select class="form-select"
                                    id="${fieldId}"
                                    name="${fieldName}"
                                    ${isRequired ? 'required' : ''}>
                                ${options}
                            </select>
                        `;
                        break;

                    case 'multiselect':
                        if (attr.opciones && Array.isArray(attr.opciones)) {
                            fieldHtml = '<div class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">';
                            attr.opciones.forEach(opt => {
                                const checkId = `${fieldId}_${opt.replace(/\s+/g, '_').replace(/[^\w-]/g, '')}`;
                                fieldHtml += `
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox"
                                               id="${checkId}"
                                               name="${fieldName}[]"
                                               value="${this.escapeHtml(opt)}" />
                                        <span>${this.escapeHtml(opt)}</span>
                                    </label>
                                `;
                            });
                            fieldHtml += '</div>';
                        }
                        break;

                    case 'checkbox':
                        fieldHtml = `
                            <label class="toggle-switch" for="${fieldId}" style="display: flex; align-items: center; gap: 0.75rem;">
                                <input type="checkbox"
                                       id="${fieldId}"
                                       name="${fieldName}"
                                       value="true" />
                                <span class="toggle-slider"></span>
                                <span>${this.escapeHtml(attr.descripcion || 'Sí')}</span>
                            </label>
                        `;
                        break;

                    case 'color':
                        fieldHtml = `
                            <input type="color"
                                   class="form-input"
                                   id="${fieldId}"
                                   name="${fieldName}"
                                   style="height: 42px; padding: 4px;"
                                   ${isRequired ? 'required' : ''} />
                        `;
                        break;

                    case 'date':
                        fieldHtml = `
                            <input type="date"
                                   class="form-input"
                                   id="${fieldId}"
                                   name="${fieldName}"
                                   ${isRequired ? 'required' : ''} />
                        `;
                        break;

                    case 'textarea':
                        fieldHtml = `
                            <textarea class="form-textarea"
                                      id="${fieldId}"
                                      name="${fieldName}"
                                      rows="3"
                                      maxlength="2000"
                                      placeholder="${this.escapeHtml(attr.descripcion || '')}"
                                      ${isRequired ? 'required' : ''}></textarea>
                        `;
                        break;

                    default:
                        fieldHtml = `
                            <input type="text"
                                   class="form-input"
                                   id="${fieldId}"
                                   name="${fieldName}"
                                   ${isRequired ? 'required' : ''} />
                        `;
                }

                return `
                    <div class="form-group">
                        <label class="form-label ${isRequired ? 'required' : ''}" for="${fieldId}">
                            ${attr.iconoClass ? `<i class="${attr.iconoClass}" style="margin-right: 0.25rem;"></i>` : ''}
                            ${this.escapeHtml(attr.nombre)}
                        </label>
                        ${fieldHtml}
                        ${attr.descripcion && attr.tipoCampo !== 'checkbox' ?
                            `<div class="form-note"><i class="fas fa-info-circle"></i> ${this.escapeHtml(attr.descripcion)}</div>` : ''}
                    </div>
                `;
            },

            // ══════════════════════════════════════════════════════════════════
            // APLICAR VALORES EXISTENTES A LOS CAMPOS
            // ══════════════════════════════════════════════════════════════════

            aplicarValoresExistentes: function() {
                if (!this.valores || Object.keys(this.valores).length === 0) return;

                Object.keys(this.valores).forEach(atributoId => {
                    const valor = this.valores[atributoId];
                    const fieldId = `atributo_${atributoId}`;
                    const field = document.getElementById(fieldId);
                    const atributo = this.atributos.find(a => a.atributoId == atributoId);

                    if (!field || !atributo) return;

                    switch (atributo.tipoCampo) {
                        case 'checkbox':
                            field.checked = valor === 'true' || valor === '1' || valor === true;
                            break;

                        case 'multiselect':
                            try {
                                const valores = typeof valor === 'string' ? JSON.parse(valor) : valor;
                                if (Array.isArray(valores)) {
                                    valores.forEach(v => {
                                        const checkbox = document.querySelector(
                                            `input[name="atributo_${atributoId}[]"][value="${v}"]`
                                        );
                                        if (checkbox) checkbox.checked = true;
                                    });
                                }
                            } catch (e) {
                                console.warn('[AtributosDinamicos] Error al parsear multiselect:', e);
                            }
                            break;

                        default:
                            field.value = valor;
                    }
                });

                console.log('[AtributosDinamicos] Valores aplicados a campos');
            },

            // ══════════════════════════════════════════════════════════════════
            // CONTROL DE VISIBILIDAD
            // ══════════════════════════════════════════════════════════════════

            mostrarCargando: function() {
                if (this.elements.section) this.elements.section.style.display = 'block';
                if (this.elements.loading) this.elements.loading.style.display = 'block';
                if (this.elements.content) this.elements.content.style.display = 'none';
                if (this.elements.empty) this.elements.empty.style.display = 'none';
            },

            mostrarContenido: function() {
                if (this.elements.section) this.elements.section.style.display = 'block';
                if (this.elements.loading) this.elements.loading.style.display = 'none';
                if (this.elements.content) this.elements.content.style.display = 'grid';
                if (this.elements.empty) this.elements.empty.style.display = 'none';
            },

            mostrarVacio: function() {
                if (this.elements.section) this.elements.section.style.display = 'block';
                if (this.elements.loading) this.elements.loading.style.display = 'none';
                if (this.elements.content) this.elements.content.style.display = 'none';
                if (this.elements.empty) this.elements.empty.style.display = 'block';
                this.actualizarBadge(0);
            },

            mostrarError: function(mensaje) {
                if (this.elements.empty) {
                    this.elements.empty.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-2x" style="color: var(--error); margin-bottom: 1rem;"></i>
                        <p style="color: var(--error); margin: 0;">${this.escapeHtml(mensaje)}</p>
                    `;
                }
                this.mostrarVacio();
            },

            ocultarSeccion: function() {
                if (this.elements.section) this.elements.section.style.display = 'none';
                this.atributos = [];
                this.categoriaActual = null;
            },

            actualizarBadge: function(count = null) {
                if (!this.elements.badge) return;
                const cantidad = count !== null ? count : this.atributos.length;
                this.elements.badge.textContent = `${cantidad} atributo${cantidad !== 1 ? 's' : ''}`;
            },

            // ══════════════════════════════════════════════════════════════════
            // UTILIDADES
            // ══════════════════════════════════════════════════════════════════

            escapeHtml: function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // ══════════════════════════════════════════════════════════════════
            // PREPARAR DATOS PARA ENVÍO (llamado antes del submit)
            // ══════════════════════════════════════════════════════════════════

            prepararParaEnvio: function(form) {
                // Convertir multiselect checkboxes a JSON
                this.atributos.forEach(attr => {
                    if (attr.tipoCampo === 'multiselect') {
                        const checkboxes = form.querySelectorAll(`input[name="atributo_${attr.atributoId}[]"]:checked`);
                        const valores = Array.from(checkboxes).map(cb => cb.value);

                        // Remover campo hidden anterior si existe
                        const existingHidden = form.querySelector(`input[type="hidden"][name="atributo_${attr.atributoId}"]`);
                        if (existingHidden) existingHidden.remove();

                        // Crear nuevo campo hidden con JSON
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = `atributo_${attr.atributoId}`;
                        hidden.value = JSON.stringify(valores);
                        form.appendChild(hidden);
                    }
                });
            }
        };

        // ══════════════════════════════════════════════════════════════════════
        // INICIALIZACIÓN CUANDO EL DOM ESTÉ LISTO
        // ══════════════════════════════════════════════════════════════════════

        function inicializar() {
            AtributosDinamicos.init();

            // Hook para preparar datos antes del envío del formulario
            const form = document.getElementById('productoForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    AtributosDinamicos.prepararParaEnvio(form);
                }, true); // Captura para ejecutar antes de otros handlers
            }
        }

        // Inicializar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            inicializar();
        }

        // Exponer globalmente para debugging
        window.AtributosDinamicos = AtributosDinamicos;

    })();
</script>
