@*
    ══════════════════════════════════════════════════════════════════════════
    Partial View: _AtributosDinamicos.cshtml
    Ubicación: Views/Panel/_AtributosDinamicos.cshtml
    
    ATRIBUTOS DINÁMICOS PARA PRODUCTOS
    Carga automáticamente campos de atributos según la categoría seleccionada
    
    ADAPTADO PARA: PanelController
    ══════════════════════════════════════════════════════════════════════════
*@

<div id="atributosDinamicosContainer" class="card shadow-sm mb-4" style="display: none;">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">
            <i class="fas fa-tags me-2"></i>
            Atributos de la Categoría
        </h5>
        <small class="text-white-50">Los campos se cargan automáticamente según la categoría</small>
    </div>
    <div class="card-body" id="atributosDinamicosContent">
        <!-- Los campos se cargan dinámicamente aquí vía JavaScript -->
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Selecciona una categoría para ver sus atributos...
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ══════════════════════════════════════════════════════════════════════
        // JAVASCRIPT PARA ATRIBUTOS DINÁMICOS
        // Adaptado para PanelController
        // ══════════════════════════════════════════════════════════════════════

        var atributosActuales = [];
        var valoresActuales = {};

        // ────────────────────────────────────────────────────────────────────
        // EVENTO: Cambio de categoría
        // ────────────────────────────────────────────────────────────────────
        $('#categoriaID').on('change', function() {
            var categoriaId = $(this).val();

            if (!categoriaId || categoriaId === '0') {
                $('#atributosDinamicosContainer').hide();
                return;
            }

            cargarAtributosDeCategoria(categoriaId);
        });

        // ────────────────────────────────────────────────────────────────────
        // FUNCIÓN: Cargar atributos de una categoría vía AJAX
        // ────────────────────────────────────────────────────────────────────
        function cargarAtributosDeCategoria(categoriaId) {
            // Mostrar indicador de carga
            $('#atributosDinamicosContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i> Cargando atributos...</div>');
            $('#atributosDinamicosContainer').show();

            $.ajax({
                url: '@Url.Action("ObtenerAtributosPorCategoria", "Panel")',
                type: 'GET',
                data: { categoriaId: categoriaId },
                success: function(response) {
                    if (response.success) {
                        atributosActuales = response.atributos;

                        if (atributosActuales.length > 0) {
                            renderizarAtributos();
                            $('#atributosDinamicosContainer').show();
                        } else {
                            $('#atributosDinamicosContent').html('<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>Esta categoría no tiene atributos configurados.</div>');
                        }
                    } else {
                        console.error('Error al cargar atributos:', response.mensaje);
                        $('#atributosDinamicosContent').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>' + response.mensaje + '</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error AJAX al cargar atributos:', error);
                    $('#atributosDinamicosContent').html('<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>Error al conectar con el servidor.</div>');
                }
            });
        }

        // ────────────────────────────────────────────────────────────────────
        // FUNCIÓN: Renderizar campos de atributos
        // ────────────────────────────────────────────────────────────────────
        function renderizarAtributos() {
            var html = '';
            var grupos = {};

            // Agrupar atributos por grupo
            atributosActuales.forEach(function(atributo) {
                var grupo = atributo.grupo || 'General';
                if (!grupos[grupo]) {
                    grupos[grupo] = [];
                }
                grupos[grupo].push(atributo);
            });

            // Renderizar por grupos
            Object.keys(grupos).forEach(function(grupo, index) {
                if (index > 0) {
                    html += '<hr class="my-4">';
                }

                html += '<h6 class="text-primary mb-3 fw-bold">';
                html += '<i class="fas fa-layer-group me-2"></i>' + grupo;
                html += '</h6>';
                html += '<div class="row">';

                grupos[grupo].forEach(function(atributo) {
                    html += renderizarCampoAtributo(atributo);
                });

                html += '</div>';
            });

            $('#atributosDinamicosContent').html(html);

            // Aplicar valores existentes (modo edición)
            aplicarValoresExistentes();
        }

        // ────────────────────────────────────────────────────────────────────
        // FUNCIÓN: Renderizar un campo individual según su tipo
        // ────────────────────────────────────────────────────────────────────
        function renderizarCampoAtributo(atributo) {
            var html = '<div class="col-md-6 mb-3">';

            // ═══ LABEL ═══
            html += '<label class="form-label fw-medium">';
            if (atributo.iconoClass) {
                html += '<i class="' + atributo.iconoClass + ' me-1"></i>';
            }
            html += atributo.nombre;
            if (atributo.obligatorio) {
                html += ' <span class="text-danger">*</span>';
            }
            html += '</label>';

            // ═══ CAMPO SEGÚN TIPO ═══
            var fieldName = 'atributo_' + atributo.atributoId;
            var fieldId = 'atributo_' + atributo.atributoId;

            switch (atributo.tipoCampo) {
                case 'text':
                    html += '<input type="text" class="form-control" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    if (atributo.obligatorio) html += 'required ';
                    html += 'placeholder="' + (atributo.descripcion || 'Ingrese ' + atributo.nombre) + '" />';
                    break;

                case 'number':
                    html += '<div class="input-group">';
                    html += '<input type="number" step="0.01" class="form-control" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    if (atributo.valorMinimo) html += 'min="' + atributo.valorMinimo + '" ';
                    if (atributo.valorMaximo) html += 'max="' + atributo.valorMaximo + '" ';
                    if (atributo.obligatorio) html += 'required ';
                    html += '/>';
                    if (atributo.unidad) {
                        html += '<span class="input-group-text">' + atributo.unidad + '</span>';
                    }
                    html += '</div>';
                    break;

                case 'select':
                    html += '<select class="form-select" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    if (atributo.obligatorio) html += 'required ';
                    html += '>';
                    html += '<option value="">-- Seleccionar ' + atributo.nombre + ' --</option>';
                    if (atributo.opciones) {
                        atributo.opciones.forEach(function(opcion) {
                            html += '<option value="' + opcion + '">' + opcion + '</option>';
                        });
                    }
                    html += '</select>';
                    break;

                case 'multiselect':
                    if (atributo.opciones) {
                        atributo.opciones.forEach(function(opcion) {
                            var checkId = fieldId + '_' + opcion.replace(/\s+/g, '_').replace(/[^\w-]/g, '');
                            html += '<div class="form-check">';
                            html += '<input type="checkbox" class="form-check-input" ';
                            html += 'id="' + checkId + '" ';
                            html += 'name="' + fieldName + '[]" ';
                            html += 'value="' + opcion + '" />';
                            html += '<label class="form-check-label" for="' + checkId + '">';
                            html += opcion;
                            html += '</label>';
                            html += '</div>';
                        });
                    }
                    break;

                case 'checkbox':
                    html += '<div class="form-check form-switch mt-2">';
                    html += '<input type="checkbox" class="form-check-input" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    html += 'value="true" />';
                    html += '<label class="form-check-label" for="' + fieldId + '">';
                    html += atributo.descripcion || 'Sí';
                    html += '</label>';
                    html += '</div>';
                    break;

                case 'color':
                    html += '<input type="color" class="form-control form-control-color" style="height: 42px;" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    if (atributo.obligatorio) html += 'required ';
                    html += '/>';
                    break;

                case 'date':
                    html += '<input type="date" class="form-control" ';
                    html += 'id="' + fieldId + '" name="' + fieldName + '" ';
                    if (atributo.obligatorio) html += 'required ';
                    html += '/>';
                    break;
            }

            // ═══ DESCRIPCIÓN ═══
            if (atributo.descripcion && atributo.tipoCampo !== 'checkbox') {
                html += '<small class="form-text text-muted">';
                html += '<i class="fas fa-info-circle me-1"></i>' + atributo.descripcion;
                html += '</small>';
            }

            html += '</div>';
            return html;
        }

        // ────────────────────────────────────────────────────────────────────
        // FUNCIÓN: Aplicar valores existentes (modo edición)
        // ────────────────────────────────────────────────────────────────────
        function aplicarValoresExistentes() {
            if (Object.keys(valoresActuales).length === 0) return;

            Object.keys(valoresActuales).forEach(function(atributoId) {
                var valor = valoresActuales[atributoId];
                var fieldId = '#atributo_' + atributoId;
                var atributo = atributosActuales.find(a => a.atributoId == atributoId);

                if (!atributo) return;

                if (atributo.tipoCampo === 'checkbox') {
                    $(fieldId).prop('checked', valor === 'true' || valor === '1');
                } else if (atributo.tipoCampo === 'multiselect') {
                    try {
                        var valores = JSON.parse(valor);
                        valores.forEach(function(v) {
                            $('input[name="atributo_' + atributoId + '[]"][value="' + v + '"]')
                                .prop('checked', true);
                        });
                    } catch (e) {
                        console.error('Error al parsear valores multiselect:', e);
                    }
                } else {
                    $(fieldId).val(valor);
                }
            });
        }

        // ────────────────────────────────────────────────────────────────────
        // MODO EDICIÓN: Cargar valores si estamos editando un producto
        // ────────────────────────────────────────────────────────────────────
        @if (ViewBag.ProductoID != null)
        {
                <text>
                var productoId = @ViewBag.ProductoID;

                $.ajax({
                    url: '@Url.Action("ObtenerValoresAtributos", "Panel")',
                    type: 'GET',
                    data: { productoId: productoId },
                    success: function(response) {
                        if (response.success) {
                            valoresActuales = response.valores;

                            // Si ya hay categoría seleccionada, cargar atributos
                            var categoriaId = $('#categoriaID').val();
                            if (categoriaId && categoriaId !== '0') {
                                cargarAtributosDeCategoria(categoriaId);
                            }
                        }
                    }
                });
                </text>
        }

        // ────────────────────────────────────────────────────────────────────
        // SUBMIT: Procesar multiselect antes de enviar formulario
        // ────────────────────────────────────────────────────────────────────
        $('form').on('submit', function(e) {
            // Para multiselect, convertir checkboxes a JSON
            atributosActuales.forEach(function(atributo) {
                if (atributo.tipoCampo === 'multiselect') {
                    var valores = [];
                    $('input[name="atributo_' + atributo.atributoId + '[]"]:checked').each(function() {
                        valores.push($(this).val());
                    });

                    // Crear campo hidden con JSON
                    var json = JSON.stringify(valores);

                    // Remover hidden anterior si existe
                    $('input[name="atributo_' + atributo.atributoId + '"]').remove();

                    // Agregar nuevo hidden
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'atributo_' + atributo.atributoId,
                        value: json
                    }).appendTo($(this));
                }
            });
        });

        // ────────────────────────────────────────────────────────────────────
        // INICIALIZACIÓN: Si ya hay categoría seleccionada al cargar
        // ────────────────────────────────────────────────────────────────────
        $(document).ready(function() {
            var categoriaId = $('#categoriaID').val();
            if (categoriaId && categoriaId !== '0') {
                cargarAtributosDeCategoria(categoriaId);
            }
        });
    </script>
}
