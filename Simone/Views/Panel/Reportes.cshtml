@model List<Simone.ViewModels.Reportes.CompradorResumenVM>
@using System.Globalization
@{
    ViewData["Title"] = "Compradores / Ventas";
    var culture = new CultureInfo("es-EC");
}

<div class="container-xl py-4">
    <h2 class="fw-bold mb-3">Compradores</h2>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">No hay ventas registradas.</div>
    }
    else
    {
        <div class="list-group shadow-sm">
            @foreach (var v in Model)
            {
                var badge = v.Estado?.Equals("Enviado", StringComparison.OrdinalIgnoreCase) == true
                ? "bg-success"
                : "bg-secondary";

                <div class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-3">
                    <div class="d-flex align-items-start gap-3 flex-grow-1">
                        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <div class="fw-bold">
                                <a asp-action="VentaDetalle" asp-controller="Panel" asp-route-id="@v.VentaID" class="text-decoration-none">
                                    @v.Nombre
                                </a>
                                <span class="badge @badge ms-2">@v.Estado</span>
                            </div>
                            <div class="text-muted small">
                                @v.Email Â· @v.Telefono
                                <span class="ms-2">| @v.Fecha.ToString("dd/MM/yyyy HH:mm")</span>
                                <span class="ms-2">| @v.MetodoPago</span>
                            </div>
                        </div>
                    </div>

                    <div class="text-end">
                        <div class="fw-bolder">@v.Total.ToString("C", culture)</div>
                        <form method="post" asp-action="MarcarEnviada" asp-controller="Panel" class="d-inline-block ms-2 js-mark-shipped">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@v.VentaID" />
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Marcar como enviado">
                                <i class="fa-solid fa-truck-fast me-1"></i> Enviado
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('form.js-mark-shipped').forEach(f => {
            f.addEventListener('submit', async (e) => {
              e.preventDefault();
              const row = f.closest('.list-group-item');
              const badge = row.querySelector('.badge');
              const data = new FormData(f);
              const res = await fetch(f.action, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}, body:data });
              if(res.ok){
                const json = await res.json();
                if(json.ok){
                  badge.textContent = json.estado;
                  badge.className = 'badge bg-success ms-2';
                }
              }
            });
          });
        });
    </script>
}
