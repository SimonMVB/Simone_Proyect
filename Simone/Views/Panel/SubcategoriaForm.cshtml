@using Simone.Models
@{
    ViewData["Title"] = ViewBag.Subcategoria != null ? "Editar Subcategoría" : "Añadir Subcategoría";

    // Robustez: castear ViewBag con fallback vacío
    var subcat = ViewBag.Subcategoria as Subcategorias;
    var categorias = ViewBag.Categorias as IEnumerable<Categorias> ?? Enumerable.Empty<Categorias>();
}

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-dark: #1A1A1A;
        --primary-light: #FFFFFF;
        --accent-purple: #4B0082;
        --accent-gold: #D4AF37;
        --light-gray: #F8F8F8;
        --medium-gray: #E0E0E0;
        --dark-gray: #333333;
        --text-color: #333333;
        --text-light: #777777;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
    }

    body {
        font-family: 'Montserrat',sans-serif;
        background: #f5f5f7;
        color: var(--text-color);
    }

    h1, h2, h3, h4, h5, h6 {
        font-family: 'Playfair Display',serif;
        font-weight: 600;
    }

    .form-container {
        max-width: 820px;
        margin: 2rem auto;
        padding: 0 15px;
    }

    .card {
        background: var(--primary-light);
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,.08);
        overflow: hidden;
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.1rem 1.25rem;
        border-bottom: 1px solid var(--medium-gray);
        background: linear-gradient(135deg, rgba(75,0,130,.06), rgba(75,0,130,.02));
    }

    .title {
        display: flex;
        align-items: center;
        gap: .75rem;
        color: var(--accent-purple);
    }

        .title i {
            font-size: 1.4rem;
        }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        text-decoration: none;
        font-weight: 600;
        color: var(--accent-purple);
        border: 1px solid rgba(75,0,130,.25);
        padding: .45rem .75rem;
        border-radius: 999px;
        background: rgba(75,0,130,.05);
    }

        .back-link:hover {
            background: rgba(75,0,130,.12);
        }

    .card-body {
        padding: 1.25rem 1.25rem 1rem 1.25rem;
    }

    .form-group {
        margin-bottom: 1.1rem;
    }

    .form-label {
        display: block;
        margin-bottom: .45rem;
        font-weight: 600;
        color: var(--dark-gray);
    }

    .form-input, .form-select {
        width: 100%;
        padding: .75rem 1rem;
        border: 1px solid var(--medium-gray);
        border-radius: 10px;
        font-size: 1rem;
        background: var(--primary-light);
        transition: border-color .15s ease, box-shadow .15s ease;
    }

        .form-input:focus, .form-select:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(75,0,130,.12);
            outline: none;
        }

    .muted {
        color: var(--text-light);
        font-size: .9rem;
        margin-top: .35rem;
    }

    .counter {
        font-size: .9rem;
        color: var(--text-light);
    }

    .actions {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
        margin-top: .25rem;
    }

    .btn {
        appearance: none;
        border: none;
        cursor: pointer;
        font-weight: 700;
        border-radius: 999px;
        padding: .8rem 1.25rem;
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        transition: transform .15s ease, box-shadow .15s ease, background .2s ease, color .2s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--accent-purple), #5E2D8C);
        color: #fff;
    }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(75,0,130,.25);
        }

    .btn-secondary {
        background: #fff;
        color: var(--accent-purple);
        border: 1px solid rgba(75,0,130,.3);
    }

        .btn-secondary:hover {
            background: rgba(75,0,130,.06);
        }

    .alert {
        border-radius: 12px;
        padding: .9rem 1rem;
        margin: 1rem 0;
        display: flex;
        gap: .6rem;
        align-items: center;
        font-weight: 500;
    }

    .alert-success {
        background: rgba(40,167,69,.1);
        color: var(--success-color);
        border: 1px solid rgba(40,167,69,.25);
    }

    .alert-danger {
        background: rgba(220,53,69,.1);
        color: var(--danger-color);
        border: 1px solid rgba(220,53,69,.25);
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn .35s ease-out;
    }

    @@media (max-width:768px) {
        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: .6rem;
        }
    }
</style>

<div class="form-container fade-in">
    <div class="card">
        <div class="card-header">
            <div class="title">
                <i class="fas fa-tags"></i>
                <h2 style="margin:0">@ViewData["Title"]</h2>
            </div>
            <a class="back-link" asp-controller="Panel" asp-action="Subcategorias">
                <i class="fa-solid fa-arrow-left"></i> Volver al listado
            </a>
        </div>

        <div class="card-body">

            @* Mensajes de servidor *@
            @if (TempData["Ok"] != null)
            {
                <div class="alert alert-success fade-in">
                    <i class="fa-solid fa-circle-check"></i>
                    <span>@TempData["Ok"]</span>
                </div>
            }
            @if (TempData["Err"] != null)
            {
                <div class="alert alert-danger fade-in">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span>@TempData["Err"]</span>
                </div>
            }

            @* EDICIÓN *@
            @if (subcat != null)
            {
                <form method="post" asp-controller="Panel" asp-action="EditarSubcategoria" id="formSubcatEdit" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="form-group">
                        <label for="Nombre" class="form-label">Nombre de la subcategoría</label>
                        <input type="text"
                               class="form-input"
                               id="Nombre"
                               name="nombresubCategoria"
                               placeholder="Ej.: Camisetas deportivas"
                               value="@subcat.NombreSubcategoria"
                               maxlength="100"
                               pattern=".*\S.*"
                               title="Escribe al menos un carácter no vacío."
                               required />
                        <div class="muted"><span id="count">0</span>/100 caracteres</div>
                    </div>

                    <input type="hidden" name="subcategoriaID" value="@subcat.SubcategoriaID" />

                    <div class="form-group">
                        <label for="CategoriaID" class="form-label">Categoría</label>
                        @if (categorias.Any())
                        {
                            <select id="CategoriaID" name="categoriaID" class="form-select" required>
                                <option value="">Seleccione una categoría</option>
                                @foreach (var c in categorias)
                                {
                                    <option value="@c.CategoriaID" selected="@(c.CategoriaID == subcat.CategoriaID)">
                                        @c.Nombre
                                    </option>
                                }
                            </select>
                        }
                        else
                        {
                            <select id="CategoriaID" name="categoriaID" class="form-select" disabled required>
                                <option value="">No hay categorías disponibles</option>
                            </select>
                            <div class="muted">Debes crear categorías primero (Panel → Categorías).</div>
                        }
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-floppy-disk"></i> Guardar cambios
                        </button>
                        <a asp-controller="Panel" asp-action="Subcategorias" class="btn btn-secondary">
                            <i class="fa-solid fa-xmark"></i> Cancelar
                        </a>
                    </div>
                </form>
            }
            else
            {
                @* CREACIÓN *@
                <form method="post" asp-controller="Panel" asp-action="AnadirSubcategoria" id="formSubcatCreate" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="form-group">
                        <label for="Nombre" class="form-label">Nombre de la subcategoría</label>
                        <input type="text"
                               class="form-input"
                               id="Nombre"
                               name="nombresubCategoria"
                               placeholder="Ej.: Camisetas deportivas"
                               maxlength="100"
                               pattern=".*\S.*"
                               title="Escribe al menos un carácter no vacío."
                               required />
                        <div class="muted"><span id="count">0</span>/100 caracteres</div>
                    </div>

                    <div class="form-group">
                        <label for="Categoria" class="form-label">Categoría</label>
                        @if (categorias.Any())
                        {
                            <select id="Categoria" name="categoriaID" class="form-select" required>
                                <option value="">Seleccione una categoría</option>
                                @foreach (var c in categorias)
                                {
                                    <option value="@c.CategoriaID">@c.Nombre</option>
                                }
                            </select>
                        }
                        else
                        {
                            <select id="Categoria" name="categoriaID" class="form-select" disabled required>
                                <option value="">No hay categorías disponibles</option>
                            </select>
                            <div class="muted">Debes crear categorías primero (Panel → Categorías).</div>
                        }
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i> Añadir subcategoría
                        </button>
                        <a asp-controller="Panel" asp-action="Subcategorias" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left"></i> Cancelar
                        </a>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
            // Elementos comunes (ambos formularios usan #Nombre y #count)
            const input = document.getElementById('Nombre');
            const counter = document.getElementById('count');
            const forms = [document.getElementById('formSubcatCreate'), document.getElementById('formSubcatEdit')].filter(Boolean);

            function updateCount(){
                if(!input || !counter) return;
                const len = (input.value || '').length;
                counter.textContent = len + '';
            }
            if(input){
                updateCount();
                input.addEventListener('input', updateCount);
                input.addEventListener('blur', () => { input.value = (input.value || '').trim(); updateCount(); });
            }

            // Evitar doble submit y añadir pequeña UX de "procesando"
            forms.forEach(form => {
                form.addEventListener('submit', function(e){
                    // Trim nombre
                    if (input) input.value = (input.value || '').trim();

                    // Validación nativa
                    if(!form.checkValidity()){
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Revisa los campos: el nombre es obligatorio (máx. 100) y debes seleccionar una categoría.');
                        return;
                    }

                    // Deshabilitar botones para evitar dobles envíos
                    const btns = form.querySelectorAll('button[type="submit"]');
                    btns.forEach(b => {
                        b.disabled = true;
                        const icon = b.querySelector('i');
                        if(icon) icon.className = 'fa-solid fa-circle-notch fa-spin';
                        b.lastChild && (b.lastChild.nodeType === 3) && (b.lastChild.textContent = ' Guardando...');
                    });
                }, { once:false });
            });
        })();
    </script>
}
