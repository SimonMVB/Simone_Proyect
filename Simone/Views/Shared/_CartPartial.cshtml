@model IEnumerable<Simone.Models.CarritoDetalle>
@using System.Globalization
@{
    var culture = CultureInfo.CreateSpecificCulture("es-EC");

    string Img(string? src) => string.IsNullOrWhiteSpace(src)
        ? Url.Content("~/images/Productos/default.jpg")
        : src!;

    // Escoge imagen de variante si existe; si no, la del producto
    string ImgFor(Simone.Models.CarritoDetalle it)
        => Img(it?.Variante?.ImagenPath ?? it?.Producto?.ImagenPath);

    decimal total = Model?.Sum(x => x.Precio * x.Cantidad) ?? 0m;
}

<div id="mini-cart" class="cart-partial">
    <h5 class="mb-3">Mis artículos</h5>
    <hr />

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info mb-0" role="alert">
            No tienes artículos en tu carrito.
        </div>
    }
    else
    {
        <!-- token global reutilizable para AJAX -->
        <form id="mini-cart-af" class="d-none" method="post">@Html.AntiForgeryToken()</form>

        <ul class="list-group">
            @foreach (var item in Model)
            {
                var p = item.Producto;
                var v = item.Variante; // puede ser null
                                       <li class="list-group-item" data-row data-id="@item.ProductoID" data-det-id="@item.CarritoDetalleID">
                                           <div class="row align-items-center g-2">
                                               <!-- Imagen (variante -> producto -> default) -->
                                               <div class="col-3">
                                                   <a asp-controller="Compras" asp-action="VerProducto" asp-route-productoID="@item.ProductoID">
                                                       <img src="@ImgFor(item)"
                                                            alt="@(p?.Nombre ?? "Producto")"
                                                            class="img-fluid rounded"
                                                            onerror="this.src='@Url.Content("~/images/Productos/default.jpg")';" />
                                                   </a>
                                               </div>

                        <!-- Detalles -->
                        <div class="col-6">
                            <h6 class="mb-1 text-truncate">
                                <a asp-controller="Compras" asp-action="VerProducto" asp-route-productoID="@item.ProductoID" class="text-decoration-none">
                                    @(p?.Nombre ?? "Producto")
                                </a>
                                @* Variante: [Color/Talla] *@
                                @if (v != null && (!string.IsNullOrWhiteSpace(v.Color) || !string.IsNullOrWhiteSpace(v.Talla)))
                                {
                                    <span class="text-muted small">
                                        [
                                        @if (!string.IsNullOrWhiteSpace(v.Color))
                                        {
                                            @v.Color
                                        }
             @if (!string.IsNullOrWhiteSpace(v.Color) && !string.IsNullOrWhiteSpace(v.Talla))
            {
                                            <text>/</text>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(v.Talla))
                                        {
                                            @v.Talla
                                        }
                                        ]
                                    </span>
                                }
                            </h6>

                            <div class="small text-muted">Cantidad: <span data-qty>@item.Cantidad</span></div>
                            <div class="small">Precio: @item.Precio.ToString("C", culture)</div>
                        </div>

                        <!-- Total y acciones -->
                        <div class="col-3 text-end">
                            <div class="mb-2 fw-semibold" data-subtotal>
                                @((item.Precio * item.Cantidad).ToString("C", culture))
                            </div>

                            <!-- Fallback clásico (si no hay JS) -->
                            <form asp-controller="Compras" asp-action="EliminarArticulo" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="carritoDetalleID" value="@item.CarritoDetalleID" />
                                <button type="submit" class="btn btn-sm btn-danger" title="Eliminar artículo">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </li>
            }
        </ul>

        <!-- Total general -->
        <div class="mt-3 text-end">
            <h5 class="mb-0">Total: <span id="mini-cart-total">@total.ToString("C", culture)</span></h5>
        </div>

        @if (User?.Identity?.IsAuthenticated == true)
        {
            <a href="@Url.Action("Resumen", "Compras")" class="btn btn-lg btn-success w-100 mt-3">
                <i class="fa fa-shopping-cart me-2"></i> Comprar Ahora
            </a>
        }
    }
</div>
