@model Simone.ViewModels.LoginViewModel
@{
    ViewData["Title"] = "Iniciar sesión";
    Layout = "~/Views/Shared/_LayoutCuenta.cshtml";
    var returnUrl = (string?)ViewData["ReturnUrl"] ?? "";
}

<div class="container py-5" style="max-width: 520px;">
    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-header text-center border-0 p-4" style="background: linear-gradient(135deg,#f9d5ec,#f4a7c1);">
            <h4 class="mb-0 text-white">
                <i class="fa-solid fa-right-to-bracket me-2"></i> Iniciar sesión
            </h4>
        </div>

        <div class="card-body p-4">

            @* Alertas *@
            @if (TempData["MensajeError"] is string err && !string.IsNullOrWhiteSpace(err))
            {
                <div class="alert alert-danger d-flex align-items-start" role="alert">
                    <i class="fa-solid fa-circle-exclamation me-2 mt-1"></i>
                    <div>@err</div>
                </div>
            }
            @if (TempData["MensajeExito"] is string ok && !string.IsNullOrWhiteSpace(ok))
            {
                <div class="alert alert-success d-flex align-items-start" role="alert">
                    <i class="fa-solid fa-circle-check me-2 mt-1"></i>
                    <div>@ok</div>
                </div>
            }

            <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

            <form asp-action="Login" method="post" id="formLogin" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="returnUrl" value="@returnUrl" />
                <input type="hidden" name="RequestID" value="@ViewData["RequestID"]" />

                <!-- Email -->
                <div class="mb-3">
                    <label asp-for="Email" class="form-label">Correo electrónico</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                        <input asp-for="Email"
                               type="email"
                               class="form-control"
                               placeholder="usuario@correo.com"
                               inputmode="email"
                               autocomplete="username"
                               required />
                    </div>
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <!-- Password -->
                <div class="mb-1">
                    <label asp-for="Password" class="form-label">Contraseña</label>
                    <div class="input-group" id="grpPwd">
                        <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                        <input asp-for="Password"
                               type="password"
                               class="form-control"
                               placeholder="••••••••"
                               autocomplete="current-password"
                               required />
                        <button class="btn btn-outline-secondary" type="button" id="btnTogglePwd" title="Mostrar/ocultar">
                            <i class="fa-regular fa-eye"></i>
                        </button>
                    </div>
                    <div id="capsWarn" class="form-text text-warning d-none">
                        <i class="fa-solid fa-unlock-keyhole me-1"></i> Bloq Mayús está activado.
                    </div>
                    <span asp-validation-for="Password" class="text-danger small"></span>
                </div>

                <!-- Remember / Forgot -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="form-check">
                        <input asp-for="RememberMe" class="form-check-input" />
                        <label asp-for="RememberMe" class="form-check-label">Recordarme</label>
                    </div>
                    <div>
                        <a asp-controller="Cuenta" asp-action="OlvidoPassword" class="link-secondary small">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                </div>

                <!-- Botón -->
                <button type="submit" class="btn w-100 py-2 fw-semibold text-white" id="btnLogin"
                        style="background-color:#f4a7c1; border-color:#f4a7c1;">
                    <span class="me-2"><i class="fa-solid fa-arrow-right-to-bracket"></i></span> Ingresar
                </button>
            </form>
        </div>

        <div class="card-footer text-center small bg-white">
            ¿No tienes una cuenta?
            <a asp-controller="Cuenta" asp-action="Registrar" class="fw-semibold" style="color:#f4a7c1;">
                Regístrate aquí
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('formLogin');
            const btn  = document.getElementById('btnLogin');
            const pwd  = document.getElementById('@Html.IdFor(m => m.Password)');
            const toggle = document.getElementById('btnTogglePwd');
            const capsWarn = document.getElementById('capsWarn');

            // Mostrar/ocultar contraseña
            toggle?.addEventListener('click', (e) => {
                e.preventDefault();
                const isPwd = pwd.getAttribute('type') === 'password';
                pwd.setAttribute('type', isPwd ? 'text' : 'password');
                const i = toggle.querySelector('i');
                i.classList.toggle('fa-eye');
                i.classList.toggle('fa-eye-slash');
            });

            // Detector de CapsLock
            const handleCaps = (evt) => {
                const caps = evt.getModifierState && evt.getModifierState('CapsLock');
                capsWarn.classList.toggle('d-none', !caps);
            };
            ['keyup','keydown'].forEach(ev => pwd.addEventListener(ev, handleCaps));

            // Habilitar/deshabilitar por validez
            const toggleSubmit = () => {
                let valid = form.checkValidity();
                if (window.jQuery && $.validator && $(form).data('validator')) {
                    valid = valid && $(form).valid();
                }
                btn.disabled = !valid;
            };

            // Validación en vivo
            ['input','change','keyup','blur'].forEach(evt => {
                form.addEventListener(evt, toggleSubmit, true);
            });

            // Estado inicial
            toggleSubmit();

            // Evitar doble envío
            form.addEventListener('submit', function () {
                if (window.jQuery && $.validator && !$(form).valid()) return;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Ingresando...';
            }, { once: true });

            // Rehabilitar al navegar atrás
            window.addEventListener('pageshow', () => {
                btn.disabled = false;
                btn.innerHTML = '<span class="me-2"><i class="fa-solid fa-arrow-right-to-bracket"></i></span> Ingresar';
            });
        })();
    </script>

    <style>
        .input-group-text {
            background: #fff;
        }

        .form-control:focus {
            border-color: #f4a7c1;
            box-shadow: 0 0 0 .25rem rgba(244,167,193,.25);
        }

        .btn:disabled {
            opacity: .65;
        }

        a.link-secondary {
            text-decoration: none;
        }

            a.link-secondary:hover {
                text-decoration: underline;
            }
    </style>
}
