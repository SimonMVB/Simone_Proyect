@model Simone.ViewModels.RegistroViewModel
@{
    ViewData["Title"] = "Registro";
    Layout = "~/Views/Shared/_LayoutCuenta.cshtml";
}

<div class="container py-5" style="max-width: 560px;">
    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-header text-center border-0 p-4" style="background: linear-gradient(135deg,#f7cadb,#f4a7c1);">
            <h4 class="mb-0 text-white">
                <i class="fa-solid fa-user-plus me-2"></i> Crear una cuenta
            </h4>
        </div>

        <div class="card-body p-4">
            @* mensajes *@
            @if (TempData["MensajeError"] is string err && !string.IsNullOrWhiteSpace(err))
            {
                <div class="alert alert-danger d-flex align-items-start" role="alert">
                    <i class="fa-solid fa-circle-exclamation me-2 mt-1"></i>
                    <div>@err</div>
                </div>
            }
            @if (TempData["MensajeExito"] is string ok && !string.IsNullOrWhiteSpace(ok))
            {
                <div class="alert alert-success d-flex align-items-start" role="alert">
                    <i class="fa-solid fa-circle-check me-2 mt-1"></i>
                    <div>@ok</div>
                </div>
            }

            @* errores del modelo *@
            <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

            <form asp-action="Registrar" method="post" id="formRegistro" novalidate>
                @Html.AntiForgeryToken()

                <!-- Nombre -->
                <div class="mb-3">
                    <label asp-for="Nombre" class="form-label">Nombre completo</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                        <input asp-for="Nombre"
                               class="form-control"
                               placeholder="Nombre y apellidos"
                               autocomplete="name"
                               required />
                    </div>
                    <span asp-validation-for="Nombre" class="text-danger small"></span>
                </div>

                <!-- Cédula -->
                <div class="mb-3">
                    <label asp-for="Cedula" class="form-label">Cédula</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-id-card"></i></span>
                        <input asp-for="Cedula"
                               class="form-control"
                               placeholder="10 dígitos"
                               inputmode="numeric"
                               pattern="\d{10}"
                               maxlength="10"
                               autocomplete="off"
                               aria-describedby="cedHelp"
                               required />
                    </div>
                    <div id="cedHelp" class="form-text">Solo números, exactamente 10 dígitos.</div>
                    <span asp-validation-for="Cedula" class="text-danger small"></span>
                </div>

                <!-- Email -->
                <div class="mb-3">
                    <label asp-for="Email" class="form-label">Correo electrónico</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                        <input asp-for="Email"
                               class="form-control"
                               placeholder="correo@ejemplo.com"
                               inputmode="email"
                               autocomplete="username email"
                               required />
                    </div>
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <!-- Teléfono -->
                <div class="mb-3">
                    <label asp-for="Telefono" class="form-label">Número de celular</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-phone"></i></span>
                        <input asp-for="Telefono"
                               class="form-control"
                               placeholder="0999999999"
                               inputmode="numeric"
                               pattern="\d{9,10}"
                               maxlength="10"
                               autocomplete="tel-national"
                               aria-describedby="telHelp" />
                    </div>
                    <div id="telHelp" class="form-text">Solo dígitos, 9–10 caracteres.</div>
                    <span asp-validation-for="Telefono" class="text-danger small"></span>
                </div>

                <!-- Dirección -->
                <div class="mb-3">
                    <label asp-for="Direccion" class="form-label">Dirección</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                        <input asp-for="Direccion"
                               class="form-control"
                               placeholder="Calle principal y Nro."
                               autocomplete="street-address" />
                    </div>
                    <span asp-validation-for="Direccion" class="text-danger small"></span>
                </div>

                <!-- Ciudad -->
                <div class="mb-3">
                    <label asp-for="Ciudad" class="form-label">Ciudad</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-city"></i></span>
                        <input asp-for="Ciudad"
                               class="form-control"
                               placeholder="Selecciona tu ciudad"
                               autocomplete="address-level2"
                               readonly
                               required />
                        <button class="btn btn-outline-secondary"
                                type="button"
                                data-bs-toggle="offcanvas"
                                data-bs-target="#offProvinciaCiudad"
                                title="Elegir provincia y ciudad">
                            <i class="fa-solid fa-magnifying-glass-location"></i>
                        </button>
                    </div>
                    <span asp-validation-for="Ciudad" class="text-danger small"></span>
                </div>

                <!-- Provincia -->
                <div class="mb-3">
                    <label asp-for="Provincia" class="form-label">Provincia</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-map"></i></span>
                        <input asp-for="Provincia"
                               class="form-control"
                               placeholder="Selecciona tu provincia"
                               autocomplete="address-level1"
                               readonly
                               required />
                        <button class="btn btn-outline-secondary"
                                type="button"
                                data-bs-toggle="offcanvas"
                                data-bs-target="#offProvinciaCiudad"
                                title="Elegir provincia y ciudad">
                            <i class="fa-solid fa-list"></i>
                        </button>
                    </div>
                    <span asp-validation-for="Provincia" class="text-danger small"></span>
                </div>

                <!-- Referencia -->
                <div class="mb-3">
                    <label asp-for="Referencia" class="form-label">Referencia (opcional)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-map-pin"></i></span>
                        <input asp-for="Referencia"
                               class="form-control"
                               placeholder="Casa blanca con portón azul" />
                    </div>
                    <span asp-validation-for="Referencia" class="text-danger small"></span>
                </div>

                <!-- Contraseña -->
                <div class="mb-2">
                    <label asp-for="Password" class="form-label">Contraseña</label>
                    <div class="input-group" data-pass>
                        <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                        <input asp-for="Password"
                               type="password"
                               class="form-control"
                               placeholder="••••••••"
                               autocomplete="new-password"
                               aria-describedby="pwdHelp"
                               required />
                        <button class="btn btn-outline-secondary" type="button" data-pass-toggle title="Mostrar/ocultar">
                            <i class="fa-regular fa-eye"></i>
                        </button>
                    </div>
                    <div class="progress mt-2" style="height:6px;">
                        <div class="progress-bar" role="progressbar" style="width:0%" id="pwdMeter"></div>
                    </div>
                    <small id="pwdHelp" class="form-text text-muted">
                        Usa 8+ caracteres, mayúsculas, minúsculas, números y símbolos.
                    </small>
                    <span asp-validation-for="Password" class="text-danger small d-block"></span>
                </div>

                <!-- Confirmar Contraseña -->
                <div class="mb-3">
                    <label asp-for="ConfirmPassword" class="form-label">Confirmar contraseña</label>
                    <div class="input-group" data-pass2>
                        <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                        <input asp-for="ConfirmPassword"
                               type="password"
                               class="form-control"
                               placeholder="••••••••"
                               autocomplete="new-password"
                               required />
                        <button class="btn btn-outline-secondary" type="button" data-pass2-toggle title="Mostrar/ocultar">
                            <i class="fa-regular fa-eye"></i>
                        </button>
                    </div>
                    <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                </div>

                <!-- Botón -->
                <button type="submit" class="btn w-100 py-2 fw-semibold text-white" id="btnRegistrar"
                        style="background-color:#f4a7c1; border-color:#f4a7c1;">
                    <span class="me-2"><i class="fa-solid fa-user-plus"></i></span> Registrarme
                </button>
            </form>
        </div>

        <div class="card-footer text-center small bg-white">
            ¿Ya tienes una cuenta?
            <a asp-controller="Cuenta" asp-action="Login" class="fw-semibold" style="color:#f4a7c1;">
                Inicia sesión aquí
            </a>
        </div>
    </div>
</div>

<!-- Offcanvas Provincia/Ciudad -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offProvinciaCiudad" aria-labelledby="offProvinciaCiudadLabel">
    <div class="offcanvas-header">
        <h5 id="offProvinciaCiudadLabel" class="mb-0">
            <i class="fa-solid fa-location-dot me-2"></i> Selecciona provincia y ciudad
        </h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
        <div class="row g-3">
            <div class="col-12 col-md-5">
                <div class="mb-2 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-map text-muted"></i>
                    <input type="text" class="form-control form-control-sm" id="searchProv" placeholder="Filtrar provincias..." />
                </div>
                <div class="list-group small" id="provList" style="max-height: 60vh; overflow:auto;"></div>
            </div>
            <div class="col-12 col-md-7">
                <div class="mb-2 d-flex align-items-center gap-2">
                    <i class="fa-solid fa-city text-muted"></i>
                    <input type="text" class="form-control form-control-sm" id="searchCity" placeholder="Filtrar ciudades..." disabled />
                </div>
                <div class="list-group small" id="cityList" style="max-height: 60vh; overflow:auto;">
                    <div class="text-muted ps-2">Elige primero una provincia.</div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('formRegistro');
            const btn  = document.getElementById('btnRegistrar');
            const tel  = document.getElementById('@Html.IdFor(m => m.Telefono)');
            const ced  = document.getElementById('@Html.IdFor(m => m.Cedula)');
            const pwd  = document.getElementById('@Html.IdFor(m => m.Password)');
            const pwd2 = document.getElementById('@Html.IdFor(m => m.ConfirmPassword)');
            const meter= document.getElementById('pwdMeter');

            // Habilitar/deshabilitar por validez
            const toggleSubmit = () => {
                let valid = form.checkValidity();
                if (window.jQuery && $.validator && $(form).data('validator')) {
                    valid = valid && $(form).valid();
                }
                btn.disabled = !valid;
            };

            // Solo dígitos en Cédula (10) y Teléfono (máx 10)
            if (ced) {
                ced.addEventListener('input', () => {
                    const digits = (ced.value || '').replace(/\D+/g, '').slice(0, 10);
                    if (ced.value !== digits) ced.value = digits;
                    ced.setCustomValidity(digits.length === 10 ? '' : 'La cédula debe tener 10 dígitos.');
                });
            }
            if (tel) {
                tel.addEventListener('input', () => {
                    tel.value = (tel.value || '').replace(/\D+/g, '').slice(0, 10);
                });
            }

            // Medidor de contraseña
            function scorePassword(v) {
                let s = 0; if (!v) return 0;
                if (v.length >= 8) s += 20;
                if (/[a-z]/.test(v)) s += 20;
                if (/[A-Z]/.test(v)) s += 20;
                if (/\d/.test(v))   s += 20;
                if (/[^A-Za-z0-9]/.test(v)) s += 20;
                return Math.min(s, 100);
            }
            function updateMeter() {
                const s = scorePassword(pwd.value);
                meter.style.width = s + '%';
                meter.className = 'progress-bar';
                if (s < 40) meter.classList.add('bg-danger');
                else if (s < 70) meter.classList.add('bg-warning');
                else meter.classList.add('bg-success');
            }

            // Mostrar/ocultar contraseña
            const toggleType = (input, btn) => {
                const isPwd = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPwd ? 'text' : 'password');
                const icon = btn.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            };
            document.querySelector('[data-pass-toggle]')?.addEventListener('click', (e) => {
                e.preventDefault();
                toggleType(pwd, e.currentTarget);
            });
            document.querySelector('[data-pass2-toggle]')?.addEventListener('click', (e) => {
                e.preventDefault();
                toggleType(pwd2, e.currentTarget);
            });

            // Validación en vivo
            ['input', 'change', 'keyup', 'blur'].forEach(evt => {
                form.addEventListener(evt, () => {
                    updateMeter();
                    toggleSubmit();
                }, true);
            });

            // ====== Provincia / Ciudad (Offcanvas) ======
            const inProv  = document.getElementById('@Html.IdFor(m => m.Provincia)');
            const inCity  = document.getElementById('@Html.IdFor(m => m.Ciudad)');
            const provList= document.getElementById('provList');
            const cityList= document.getElementById('cityList');
            const sProv   = document.getElementById('searchProv');
            const sCity   = document.getElementById('searchCity');
            let selectedProv = null;

            // Catálogo Ecuador (muestra base; si tienes JSON propio lo integramos en 1 paso)
            const EC_PROVINCIAS = {
                "Azuay": ["Cuenca","Gualaceo","Paute","Sígsig","Chordeleg","Nabón","Sevilla de Oro","Santa Isabel","Oña","Camilo Ponce Enríquez"],
                "Bolívar": ["Guaranda","Chillanes","Chimbo","Echeandía","San Miguel","Caluma","Las Naves"],
                "Cañar": ["Azogues","Biblián","Cañar","La Troncal","El Tambo","Déleg","Suscal"],
                "Carchi": ["Tulcán","Montúfar (San Gabriel)","Mira","Espejo (El Ángel)","Bolívar","Huaca"],
                "Chimborazo": ["Riobamba","Alausí","Colta","Chambo","Guamote","Guano","Pallatanga","Penipe"],
                "Cotopaxi": ["Latacunga","La Maná","Pujilí","Salcedo","Saquisilí","Sigchos"],
                "El Oro": ["Machala","Arenillas","Atahualpa","Balsas","Chilla","El Guabo","Huaquillas","Las Lajas","Marcabelí","Pasaje","Piñas","Portovelo","Santa Rosa","Zaruma"],
                "Esmeraldas": ["Esmeraldas","Atacames","Eloy Alfaro (San Lorenzo)","Muisne","Quinindé","Rioverde"],
                "Galápagos": ["Puerto Ayora","Puerto Baquerizo Moreno","Puerto Villamil"],
                "Guayas": ["Guayaquil","Daule","Samborondón","Durán","Milagro","Playas","Naranjal","Balao","Bucay","El Empalme","Salitre","Pedro Carbo","Yaguachi","Colimes","Isidro Ayora","Simón Bolívar","General Antonio Elizalde"],
                "Imbabura": ["Ibarra","Atuntaqui (Antonio Ante)","Otavalo","Cotacachi","Pimampiro","Urcuquí"],
                "Loja": ["Loja","Catamayo","Cariamanga (Calvas)","Catacocha (Paltas)","Cariamanga","Macará","Saraguro","Gonzanamá","Celica","Pindal","Zapotillo"],
                "Los Ríos": ["Babahoyo","Quevedo","Ventanas","Vinces","Buena Fe","Mocache","Puebloviejo","Urdaneta","Montalvo","Quinsaloma","Palenque"],
                "Manabí": ["Portoviejo","Manta","Chone","Jipijapa","Montecristi","Rocafuerte","El Carmen","Santa Ana","Bahía de Caráquez (Sucre)","Pedernales","Tosagua","Paján","24 de Mayo","Jama","San Vicente","Olmedo","Flavio Alfaro","Jaramijó","Puerto López"],
                "Morona Santiago": ["Macas (Morona)","Gualaquiza","Sucúa","Huamboya","Santiago de Méndez","Logroño","Pablo Sexto","Palora","Taisha"],
                "Napo": ["Tena","Archidona","El Chaco","Quijos","Carlos Julio Arosemena Tola"],
                "Orellana": ["Coca (Francisco de Orellana)","Aguarico","La Joya de los Sachas","Loreto"],
                "Pastaza": ["Puyo (Pastaza)","Mera","Santa Clara","Arajuno"],
                "Pichincha": ["Quito","Cayambe","Mejía (Machachi)","Pedro Moncayo (Tabacundo)","Pedro Vicente Maldonado","Puerto Quito","Rumiñahui (Sangolquí)"],
                "Santa Elena": ["La Libertad","Salinas","Santa Elena"],
                "Santo Domingo de los Tsáchilas": ["Santo Domingo","La Concordia"],
                "Sucumbíos": ["Nueva Loja (Lago Agrio)","Cascales","Cuyabeno","Gonzalo Pizarro","Putumayo","Shushufindi","Sucumbíos"],
                "Tungurahua": ["Ambato","Baños de Agua Santa","Cevallos","Mocha","Patate","Quero","San Pedro de Pelileo","Tisaleo"],
                "Zamora Chinchipe": ["Zamora","Yantzaza","Yacuambi","El Pangui","Centinela del Cóndor","Palanda","Paquisha","Chinchipe","Nangaritza"]
            };

            // Render inicial
            function renderProvinces(filter = '') {
                const q = (filter || '').toLowerCase();
                provList.innerHTML = '';
                Object.keys(EC_PROVINCIAS).sort().forEach(p => {
                    if (q && !p.toLowerCase().includes(q)) return;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'list-group-item list-group-item-action';
                    btn.textContent = p;
                    btn.dataset.prov = p;
                    if (selectedProv === p) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        selectedProv = p;
                        renderProvinces(sProv.value);
                        renderCities('', p);
                        sCity.disabled = false;
                        sCity.focus();
                    });
                    provList.appendChild(btn);
                });
                if (!provList.children.length) {
                    provList.innerHTML = '<div class="text-muted ps-2">Sin resultados.</div>';
                }
            }
            function renderCities(filter = '', prov = selectedProv) {
                cityList.innerHTML = '';
                if (!prov) {
                    cityList.innerHTML = '<div class="text-muted ps-2">Elige primero una provincia.</div>';
                    return;
                }
                const q = (filter || '').toLowerCase();
                const cities = (EC_PROVINCIAS[prov] || []).filter(c => !q || c.toLowerCase().includes(q));
                if (!cities.length) {
                    cityList.innerHTML = '<div class="text-muted ps-2">Sin resultados en ' + prov + '.</div>';
                    return;
                }
                cities.forEach(c => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'list-group-item list-group-item-action';
                    btn.textContent = c;
                    btn.addEventListener('click', () => {
                        setUbicacion(prov, c);
                        closeOffcanvas();
                    });
                    cityList.appendChild(btn);
                });
            }
            function setUbicacion(prov, city) {
                if (inProv) inProv.value = prov || '';
                if (inCity) inCity.value = city || '';
                // Validar requeridos
                if (inProv) inProv.reportValidity?.();
                if (inCity) inCity.reportValidity?.();
                toggleSubmit();
            }
            function closeOffcanvas() {
                const el = document.getElementById('offProvinciaCiudad');
                if (!el) return;
                const inst = bootstrap.Offcanvas.getOrCreateInstance(el);
                inst.hide();
            }

            // Filtros
            sProv?.addEventListener('input', () => renderProvinces(sProv.value));
            sCity?.addEventListener('input', () => renderCities(sCity.value));

            // Abrir slide: precargar estado actual
            document.querySelectorAll('[data-bs-target="#offProvinciaCiudad"]').forEach(btnOpen => {
                btnOpen.addEventListener('click', () => {
                    // Si ya hay valores en inputs, mantener selección
                    selectedProv = (inProv?.value || '') || null;
                    renderProvinces(sProv?.value || '');
                    renderCities(sCity?.value || '');
                });
            });

            // Estado inicial
            updateMeter();
            toggleSubmit();

            // Evita doble envío
            form.addEventListener('submit', function () {
                if (window.jQuery && $.validator && !$(form).valid()) return;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Registrando...';
            }, { once: true });
        })();
    </script>

    <style>
        .input-group-text {
            background: #fff;
        }

        .form-control:focus {
            border-color: #f4a7c1;
            box-shadow: 0 0 0 .25rem rgba(244,167,193,.25);
        }

        .btn:disabled {
            opacity: .65;
        }

        /* Offcanvas UI */
        #offProvinciaCiudad .list-group-item.active {
            background-color: #f4a7c1;
            border-color: #f4a7c1;
        }

        #offProvinciaCiudad .form-control:focus {
            border-color: #f4a7c1;
            box-shadow: 0 0 0 .2rem rgba(244,167,193,.2);
        }
    </style>
}
