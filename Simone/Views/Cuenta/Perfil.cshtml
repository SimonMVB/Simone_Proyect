@model Simone.Models.Usuario

@{
    ViewData["Title"] = "Mi Perfil";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --peach: #FFC89C;
        --peach-200: #ffe3c7;
        --peach-50: #fff6ec;
        --ink: #1a1a1a;
        --muted: #6b7280;
        --bg: #f7f7fa;
    }

    body, .profile-main-bg {
        background: var(--bg);
    }

    .profile-card {
        background: #fff;
        border-radius: 1.2rem;
        box-shadow: 0 2px 16px #1111,0 .5px 2px #6366f120;
        padding: 2rem 2.3rem 1.4rem;
        margin: 2rem auto;
        max-width: 680px;
        transition: box-shadow .3s
    }

        .profile-card:hover {
            box-shadow: 0 8px 48px #3232462e
        }

    .profile-header h2 {
        font-weight: 800;
        color: var(--ink);
        font-size: 2.1rem
    }

    .profile-header i {
        color: #ffb88b
    }

    .profile-subtitle {
        font-size: 1.02rem;
        color: #a1a1aa;
        margin-bottom: 1.1rem;
        font-weight: 500
    }

    .profile-alert {
        border-radius: 1rem;
        font-size: 1.05rem;
        margin-bottom: 1.2rem
    }

    .profile-avatar-container {
        display: flex;
        align-items: center;
        gap: 1.4rem;
        margin-bottom: 2.1rem
    }

    .avatar-wrapper {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #fff5ee;
        border: 2px solid #ffd5b2;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative
    }

    .profile-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%
    }

    .avatar-placeholder {
        color: #ffd1b1;
        font-size: 2.7rem;
        text-align: center;
        width: 100%
    }

    .avatar-upload {
        display: flex;
        flex-direction: column;
        gap: .25rem;
        align-items: flex-start;
        flex: 1
    }

    .upload-btn, .btn-outline-primary {
        font-weight: 600;
        border-radius: 1.2rem;
        padding: .35rem 1.2rem;
        border: 1.5px solid var(--peach);
        color: #d97706;
        background: var(--peach-50);
        transition: background .13s,color .13s
    }

        .upload-btn:hover, .btn-outline-primary:hover {
            background: var(--peach);
            color: #111
        }

    .btn-outline-danger {
        border-radius: 1.2rem;
        background: #fff;
        color: #dc2626;
        border-color: #fecaca;
        padding: .35rem 1.2rem
    }

        .btn-outline-danger:hover {
            background: #fecaca;
            color: #7f1d1d
        }

    .upload-hint {
        font-size: .86rem;
        color: #bca389;
        margin-left: .2rem
    }

    .profile-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.18rem 1.2rem;
        margin-bottom: 1.45rem
    }

    .profile-tabs {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1.5rem
    }

    .profile-tab {
        padding: .5rem 1rem;
        border: none;
        background: none;
        color: #6b7280;
        font-weight: 600;
        border-radius: .5rem .5rem 0 0;
        margin-right: .5rem;
        transition: all .2s
    }

        .profile-tab.active {
            color: #ea580c;
            border-bottom: 2px solid #ea580c;
            background: #fff7ed
        }

        .profile-tab:hover:not(.active) {
            color: #9a3412;
            background: #ffedd5
        }

    .form-label {
        font-weight: 600;
        color: #e57736;
        margin-bottom: .5rem
    }

    .input-group-text {
        background: var(--peach-50);
        color: #ffb87d;
        border-radius: 1.1rem 0 0 1.1rem;
        border-right: 0;
        border: 1.5px solid var(--peach-200)
    }

    .form-control, .form-control:focus {
        border-radius: 0 1.1rem 1.1rem 0;
        box-shadow: none;
        border: 1.5px solid var(--peach-200)
    }

        .form-control:focus, .btn:focus, .input-group-text:focus {
            border-color: var(--peach) !important;
            box-shadow: 0 0 0 .25rem rgba(255,200,156,.25) !important
        }

    .form-error {
        color: #dc2626;
        font-size: .97rem;
        margin-top: .25rem;
        display: block
    }

    .status-icon.active i {
        color: #16a34a !important
    }

    .status-icon.inactive i {
        color: #ef4444 !important
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem
    }

    .save-btn {
        font-weight: 700;
        border-radius: 1.3rem;
        padding: .65rem 1.5rem;
        background: var(--peach);
        color: #1a1a1a;
        border: none;
        box-shadow: 0 1.5px 6px #FFD7AE33;
        transition: background .16s,color .16s
    }

        .save-btn:disabled {
            opacity: .7;
            pointer-events: none
        }

    .btn-outline-secondary {
        border-radius: 1.3rem;
        color: #888;
        border: 1.5px solid #e5e7eb;
        background: #fff
    }

        .btn-outline-secondary:hover {
            background: #f3f4f6;
            color: #333
        }

    .tab-content {
        display: none
    }

        .tab-content.active {
            display: block
        }

    .activity-item {
        padding: .75rem 0;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 1rem
    }

    .activity-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: #ffedd5;
        color: #ea580c;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0
    }

    .activity-time {
        font-size: .75rem;
        color: #6b7280
    }

    .progress {
        background: #f1f5f9
    }

    @@media (max-width:680px) {
        .profile-card {
            padding: 1.2rem 1rem;
            margin: 1rem auto
        }

        .profile-form-grid {
            grid-template-columns: 1fr
        }

        .profile-avatar-container {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem
        }

        .avatar-wrapper {
            width: 84px;
            height: 84px
        }
    }
</style>

<div class="profile-main-bg">
    <div class="profile-card">
        <div class="profile-header text-center mb-2">
            <h2><i class="fas fa-user-circle me-1" aria-hidden="true"></i> Mi Perfil</h2>
            <div class="profile-subtitle">Administra tu información personal</div>
        </div>

        <div class="profile-tabs" role="tablist" aria-label="Secciones de perfil">
            <button class="profile-tab active" data-tab="personal" role="tab" aria-selected="true">Información Personal</button>
            <button class="profile-tab" data-tab="security" role="tab" aria-selected="false">Seguridad</button>
            <button class="profile-tab" data-tab="activity" role="tab" aria-selected="false">Actividad</button>
        </div>

        <div class="profile-body">
            @if (TempData["MensajeExito"] != null || TempData["MensajeError"] != null)
            {
                var alertClass = TempData["MensajeExito"] != null ? "alert-success" : "alert-danger";
                var iconClass = TempData["MensajeExito"] != null ? "fa-circle-check" : "fa-circle-exclamation";
                <div class="profile-alert alert @alertClass alert-dismissible fade show" role="alert">
                    <i class="fas @iconClass me-2" aria-hidden="true"></i>
                    <span>@(TempData["MensajeExito"] ?? TempData["MensajeError"])</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            }

            <!-- Pestaña: Información personal -->
            <div id="personal-tab" class="tab-content active" role="tabpanel" aria-labelledby="personal">
                <form asp-action="ActualizarPerfil" asp-controller="Cuenta" method="post" enctype="multipart/form-data" id="formPerfil" class="needs-validation" novalidate>
                    @Html.AntiForgeryToken()
                    <!-- No usamos el Id posteado en servidor, pero no estorba si existe -->
                    <input asp-for="Id" type="hidden" />

                    <div class="profile-avatar-container">
                        <div class="avatar-wrapper">
                            @if (!string.IsNullOrEmpty(Model.FotoPerfil))
                            {
                                <img src="@Model.FotoPerfil"
                                     class="profile-avatar"
                                     loading="lazy"
                                     alt="Foto de perfil"
                                     onerror="this.style.display='none'; this.closest('.avatar-wrapper').querySelector('.avatar-placeholder').classList.remove('d-none');" />
                            }
                            <div class="avatar-placeholder @(Model?.FotoPerfil == null ? "" : "d-none")" aria-hidden="true">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>

                        <div class="avatar-upload">
                            <label for="ImagenPerfil" class="upload-btn mb-1" tabindex="0">
                                <i class="fas fa-camera me-2" aria-hidden="true"></i> Cambiar foto
                            </label>
                            <input type="file" id="ImagenPerfil" name="ImagenPerfil" accept="image/jpeg,image/png,image/webp" class="d-none" aria-label="Seleccionar imagen de perfil" />
                            <button type="button" id="btnEliminarFoto" class="btn btn-outline-danger btn-sm mb-1 @(string.IsNullOrEmpty(Model.FotoPerfil) ? "d-none" : "")">
                                <i class="fas fa-trash me-2" aria-hidden="true"></i> Eliminar
                            </button>
                            <div class="upload-hint">Formatos: JPG, PNG, WEBP (máx 5MB)</div>
                        </div>
                    </div>

                    <div class="profile-form-grid">
                        <div class="form-group">
                            <label asp-for="NombreCompleto" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user" aria-hidden="true"></i></span>
                                <input asp-for="NombreCompleto" class="form-control" placeholder="Nombre completo" autocomplete="name" />
                            </div>
                            <span asp-validation-for="NombreCompleto" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Email" class="form-label">Correo electrónico</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope" aria-hidden="true"></i></span>
                                <input asp-for="Email" class="form-control" placeholder="Correo electrónico" readonly />
                            </div>
                            <small class="text-muted">Para cambiar tu correo, contacta al administrador.</small>
                        </div>

                        <!-- CÉDULA (10 dígitos) -->
                        <div class="form-group">
                            <label asp-for="Cedula" class="form-label">Cédula</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card" aria-hidden="true"></i></span>
                                <input asp-for="Cedula"
                                       class="form-control"
                                       placeholder="10 dígitos"
                                       inputmode="numeric"
                                       pattern="\d{10}"
                                       maxlength="10"
                                       aria-describedby="cedulaHelp" />
                            </div>
                            <small id="cedulaHelp" class="text-muted">Solo números, exactamente 10 dígitos.</small>
                            <span asp-validation-for="Cedula" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Telefono" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone" aria-hidden="true"></i></span>
                                <input asp-for="Telefono" class="form-control" placeholder="09xxxxxxxx" maxlength="15" inputmode="tel" autocomplete="tel" />
                            </div>
                            <span asp-validation-for="Telefono" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Direccion" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt" aria-hidden="true"></i></span>
                                <input asp-for="Direccion" class="form-control" placeholder="Dirección completa" autocomplete="street-address" />
                            </div>
                            <span asp-validation-for="Direccion" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Ciudad" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-city" aria-hidden="true"></i></span>
                                <input asp-for="Ciudad" class="form-control" placeholder="Ciudad" autocomplete="address-level2" />
                            </div>
                            <span asp-validation-for="Ciudad" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Provincia" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-globe-americas" aria-hidden="true"></i></span>
                                <input asp-for="Provincia" class="form-control" placeholder="Provincia" autocomplete="address-level1" />
                            </div>
                            <span asp-validation-for="Provincia" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="Referencia" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-info-circle" aria-hidden="true"></i></span>
                                <input asp-for="Referencia" class="form-control" placeholder="Punto de referencia" autocomplete="off" />
                            </div>
                            <span asp-validation-for="Referencia" class="form-error"></span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Rol actual</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user-tag" aria-hidden="true"></i></span>
                                <input value="@ViewBag.RolUsuario" class="form-control" readonly />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fecha de registro</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar-alt" aria-hidden="true"></i></span>
                                <input value="@Model.FechaRegistro.ToString("dd/MM/yyyy")" class="form-control" readonly />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-circle" aria-hidden="true"></i></span>
                                <input value="@(Model.Activo ? "Activo" : "Inactivo")" class="form-control" readonly />
                                <span class="input-group-text status-icon @(Model.Activo ? "active" : "inactive")" aria-hidden="true">
                                    <i class="fas @(Model.Activo ? "fa-check" : "fa-times")"></i>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <a asp-action="Index" asp-controller="Home" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2" aria-hidden="true"></i> Cancelar
                        </a>
                        <button type="submit" class="save-btn" id="btnPerfil">
                            <i class="fas fa-save me-2" aria-hidden="true"></i>
                            <span class="btn-text">Guardar cambios</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Pestaña: Seguridad -->
            <div id="security-tab" class="tab-content" role="tabpanel" aria-labelledby="security">
                <div class="mb-4">
                    <h5 class="mb-3"><i class="fas fa-shield-alt me-2" aria-hidden="true"></i> Seguridad de la cuenta</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                        <div>
                            <h6 class="mb-1">Contraseña</h6>
                            <p class="mb-0 text-muted">Mantén tu cuenta protegida</p>
                        </div>
                        <button class="btn btn-outline-primary" id="btnCambiarPassword">
                            <i class="fas fa-key me-2" aria-hidden="true"></i> Cambiar
                        </button>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        Te recomendamos una contraseña de al menos 12 caracteres con mayúsculas, minúsculas y números.
                    </div>
                </div>

                <div id="passwordForm" class="d-none">
                    <h5 class="mb-3"><i class="fas fa-key me-2" aria-hidden="true"></i> Cambiar contraseña</h5>
                    <form id="changePasswordForm" method="post" asp-action="CambiarPassword" asp-controller="Cuenta" novalidate>
                        @Html.AntiForgeryToken()

                        <div class="form-group mb-3">
                            <label for="CurrentPassword" class="form-label">Contraseña actual</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock" aria-hidden="true"></i></span>
                                <input type="password" class="form-control" id="CurrentPassword" name="CurrentPassword" autocomplete="current-password" required />
                                <button class="btn btn-outline-secondary toggle-password" type="button" aria-label="Mostrar/ocultar contraseña"><i class="fas fa-eye"></i></button>
                            </div>
                            <div id="capsWarnCurrent" class="form-text text-warning d-none">
                                <i class="fa-solid fa-unlock-keyhole me-1"></i> Bloq Mayús está activado.
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="NewPassword" class="form-label">Nueva contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock" aria-hidden="true"></i></span>
                                <input type="password" class="form-control" id="NewPassword" name="NewPassword" autocomplete="new-password" required />
                                <button class="btn btn-outline-secondary toggle-password" type="button" aria-label="Mostrar/ocultar contraseña"><i class="fas fa-eye"></i></button>
                            </div>

                            <div class="progress mt-2" role="progressbar" aria-label="Fuerza de contraseña" aria-valuemin="0" aria-valuemax="100" style="height:8px;">
                                <div id="pwdStrengthBar" class="progress-bar" style="width:0%"></div>
                            </div>
                            <small id="pwdStrengthText" class="text-muted">Fuerza: —</small>

                            <div id="capsWarnNew" class="form-text text-warning d-none">
                                <i class="fa-solid fa-unlock-keyhole me-1"></i> Bloq Mayús está activado.
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="ConfirmPassword" class="form-label">Confirmar nueva contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock" aria-hidden="true"></i></span>
                                <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword" autocomplete="new-password" required />
                                <button class="btn btn-outline-secondary toggle-password" type="button" aria-label="Mostrar/ocultar contraseña"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-outline-secondary" id="cancelPasswordChange">Cancelar</button>
                            <button type="submit" class="save-btn" id="btnSavePassword">
                                <i class="fas fa-save me-2" aria-hidden="true"></i> Actualizar contraseña
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Pestaña: Actividad (placeholder) -->
            <div id="activity-tab" class="tab-content" role="tabpanel" aria-labelledby="activity">
                <h5 class="mb-3"><i class="fas fa-history me-2" aria-hidden="true"></i> Actividad reciente</h5>

                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-sign-in-alt" aria-hidden="true"></i></div>
                    <div class="activity-content">
                        <div>Inicio de sesión exitoso</div>
                        <div class="activity-time">Hoy a las @DateTime.Now.ToString("HH:mm")</div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-user-edit" aria-hidden="true"></i></div>
                    <div class="activity-content">
                        <div>Actualizaste tu información de perfil</div>
                        <div class="activity-time">Ayer a las 15:42</div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-shopping-cart" aria-hidden="true"></i></div>
                    <div class="activity-content">
                        <div>Realizaste una compra reciente</div>
                        <div class="activity-time">Hace 3 días</div>
                    </div>
                </div>

                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-key" aria-hidden="true"></i></div>
                    <div class="activity-content">
                        <div>Cambiaste tu contraseña</div>
                        <div class="activity-time">Hace 2 semanas</div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-history me-2" aria-hidden="true"></i> Ver historial completo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
            // Tabs
            const tabs=document.querySelectorAll('.profile-tab');
            tabs.forEach(tab=>{
                tab.addEventListener('click',()=>{
                    tabs.forEach(t=>{t.classList.remove('active'); t.setAttribute('aria-selected','false');});
                    tab.classList.add('active'); tab.setAttribute('aria-selected','true');
                    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            // Avatar: selección/preview/validación
            const imgInput=document.getElementById('ImagenPerfil');
            const delBtn=document.getElementById('btnEliminarFoto');
            const MAX=5*1024*1024;
            imgInput?.addEventListener('change',()=>{
                if(!imgInput.files?.length) return;
                const f=imgInput.files[0];
                const okType=['image/jpeg','image/png','image/webp'].includes(f.type);
                if(!okType){ toast('danger','Solo JPG, PNG o WEBP.'); imgInput.value=''; return; }
                if(f.size>MAX){ toast('danger','La imagen supera 5MB.'); imgInput.value=''; return; }
                const reader=new FileReader();
                reader.onload=e=>{
                    const wrap=document.querySelector('.avatar-wrapper');
                    let avatar=wrap.querySelector('.profile-avatar');
                    if(!avatar){
                        avatar=document.createElement('img');
                        avatar.className='profile-avatar'; avatar.alt='Foto de perfil';
                        wrap.prepend(avatar);
                    }
                    avatar.src=e.target.result; avatar.style.display='block';
                    wrap.querySelector('.avatar-placeholder')?.classList.add('d-none');
                    // Si se había marcado eliminar, lo revertimos
                    const hidden=document.getElementById('EliminarFoto'); if(hidden) hidden.remove();
                    delBtn?.classList.remove('d-none');
                };
                reader.readAsDataURL(f);
            });

            // Eliminar foto (marca hidden para que el controlador la quite)
            delBtn?.addEventListener('click',()=>{
                const wrap=document.querySelector('.avatar-wrapper');
                const avatar=wrap.querySelector('.profile-avatar'); if(avatar) avatar.style.display='none';
                wrap.querySelector('.avatar-placeholder')?.classList.remove('d-none');
                imgInput.value=''; delBtn.classList.add('d-none');
                if(!document.getElementById('EliminarFoto')){
                    const input=document.createElement('input');
                    input.type='hidden'; input.name='EliminarFoto'; input.id='EliminarFoto'; input.value='true';
                    document.getElementById('formPerfil').appendChild(input);
                }
            });

            // CÉDULA: fuerza solo dígitos y longitud 10
            const ced=document.getElementById('Cedula');
            ced?.addEventListener('input',()=>{
                const digits=(ced.value||'').replace(/\D+/g,'').slice(0,10);
                if(ced.value!==digits) ced.value=digits;
                ced.setCustomValidity(digits.length===0 || digits.length===10 ? '' : 'La cédula debe tener 10 dígitos.');
            });

            // Guardar perfil (feedback)
            const formPerfil=document.getElementById('formPerfil');
            const btnPerfil=document.getElementById('btnPerfil');
            formPerfil?.addEventListener('submit',(e)=>{
                if(!formPerfil.checkValidity()){
                    e.preventDefault(); e.stopPropagation();
                    formPerfil.classList.add('was-validated'); return;
                }
                btnPerfil.disabled=true;
                const txt=btnPerfil.querySelector('.btn-text'); const prev=txt.textContent;
                txt.textContent='Guardando...';
                btnPerfil.insertAdjacentHTML('afterbegin','<span class="spinner-border spinner-border-sm me-2"></span>');
                // Se restablece tras postback
            });

            // Seguridad: mostrar/ocultar formulario
            const btnCambiar=document.getElementById('btnCambiarPassword');
            const formPwdWrap=document.getElementById('passwordForm');
            const cancelPwd=document.getElementById('cancelPasswordChange');
            btnCambiar?.addEventListener('click',()=>{formPwdWrap.classList.remove('d-none'); btnCambiar.classList.add('d-none');});
            cancelPwd?.addEventListener('click',()=>{
                formPwdWrap.classList.add('d-none'); btnCambiar.classList.remove('d-none');
                document.getElementById('changePasswordForm').reset(); resetStrength();
            });

            // Mostrar/ocultar contraseñas
            document.querySelectorAll('.toggle-password').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const input=btn.parentElement.querySelector('input');
                    const icon=btn.querySelector('i');
                    const isPwd=input.type==='password';
                    input.type=isPwd?'text':'password';
                    icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash');
                });
            });

            // Aviso CapsLock
            function capsFor(inputId,warnId){
                const input=document.getElementById(inputId);
                const warn=document.getElementById(warnId);
                if(!input||!warn) return;
                ['keyup','keydown'].forEach(ev=>input.addEventListener(ev,(e)=>{
                    const caps=e.getModifierState&&e.getModifierState('CapsLock');
                    warn.classList.toggle('d-none',!caps);
                }));
            }
            capsFor('CurrentPassword','capsWarnCurrent');
            capsFor('NewPassword','capsWarnNew');

            // Medidor de fuerza
            const newPwd=document.getElementById('NewPassword');
            const bar=document.getElementById('pwdStrengthBar');
            const txt=document.getElementById('pwdStrengthText');
            function score(p){ if(!p) return 0; let s=0;
                if(p.length>=8) s+=25; if(p.length>=12) s+=15;
                if(/[A-Z]/.test(p)) s+=20; if(/[a-z]/.test(p)) s+=15;
                if(/\d/.test(p)) s+=15; if(/[^A-Za-z0-9]/.test(p)) s+=10; return Math.min(s,100);
            }
            function paint(n){ bar.style.width=n+'%'; bar.classList.remove('bg-danger','bg-warning','bg-success'); let l='—';
                if(n<40){bar.classList.add('bg-danger'); l='Débil';}
                else if(n<75){bar.classList.add('bg-warning'); l='Media';}
                else {bar.classList.add('bg-success'); l='Fuerte';}
                txt.textContent='Fuerza: '+l;
            }
            function resetStrength(){ paint(0); }
            newPwd?.addEventListener('input',()=>paint(score(newPwd.value)));
            resetStrength();

            // Toast helper
            function toast(type,msg){
                const id='t'+Date.now();
                const el=document.createElement('div');
                el.id=id; el.className=`toast align-items-center text-bg-${type} border-0 position-fixed top-0 end-0 m-3`;
                el.role='alert'; el.ariaLive='assertive'; el.ariaAtomic='true';
                el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
                document.body.appendChild(el);
                const t=new bootstrap.Toast(el,{delay:3500}); t.show(); setTimeout(()=>el.remove(),4000);
            }

            // Cambiar contraseña vía AJAX
            const formPwd=document.getElementById('changePasswordForm');
            const btnSave=document.getElementById('btnSavePassword');
            formPwd?.addEventListener('submit',async (e)=>{
                e.preventDefault();
                const cur=document.getElementById('CurrentPassword').value.trim();
                const np=document.getElementById('NewPassword').value.trim();
                const cp=document.getElementById('ConfirmPassword').value.trim();
                if(!cur||!np||!cp){ toast('danger','Completa todos los campos.'); return; }
                if(np!==cp){ toast('danger','Las contraseñas no coinciden.'); return; }

                btnSave.disabled=true; const prev=btnSave.innerHTML;
                btnSave.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span> Guardando...';
                try{
                    const fd=new FormData(formPwd);
                    const res=await fetch(formPwd.action,{method:'POST',body:fd,headers:{'X-Requested-With':'XMLHttpRequest'}});
                    if(res.ok){
                        toast('success','Contraseña actualizada correctamente.');
                        formPwd.reset(); resetStrength();
                        formPwdWrap.classList.add('d-none'); btnCambiar.classList.remove('d-none');
                    }else{
                        let msg='No se pudo actualizar la contraseña.';
                        try{const j=await res.json(); if(j?.error) msg=j.error; else if(Array.isArray(j?.errors)) msg=j.errors.join('<br>');}catch{}
                        toast('danger',msg);
                    }
                }catch{ toast('danger','Error de red.'); }
                finally{ btnSave.disabled=false; btnSave.innerHTML=prev; }
            });
        })();
    </script>
}
