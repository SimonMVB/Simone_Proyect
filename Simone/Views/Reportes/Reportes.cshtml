@model IEnumerable<Simone.ViewModels.Reportes.CompradorResumenVM>
@using System.Globalization

@{
    ViewData["Title"] = "Compradores y Ventas";
    ViewData["Description"] = "Panel de gestión de ventas y compradores en Neo Ágora.";
    var culture = new CultureInfo("es-EC");

    var controllerName = ViewContext?.RouteData?.Values?["controller"]?.ToString() ?? "";
    var isVendorContext = string.Equals(controllerName, "Vendedor", StringComparison.OrdinalIgnoreCase);
    var vId = ViewContext?.HttpContext?.Request?.Query["vId"].ToString();

    var detalleRouteName = isVendorContext ? "Vendedor_VentaDetalle" : "Panel_VentaDetalle";
    var marcarUrl = Url.Action("MarcarEnviada", isVendorContext ? "Vendedor" : "Panel",
                               isVendorContext ? new { vId = string.IsNullOrWhiteSpace(vId) ? null : vId } : null);

    var ventas = Model?.ToList() ?? new List<Simone.ViewModels.Reportes.CompradorResumenVM>();
    var totalVentas = ventas.Count;
    var totalIngresos = ventas.Sum(v => v.Total);
    var ticketPromedio = totalVentas > 0 ? totalIngresos / totalVentas : 0m;
    var pendientes = ventas.Count(v => (v.Estado ?? "").ToLowerInvariant().Contains("pend"));
    var enviadas = ventas.Count(v => (v.Estado ?? "").ToLowerInvariant().Contains("env"));
}

@section Styles {
    <style>
        :root {
            --buyers-primary: #e91e63;
            --buyers-primary-light: #f48fb1;
            --buyers-primary-dark: #c2185b;
            --buyers-secondary: #9c27b0;
            --buyers-accent: #ff4081;
            --buyers-success: #4caf50;
            --buyers-warning: #ff9800;
            --buyers-danger: #f44336;
            --buyers-info: #2196f3;
            --buyers-dark: #212121;
            --buyers-text: #424242;
            --buyers-light: #fafafa;
            --buyers-white: #ffffff;
            --buyers-border: #e0e0e0;
            --buyers-shadow: 0 8px 32px rgba(233, 30, 99, 0.15);
            --buyers-shadow-lg: 0 16px 48px rgba(233, 30, 99, 0.2);
        }

        /* Page Layout */
        .buyers-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 50%, #f48fb1 100%);
            padding: 2rem 0;
            animation: fadeIn 0.6s ease;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .buyers-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Breadcrumb */
        .buyers-breadcrumb {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            animation: slideDown 0.4s ease;
        }

        @@keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

            .breadcrumb li + li::before {
                content: "›";
                margin: 0 0.5rem;
                color: #9e9e9e;
                font-weight: bold;
            }

            .breadcrumb a {
                color: var(--buyers-primary);
                text-decoration: none;
                font-weight: 500;
                transition: color 0.3s;
            }

                .breadcrumb a:hover {
                    color: var(--buyers-primary-dark);
                }

            .breadcrumb .active {
                color: var(--buyers-text);
                font-weight: 600;
            }

        /* Page Header */
        .page-header {
            background: white;
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: var(--buyers-shadow-lg);
            margin-bottom: 2rem;
            animation: zoomIn 0.5s ease;
        }

        @@keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .page-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--buyers-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .page-title i {
                color: var(--buyers-primary);
            }

        .page-subtitle {
            color: #757575;
            font-size: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--buyers-primary) 0%, var(--buyers-secondary) 100%);
            padding: 1.75rem;
            border-radius: 16px;
            color: white;
            position: relative;
            overflow: hidden;
            animation: slideDown 0.6s ease;
        }

            .stat-card::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
        }

        /* Filters */
        .filters-card {
            background: white;
            padding: 1.75rem;
            border-radius: 20px;
            box-shadow: var(--buyers-shadow);
            margin-bottom: 2rem;
            animation: slideDown 0.7s ease;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            color: var(--buyers-dark);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--buyers-border);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: var(--buyers-light);
        }

            .filter-input:focus,
            .filter-select:focus {
                outline: none;
                border-color: var(--buyers-primary);
                background: white;
                box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.1);
            }

        .filter-input-wrapper {
            position: relative;
        }

        .filter-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9e9e9e;
        }

        .filter-input-wrapper .filter-input {
            padding-left: 3rem;
        }

        .btn-clear {
            padding: 0.875rem 1.5rem;
            background: white;
            color: #757575;
            border: 2px solid var(--buyers-border);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .btn-clear:hover {
                background: var(--buyers-light);
                color: var(--buyers-dark);
            }

        /* Buyers List */
        .buyers-list {
            background: white;
            border-radius: 24px;
            box-shadow: var(--buyers-shadow-lg);
            overflow: hidden;
            animation: slideDown 0.8s ease;
        }

        .buyer-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 1.75rem;
            border-bottom: 2px solid var(--buyers-border);
            transition: all 0.3s;
        }

            .buyer-card:last-child {
                border-bottom: none;
            }

            .buyer-card:hover {
                background: rgba(233, 30, 99, 0.05);
            }

        .buyer-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
            min-width: 0;
        }

        /* Avatar */
        .avatar-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .avatar-img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        .avatar-initials {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            background: linear-gradient(135deg, var(--buyers-primary) 0%, var(--buyers-accent) 100%);
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        /* Buyer Details */
        .buyer-details {
            flex: 1;
            min-width: 0;
        }

        .buyer-name-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .buyer-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--buyers-dark);
            text-decoration: none;
            transition: color 0.3s;
        }

            .buyer-name:hover {
                color: var(--buyers-primary);
            }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.813rem;
        }

        .badge-pending {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-shipped {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .badge-default {
            background: #f5f5f5;
            color: #616161;
        }

        .buyer-contact {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #757575;
            flex-wrap: wrap;
        }

            .buyer-contact i {
                color: var(--buyers-primary);
                margin-right: 0.25rem;
            }

        .buyer-meta {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.875rem;
            color: #757575;
            flex-wrap: wrap;
        }

            .buyer-meta i {
                color: var(--buyers-primary);
                margin-right: 0.25rem;
            }

        /* Buyer Actions */
        .buyer-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        .buyer-total {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--buyers-primary);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-shipped,
        .btn-view,
        .btn-report {
            padding: 0.625rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            border: none;
        }

        .btn-shipped {
            background: white;
            color: var(--buyers-success);
            border: 2px solid var(--buyers-success);
        }

            .btn-shipped:hover:not(:disabled) {
                background: var(--buyers-success);
                color: white;
            }

            .btn-shipped:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .btn-view {
            background: linear-gradient(135deg, var(--buyers-primary), var(--buyers-accent));
            color: white;
        }

            .btn-view:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(233, 30, 99, 0.35);
                color: white;
            }

        .btn-report {
            background: white;
            color: var(--buyers-danger);
            border: 2px solid var(--buyers-danger);
        }

            .btn-report:hover {
                background: var(--buyers-danger);
                color: white;
            }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 24px;
            box-shadow: var(--buyers-shadow);
        }

        .empty-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--buyers-primary-light), var(--buyers-accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 3.5rem;
            color: white;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--buyers-dark);
            margin-bottom: 0.75rem;
        }

        .empty-text {
            color: #757575;
            font-size: 1rem;
        }

        /* Modal */
        .modal-content {
            border-radius: 24px;
            border: none;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--buyers-danger) 0%, #d32f2f 100%);
            color: white;
            padding: 1.5rem 2rem;
            border: none;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 2px solid var(--buyers-border);
        }

        /* Responsive */
        @@media (max-width: 991px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .buyer-card {
                flex-direction: column;
                align-items: start;
            }

            .buyer-actions {
                width: 100%;
                align-items: start;
            }

            .action-buttons {
                width: 100%;
            }

                .action-buttons button,
                .action-buttons a {
                    flex: 1;
                }
        }

        @@media (max-width: 575px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                padding: 1.5rem;
            }

            .buyer-info {
                flex-direction: column;
                align-items: start;
            }
        }

        /* Loading */
        .btn-loading {
            position: relative;
            color: transparent;
        }

            .btn-loading::after {
                content: '';
                position: absolute;
                width: 16px;
                height: 16px;
                top: 50%;
                left: 50%;
                margin: -8px 0 0 -8px;
                border: 2px solid currentColor;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 0.6s linear infinite;
            }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Alert */
        .alert {
            border-radius: 12px;
            padding: 1rem 1.25rem;
            border: none;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Focus Visible */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--buyers-primary);
            outline-offset: 2px;
        }

        /* Reduced Motion */
        @@media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
}

<div class="buyers-page">
    <div class="buyers-container">
        <!-- Breadcrumb -->
        <nav class="buyers-breadcrumb" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li>
                    <a href="@Url.Action("Index", isVendorContext ? "Vendedor" : "Panel")">
                        <i class="fa-solid fa-house"></i>
                        @(isVendorContext ? "Panel Vendedor" : "Panel Admin")
                    </a>
                </li>
                <li class="active" aria-current="page">Compradores y Ventas</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fa-solid fa-users"></i>
                Compradores y Ventas
            </h1>
            <p class="page-subtitle">Gestión de ventas y compradores registrados</p>
        </div>

        @if (!ventas.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fa-solid fa-receipt"></i>
                </div>
                <h3 class="empty-title">No hay ventas registradas</h3>
                <p class="empty-text">
                    Las ventas aparecerán aquí cuando se realicen compras
                </p>
            </div>
        }
        else
        {
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-shopping-cart"></i>
                    </div>
                    <div class="stat-label">Total Ventas</div>
                    <div class="stat-value">@totalVentas</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-dollar-sign"></i>
                    </div>
                    <div class="stat-label">Total Ingresos</div>
                    <div class="stat-value">@totalIngresos.ToString("C0", culture)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <div class="stat-label">Ticket Promedio</div>
                    <div class="stat-value">@ticketPromedio.ToString("C0", culture)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-label">Pendientes</div>
                    <div class="stat-value">@pendientes</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-card">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="txtFiltro">Buscar</label>
                        <div class="filter-input-wrapper">
                            <i class="fa-solid fa-magnifying-glass filter-input-icon"></i>
                            <input type="text"
                                   id="txtFiltro"
                                   class="filter-input"
                                   placeholder="Buscar por nombre, email, teléfono..." />
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="selEstado">Estado</label>
                        <select id="selEstado" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="enviado">Enviado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn-clear" id="btnLimpiar">
                            <i class="fa-solid fa-eraser"></i>
                            <span>Limpiar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Buyers List -->
            <div class="buyers-list">
                @foreach (var v in ventas.OrderByDescending(x => x.Fecha))
                {
                    var initials = "";
                    {
                        var name = v.Nombre ?? "";
                        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                        initials = parts.Length switch
                        {
                            0 => "?",
                            1 => parts[0].Substring(0, 1).ToUpperInvariant(),
                            _ => (parts[0].Substring(0, 1) + parts[1].Substring(0, 1)).ToUpperInvariant()
                        };
                    }

                    var estadoLower = (v.Estado ?? "").ToLowerInvariant();
                    var badgeClass = estadoLower.Contains("env") ? "badge-shipped"
                    : estadoLower.Contains("pend") ? "badge-pending"
                    : (estadoLower.Contains("canc") || estadoLower.Contains("dev")) ? "badge-cancelled"
                    : "badge-default";

                    <div class="buyer-card" data-venta-id="@v.VentaID">
                        <div class="buyer-info">
                            <div class="avatar-wrapper">
                                @if (!string.IsNullOrWhiteSpace(v.FotoPerfil))
                                {
                                    <img src="@v.FotoPerfil"
                                         class="avatar-img"
                                         alt="@v.Nombre"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div class="avatar-initials" style="display: none;">@initials</div>
                                }
                                else
                                {
                                    <div class="avatar-initials">@initials</div>
                                }
                            </div>

                            <div class="buyer-details">
                                <div class="buyer-name-row">
                                    <a href="@Url.RouteUrl(detalleRouteName, new { id = v.VentaID, vId = isVendorContext ? (string.IsNullOrWhiteSpace(vId) ? null : vId) : null })"
                                       class="buyer-name">
                                        @(!string.IsNullOrWhiteSpace(v.Nombre) ? v.Nombre : "—")
                                    </a>
                                    <span class="status-badge @badgeClass estado-texto">
                                        @(!string.IsNullOrWhiteSpace(v.Estado) ? v.Estado : "—")
                                    </span>
                                </div>

                                <div class="buyer-contact">
                                    <div>
                                        <i class="fa-solid fa-envelope"></i>
                                        @(!string.IsNullOrWhiteSpace(v.Email) ? v.Email : "—")
                                    </div>
                                    <div>
                                        <i class="fa-solid fa-phone"></i>
                                        @(!string.IsNullOrWhiteSpace(v.Telefono) ? v.Telefono : "—")
                                    </div>
                                </div>

                                <div class="buyer-meta">
                                    <div>
                                        <i class="fa-solid fa-calendar-alt"></i>
                                        @v.Fecha.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                    <div>
                                        <i class="fa-solid fa-credit-card"></i>
                                        @(!string.IsNullOrWhiteSpace(v.MetodoPago) ? v.MetodoPago : "—")
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="buyer-actions">
                            <div class="buyer-total" data-total="@v.Total">
                                @v.Total.ToString("C", culture)
                            </div>

                            <div class="action-buttons">
                                <form method="post"
                                      action="@marcarUrl"
                                      class="js-mark-shipped"
                                      style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@v.VentaID" />
                                    <button type="submit"
                                            class="btn-shipped"
                                            @(v.Estado?.Equals("Enviado", StringComparison.OrdinalIgnoreCase) == true ? "disabled" : null)>
                                        <i class="fa-solid fa-truck-fast"></i>
                                        <span>Enviado</span>
                                    </button>
                                </form>

                                <a href="@Url.RouteUrl(detalleRouteName, new { id = v.VentaID, vId = isVendorContext ? (string.IsNullOrWhiteSpace(vId) ? null : vId) : null })"
                                   class="btn-view">
                                    <i class="fa-solid fa-eye"></i>
                                    <span>Ver</span>
                                </a>

                                <button type="button"
                                        class="btn-report"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalReportar"
                                        data-venta-id="@v.VentaID"
                                        data-venta-nombre="@v.Nombre">
                                    <i class="fa-solid fa-flag"></i>
                                    <span>Reportar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Modal Reportar Venta -->
<div class="modal fade" id="modalReportar" tabindex="-1" aria-labelledby="modalReportarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalReportarLabel">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    Reportar Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formReportar" method="post" asp-action="ReportarVenta">
                <div class="modal-body">
                    <input type="hidden" name="ventaId" id="reportarVentaId" />

                    <div class="alert alert-warning">
                        <i class="fa-solid fa-circle-info"></i>
                        <strong>¡Atención!</strong> Esta acción:
                        <ul class="mb-0 mt-2">
                            <li>Repondrá el stock de los productos</li>
                            <li>Marcará la venta como <strong>Cancelada (revertida)</strong></li>
                            <li><strong>NO se puede deshacer</strong></li>
                        </ul>
                    </div>

                    <p class="mb-3">
                        Venta: <strong id="reportarVentaNombre"></strong>
                    </p>

                    <div class="mb-3">
                        <label for="reportarMotivo" class="form-label">
                            <i class="fa-solid fa-list"></i>
                            Motivo de la reversión <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="reportarMotivo" name="motivo" required>
                            <option value="">Selecciona un motivo...</option>
                            <option value="devolucion">Devolución del cliente</option>
                            <option value="deposito_falso">Depósito falso</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="reportarNota" class="form-label">
                            <i class="fa-solid fa-note-sticky"></i>
                            Nota adicional (opcional)
                        </label>
                        <textarea class="form-control" id="reportarNota" name="nota" rows="3"
                                  placeholder="Explica brevemente el problema..."></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="reportarConfirm" required>
                        <label class="form-check-label" for="reportarConfirm">
                            <strong>Confirmo que quiero revertir esta venta</strong>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa-solid fa-xmark"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger" id="btnConfirmarReporte">
                        <i class="fa-solid fa-flag"></i>
                        Confirmar Reversión
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            'use strict';

            // ===== FILTER =====
            const txtFiltro = document.getElementById('txtFiltro');
            const selEstado = document.getElementById('selEstado');
            const btnLimpiar = document.getElementById('btnLimpiar');
            const cards = document.querySelectorAll('.buyer-card');

            function normalize(text) {
                return (text || '')
                    .toString()
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .trim();
            }

            function aplicarFiltros() {
                const query = normalize(txtFiltro?.value || '');
                const estadoFiltro = normalize(selEstado?.value || '');

                let visibles = 0;

                cards.forEach(card => {
                    const texto = normalize(card.textContent);
                    const estadoCell = card.querySelector('.estado-texto')?.textContent || '';

                    const pasaTexto = query === '' || texto.includes(query);
                    const pasaEstado = estadoFiltro === '' || normalize(estadoCell).includes(estadoFiltro);

                    const mostrar = pasaTexto && pasaEstado;
                    card.style.display = mostrar ? '' : 'none';

                    if (mostrar) visibles++;
                });
            }

            txtFiltro?.addEventListener('input', aplicarFiltros);
            selEstado?.addEventListener('change', aplicarFiltros);

            btnLimpiar?.addEventListener('click', () => {
                if (txtFiltro) txtFiltro.value = '';
                if (selEstado) selEstado.value = '';
                aplicarFiltros();
            });

            // ===== MARK AS SHIPPED =====
            document.querySelectorAll('form.js-mark-shipped').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const card = form.closest('.buyer-card');
                    const badge = card.querySelector('.estado-texto');
                    const btn = form.querySelector('.btn-shipped');
                    const prevHTML = btn.innerHTML;

                    btn.disabled = true;
                    btn.classList.add('btn-loading');
                    btn.innerHTML = '<span style="visibility: hidden;">Enviando...</span>';

                    try {
                        const res = await fetch(form.action, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
                            body: new FormData(form)
                        });

                        if (res.ok) {
                            let json = null;
                            try { json = await res.json(); } catch {}

                            badge.textContent = (json && json.estado) ? json.estado : 'Enviado';
                            badge.className = 'status-badge badge-shipped estado-texto';
                            btn.classList.remove('btn-loading');
                            btn.innerHTML = '<i class="fa-solid fa-check"></i><span>Enviado</span>';
                        } else {
                            btn.disabled = false;
                            btn.classList.remove('btn-loading');
                            btn.innerHTML = prevHTML;
                            alert('No se pudo marcar como enviado');
                        }
                    } catch {
                        btn.disabled = false;
                        btn.classList.remove('btn-loading');
                        btn.innerHTML = prevHTML;
                        alert('Error de red');
                    }
                });
            });

            // ===== MODAL REPORTAR =====
            const modalReportar = document.getElementById('modalReportar');
            if (modalReportar) {
                modalReportar.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const ventaId = button.getAttribute('data-venta-id');
                    const ventaNombre = button.getAttribute('data-venta-nombre');

                    document.getElementById('reportarVentaId').value = ventaId;
                    document.getElementById('reportarVentaNombre').textContent = `#${ventaId} - ${ventaNombre}`;
                });

                // Resetear formulario al cerrar
                modalReportar.addEventListener('hidden.bs.modal', function () {
                    const form = document.getElementById('formReportar');
                    form.reset();
                    document.getElementById('reportarConfirm').checked = false;
                });
            }

            // ===== INIT =====
            console.log('✓ Buyers page initialized');
        })();
    </script>
}
