@model Simone.ViewModels.Reportes.VentaDetalleVM
@using System.Globalization
@{
    ViewData["Title"] = $"Detalle de venta #{Model.VentaID}";
    var culture = new CultureInfo("es-EC");

    // Helpers
    string Safe(string? v) => string.IsNullOrWhiteSpace(v) ? "—" : v;
    string JoinNonEmpty(params string?[] xs) => string.Join(", ", xs.Where(s => !string.IsNullOrWhiteSpace(s)));

    // Bonito para banco
    string BankPretty(string? b)
    {
        if (string.IsNullOrWhiteSpace(b)) return "";
        var k = b.Trim().ToLowerInvariant();
        return k switch
        {
            "pichincha" => "Banco Pichincha",
            "guayaquil" => "Banco Guayaquil",
            "pacifico" => "Banco del Pacífico",
            "jep" => "Banco JEP",
            _ => CultureInfo.CurrentCulture.TextInfo.ToTitleCase(b)
        };
    }

    // Perfil (fallback)
    var dirPerfil = string.IsNullOrWhiteSpace(Model.Direccion) ? null : Model.Direccion;
    var telPerfil = string.IsNullOrWhiteSpace(Model.Telefono) ? null : Model.Telefono;
    var ciudadPerf = string.IsNullOrWhiteSpace(Model.PerfilCiudad) ? null : Model.PerfilCiudad;
    var provPerf = string.IsNullOrWhiteSpace(Model.PerfilProvincia) ? null : Model.PerfilProvincia;
    var refPerf = string.IsNullOrWhiteSpace(Model.PerfilReferencia) ? null : Model.PerfilReferencia;

    // Dirección usada (la más cercana a la fecha de la venta; si no hay, la última)
    var dirUsada = (Model.Direcciones ?? Enumerable.Empty<Simone.ViewModels.Reportes.DireccionVM>())
                    .Where(d => d.FechaRegistro <= Model.Fecha)
                    .OrderByDescending(d => d.FechaRegistro)
                    .FirstOrDefault()
                ?? (Model.Direcciones ?? Enumerable.Empty<Simone.ViewModels.Reportes.DireccionVM>())
                    .OrderByDescending(d => d.FechaRegistro)
                    .FirstOrDefault();

    var calleUsada = dirUsada?.Calle ?? dirPerfil;
    var ciudadUsada = string.IsNullOrWhiteSpace(dirUsada?.Ciudad) ? ciudadPerf : dirUsada!.Ciudad;
    var estadoUsado = string.IsNullOrWhiteSpace(dirUsada?.EstadoProvincia) ? provPerf : dirUsada!.EstadoProvincia;
    var cpUsado = string.IsNullOrWhiteSpace(dirUsada?.CodigoPostal) ? null : dirUsada!.CodigoPostal;
    var telUsado = string.IsNullOrWhiteSpace(dirUsada?.TelefonoContacto) ? telPerfil : dirUsada!.TelefonoContacto;
    var refUsada = dirUsada != null ? null : refPerf;

    var linea2Usada = JoinNonEmpty(ciudadUsada, estadoUsado) + (string.IsNullOrWhiteSpace(cpUsado) ? "" : $" ({cpUsado})");

    // Etiqueta (se agrega CI si la tenemos)
    var etiquetaEnvio = string.Join("\n", new[]
    {
        Model?.Nombre,
        string.IsNullOrWhiteSpace(Model.Cedula) ? null : $"CI: {Model.Cedula}",
        string.IsNullOrWhiteSpace(calleUsada)   ? null :  calleUsada,
        string.IsNullOrWhiteSpace(linea2Usada)  ? null :  linea2Usada,
        string.IsNullOrWhiteSpace(refUsada)     ? null : $"Ref: {refUsada}",
        string.IsNullOrWhiteSpace(telUsado)     ? null : $"Tel.: {telUsado}"
    }.Where(x => !string.IsNullOrWhiteSpace(x)));

    var yaEnviado = string.Equals(Model.Estado, "Enviado", StringComparison.OrdinalIgnoreCase);
    var bancoNice = BankPretty(Model.Banco);

    // Mostrar sección Pago si hay pista
    var showPago = !string.IsNullOrWhiteSpace(Model.Depositante)
                   || !string.IsNullOrWhiteSpace(Model.ComprobanteUrl)
                   || (!string.IsNullOrWhiteSpace(Model.MetodoPago)
                       && Model.MetodoPago.Contains("dep", StringComparison.OrdinalIgnoreCase));

    // Normaliza URL del comprobante
    string? compUrl = null;
    if (!string.IsNullOrWhiteSpace(Model.ComprobanteUrl))
    {
        var raw = Model.ComprobanteUrl.Trim();
        compUrl = raw.StartsWith("http", StringComparison.OrdinalIgnoreCase)
            ? raw
            : Url.Content(raw.StartsWith("~/") || raw.StartsWith("/") ? raw : "~/" + raw);
    }
    bool isPdf = !string.IsNullOrWhiteSpace(compUrl)
                 && compUrl!.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase);

    // UI: depositante
    var hasDepos = !string.IsNullOrWhiteSpace(Model.Depositante);
    var deposText = hasDepos ? Model.Depositante!.Trim() : "—";
}

<div class="main-container">
    <div class="header no-print">
        <div class="logo">
            <i class="fas fa-store"></i><span>SIMONE</span>
        </div>
        <a asp-controller="Panel" asp-action="Reportes" class="back-btn">
            <i class="fas fa-arrow-left"></i> Volver a compradores
        </a>
    </div>

    <h1 class="page-title">Detalle de Venta #@Model.VentaID</h1>
    <p class="page-subtitle">Venta del @Model.Fecha.ToString("dd/MM/yyyy HH:mm")</p>

    <div class="row">
        <!-- Izquierda -->
        <div class="col-lg-4">
            <!-- Cliente -->
            <div class="card">
                <div class="card-header"><span><i class="fas fa-user-circle"></i> Información del cliente</span></div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Nombre</span>   <span class="info-value">@Safe(Model.Nombre)</span></div>
                        <div class="info-item"><span class="info-label">Cédula</span>   <span class="info-value">@Safe(Model.Cedula)</span></div>
                        <div class="info-item"><span class="info-label">Email</span>    <span class="info-value">@Safe(Model.Email)</span></div>
                        <div class="info-item"><span class="info-label">Teléfono</span> <span class="info-value">@Safe(Model.Telefono)</span></div>
                        <div class="info-item"><span class="info-label">Dirección (perfil)</span><span class="info-value">@Safe(Model.Direccion)</span></div>
                        <div class="info-item"><span class="info-label">Venta #</span>  <span class="info-value">@Model.VentaID</span></div>
                        <div class="info-item"><span class="info-label">Fecha</span>    <span class="info-value">@Model.Fecha.ToString("dd/MM/yyyy HH:mm")</span></div>
                        <div class="info-item"><span class="info-label">Método de pago</span><span class="info-value">@Safe(Model.MetodoPago)</span></div>
                        <div class="info-item">
                            <span class="info-label">Estado</span>
                            <span class="status-badge @(yaEnviado ? "status-shipped" : "status-pending")">
                                <i class="fas @(yaEnviado ? "fa-check-circle" : "fa-clock")"></i> @(yaEnviado ? "Enviado" : "Pendiente")
                            </span>
                        </div>
                    </div>

                    <div class="mt-4 no-print">
                        <form id="markShippedForm" method="post" asp-controller="Panel" asp-action="MarcarEnviada" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.VentaID" />
                            <button id="btnMarkShipped" type="submit" class="btn-action btn-success" @(yaEnviado ? "disabled" : null)>
                                <i class="fas fa-truck-fast"></i> Marcar como enviado
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Pago / Depósito -->
            @if (showPago)
            {
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-receipt"></i> Pago / Depósito</span>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Depositante</span>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="info-value" id="depositanteText">@deposText</span>
                                    @if (hasDepos)
                                    {
                                        <button type="button" class="btn-action btn-outline no-print" id="copyDepositante">
                                            <i class="fas fa-copy"></i> Copiar
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Banco</span>
                                <span class="info-value">@Safe(bancoNice)</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(compUrl))
                        {
                            <div class="mt-3 text-center">
                                @if (isPdf)
                                {
                                    <a class="file-pill" href="@compUrl" target="_blank" rel="noopener">
                                        <i class="fas fa-file-pdf"></i> Ver comprobante (PDF)
                                    </a>
                                    <div class="deposit-actions mt-2 no-print">
                                        <a class="btn-action btn-outline" href="@compUrl" target="_blank" rel="noopener" download>
                                            <i class="fas fa-download"></i> Descargar
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#modalComprobante">
                                        <img src="@compUrl" alt="Comprobante de depósito" class="deposit-proof" />
                                    </a>
                                    <div class="text-muted mt-2"><small>Clic para ver en grande</small></div>
                                    <div class="deposit-actions mt-2 no-print">
                                        <a class="btn-action btn-outline" href="@compUrl" target="_blank" rel="noopener" download>
                                            <i class="fas fa-download"></i> Descargar imagen
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert-warning mt-2">
                                <i class="fas fa-exclamation-circle"></i>
                                No se adjuntó comprobante de depósito.
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Centro: Dirección -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header"><span><i class="fas fa-truck"></i> Dirección de envío</span></div>
                <div class="card-body">
                    <div class="address-box">
                        @if (dirUsada != null)
                        {
                            <div class="address-line"><span class="address-label">Principal:</span><span>@Safe(dirUsada.Calle)</span></div>
                            @if (!string.IsNullOrWhiteSpace(linea2Usada))
                            {
                                <div class="address-line"><span>@linea2Usada</span></div>
                            }
                            @if (!string.IsNullOrWhiteSpace(telUsado))
                            {
                                <div class="address-line"><span class="address-label">Tel:</span> <span>@telUsado</span></div>
                            }
                            <div class="address-line text-muted"><small>Registrada: @dirUsada.FechaRegistro.ToString("dd/MM/yyyy")</small></div>
                        }
                        else
                        {
                            <div class="address-line"><span class="address-label">Principal:</span><span>Sin direcciones guardadas</span></div>
                            <div class="address-line text-muted">Se usó la dirección del perfil en el momento de la compra.</div>
                            @if (!string.IsNullOrWhiteSpace(calleUsada))
                            {
                                <div class="address-line"><span>@calleUsada</span></div>
                            }
                            @if (!string.IsNullOrWhiteSpace(JoinNonEmpty(ciudadUsada, estadoUsado)))
                            {
                                <div class="address-line"><span>@JoinNonEmpty(ciudadUsada, estadoUsado)</span></div>
                            }
                            @if (!string.IsNullOrWhiteSpace(refUsada))
                            {
                                <div class="address-line"><span class="address-label">Ref:</span><span>@refUsada</span></div>
                            }
                            @if (!string.IsNullOrWhiteSpace(telUsado))
                            {
                                <div class="address-line"><span class="address-label">Tel:</span><span>@telUsado</span></div>
                            }
                        }
                    </div>

                    @{
                        var faltaCalle = string.IsNullOrWhiteSpace(calleUsada);
                        var faltaCiudad = string.IsNullOrWhiteSpace(ciudadUsada);
                    }
                    @if (faltaCalle || faltaCiudad)
                    {
                        <div class="alert-warning">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Falta información clave para el envío: @(faltaCalle ? "calle/dirección" : null) @((faltaCalle && faltaCiudad) ? " y " : null) @(faltaCiudad ? "ciudad" : null). Verifica antes de despachar.</span>
                        </div>
                    }

                    <div class="section-title"><i class="fas fa-copy"></i><span>Etiqueta de envío</span></div>
                    <div class="copy-box">
                        <pre id="copyContent" class="copy-content">@etiquetaEnvio</pre>
                        <button id="btnCopy" class="btn-action btn-outline copy-btn no-print"><i class="fas fa-copy"></i> Copiar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Derecha: Productos -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header"><span><i class="fas fa-shopping-bag"></i> Productos</span></div>
                <div class="card-body">
                    <table class="products-table">
                        <thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th></tr></thead>
                        <tbody>
                            @if (Model.Detalles == null || !Model.Detalles.Any())
                            {
                                <tr><td colspan="3" class="text-muted">Sin detalles.</td></tr>
                            }
                            else
                            {
                                foreach (var d in Model.Detalles)
                                {
                                    <tr><td>@d.Producto</td><td>× @d.Cantidad</td><td>@d.Subtotal.ToString("C", culture)</td></tr>
                                }
                                <tr class="total-row"><td colspan="2">Total</td><td>@Model.Total.ToString("C", culture)</td></tr>
                            }
                        </tbody>
                    </table>

                    <div class="mt-4 no-print">
                        <button class="btn-action btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir comprobante
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary: #4a6cf7;
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --dark: #343a40;
        --light: #f8f9fa;
        --border-radius: 12px;
        --box-shadow: 0 5px 15px rgba(0,0,0,.08);
        --transition: all .3s ease
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box
    }

    body {
        font-family: 'Poppins',sans-serif;
        background: #f8fafc;
        color: var(--dark);
        line-height: 1.6
    }

    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0
    }

    .logo {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        text-decoration: none;
        color: var(--dark);
        font-weight: 500;
        transition: var(--transition)
    }

        .back-btn:hover {
            background: var(--primary);
            color: #fff;
            transform: translateY(-2px)
        }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 5px
    }

    .page-subtitle {
        color: var(--secondary);
        margin-bottom: 25px
    }

    .card {
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 25px;
        border: none;
        transition: var(--transition)
    }

        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,.1)
        }

    .card-header {
        background: #fff;
        border-bottom: 1px solid #e2e8f0;
        padding: 15px 20px;
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important
    }

        .card-header i {
            margin-right: 10px;
            color: var(--primary)
        }

    .card-body {
        padding: 20px
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
        gap: 20px
    }

    .info-item {
        display: flex;
        flex-direction: column
    }

    .info-label {
        font-size: 13px;
        color: var(--secondary);
        margin-bottom: 5px
    }

    .info-value {
        font-weight: 500;
        color: var(--dark)
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 5px
    }

    .status-pending {
        background: #fff8e1;
        color: #f57c00
    }

    .status-shipped {
        background: #e8f5e9;
        color: var(--success)
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        transition: var(--transition);
        text-decoration: none;
        border: none;
        cursor: pointer
    }

    .btn-primary {
        background: var(--primary);
        color: #fff
    }

        .btn-primary:hover {
            background: #3a5ad9;
            color: #fff
        }

    .btn-success {
        background: var(--success);
        color: #fff
    }

        .btn-success:hover {
            background: #218838;
            color: #fff
        }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary)
    }

        .btn-outline:hover {
            background: var(--primary);
            color: #fff
        }

    .address-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid var(--primary)
    }

    .address-line {
        margin-bottom: 5px
    }

    .address-label {
        font-weight: 600;
        margin-right: 5px
    }

    .products-table {
        width: 100%;
        border-collapse: collapse
    }

        .products-table th {
            text-align: left;
            padding: 12px 15px;
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark)
        }

        .products-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0
        }

        .products-table tr:last-child td {
            border-bottom: none
        }

    .total-row {
        font-weight: 600;
        background: #f8f9fa
    }

    .copy-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        position: relative
    }

    .copy-content {
        font-family: monospace;
        white-space: pre-wrap;
        margin-bottom: 15px
    }

    .copy-btn {
        position: absolute;
        top: 15px;
        right: 15px
    }

    .alert-warning {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 12px 15px;
        border-radius: 4px;
        margin-top: 15px;
        font-size: 14px
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px
    }

    .deposit-proof {
        max-width: 100%;
        max-height: 240px;
        width: auto;
        border-radius: 10px;
        box-shadow: var(--box-shadow);
        object-fit: contain
    }

    .file-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        background: #f3f4f6;
        text-decoration: none;
        color: #111827;
        font-weight: 500;
        box-shadow: var(--box-shadow)
    }

        .file-pill i {
            color: #b91c1c
        }

    .deposit-actions {
        display: flex;
        justify-content: center
    }

    /* Responsive */
    @@media (max-width:992px) {
        .info-grid

    {
        grid-template-columns: 1fr 1fr
    }

    }

    @@media (max-width:768px) {
        .info-grid

    {
        grid-template-columns: 1fr
    }

    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px
    }

    }

    /* Impresión */
    @@media print {
        .no-print, .no-print *

    {
        display: none !important;
    }

    body {
        background: #fff;
    }

    .main-container {
        max-width: 100%;
        padding: 0;
    }

    .card {
        box-shadow: none !important;
        border: 1px solid #e5e7eb;
        page-break-inside: avoid;
    }

    .page-title, .page-subtitle {
        margin-left: 10px;
    }

    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

@if (!string.IsNullOrWhiteSpace(compUrl) && !isPdf)
{
    <!-- Modal comprobante (imagen) -->
    <div class="modal fade" id="modalComprobante" tabindex="-1" aria-labelledby="modalComprobanteLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalComprobanteLabel"><i class="fas fa-image me-2"></i>Comprobante de depósito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="@compUrl" alt="Comprobante de depósito" class="img-fluid" />
                </div>
                <div class="modal-footer">
                    <a class="btn-action btn-outline" href="@compUrl" target="_blank" rel="noopener" download>
                        <i class="fas fa-download"></i> Descargar
                    </a>
                    <button type="button" class="btn-action btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Copiar etiqueta envío
            const btnCopy = document.getElementById('btnCopy');
            if (btnCopy) {
                btnCopy.addEventListener('click', () => {
                    const textToCopy = document.getElementById('copyContent').innerText;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const prev = btnCopy.innerHTML;
                        btnCopy.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => btnCopy.innerHTML = prev, 1800);
                    });
                });
            }
            // Copiar depositante
            const btnDep = document.getElementById('copyDepositante');
            if (btnDep) {
                btnDep.addEventListener('click', () => {
                    const name = document.getElementById('depositanteText').innerText.trim();
                    if (!name || name === '—') return;
                    navigator.clipboard.writeText(name).then(() => {
                        const prev = btnDep.innerHTML;
                        btnDep.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => btnDep.innerHTML = '<i class="fas fa-copy"></i> Copiar', 1400);
                    });
                });
            }
            // Marcar como enviado (AJAX)
            const form = document.getElementById('markShippedForm');
            const btn  = document.getElementById('btnMarkShipped');
            if (form && btn) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (btn.disabled) return;
                    btn.disabled = true;
                    const prev = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    try {
                        const res = await fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'X-Requested-With':'XMLHttpRequest' }});
                        if (res.ok) {
                            let data = null; try { data = await res.json(); } catch {}
                            if (!data || data.ok) location.reload();
                        } else {
                            btn.disabled = false; btn.innerHTML = prev; alert('No se pudo marcar como enviado.');
                        }
                    } catch {
                        btn.disabled = false; btn.innerHTML = prev; alert('Error de red al marcar como enviado.');
                    }
                });
            }
        });
    </script>
}
