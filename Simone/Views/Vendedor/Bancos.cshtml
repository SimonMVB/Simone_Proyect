@using SimoneCfg = Simone.Configuration
@{
    ViewData["Title"] = "Mis Cuentas Bancarias";
    var cuentas = ViewBag.Cuentas as IEnumerable<SimoneCfg.CuentaBancaria> ?? Enumerable.Empty<SimoneCfg.CuentaBancaria>();

    bool isAdmin = User.IsInRole("Administrador");
    string? targetVendorId = ViewBag.TargetVendorId as string; // si Admin ayuda a un vendedor

    // Catálogo fijo (códigos y logos). Ajusta rutas si lo necesitas.
    var catalogo = new[] {
        new { Codigo="pichincha",   Nombre="Banco Pichincha",    Logo="/images/Bancos/pichincha.webp" },
        new { Codigo="guayaquil",   Nombre="Banco Guayaquil",    Logo="/images/Bancos/Guayaquil.png" },
        new { Codigo="pacifico",    Nombre="Banco del Pacífico", Logo="/images/Bancos/Pacifico.png" },
        new { Codigo="bolivariano", Nombre="Banco Bolivariano",  Logo="/images/Bancos/Bolivariano.webp" },
        new { Codigo="jep",         Nombre="Cooperativa JEP",    Logo="/images/Bancos/JEP.png" },
    };
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    .container-narrow {
        max-width: 1100px;
        margin: 0 auto
    }

    .card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,.06)
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0
    }

    .card-body {
        padding: 1.25rem
    }

    /* LOGOS: 56x56, sin recortes */
    .bank-logo {
        width: 56px;
        height: 56px;
        object-fit: contain;
        background: #fff;
        border: 1px solid #eaecef;
        border-radius: 12px
    }

    /* preview */
    .bank-preview {
        display: flex;
        gap: 16px;
        align-items: center;
        background: #f8fafc;
        border: 1px solid #eef0f4;
        padding: 14px 16px;
        border-radius: 14px
    }

    .text-mono {
        font-family: ui-monospace,Menlo,Consolas,monospace
    }

    .badge-dot {
        display: inline-flex;
        align-items: center;
        gap: .4rem
    }

        .badge-dot i {
            font-size: .5rem
        }
</style>

<div class="container-narrow py-4">
    <h2 class="mb-3">
        <i class="fas fa-university me-2"></i>@ViewData["Title"]
        @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
        {
            <small class="text-muted ms-2">(Ayudando a: <code>@targetVendorId</code>)</small>
        }
    </h2>

    @if (TempData["MensajeExito"] is string ok)
    {
        <div class="alert alert-success"><i class="fas fa-check-circle me-1"></i>@ok</div>
    }
    @if (TempData["MensajeError"] is string ko)
    {
        <div class="alert alert-danger"><i class="fas fa-triangle-exclamation me-1"></i>@ko</div>
    }

    <!-- ===== Formulario tipo ADMIN ===== -->
    <div class="card mb-4">
        <div class="card-header">
            <strong><i class="fas fa-pen-to-square me-2"></i>Agregar / editar cuenta</strong>
        </div>
        <div class="card-body">
            <form asp-controller="Vendedor" asp-action="Save" method="post" id="frmBanco" class="row g-3" novalidate>
                @Html.AntiForgeryToken()
                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                {
                    <input type="hidden" name="vId" value="@targetVendorId" />
                }

                <!-- se usa al editar -->
                <input type="hidden" id="OriginalCodigo" name="OriginalCodigo" />

                <!-- Catálogo de bancos (elige y se autocompleta) -->
                <div class="col-12">
                    <label class="form-label fw-semibold">Banco</label>
                    <select id="ddlBanco" class="form-select" required>
                        <option value="">Selecciona un banco...</option>
                        @foreach (var b in catalogo)
                        {
                            <option value="@b.Codigo" data-nombre="@b.Nombre" data-logo="@b.Logo">@b.Nombre</option>
                        }
                    </select>
                    <div class="form-text">Al seleccionar, se autocompletan el nombre y el logo.</div>
                </div>

                <!-- Preview -->
                <div class="col-12">
                    <div class="bank-preview">
                        <img id="logoPreview" class="bank-logo" src="/images/product-placeholder.png"
                             onerror="this.src='/images/product-placeholder.png'">
                        <div>
                            <div class="fw-semibold" id="bankName">—</div>
                            <div class="small text-muted">Los datos del banco se establecen automáticamente.</div>
                        </div>
                    </div>
                </div>

                <!-- Campos que edita el vendedor -->
                <div class="col-md-4">
                    <label class="form-label">Número de cuenta</label>
                    <input id="Numero" name="Numero" class="form-control" inputmode="numeric" maxlength="20" pattern="[0-9]{6,20}"
                           placeholder="Ej. 2210704773" required>
                    <div class="invalid-feedback">Ingrese un número válido (solo dígitos, 6–20).</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select id="Tipo" name="Tipo" class="form-select" required>
                        <option value="Cuenta de Ahorros">Cuenta de Ahorros</option>
                        <option value="Cuenta Corriente">Cuenta Corriente</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Titular <small class="text-muted">(opcional)</small></label>
                    <input id="Titular" name="Titular" class="form-control" placeholder="Nombre del titular" maxlength="120">
                </div>

                <div class="col-md-4">
                    <label class="form-label">RUC / Cédula <small class="text-muted">(opcional)</small></label>
                    <input id="Ruc" name="Ruc" class="form-control" inputmode="numeric" pattern="^\d{10}(\d{3})?$" maxlength="13"
                           placeholder="10 o 13 dígitos">
                    <div class="form-text">Ej: cédula (10) o RUC (13).</div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="form-check">
                        <input type="hidden" name="Activo" value="false" />
                        <input class="form-check-input" type="checkbox" id="Activo" name="Activo" value="true" checked>
                        <label class="form-check-label" for="Activo">Activo</label>
                    </div>
                </div>

                <!-- Hidden que usa el backend (no los edita el vendedor) -->
                <input type="hidden" id="Codigo" name="Codigo" required maxlength="50">
                <input type="hidden" id="Nombre" name="Nombre" required maxlength="120">
                <input type="hidden" id="LogoPath" name="LogoPath" maxlength="200">

                <div class="col-12">
                    <button type="submit" class="btn btn-primary me-2" id="btnGuardar">
                        <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
                    </button>
                    <button type="reset" class="btn btn-outline-secondary" id="btnLimpiar">
                        <i class="fa-solid fa-eraser me-1"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== Listado ===== -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong><i class="fa-solid fa-list-ul me-2"></i>Cuentas registradas</strong>
            <span class="text-muted small">@cuentas.Count() registro(s)</span>
        </div>
        <div class="card-body">
            @if (!cuentas.Any())
            {
                <div class="alert alert-info mb-0">Aún no has registrado cuentas bancarias.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width:72px;">Logo</th>
                                <th>Banco</th>
                                <th>Número</th>
                                <th>Tipo</th>
                                <th>Titular</th>
                                <th>RUC</th>
                                <th>Estado</th>
                                <th style="width:170px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in cuentas)
                            {
                                var logo = string.IsNullOrWhiteSpace(c.LogoPath) ? "/images/product-placeholder.png" : c.LogoPath;
                                <tr>
                                    <td><img class="bank-logo" src="@logo" alt="@c.Nombre" onerror="this.src='/images/product-placeholder.png'"></td>
                                    <td>@(string.IsNullOrWhiteSpace(c.Nombre) ? c.Codigo : c.Nombre)</td>
                                    <td class="text-mono">@c.Numero</td>
                                    <td>@c.Tipo</td>
                                    <td>@(c.Titular ?? "-")</td>
                                    <td>@(c.Ruc ?? "-")</td>
                                    <td>
                                        @if (c.Activo)
                                        {
                                            <span class="badge bg-success badge-dot"><i class="fa-solid fa-circle"></i> Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary badge-dot"><i class="fa-solid fa-circle"></i> Inactivo</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <button type="button"
                                                    class="btn btn-outline-primary btn-sm"
                                                    title="Editar"
                                                    data-codigo="@c.Codigo"
                                                    data-nombre="@(c.Nombre ?? "")"
                                                    data-numero="@(c.Numero ?? "")"
                                                    data-tipo="@(c.Tipo ?? "")"
                                                    data-titular="@(c.Titular ?? "")"
                                                    data-ruc="@(c.Ruc ?? "")"
                                                    data-logo="@(c.LogoPath ?? "")"
                                                    data-activo="@(c.Activo ? "true" : "false")"
                                                    onclick="editarDesdeData(this)">
                                                <i class="fa-regular fa-pen-to-square"></i>
                                            </button>

                                            <form method="post" asp-controller="Vendedor" asp-action="Toggle" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                                                {
                                                    <input type="hidden" name="vId" value="@targetVendorId" />
                                                }
                                                <input type="hidden" name="codigo" value="@c.Codigo" />
                                                <button class="btn btn-outline-secondary btn-sm" title="Activar/Desactivar"><i class="fa-solid fa-power-off"></i></button>
                                            </form>

                                            <form method="post" asp-controller="Vendedor" asp-action="Delete" class="d-inline" onsubmit="return confirm('¿Eliminar la cuenta @((c.Nombre ?? c.Codigo))?');">
                                                @Html.AntiForgeryToken()
                                                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                                                {
                                                    <input type="hidden" name="vId" value="@targetVendorId" />
                                                }
                                                <input type="hidden" name="codigo" value="@c.Codigo" />
                                                <button class="btn btn-outline-danger btn-sm" title="Eliminar"><i class="fa-regular fa-trash-can"></i></button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script>
    (() => {
      const $ = s => document.querySelector(s);
      const ddl   = $("#ddlBanco");
      const nameL = $("#bankName");
      const logo  = $("#logoPreview");

      const frm   = $("#frmBanco");
      const hOrig = $("#OriginalCodigo");
      const hCod  = $("#Codigo");
      const hNom  = $("#Nombre");
      const hLogo = $("#LogoPath");

      const inpN  = $("#Numero");
      const selT  = $("#Tipo");
      const inpTi = $("#Titular");
      const inpR  = $("#Ruc");
      const chkA  = $("#Activo");
      const btnG  = $("#btnGuardar");

      function setPreview(nombre, logoPath){
        nameL.textContent = nombre || "—";
        logo.src = (logoPath || "/images/product-placeholder.png");
      }

      function setFromCatalog(opt){
        if (!opt){ setPreview(null, null); hCod.value=hNom.value=hLogo.value=""; return; }
        const code = opt.value;
        const name = opt.getAttribute("data-nombre") || code;
        const img  = opt.getAttribute("data-logo")   || "/images/product-placeholder.png";
        hCod.value  = code;
        hNom.value  = name;
        hLogo.value = img;
        setPreview(name, img);
      }

      ddl?.addEventListener("change", function(){
        const opt = this.selectedIndex > 0 ? this.options[this.selectedIndex] : null;
        setFromCatalog(opt);
        if (!selT.value) selT.value = "Cuenta de Ahorros";
      });

      // Editar desde la tabla
      window.editarDesdeData = (btn) => {
        const d = btn.dataset;
        editar(d.codigo, d.nombre || '', d.numero || '', d.tipo || '',
               d.titular || '', d.ruc || '', d.logo || '', d.activo === 'true');
      };

      function editar(codigo, nombre, numero, tipo, titular, ruc, logoPath, activo){
        hOrig.value = codigo;
        hCod.value  = codigo;
        hNom.value  = nombre || codigo;
        hLogo.value = logoPath || "/images/product-placeholder.png";
        setPreview(hNom.value, hLogo.value);

        // Selecciona en el catálogo si existe
        if (ddl){
          const opt = Array.from(ddl.options).find(o => o.value === codigo);
          ddl.value = opt ? codigo : "";
        }

        inpN.value   = numero || "";
        selT.value   = tipo || "Cuenta de Ahorros";
        inpTi.value  = titular || "";
        inpR.value   = ruc || "";
        chkA.checked = !!activo;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Limpiar
      $("#btnLimpiar")?.addEventListener("click", () => {
        setTimeout(() => {
          frm.reset();
          ddl.value = "";
          hOrig.value = "";
          hCod.value = hNom.value = hLogo.value = "";
          setPreview(null, null);
          frm.classList.remove("was-validated");
          btnG && (btnG.disabled = false);
        }, 0);
      });

      frm?.addEventListener("submit", (e) => {
        // Si eligió del catálogo, asegura los hidden
        if (!hCod.value && ddl && ddl.value){
          const opt = ddl.options[ddl.selectedIndex];
          setFromCatalog(opt);
        }
        if (!frm.checkValidity()){
          e.preventDefault(); e.stopPropagation();
        } else {
          btnG && (btnG.disabled = true);
        }
        frm.classList.add("was-validated");
      });
    })();
</script>
