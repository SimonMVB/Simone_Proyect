@using SimoneCfg = Simone.Configuration
@{
    ViewData["Title"] = "Tarifas de envío";
    var reglas = ViewBag.Reglas as IEnumerable<SimoneCfg.TarifaEnvioRegla> ?? Enumerable.Empty<SimoneCfg.TarifaEnvioRegla>();

    bool isAdmin = User.IsInRole("Administrador");
    string? targetVendorId = ViewBag.TargetVendorId as string; // si Admin ayuda a un vendedor
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    .container-narrow {
        max-width: 1100px;
        margin: 0 auto
    }

    .card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,.06)
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0
    }

    .card-body {
        padding: 1.25rem
    }

    .badge-dot {
        display: inline-flex;
        align-items: center;
        gap: .4rem
    }

        .badge-dot i {
            font-size: .5rem
        }

    .text-mono {
        font-family: ui-monospace,Menlo,Consolas,monospace
    }

    .hint {
        color: #6b7280;
        font-size: .92rem
    }

    .table td, .table th {
        vertical-align: middle
    }

    .pill {
        background: #fff7ed;
        border: 1px solid #ffedd5;
        color: #9a3412;
        padding: .2rem .5rem;
        border-radius: 999px;
        font-size: .8rem
    }
</style>

<div class="container-narrow py-4">
    <h2 class="mb-3">
        <i class="fa-solid fa-truck-fast me-2"></i>@ViewData["Title"]
        @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
        {
            <small class="text-muted ms-2">(Ayudando a: <code>@targetVendorId</code>)</small>
        }
    </h2>

    @if (TempData["MensajeExito"] is string ok)
    {
        <div class="alert alert-success"><i class="fas fa-check-circle me-1"></i>@ok</div>
    }
    @if (TempData["MensajeError"] is string ko)
    {
        <div class="alert alert-danger"><i class="fas fa-triangle-exclamation me-1"></i>@ko</div>
    }

    <!-- ===== Formulario ===== -->
    <div class="card mb-4">
        <div class="card-header">
            <strong><i class="fa-solid fa-pen-to-square me-2"></i>Agregar / editar tarifa</strong>
        </div>
        <div class="card-body">
            <form asp-controller="Vendedor" asp-action="EnviosSave" method="post" id="frmEnvio" class="row g-3" novalidate>
                @Html.AntiForgeryToken()
                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                {
                    <input type="hidden" name="vId" value="@targetVendorId" />
                }

                <!-- claves al editar -->
                <input type="hidden" id="OriginalProvincia" name="OriginalProvincia" />
                <input type="hidden" id="OriginalCiudad" name="OriginalCiudad" />

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Provincia</label>
                    <select id="Provincia" name="Provincia" class="form-select" required></select>
                    <div class="invalid-feedback">Selecciona una provincia.</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Ciudad</label>
                    <select id="Ciudad" name="Ciudad" class="form-select"></select>
                    <div class="hint">Déjalo vacío para que la regla aplique a toda la provincia.</div>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-semibold">Precio</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input id="Precio" name="Precio" type="number" class="form-control text-end" step="0.01" min="0" max="9999.99" placeholder="0.50" required />
                    </div>
                    <div class="invalid-feedback">Ingresa un precio válido (0 – 9999.99).</div>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <div class="form-check">
                        <input type="hidden" name="Activo" value="false" />
                        <input class="form-check-input" type="checkbox" id="Activo" name="Activo" value="true" checked>
                        <label class="form-check-label" for="Activo">Activo</label>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label">Nota <small class="text-muted">(opcional)</small></label>
                    <input id="Nota" name="Nota" class="form-control" maxlength="120" placeholder="Ej.: Envío urbano moto mensajería" />
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary me-2" id="btnGuardar">
                        <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
                    </button>
                    <button type="reset" class="btn btn-outline-secondary" id="btnLimpiar">
                        <i class="fa-solid fa-eraser me-1"></i> Limpiar
                    </button>
                    <span class="ms-2 pill"><i class="fa-solid fa-lightbulb me-1"></i> Prioridad: Ciudad &gt; Provincia</span>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== Listado ===== -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong><i class="fa-solid fa-list-ul me-2"></i>Tarifas registradas</strong>
            <span class="text-muted small">@reglas.Count() registro(s)</span>
        </div>
        <div class="card-body">
            @if (!reglas.Any())
            {
                <div class="alert alert-info mb-0">Aún no has registrado tarifas de envío.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Provincia</th>
                                <th>Ciudad</th>
                                <th class="text-end">Precio</th>
                                <th>Estado</th>
                                <th>Nota</th>
                                <th style="width:170px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in reglas)
                            {
                                <tr>
                                    <td>@r.Provincia</td>
                                    <td>@(string.IsNullOrWhiteSpace(r.Ciudad) ? "— (toda la provincia)" : r.Ciudad)</td>
                                    <td class="text-end text-mono">$ @r.Precio.ToString("0.##")</td>
                                    <td>
                                        @if (r.Activo)
                                        {
                                            <span class="badge bg-success badge-dot"><i class="fa-solid fa-circle"></i> Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary badge-dot"><i class="fa-solid fa-circle"></i> Inactivo</span>
                                        }
                                    </td>
                                    <td>@(string.IsNullOrWhiteSpace(r.Nota) ? "-" : r.Nota)</td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <button type="button"
                                                    class="btn btn-outline-primary btn-sm"
                                                    title="Editar"
                                                    data-provincia="@r.Provincia"
                                                    data-ciudad="@(r.Ciudad ?? "")"
                                                    data-precio="@r.Precio"
                                                    data-activo="@(r.Activo ? "true" : "false")"
                                                    data-nota="@(r.Nota ?? "")"
                                                    onclick="editarTarifa(this)">
                                                <i class="fa-regular fa-pen-to-square"></i>
                                            </button>

                                            <form method="post" asp-controller="Vendedor" asp-action="EnviosToggle" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                                                {
                                                    <input type="hidden" name="vId" value="@targetVendorId" />
                                                }
                                                <input type="hidden" name="provincia" value="@r.Provincia" />
                                                <input type="hidden" name="ciudad" value="@(r.Ciudad ?? "")" />
                                                <button class="btn btn-outline-secondary btn-sm" title="Activar/Desactivar"><i class="fa-solid fa-power-off"></i></button>
                                            </form>

                                            <form method="post" asp-controller="Vendedor" asp-action="EnviosDelete" class="d-inline" onsubmit="return confirm('¿Eliminar la tarifa de @r.Provincia / @((r.Ciudad ?? "provincia completa"))?');">
                                                @Html.AntiForgeryToken()
                                                @if (isAdmin && !string.IsNullOrWhiteSpace(targetVendorId))
                                                {
                                                    <input type="hidden" name="vId" value="@targetVendorId" />
                                                }
                                                <input type="hidden" name="provincia" value="@r.Provincia" />
                                                <input type="hidden" name="ciudad" value="@(r.Ciudad ?? "")" />
                                                <button class="btn btn-outline-danger btn-sm" title="Eliminar"><i class="fa-regular fa-trash-can"></i></button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script>
    (() => {
      // --- Catálogo EC (extensible). Si ya tienes otro origen, reemplaza aquí.
      const CAT = {
        "Azuay": ["Cuenca","Gualaceo","Paute","Sígsig","Nabón","Girón","Santa Isabel"],
        "Bolívar": ["Guaranda","Chillanes","Echeandía"],
        "Cañar": ["Azogues","La Troncal","El Tambo","Cañar"],
        "Carchi": ["Tulcán","Montúfar","Mira"],
        "Chimborazo": ["Riobamba","Guano","Alausí","Colta","Chambo"],
        "Cotopaxi": ["Latacunga","Salcedo","Saquisilí","Pujilí"],
        "El Oro": ["Machala","Santa Rosa","Pasaje","Huaquillas","Arenillas"],
        "Esmeraldas": ["Esmeraldas","Atacames","Quinindé","Muisne"],
        "Galápagos": ["Puerto Ayora","Puerto Baquerizo Moreno","Puerto Villamil"],
        "Guayas": ["Guayaquil","Daule","Samborondón","Durán","Milagro","Playas","El Triunfo","Naranjal","Balao"],
        "Imbabura": ["Ibarra","Otavalo","Cotacachi","Atuntaqui"],
        "Loja": ["Loja","Catamayo","Macará","Cariamanga"],
        "Los Ríos": ["Babahoyo","Quevedo","Vinces","Puebloviejo","Buena Fe"],
        "Manabí": ["Portoviejo","Manta","Chone","Bahía de Caráquez","Jipijapa","El Carmen"],
        "Morona Santiago": ["Macas","Sucúa","Gualaquiza","Taisha"],
        "Napo": ["Tena","Archidona","El Chaco"],
        "Orellana": ["Coca","La Joya de los Sachas","Loreto"],
        "Pastaza": ["Puyo","Mera","Santa Clara"],
        "Pichincha": ["Quito","Sangolquí","Cayambe","Machachi","San Antonio de Pichincha"],
        "Santa Elena": ["La Libertad","Salinas","Santa Elena"],
        "Santo Domingo de los Tsáchilas": ["Santo Domingo","La Concordia"],
        "Sucumbíos": ["Lago Agrio","Shushufindi","Cuyabeno"],
        "Tungurahua": ["Ambato","Baños","Pelileo","Tisaleo","Cevallos"],
        "Zamora Chinchipe": ["Zamora","Yantzaza","Zumba"]
      };

      const $ = s => document.querySelector(s);
      const ddlProv = $("#Provincia");
      const ddlCity = $("#Ciudad");

      const frm = $("#frmEnvio");
      const btnG = $("#btnGuardar");

      const hOrigP = $("#OriginalProvincia");
      const hOrigC = $("#OriginalCiudad");

      const inpPrecio = $("#Precio");
      const chkActivo = $("#Activo");
      const inpNota = $("#Nota");

      // Rellenar provincias
      function fillProvinces() {
        ddlProv.innerHTML = '<option value="">Selecciona una provincia...</option>';
        Object.keys(CAT).sort().forEach(p => {
          const opt = document.createElement("option");
          opt.value = p; opt.textContent = p; ddlProv.appendChild(opt);
        });
      }

      // Rellenar ciudades según provincia
      function fillCities(prov, selected="") {
        ddlCity.innerHTML = '<option value="">(toda la provincia)</option>';
        const arr = CAT[prov] || [];
        arr.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          if (selected && selected.toLowerCase() === c.toLowerCase()) opt.selected = true;
          ddlCity.appendChild(opt);
        });
      }

      ddlProv?.addEventListener("change", () => {
        fillCities(ddlProv.value, "");
      });

      // Editar desde tabla
      window.editarTarifa = (btn) => {
        const d = btn.dataset;
        const prov = d.provincia || "";
        const city = d.ciudad || "";
        const price = d.precio || "";
        const act = d.activo === "true";
        const nota = d.nota || "";

        // claves originales
        hOrigP.value = prov;
        hOrigC.value = city;

        // form
        ddlProv.value = prov;
        fillCities(prov, city);
        inpPrecio.value = price;
        chkActivo.checked = act;
        inpNota.value = nota;

        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      // Limpiar
      $("#btnLimpiar")?.addEventListener("click", () => {
        setTimeout(() => {
          frm.reset();
          hOrigP.value = ""; hOrigC.value = "";
          ddlProv.value = "";
          ddlCity.innerHTML = '<option value="">(toda la provincia)</option>';
          frm.classList.remove("was-validated");
          btnG && (btnG.disabled = false);
        }, 0);
      });

      // Validación submit
      frm?.addEventListener("submit", (e) => {
        if (!frm.checkValidity()) {
          e.preventDefault(); e.stopPropagation();
        } else {
          btnG && (btnG.disabled = true);
        }
        frm.classList.add("was-validated");
      });

      // Init
      fillProvinces();
      fillCities("", "");
    })();
</script>
