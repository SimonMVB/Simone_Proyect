@model CatalogoViewModel
@using System.Globalization
@using System.Text.Json

@* ============================================
   CATÁLOGO - Neo Agora E-Commerce
   Vista principal de productos con filtros
   Versión Enterprise v2.0
   Ubicación: Views/Compras/Catalogo.cshtml
   ============================================ *@

@{
    ViewData["Title"] = Model.SelectedCategoriaID.HasValue
        ? Model.Categorias.FirstOrDefault(c => c.CategoriaID == Model.SelectedCategoriaID)?.Nombre ?? "Catálogo"
        : "Catálogo de Productos";

    ViewData["Description"] = $"Explora nuestro catálogo con {Model.TotalProducts} productos. Filtra por categoría, color, talla y más.";

    // Helpers
    IFormatProvider EcFormat() => CultureInfo.CreateSpecificCulture("es-EC");
    bool EsNuevo(DateTime fecha) => (DateTime.Now - fecha).TotalDays <= 30;

    // Active filters count
    var hasActiveFilters = !string.IsNullOrWhiteSpace(Model.SearchTerm)
        || Model.PrecioMin.HasValue
        || Model.PrecioMax.HasValue
        || Model.SelectedCategoriaID.HasValue
        || Model.SelectedSubcategoriaIDs.Any()
        || Model.ColoresSeleccionados.Any()
        || Model.TallasSeleccionadas.Any()
        || Model.SoloDisponibles;

    var totalFiltros = (!string.IsNullOrWhiteSpace(Model.SearchTerm) ? 1 : 0)
        + ((Model.PrecioMin.HasValue || Model.PrecioMax.HasValue) ? 1 : 0)
        + (Model.SelectedCategoriaID.HasValue ? 1 : 0)
        + Model.SelectedSubcategoriaIDs.Count
        + Model.ColoresSeleccionados.Count
        + Model.TallasSeleccionadas.Count
        + (Model.SoloDisponibles ? 1 : 0);
}

@functions {
    /// <summary>
    /// Construye URL con todos los parámetros de filtro
    /// </summary>
    string BuildUrl(
        string? searchTerm,
        decimal? precioMin,
        decimal? precioMax,
        int? categoriaID,
        List<int>? subcategoriaIDs,
        int pageNumber,
        int pageSize,
        IEnumerable<string>? coloresSel,
        IEnumerable<string>? tallasSel,
        bool soloDisp,
        string? sort = null)
    {
        var queryParams = new List<string>();

        if (!string.IsNullOrWhiteSpace(searchTerm))
            queryParams.Add($"searchTerm={Uri.EscapeDataString(searchTerm)}");

        if (precioMin.HasValue && precioMin.Value > 0)
            queryParams.Add($"precioMin={precioMin.Value}");

        if (precioMax.HasValue && precioMax.Value > 0)
            queryParams.Add($"precioMax={precioMax.Value}");

        if (categoriaID.HasValue)
            queryParams.Add($"categoriaID={categoriaID.Value}");

        if (subcategoriaIDs != null && subcategoriaIDs.Any())
            queryParams.AddRange(subcategoriaIDs.Select(id => $"subcategoriaIDs={id}"));

        if (coloresSel != null)
            foreach (var c in coloresSel.Where(s => !string.IsNullOrWhiteSpace(s)))
                queryParams.Add($"ColoresSeleccionados={Uri.EscapeDataString(c)}");

        if (tallasSel != null)
            foreach (var t in tallasSel.Where(s => !string.IsNullOrWhiteSpace(s)))
                queryParams.Add($"TallasSeleccionadas={Uri.EscapeDataString(t)}");

        if (soloDisp)
            queryParams.Add("SoloDisponibles=true");

        if (!string.IsNullOrWhiteSpace(sort))
            queryParams.Add($"sort={Uri.EscapeDataString(sort)}");

        queryParams.Add($"pageNumber={pageNumber}");
        queryParams.Add($"pageSize={pageSize}");

        var baseUrl = Url.Action("Catalogo")!;
        return queryParams.Count > 0 ? $"{baseUrl}?{string.Join("&", queryParams)}" : baseUrl;
    }

    /// <summary>
    /// Construye URL removiendo un filtro específico
    /// </summary>
    string RemoveFilterUrl(string filterType, string? filterValue = null)
    {
        var newSearchTerm = Model.SearchTerm;
        var newPrecioMin = Model.PrecioMin;
        var newPrecioMax = Model.PrecioMax;
        var newCatID = Model.SelectedCategoriaID;
        var newSubIDs = Model.SelectedSubcategoriaIDs.ToList();
        var newColores = Model.ColoresSeleccionados.ToList();
        var newTallas = Model.TallasSeleccionadas.ToList();
        var newSoloDisp = Model.SoloDisponibles;

        switch (filterType.ToLower())
        {
            case "search":
                newSearchTerm = null;
                break;
            case "precio":
                newPrecioMin = null;
                newPrecioMax = null;
                break;
            case "categoria":
                newCatID = null;
                newSubIDs.Clear();
                break;
            case "subcategoria":
                if (int.TryParse(filterValue, out var subId))
                    newSubIDs.Remove(subId);
                break;
            case "color":
                newColores.Remove(filterValue ?? "");
                break;
            case "talla":
                newTallas.Remove(filterValue ?? "");
                break;
            case "disponibilidad":
                newSoloDisp = false;
                break;
        }

        return BuildUrl(newSearchTerm, newPrecioMin, newPrecioMax, newCatID, newSubIDs, 1, Model.PageSize, newColores, newTallas, newSoloDisp, Model.Sort);
    }

    /// <summary>
    /// Determina si un producto tiene stock disponible
    /// LÓGICA CORREGIDA: Verifica todas las fuentes de stock
    /// </summary>
    bool ProductoTieneStock(Producto producto)
    {
        // 1. Verificar en VariantesPorProducto (del ViewModel)
        if (Model.VariantesPorProducto.TryGetValue(producto.ProductoID, out var variantesDelModelo) && variantesDelModelo.Any())
        {
            return variantesDelModelo.Any(v => v.Stock > 0);
        }

        // 2. Verificar en las variantes directas del producto
        if (producto.Variantes != null && producto.Variantes.Any())
        {
            return producto.Variantes.Any(v => v.Stock > 0);
        }

        // 3. Si no hay variantes, usar el stock directo del producto
        return producto.Stock > 0;
    }

    /// <summary>
    /// Obtiene las variantes del producto desde cualquier fuente disponible
    /// </summary>
    List<ProductoVariante> ObtenerVariantes(Producto producto)
    {
        // Priorizar VariantesPorProducto del ViewModel
        if (Model.VariantesPorProducto.TryGetValue(producto.ProductoID, out var variantesDelModelo) && variantesDelModelo.Any())
        {
            return variantesDelModelo.ToList();
        }

        // Fallback a las variantes directas del producto
        return producto.Variantes?.ToList() ?? new List<ProductoVariante>();
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/catalogo.css" asp-append-version="true" />
}

<!-- ============================================
     PÁGINA DEL CATÁLOGO
     ============================================ -->
<div class="catalog-page">
    <div class="catalog-container py-4">

        <!-- ========== BREADCRUMB ========== -->
        <nav class="catalog-breadcrumb" aria-label="Navegación">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Home")">
                        <i class="fa-solid fa-house" aria-hidden="true"></i>
                        <span class="d-none d-sm-inline ms-1">Inicio</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Catalogo")">Catálogo</a>
                </li>
                @if (Model.SelectedCategoriaID.HasValue)
                {
                    var categoria = Model.Categorias.FirstOrDefault(c => c.CategoriaID == Model.SelectedCategoriaID);
                    <li class="breadcrumb-item active" aria-current="page">@categoria?.Nombre</li>
                }
                else
                {
                    <li class="breadcrumb-item active" aria-current="page">Todos los productos</li>
                }
            </ol>
        </nav>

        <!-- ========== FILTROS ACTIVOS ========== -->
        @if (hasActiveFilters)
        {
            <div class="active-filters" role="status" aria-live="polite">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="active-filters-label">
                        <i class="fa-solid fa-filter" aria-hidden="true"></i>
                        Filtros:
                    </span>

                    @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                    {
                        <span class="filter-chip">
                            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                            Búsqueda: "@Model.SearchTerm"
                            <a href="@RemoveFilterUrl("search")" class="filter-chip-close" aria-label="Quitar búsqueda">&times;</a>
                        </span>
                    }

                    @if (Model.PrecioMin.HasValue || Model.PrecioMax.HasValue)
                    {
                        <span class="filter-chip">
                            <i class="fa-solid fa-dollar-sign" aria-hidden="true"></i>
                            @if (Model.PrecioMin.HasValue && Model.PrecioMax.HasValue)
                            {
                                @: $@Model.PrecioMin.Value.ToString("N2") - $@Model.PrecioMax.Value.ToString("N2")
                            }
                            else if (Model.PrecioMin.HasValue)
                            {
                                @: Desde $@Model.PrecioMin.Value.ToString("N2")
                            }
                            else
                            {
                                @: Hasta $@Model.PrecioMax!.Value.ToString("N2")
                            }
                            <a href="@RemoveFilterUrl("precio")" class="filter-chip-close" aria-label="Quitar filtro de precio">&times;</a>
                        </span>
                    }

                    @if (Model.SelectedCategoriaID.HasValue)
                    {
                        var cat = Model.Categorias.FirstOrDefault(c => c.CategoriaID == Model.SelectedCategoriaID);
                        <span class="filter-chip">
                            <i class="fa-solid fa-folder" aria-hidden="true"></i>
                            @cat?.Nombre
                            <a href="@RemoveFilterUrl("categoria")" class="filter-chip-close" aria-label="Quitar filtro @cat?.Nombre">&times;</a>
                        </span>
                    }

                    @foreach (var subId in Model.SelectedSubcategoriaIDs)
                    {
                        var sub = Model.Subcategorias.FirstOrDefault(s => s.SubcategoriaID == subId);
                        <span class="filter-chip">
                            <i class="fa-solid fa-tag" aria-hidden="true"></i>
                            @sub?.NombreSubcategoria
                            <a href="@RemoveFilterUrl("subcategoria", subId.ToString())" class="filter-chip-close" aria-label="Quitar filtro @sub?.NombreSubcategoria">&times;</a>
                        </span>
                    }

                    @foreach (var color in Model.ColoresSeleccionados)
                    {
                        <span class="filter-chip">
                            <span class="filter-color-dot" data-color="@color"></span>
                            @color
                            <a href="@RemoveFilterUrl("color", color)" class="filter-chip-close" aria-label="Quitar filtro color @color">&times;</a>
                        </span>
                    }

                    @foreach (var talla in Model.TallasSeleccionadas)
                    {
                        <span class="filter-chip">
                            <i class="fa-solid fa-ruler" aria-hidden="true"></i>
                            @talla
                            <a href="@RemoveFilterUrl("talla", talla)" class="filter-chip-close" aria-label="Quitar filtro talla @talla">&times;</a>
                        </span>
                    }

                    @if (Model.SoloDisponibles)
                    {
                        <span class="filter-chip">
                            <i class="fa-solid fa-check-circle" aria-hidden="true"></i>
                            En stock
                            <a href="@RemoveFilterUrl("disponibilidad")" class="filter-chip-close" aria-label="Quitar filtro disponibilidad">&times;</a>
                        </span>
                    }

                    <a href="@Url.Action("Catalogo")" class="btn btn-sm btn-outline-secondary ms-auto">
                        <i class="fa-solid fa-rotate-left me-1" aria-hidden="true"></i>
                        Limpiar
                    </a>
                </div>
            </div>
        }

        <!-- ========== ESTADÍSTICAS ========== -->
        <div class="catalog-stats" role="status">
            <span class="stat-item">
                <i class="fa-solid fa-box-open" aria-hidden="true"></i>
                <strong>@Model.TotalProducts</strong> producto@(Model.TotalProducts == 1 ? "" : "s")
            </span>
            @if (hasActiveFilters)
            {
                <span class="stat-item">
                    <i class="fa-solid fa-filter" aria-hidden="true"></i>
                    <strong>@totalFiltros</strong> filtro@(totalFiltros == 1 ? "" : "s")
                </span>
            }
            @if (Model.TotalPages > 1)
            {
                <span class="stat-item">
                    <i class="fa-solid fa-file" aria-hidden="true"></i>
                    Página <strong>@Model.PageNumber</strong> de <strong>@Model.TotalPages</strong>
                </span>
            }
        </div>

        <!-- ========== TOOLBAR ========== -->
        <div class="catalog-toolbar">
            <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <h1 class="h5 m-0">
                    @(Model.SelectedCategoriaID.HasValue
                        ? Model.Categorias.FirstOrDefault(c => c.CategoriaID == Model.SelectedCategoriaID)?.Nombre ?? "Catálogo"
                        : "Todos los productos")
                </h1>

                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <!-- Botón filtros móvil -->
                    <button class="btn btn-outline-secondary d-lg-none" type="button"
                            data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas"
                            aria-label="Mostrar filtros">
                        <i class="fa-solid fa-sliders" aria-hidden="true"></i>
                        Filtros
                    </button>

                    <!-- Ordenar y cantidad -->
                    <form method="get" asp-action="Catalogo" class="d-flex align-items-center gap-2">
                        @if (Model.SelectedCategoriaID.HasValue)
                        {
                            <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                        }
                        @foreach (var sid in Model.SelectedSubcategoriaIDs)
                        {
                            <input type="hidden" name="subcategoriaIDs" value="@sid" />
                        }
                        @foreach (var c in Model.ColoresSeleccionados)
                        {
                            <input type="hidden" name="ColoresSeleccionados" value="@c" />
                        }
                        @foreach (var t in Model.TallasSeleccionadas)
                        {
                            <input type="hidden" name="TallasSeleccionadas" value="@t" />
                        }
                        @if (Model.SoloDisponibles)
                        {
                            <input type="hidden" name="SoloDisponibles" value="true" />
                        }

                        <label for="sortSel" class="text-muted small d-none d-sm-inline">Ordenar</label>
                        <select class="form-select form-select-sm" name="sort" id="sortSel"
                                style="min-width:160px" onchange="this.form.submit()">
                            <option value="">Ordenar por</option>
                            @{
                                var sortOptions = new[] {
                                    ("precio_asc", "Precio: menor a mayor"),
                                    ("precio_desc", "Precio: mayor a menor"),
                                    ("nuevos", "Más recientes"),
                                    ("nombre_asc", "Nombre A-Z")
                                };
                            }
                            @foreach (var (value, text) in sortOptions)
                            {
                                if (Model.Sort == value)
                                {
                                    <option value="@value" selected>@text</option>
                                }
                                else
                                {
                                    <option value="@value">@text</option>
                                }
                            }
                        </select>

                        <label for="pageSizeSel" class="text-muted small d-none d-md-inline">Mostrar</label>
                        <select class="form-select form-select-sm" name="pageSize" id="pageSizeSel"
                                style="min-width:80px" onchange="this.form.submit()">
                            @{
                                var pageSizes = new[] { 12, 24, 36, 48 };
                            }
                            @foreach (var size in pageSizes)
                            {
                                if (Model.PageSize == size)
                                {
                                    <option value="@size" selected>@size</option>
                                }
                                else
                                {
                                    <option value="@size">@size</option>
                                }
                            }
                        </select>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========== CONTENIDO PRINCIPAL ========== -->
        <div class="row g-4">
            <!-- Sidebar Desktop -->
            <aside class="col-lg-3">
                <div class="card catalog-sidebar">
                    
                    <!-- ========== BÚSQUEDA ========== -->
                    <div class="filter-section search-section">
                        <h2 class="filter-section-title">
                            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                            Buscar Productos
                        </h2>
                        <form method="get" asp-action="Catalogo" id="searchForm" class="search-form">
                            @if (Model.SelectedCategoriaID.HasValue)
                            {
                                <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                            }
                            @foreach (var sid in Model.SelectedSubcategoriaIDs)
                            {
                                <input type="hidden" name="subcategoriaIDs" value="@sid" />
                            }
                            @foreach (var c in Model.ColoresSeleccionados)
                            {
                                <input type="hidden" name="ColoresSeleccionados" value="@c" />
                            }
                            @foreach (var t in Model.TallasSeleccionadas)
                            {
                                <input type="hidden" name="TallasSeleccionadas" value="@t" />
                            }
                            @if (Model.PrecioMin.HasValue)
                            {
                                <input type="hidden" name="precioMin" value="@Model.PrecioMin" />
                            }
                            @if (Model.PrecioMax.HasValue)
                            {
                                <input type="hidden" name="precioMax" value="@Model.PrecioMax" />
                            }
                            @if (Model.SoloDisponibles)
                            {
                                <input type="hidden" name="SoloDisponibles" value="true" />
                            }
                            <input type="hidden" name="sort" value="@Model.Sort" />
                            <input type="hidden" name="pageSize" value="@Model.PageSize" />

                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       name="searchTerm" 
                                       id="searchInput"
                                       value="@Model.SearchTerm" 
                                       placeholder="Buscar por nombre, marca..."
                                       autocomplete="off"
                                       aria-label="Buscar productos" />
                                <button class="btn btn-primary" type="submit" aria-label="Buscar">
                                    <i class="fa-solid fa-search"></i>
                                </button>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                            {
                                <div class="mt-2">
                                    <a href="@RemoveFilterUrl("search")" class="btn btn-sm btn-outline-secondary w-100">
                                        <i class="fa-solid fa-times me-1"></i> Limpiar búsqueda
                                    </a>
                                </div>
                            }
                        </form>
                    </div>

                    <!-- ========== FILTRO DE PRECIO ========== -->
                    <div class="filter-section price-filter-section">
                        <h2 class="filter-section-title">
                            <i class="fa-solid fa-dollar-sign" aria-hidden="true"></i>
                            Rango de Precio
                        </h2>
                        <form method="get" asp-action="Catalogo" id="priceForm">
                            @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                            {
                                <input type="hidden" name="searchTerm" value="@Model.SearchTerm" />
                            }
                            @if (Model.SelectedCategoriaID.HasValue)
                            {
                                <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                            }
                            @foreach (var sid in Model.SelectedSubcategoriaIDs)
                            {
                                <input type="hidden" name="subcategoriaIDs" value="@sid" />
                            }
                            @foreach (var c in Model.ColoresSeleccionados)
                            {
                                <input type="hidden" name="ColoresSeleccionados" value="@c" />
                            }
                            @foreach (var t in Model.TallasSeleccionadas)
                            {
                                <input type="hidden" name="TallasSeleccionadas" value="@t" />
                            }
                            @if (Model.SoloDisponibles)
                            {
                                <input type="hidden" name="SoloDisponibles" value="true" />
                            }
                            <input type="hidden" name="sort" value="@Model.Sort" />
                            <input type="hidden" name="pageSize" value="@Model.PageSize" />

                            <div class="price-inputs">
                                <div class="price-input-group">
                                    <label for="precioMin" class="form-label">Mínimo</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               name="precioMin" 
                                               id="precioMin"
                                               value="@Model.PrecioMin" 
                                               min="0" 
                                               step="0.01"
                                               placeholder="0.00"
                                               aria-label="Precio mínimo" />
                                    </div>
                                </div>
                                <div class="price-input-group">
                                    <label for="precioMax" class="form-label">Máximo</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               class="form-control" 
                                               name="precioMax" 
                                               id="precioMax"
                                               value="@Model.PrecioMax" 
                                               min="0" 
                                               step="0.01"
                                               placeholder="999.99"
                                               aria-label="Precio máximo" />
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm w-100 mt-2" type="submit">
                                <i class="fa-solid fa-filter me-1"></i> Aplicar
                            </button>
                            @if (Model.PrecioMin.HasValue || Model.PrecioMax.HasValue)
                            {
                                <a href="@RemoveFilterUrl("precio")" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                    <i class="fa-solid fa-times me-1"></i> Limpiar precio
                                </a>
                            }
                        </form>
                    </div>
                    
                    <!-- Categorías -->
                    <div class="filter-section">
                        <h2 class="filter-section-title">
                            <i class="fa-solid fa-folder-tree" aria-hidden="true"></i>
                            Categorías
                        </h2>
                        <form method="get" asp-action="Catalogo">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="categoriaID" value=""
                                       id="catAll" onchange="this.form.submit()"
                                       @(Model.SelectedCategoriaID == null ? "checked" : "") />
                                <label class="form-check-label" for="catAll">Todas</label>
                            </div>
                            @foreach (var cat in Model.Categorias)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoriaID"
                                           value="@cat.CategoriaID" id="cat-@cat.CategoriaID"
                                           onchange="this.form.submit()"
                                           @(cat.CategoriaID == Model.SelectedCategoriaID ? "checked" : "") />
                                    <label class="form-check-label" for="cat-@cat.CategoriaID">@cat.Nombre</label>
                                </div>
                            }
                        </form>
                    </div>

                    @if (Model.SelectedCategoriaID.HasValue && Model.Subcategorias.Any())
                    {
                        <!-- Subcategorías -->
                        <div class="filter-section">
                            <h2 class="filter-section-title">
                                <i class="fa-solid fa-tags" aria-hidden="true"></i>
                                Subcategorías
                            </h2>
                            <form method="get" asp-action="Catalogo" id="subcatForm">
                                <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                                @foreach (var c in Model.ColoresSeleccionados)
                                {
                                    <input type="hidden" name="ColoresSeleccionados" value="@c" />
                                }
                                @foreach (var t in Model.TallasSeleccionadas)
                                {
                                    <input type="hidden" name="TallasSeleccionadas" value="@t" />
                                }
                                @if (Model.SoloDisponibles)
                                {
                                    <input type="hidden" name="SoloDisponibles" value="true" />
                                }
                                <input type="hidden" name="sort" value="@Model.Sort" />
                                <input type="hidden" name="pageSize" value="@Model.PageSize" />

                                @foreach (var sub in Model.Subcategorias)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="subcategoriaIDs"
                                               value="@sub.SubcategoriaID" id="sub-@sub.SubcategoriaID"
                                               onchange="this.form.submit()"
                                               @(Model.SelectedSubcategoriaIDs.Contains(sub.SubcategoriaID) ? "checked" : "") />
                                        <label class="form-check-label" for="sub-@sub.SubcategoriaID">
                                            @sub.NombreSubcategoria
                                        </label>
                                    </div>
                                }
                            </form>
                        </div>
                    }

                    @if (Model.ColoresDisponibles.Any())
                    {
                        <!-- Colores -->
                        <div class="filter-section">
                            <h2 class="filter-section-title">
                                <i class="fa-solid fa-palette" aria-hidden="true"></i>
                                Colores
                            </h2>
                            <form method="get" asp-action="Catalogo" id="colorForm">
                                @if (Model.SelectedCategoriaID.HasValue)
                                {
                                    <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                                }
                                @foreach (var sid in Model.SelectedSubcategoriaIDs)
                                {
                                    <input type="hidden" name="subcategoriaIDs" value="@sid" />
                                }
                                @foreach (var t in Model.TallasSeleccionadas)
                                {
                                    <input type="hidden" name="TallasSeleccionadas" value="@t" />
                                }
                                @if (Model.SoloDisponibles)
                                {
                                    <input type="hidden" name="SoloDisponibles" value="true" />
                                }
                                <input type="hidden" name="sort" value="@Model.Sort" />
                                <input type="hidden" name="pageSize" value="@Model.PageSize" />

                                <div class="row g-2">
                                    @foreach (var color in Model.ColoresDisponibles)
                                    {
                                        var isChecked = Model.ColoresSeleccionados.Contains(color, StringComparer.OrdinalIgnoreCase);
                                        var colorId = $"color-{color.Replace(" ", "-")}";
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="ColoresSeleccionados"
                                                       value="@color" id="@colorId" onchange="this.form.submit()"
                                                       @(isChecked ? "checked" : "") />
                                                <label class="form-check-label" for="@colorId">
                                                    <span class="color-dot me-1" data-color="@color"></span>
                                                    @color
                                                </label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </form>
                        </div>
                    }

                    @if (Model.TallasDisponibles.Any())
                    {
                        <!-- Tallas -->
                        <div class="filter-section">
                            <h2 class="filter-section-title">
                                <i class="fa-solid fa-ruler" aria-hidden="true"></i>
                                Tallas
                            </h2>
                            <form method="get" asp-action="Catalogo" id="sizeForm">
                                @if (Model.SelectedCategoriaID.HasValue)
                                {
                                    <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                                }
                                @foreach (var sid in Model.SelectedSubcategoriaIDs)
                                {
                                    <input type="hidden" name="subcategoriaIDs" value="@sid" />
                                }
                                @foreach (var c in Model.ColoresSeleccionados)
                                {
                                    <input type="hidden" name="ColoresSeleccionados" value="@c" />
                                }
                                @if (Model.SoloDisponibles)
                                {
                                    <input type="hidden" name="SoloDisponibles" value="true" />
                                }
                                <input type="hidden" name="sort" value="@Model.Sort" />
                                <input type="hidden" name="pageSize" value="@Model.PageSize" />

                                <div class="row g-2">
                                    @foreach (var talla in Model.TallasDisponibles)
                                    {
                                        var isChecked = Model.TallasSeleccionadas.Contains(talla, StringComparer.OrdinalIgnoreCase);
                                        var tallaId = $"talla-{talla.Replace(" ", "-")}";
                                        <div class="col-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="TallasSeleccionadas"
                                                       value="@talla" id="@tallaId" onchange="this.form.submit()"
                                                       @(isChecked ? "checked" : "") />
                                                <label class="form-check-label" for="@tallaId">@talla</label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </form>
                        </div>
                    }

                    <!-- Disponibilidad -->
                    <div class="filter-section">
                        <h2 class="filter-section-title">
                            <i class="fa-solid fa-box" aria-hidden="true"></i>
                            Disponibilidad
                        </h2>
                        <form method="get" asp-action="Catalogo" id="stockForm">
                            @if (Model.SelectedCategoriaID.HasValue)
                            {
                                <input type="hidden" name="categoriaID" value="@Model.SelectedCategoriaID" />
                            }
                            @foreach (var sid in Model.SelectedSubcategoriaIDs)
                            {
                                <input type="hidden" name="subcategoriaIDs" value="@sid" />
                            }
                            @foreach (var c in Model.ColoresSeleccionados)
                            {
                                <input type="hidden" name="ColoresSeleccionados" value="@c" />
                            }
                            @foreach (var t in Model.TallasSeleccionadas)
                            {
                                <input type="hidden" name="TallasSeleccionadas" value="@t" />
                            }
                            <input type="hidden" name="sort" value="@Model.Sort" />
                            <input type="hidden" name="pageSize" value="@Model.PageSize" />

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="SoloDisponibles" value="true"
                                       id="soloDisp" onchange="this.form.submit()"
                                       @(Model.SoloDisponibles ? "checked" : "") />
                                <label class="form-check-label" for="soloDisp">Solo productos en stock</label>
                            </div>
                        </form>
                    </div>

                    <!-- Limpiar filtros -->
                    <div class="filter-section">
                        <a href="@Url.Action("Catalogo")" class="btn btn-light w-100">
                            <i class="fa-solid fa-rotate-left me-1" aria-hidden="true"></i>
                            Limpiar filtros
                        </a>
                    </div>
                </div>
            </aside>

            <!-- ========== GRID DE PRODUCTOS ========== -->
            <section class="col-lg-9">
                @if (!Model.Productos.Any())
                {
                    <!-- Estado vacío -->
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fa-regular fa-face-frown" aria-hidden="true"></i>
                        </div>
                        <h2>No encontramos productos</h2>
                        <p>
                            @if (hasActiveFilters)
                            {
                                <span>Intenta ajustar los filtros o ver todos los productos.</span>
                            }
                            else
                            {
                                <span>No hay productos disponibles en este momento.</span>
                            }
                        </p>
                        <a href="@Url.Action("Catalogo")" class="btn btn-primary">
                            <i class="fa-solid fa-boxes-stacked me-2" aria-hidden="true"></i>
                            Ver todos los productos
                        </a>
                    </div>
                }
                else
                {
                    <div class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3" id="productGrid">
                        @foreach (var producto in Model.Productos)
                        {
                            // Obtener variantes desde cualquier fuente
                            var variantes = ObtenerVariantes(producto);
                            var hasVariantes = variantes.Any();

                            // LÓGICA DE STOCK CORREGIDA
                            var tieneStock = ProductoTieneStock(producto);

                            // Colores disponibles
                            var coloresDisponibles = variantes
                                .Where(v => !string.IsNullOrWhiteSpace(v.Color) && v.Stock > 0)
                                .Select(v => v.Color!.Trim())
                                .Distinct(StringComparer.OrdinalIgnoreCase)
                                .ToList();

                            // Tallas disponibles
                            var tallasDisponibles = variantes
                                .Where(v => !string.IsNullOrWhiteSpace(v.Talla) && v.Stock > 0)
                                .Select(v => v.Talla!.Trim())
                                .Distinct(StringComparer.OrdinalIgnoreCase)
                                .ToList();

                            // Precios
                            var variantesConStock = variantes.Where(v => v.Stock > 0).ToList();
                            decimal minPrecio = variantesConStock.Any()
                                ? variantesConStock.Min(v => v.PrecioVenta ?? producto.PrecioVenta)
                                : producto.PrecioVenta;
                            decimal maxPrecio = variantesConStock.Any()
                                ? variantesConStock.Max(v => v.PrecioVenta ?? producto.PrecioVenta)
                                : producto.PrecioVenta;

                            // Clase para producto agotado
                            var cardClass = tieneStock ? "" : "is-out-of-stock";

                            <div class="col">
                                <article class="card product-card h-100 @cardClass"
                                         data-product-card
                                         data-product-id="@producto.ProductoID"
                                         data-has-stock="@tieneStock.ToString().ToLower()">

                                    <!-- Imagen del producto -->
                                    <div class="product-media">
                                        @if (tieneStock)
                                        {
                                            <a asp-controller="Compras" asp-action="VerProducto"
                                               asp-route-productoID="@producto.ProductoID"
                                               aria-label="Ver @producto.Nombre">
                                                <img src="@(string.IsNullOrWhiteSpace(producto.ImagenPath) ? Url.Content("~/images/Productos/default.jpg") : producto.ImagenPath)"
                                                     alt="@producto.Nombre"
                                                     loading="lazy"
                                                     onerror="this.src='@Url.Content("~/images/Productos/default.jpg")'" />
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="d-block w-100 h-100">
                                                <img src="@(string.IsNullOrWhiteSpace(producto.ImagenPath) ? Url.Content("~/images/Productos/default.jpg") : producto.ImagenPath)"
                                                     alt="@producto.Nombre - Agotado"
                                                     loading="lazy"
                                                     onerror="this.src='@Url.Content("~/images/Productos/default.jpg")'" />
                                            </span>
                                        }

                                        <!-- Badges -->
                                        <div class="product-badges">
                                            <div>
                                                @if (EsNuevo(producto.FechaAgregado) && tieneStock)
                                                {
                                                    <span class="product-badge badge-new">Nuevo</span>
                                                }
                                            </div>
                                            <div>
                                                @if (!tieneStock)
                                                {
                                                    <span class="product-badge badge-out">Agotado</span>
                                                }
                                            </div>
                                        </div>

                                        <!-- Wishlist -->
                                        <form class="wishlist-form" method="post"
                                              action="@Url.Action("Toggle", "Favoritos", new { id = producto.ProductoID })">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="wishlist-btn @(Model.ProductoIDsFavoritos.Contains(producto.ProductoID) ? "is-active" : "")"
                                                    aria-label="@(Model.ProductoIDsFavoritos.Contains(producto.ProductoID) ? "Quitar de favoritos" : "Añadir a favoritos")">
                                                <i class="@(Model.ProductoIDsFavoritos.Contains(producto.ProductoID) ? "fas" : "far") fa-heart"></i>
                                            </button>
                                        </form>

                                        <!-- Overlay con acciones (solo si tiene stock) -->
                                        @if (tieneStock && (coloresDisponibles.Any() || tallasDisponibles.Any()))
                                        {
                                            <div class="product-overlay">
                                                @if (coloresDisponibles.Any())
                                                {
                                                    <div class="overlay-colors">
                                                        @foreach (var color in coloresDisponibles.Take(6))
                                                        {
                                                            <button type="button" class="overlay-color-dot"
                                                                    data-color="@color"
                                                                    data-color-select="@color"
                                                                    title="@color"
                                                                    aria-label="Seleccionar color @color">
                                                            </button>
                                                        }
                                                        @if (coloresDisponibles.Count > 6)
                                                        {
                                                            <span class="text-white small">+@(coloresDisponibles.Count - 6)</span>
                                                        }
                                                    </div>
                                                }

                                                @if (tallasDisponibles.Any())
                                                {
                                                    <div class="overlay-sizes">
                                                        @foreach (var talla in tallasDisponibles.Take(5))
                                                        {
                                                            <button type="button" class="overlay-size-btn"
                                                                    data-size-select="@talla"
                                                                    aria-label="Seleccionar talla @talla">
                                                                @talla
                                                            </button>
                                                        }
                                                        @if (tallasDisponibles.Count > 5)
                                                        {
                                                            <span class="text-white small">+@(tallasDisponibles.Count - 5)</span>
                                                        }
                                                    </div>
                                                }

                                                <button type="button" class="overlay-add-btn" data-add-to-cart>
                                                    <i class="fa-solid fa-cart-plus" aria-hidden="true"></i>
                                                    Añadir al carrito
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Info del producto -->
                                    <div class="product-info">
                                        <div class="product-category">@producto.Categoria?.Nombre</div>
                                        <h3 class="product-name">
                                            @if (tieneStock)
                                            {
                                                <a asp-controller="Compras" asp-action="VerProducto"
                                                   asp-route-productoID="@producto.ProductoID">
                                                    @producto.Nombre
                                                </a>
                                            }
                                            else
                                            {
                                                <span>@producto.Nombre</span>
                                            }
                                        </h3>
                                        <div class="product-price" data-price>
                                            @if (hasVariantes && minPrecio != maxPrecio && tieneStock)
                                            {
                                                <span class="product-price-from">Desde</span>
                                            }
                                            @minPrecio.ToString("C", EcFormat())
                                        </div>
                                    </div>

                                    <!-- JSON de variantes para JS -->
                                    <script type="application/json" data-variants-json>
                                        @Html.Raw(JsonSerializer.Serialize(
                                            variantes.Select(v => new {
                                                id = v.ProductoVarianteID,
                                                color = v.Color,
                                                talla = v.Talla,
                                                stock = v.Stock,
                                                precio = v.PrecioVenta ?? producto.PrecioVenta
                                            }),
                                            new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
                                        ))
                                    </script>
                                </article>
                            </div>
                        }
                    </div>

                    <!-- Paginación -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav class="catalog-pagination" aria-label="Paginación">
                            <ul class="pagination">
                                @{
                                    var prevDisabled = Model.PageNumber <= 1;
                                    var nextDisabled = Model.PageNumber >= Model.TotalPages;
                                }

                                <li class="page-item @(prevDisabled ? "disabled" : "")">
                                    <a class="page-link"
                                       href="@(prevDisabled ? "#" : BuildUrl(Model.SearchTerm, Model.PrecioMin, Model.PrecioMax, Model.SelectedCategoriaID, Model.SelectedSubcategoriaIDs, Model.PageNumber - 1, Model.PageSize, Model.ColoresSeleccionados, Model.TallasSeleccionadas, Model.SoloDisponibles, Model.Sort))"
                                       aria-label="Anterior" @(prevDisabled ? "tabindex=-1" : "")>
                                        <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
                                    </a>
                                </li>

                                @{
                                    var start = Math.Max(1, Model.PageNumber - 2);
                                    var end = Math.Min(Model.TotalPages, Model.PageNumber + 2);

                                    if (start > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="@BuildUrl(Model.SearchTerm, Model.PrecioMin, Model.PrecioMax, Model.SelectedCategoriaID, Model.SelectedSubcategoriaIDs, 1, Model.PageSize, Model.ColoresSeleccionados, Model.TallasSeleccionadas, Model.SoloDisponibles, Model.Sort)">1</a>
                                        </li>
                                        if (start > 2)
                                        {
                                            <li class="page-item disabled"><span class="page-link">…</span></li>
                                        }
                                    }

                                    for (var i = start; i <= end; i++)
                                    {
                                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                            <a class="page-link" href="@BuildUrl(Model.SearchTerm, Model.PrecioMin, Model.PrecioMax, Model.SelectedCategoriaID, Model.SelectedSubcategoriaIDs, i, Model.PageSize, Model.ColoresSeleccionados, Model.TallasSeleccionadas, Model.SoloDisponibles, Model.Sort)"
                                               @(i == Model.PageNumber ? "aria-current=page" : "")>@i</a>
                                        </li>
                                    }

                                    if (end < Model.TotalPages)
                                    {
                                        if (end < Model.TotalPages - 1)
                                        {
                                            <li class="page-item disabled"><span class="page-link">…</span></li>
                                        }
                                        <li class="page-item">
                                            <a class="page-link" href="@BuildUrl(Model.SearchTerm, Model.PrecioMin, Model.PrecioMax, Model.SelectedCategoriaID, Model.SelectedSubcategoriaIDs, Model.TotalPages, Model.PageSize, Model.ColoresSeleccionados, Model.TallasSeleccionadas, Model.SoloDisponibles, Model.Sort)">@Model.TotalPages</a>
                                        </li>
                                    }
                                }

                                <li class="page-item @(nextDisabled ? "disabled" : "")">
                                    <a class="page-link"
                                       href="@(nextDisabled ? "#" : BuildUrl(Model.SearchTerm, Model.PrecioMin, Model.PrecioMax, Model.SelectedCategoriaID, Model.SelectedSubcategoriaIDs, Model.PageNumber + 1, Model.PageSize, Model.ColoresSeleccionados, Model.TallasSeleccionadas, Model.SoloDisponibles, Model.Sort))"
                                       aria-label="Siguiente" @(nextDisabled ? "tabindex=-1" : "")>
                                        <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </section>
        </div>
    </div>
</div>

<!-- ========== OFFCANVAS FILTROS MÓVIL ========== -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel">
            <i class="fa-solid fa-sliders me-2" aria-hidden="true"></i>
            Filtros
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Aquí puedes duplicar los filtros del sidebar para móvil -->
        <p class="text-muted">Usa los filtros en la barra lateral en pantallas más grandes.</p>
        <a href="@Url.Action("Catalogo")" class="btn btn-outline-secondary w-100">
            <i class="fa-solid fa-rotate-left me-1" aria-hidden="true"></i>
            Limpiar filtros
        </a>
    </div>
</div>

<!-- ========== TOASTS ========== -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="toastSuccess" class="toast" role="status" aria-live="polite">
        <div class="toast-header bg-success text-white">
            <i class="fa-solid fa-circle-check me-2" aria-hidden="true"></i>
            <strong class="me-auto">Éxito</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
        <div class="toast-body">Producto añadido al carrito.</div>
    </div>

    <div id="toastError" class="toast" role="alert" aria-live="assertive">
        <div class="toast-header bg-danger text-white">
            <i class="fa-solid fa-triangle-exclamation me-2" aria-hidden="true"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
        <div class="toast-body">No se pudo añadir el producto.</div>
    </div>
</div>

@section Scripts {
    <script src="~/js/catalogo.js" asp-append-version="true"></script>
    <script>
        // Inicializar catálogo con parámetros del servidor
        document.addEventListener('DOMContentLoaded', function() {
            CatalogApp.init({
                currentSort: '@(Model.Sort ?? "")',
                currentPageSize: @Model.PageSize,
                totalProducts: @Model.TotalProducts,
                activeFilters: @totalFiltros
            });
        });
    </script>
}
