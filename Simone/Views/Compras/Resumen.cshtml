@model Simone.Models.Usuario
@using System.Globalization
@using System.Text.Json
@using SimoneCfg = Simone.Configuration
@using Simone.Configuration

@{
    ViewData["Title"] = "Resumen de Compra";

    // Totales base
    decimal totalCompra = 0m;
    if (ViewBag.TotalCompra is decimal d) totalCompra = d;
    else if (ViewBag.TotalCompra != null) totalCompra = Convert.ToDecimal(ViewBag.TotalCompra);

    var culture = new CultureInfo("es-EC");

    // Env√≠o
    decimal envioTotal = 0m;
    if (ViewBag.EnvioTotal is decimal e) envioTotal = e;
    else if (ViewBag.EnvioTotal != null) envioTotal = Convert.ToDecimal(ViewBag.EnvioTotal);

    bool canComputeShipping = ((bool?)ViewBag.CanComputeShipping == true);
    var envioMensajes = (ViewBag.EnvioMensajes as IEnumerable<string>) ?? Enumerable.Empty<string>();
    var envioPorTienda = (ViewBag.EnvioPorTienda as IDictionary<string, decimal>) ?? new Dictionary<string, decimal>();

    decimal grandTotal = totalCompra + (canComputeShipping ? envioTotal : 0m);

    // Carrito
    var items = ViewBag.CarritoDetalles as IEnumerable<dynamic>;

    // Resolver de pagos
    bool esMulti = ((bool?)ViewBag.EsMultiVendedor == true);
    string vendedorIdUnico = ViewBag.VendedorIdUnico as string ?? "";

    // Cuentas activas
    var cuentasProv = (ViewBag.CuentasProveedor as IEnumerable<SimoneCfg.CuentaBancaria> ?? Enumerable.Empty<SimoneCfg.CuentaBancaria>())
                        .Where(c => c?.Activo == true)
                        .ToList();
    var cuentasAdmin = (ViewBag.CuentasAdmin as IEnumerable<SimoneCfg.CuentaBancaria> ?? Enumerable.Empty<SimoneCfg.CuentaBancaria>())
                        .Where(c => c?.Activo == true)
                        .ToList();

    bool hayProv = cuentasProv.Any();
    bool hayAdm = cuentasAdmin.Any();
    bool hayCuentas = esMulti ? hayAdm : (hayProv || hayAdm);
    int numCtas = esMulti ? cuentasAdmin.Count : (hayProv ? cuentasProv.Count : cuentasAdmin.Count);

    // Diccionario para JS
    var bankItems = new Dictionary<string, object>(StringComparer.OrdinalIgnoreCase);
    string fallbackLogo = "/images/product-placeholder.png";

    if (esMulti || (!hayProv && hayAdm))
    {
        foreach (var c in cuentasAdmin)
        {
            var key = $"admin:{c.Codigo}";
            bankItems[key] = new
            {
                scope = "admin",
                c.Codigo,
                c.Nombre,
                c.Numero,
                c.Tipo,
                c.Titular,
                c.Ruc,
                logo = string.IsNullOrWhiteSpace(c.LogoPath) ? fallbackLogo : c.LogoPath
            };
        }
    }
    else
    {
        foreach (var c in cuentasProv)
        {
            var key = $"tienda:{vendedorIdUnico}:{c.Codigo}";
            bankItems[key] = new
            {
                scope = "tienda",
                c.Codigo,
                c.Nombre,
                c.Numero,
                c.Tipo,
                c.Titular,
                c.Ruc,
                logo = string.IsNullOrWhiteSpace(c.LogoPath) ? fallbackLogo : c.LogoPath
            };
        }
    }

    // üëá CLAVE: enviamos camelCase para que JS pueda leer b.nombre, b.numero, etc.
    var bankItemsJson = JsonSerializer.Serialize(
        bankItems,
        new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
    );
}

@section Styles {
    <style>
        :root {
            --primary: #e8b4b8;
            --border: #e8e8e8;
            --shadow: 0 10px 30px rgba(0,0,0,.08);
        }

        .summary-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 18px
        }

        .summary-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border)
        }

        .summary-title {
            margin: 0;
            font-size: 18px
        }

        .summary-body {
            padding: 16px 18px
        }

        .payment-method {
            border: 1px dashed #e6e6e6;
            border-radius: 12px;
            padding: 14px 10px;
            cursor: pointer
        }

            .payment-method.active {
                border-color: var(--primary);
                background: rgba(232,180,184,.06)
            }

        .bank-card {
            transition: .2s;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            background: #fff;
            height: 100%;
            display: flex;
            align-items: center
        }

            .bank-card:hover, .bank-card.selected {
                border-color: var(--primary);
                background-color: rgba(232,180,184,.05);
                box-shadow: 0 4px 12px rgba(232,180,184,.2)
            }

        .bank-logo {
            height: 35px;
            margin-right: 12px;
            border-radius: 5px
        }

        .text-mono {
            font-family: ui-monospace,Consolas,monospace
        }

        .pay-destination {
            border-left: 4px solid var(--primary);
            background: #fff;
            padding: 12px 14px;
            border-radius: 10px
        }

        .productos-container {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .product-item {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .product-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--border)
        }

        .product-info {
            flex: 1
        }

        .product-price {
            min-width: 110px;
            text-align: right
        }

        .copy-btn {
            border: 1px solid var(--border);
            background: #fff;
            padding: .2rem .5rem;
            border-radius: 6px
        }

        .sticky-summary {
            position: sticky;
            top: 20px
        }

        .envio-detail {
            background: #f9fafb;
            border: 1px dashed #e5e7eb;
            border-radius: 8px;
            padding: 8px 10px
        }
    </style>
}

<div class="container pb-5">
    <div class="my-3 small text-muted">Pago &rsaquo; Confirmaci√≥n</div>

    <div class="row g-4">
        <!-- IZQUIERDA -->
        <div class="col-12 col-lg-8 order-lg-1">
            <!-- Direcci√≥n -->
            <div class="summary-card">
                <div class="summary-header">
                    <h3 class="summary-title"><i class="fas fa-map-marker-alt"></i> Direcci√≥n de Env√≠o</h3>
                </div>
                <div class="summary-body">
                    @if (ViewBag.HasAddress)
                    {
                        <div class="p-3" style="background:#f9f9f9;border-radius:10px;">
                            <h5 class="mb-1 d-flex align-items-center gap-2 text-primary">
                                <i class="fas fa-user-circle"></i>
                                @(string.IsNullOrWhiteSpace(Model.NombreCompleto) ? "Cliente" : Model.NombreCompleto)
                            </h5>
                            <p class="mb-1"><i class="fas fa-id-card me-2"></i>@(string.IsNullOrWhiteSpace(Model.Cedula) ? "Sin c√©dula" : Model.Cedula)</p>
                            <p class="mb-1"><i class="fas fa-home me-2"></i>@(string.IsNullOrWhiteSpace(Model.Direccion) ? "Sin direcci√≥n" : Model.Direccion)</p>
                            <p class="mb-1"><i class="fas fa-city me-2"></i>@(string.IsNullOrWhiteSpace(Model.Ciudad) ? "Sin ciudad" : Model.Ciudad), @(string.IsNullOrWhiteSpace(Model.Provincia) ? "Sin provincia" : Model.Provincia)</p>
                            <p class="mb-0"><i class="fas fa-phone me-2"></i>@(string.IsNullOrWhiteSpace(Model.Telefono) ? "Sin tel√©fono" : Model.Telefono)</p>
                            <a asp-controller="Cuenta" asp-action="Perfil" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-pen-to-square me-1"></i> Editar Direcci√≥n
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-map-marker-alt fa-2x text-muted mb-3"></i>
                            <p class="mb-2 text-danger"><i class="fas fa-exclamation-triangle me-2"></i> Para continuar, agrega tu direcci√≥n de env√≠o.</p>
                            <a asp-controller="Cuenta" asp-action="Perfil" class="btn btn-primary">Agregar Direcci√≥n</a>
                        </div>
                    }
                </div>
            </div>

            <!-- Pago -->
            <div class="summary-card">
                <div class="summary-header">
                    <h3 class="summary-title"><i class="fas fa-credit-card"></i> M√©todo de Pago</h3>
                </div>
                <div class="summary-body">
                    <div class="pay-destination mb-3">
                        @if (esMulti)
                        {
                            <div class="d-flex align-items-center">
                                <i class="fas fa-building me-2 text-primary"></i>
                                <div><strong>Pagos centralizados al Administrador.</strong> Tu pedido incluye productos de varias tiendas; realiza el dep√≥sito a las cuentas del administrador.</div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex align-items-center">
                                <i class="fas fa-store me-2 text-primary"></i>
                                <div><strong>Pago directo a la tienda.</strong> Selecciona la cuenta de la tienda para transferir.</div>
                            </div>
                        }
                    </div>

                    <!-- M√©todos (solo dep√≥sito activo) -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="payment-method text-center" data-method="card" tabindex="0" role="button" aria-label="Pago con tarjeta (pr√≥ximamente)">
                                <i class="fas fa-credit-card method-icon"></i>
                                <h5>Tarjeta</h5>
                                <p class="small text-muted">Pr√≥ximamente</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="payment-method text-center active" data-method="deposit" tabindex="0" role="button" aria-label="Pago por dep√≥sito / transferencia">
                                <i class="fas fa-university method-icon"></i>
                                <h5>Dep√≥sito</h5>
                                <p class="small text-muted">Transferencia Bancaria</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="payment-method text-center" data-method="paypal" tabindex="0" role="button" aria-label="Pago con PayPal (pr√≥ximamente)">
                                <i class="fab fa-paypal method-icon"></i>
                                <h5>PayPal</h5>
                                <p class="small text-muted">Pr√≥ximamente</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dep√≥sito -->
                    <div id="form-deposit" class="payment-form">
                        <div class="alert alert-light border">
                            <h5 class="d-flex align-items-center mb-1">
                                <i class="fas fa-info-circle me-2 text-primary"></i> Instrucciones de Pago
                            </h5>
                            <ol class="mb-2 mt-2">
                                <li>Selecciona el banco para realizar tu transferencia.</li>
                                <li>Realiza la transferencia desde tu banco.</li>
                                <li><strong>Adjunta el comprobante</strong> y confirma tu compra.</li>
                                <li>Validaremos tu pago en un m√°ximo de 24 horas.</li>
                            </ol>
                        </div>

                        @{
                            bool renderAdmin = esMulti || (!hayProv && hayAdm);
                        }
                        <div class="mb-3" id="bank-selection"
                             data-hay-cuentas="@(hayCuentas ? "1" : "0")"
                             data-num-cuentas="@numCtas">
                            <label class="form-label fw-semibold">
                                @(renderAdmin ? "Selecciona una cuenta del administrador" : "Selecciona una cuenta de la tienda")
                            </label>

                            <div class="row">
                                @if (renderAdmin)
                                {
                                    if (cuentasAdmin.Any())
                                    {
                                        foreach (var c in cuentasAdmin)
                                        {
                                            var dataVal = $"admin:{c.Codigo}";
                                            <div class="col-md-6 mb-3">
                                                <div class="bank-card" data-bank="@dataVal" tabindex="0" role="button" aria-label="@c.Nombre">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@(string.IsNullOrWhiteSpace(c.LogoPath) ? fallbackLogo : c.LogoPath)"
                                                             alt="@c.Nombre" class="bank-logo"
                                                             onerror="this.src='@fallbackLogo'">
                                                        <div>
                                                            <h6 class="mb-0">@c.Nombre</h6>
                                                            <small class="text-muted">@c.Tipo ¬∑ @c.Numero</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12">
                                            <div class="alert alert-warning">No hay cuentas del administrador configuradas.</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    if (cuentasProv.Any() && !string.IsNullOrWhiteSpace(vendedorIdUnico))
                                    {
                                        foreach (var c in cuentasProv)
                                        {
                                            var dataVal = $"tienda:{vendedorIdUnico}:{c.Codigo}";
                                            <div class="col-md-6 mb-3">
                                                <div class="bank-card" data-bank="@dataVal" tabindex="0" role="button" aria-label="@c.Nombre">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@(string.IsNullOrWhiteSpace(c.LogoPath) ? fallbackLogo : c.LogoPath)"
                                                             class="bank-logo" alt="@c.Nombre"
                                                             onerror="this.src='@fallbackLogo'">
                                                        <div>
                                                            <h6 class="mb-0">@c.Nombre</h6>
                                                            <small class="text-muted">@c.Tipo ¬∑ @c.Numero</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else if (cuentasAdmin.Any())
                                    {
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                La tienda no tiene cuentas configuradas. Mostrando <strong>cuentas del administrador</strong>.
                                            </div>
                                        </div>

                                        @foreach (var c in cuentasAdmin)
                                        {
                                            var dataVal = $"admin:{c.Codigo}";
                                            <div class="col-md-6 mb-3">
                                                <div class="bank-card" data-bank="@dataVal" tabindex="0" role="button" aria-label="@c.Nombre">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@(string.IsNullOrWhiteSpace(c.LogoPath) ? fallbackLogo : c.LogoPath)"
                                                             class="bank-logo" alt="@c.Nombre"
                                                             onerror="this.src='@fallbackLogo'">
                                                        <div>
                                                            <h6 class="mb-0">@c.Nombre</h6>
                                                            <small class="text-muted">@c.Tipo ¬∑ @c.Numero</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12"><div class="alert alert-warning">No hay cuentas disponibles.</div></div>
                                    }
                                }
                            </div>
                        </div>

                        <!-- Detalle de la cuenta elegida -->
                        <div id="bank-details" class="mb-3 d-none">
                            <h5 class="d-flex align-items-center"><i class="fas fa-university me-2"></i> Detalles de la Cuenta</h5>
                            <div class="p-3 border rounded" style="background:#f0f9ff;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1"><strong>Banco:</strong> <span id="bank-name">-</span></p>
                                        <p class="mb-1">
                                            <strong>N¬∞ de cuenta:</strong> <span id="account-number" class="text-mono">-</span>
                                            <button type="button" class="ms-2 copy-btn btn-sm" id="copy-account">Copiar</button>
                                        </p>
                                        <p class="mb-1"><strong>Tipo:</strong> <span id="account-type">-</span></p>
                                        <p class="mb-1"><strong>Titular:</strong> <span id="account-owner">-</span></p>
                                        <p class="mb-0"><strong>RUC:</strong> <span id="account-ruc">-</span></p>
                                    </div>
                                    <img id="bank-logo" src="@fallbackLogo" class="bank-logo" alt="logo" onerror="this.src='@fallbackLogo'">
                                </div>
                            </div>
                        </div>

                        <!-- Campos del dep√≥sito -->
                        <div class="mb-3">
                            <label for="depositName" class="form-label">Nombre de quien deposita</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-user text-muted"></i></span>
                                <input type="text" class="form-control" id="depositName" name="Depositante" form="form-finalizar" placeholder="Ingresa tu nombre completo" required autocomplete="name">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="depositReceipt" class="form-label">Comprobante de pago</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="depositReceipt" name="Comprobante" form="form-finalizar" accept="image/*,.pdf" required>
                            </div>
                            <div class="form-text text-muted">Formatos aceptados: JPG, PNG, WEBP, PDF (m√°ximo 5MB)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DERECHA -->
        <div class="col-12 col-lg-4 order-lg-2">
            <div class="sticky-summary">
                <div class="summary-card">
                    <div class="summary-header">
                        <h3 class="summary-title"><i class="fas fa-shopping-bag"></i> Tu Pedido</h3>
                    </div>
                    <div class="summary-body">
                        @if (items != null && items.Any())
                        {
                            <div class="productos-container">
                                @foreach (var item in items)
                                {
                                    var img = (item?.Producto?.ImagenPath as string);
                                    img = string.IsNullOrWhiteSpace(img) ? "/images/product-placeholder.png" : img;

                                    decimal precioUnit = 0m; int cant = 0;
                                    try { precioUnit = Convert.ToDecimal(item?.Precio); } catch { }
                                    try { cant = Convert.ToInt32(item?.Cantidad); } catch { }
                                    var lineTotal = precioUnit * cant;

                                    <div class="product-item">
                                        <img src="@img" alt="@(item?.Producto?.Nombre as string ?? "Producto")" class="product-img" loading="lazy" onerror="this.src='/images/product-placeholder.png'">
                                        <div class="product-info">
                                            <div class="product-name">@((item?.Producto?.Nombre as string) ?? "Producto")</div>
                                            <div class="product-details">Cantidad: @cant</div>
                                        </div>
                                        <div class="product-price">@lineTotal.ToString("C", culture)</div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
                                <p class="text-muted mb-0">No hay productos en tu carrito.</p>
                            </div>
                        }

                        <div class="total-section mt-3">
                            <div class="d-flex justify-content-between"><span>Subtotal:</span><span>@totalCompra.ToString("C", culture)</span></div>

                            <div class="d-flex justify-content-between align-items-start">
                                <span>Env√≠o:</span>
                                <span>
                                    @if (canComputeShipping)
                                    {
                                        @envioTotal.ToString("C", culture)
                                    }
                                    else
                                    {

                                        <span class="text-muted">‚Äî</span>
                                    }
                                </span>
                            </div>

                            @if (canComputeShipping && (envioMensajes.Any() || envioPorTienda.Any()))
                            {
                                <div class="envio-detail mt-2">
                                    @if (envioPorTienda.Any())
                                    {
                                        <div class="small mb-1"><strong>Desglose por tienda</strong></div>
                                        <ul class="mb-2" style="padding-left:18px;">
                                            @foreach (var kv in envioPorTienda)
                                            {
                                                <li class="small">@kv.Key: @kv.Value.ToString("C", culture)</li>
                                            }
                                        </ul>
                                    }
                                    @if (envioMensajes.Any())
                                    {
                                        <div class="small text-muted">
                                            @foreach (var m in envioMensajes)
                                            {
                                                <div><i class="fas fa-info-circle me-1"></i>@m</div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else if (!canComputeShipping)
                            {
                                <div class="small text-muted mt-1">
                                    <i class="fas fa-location-dot me-1"></i>
                                    Agrega/actualiza tu direcci√≥n para calcular el costo de env√≠o.
                                </div>
                            }

                            <div class="d-flex justify-content-between">
                                <span>Total:</span>
                                <span class="fw-bold" style="color:var(--primary);">@grandTotal.ToString("C", culture)</span>
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <small class="text-muted d-flex align-items-center justify-content-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Flag_of_Ecuador.svg/320px-Flag_of_Ecuador.svg.png" alt="Ecuador" height="16" class="me-2">
                                Todos los precios en d√≥lares estadounidenses (USD)
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Finalizar -->
                <form id="form-finalizar" asp-controller="Compras" asp-action="ConfirmarCompra" method="post" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="MetodoPagoInput" name="MetodoPago" value="Deposito" />
                    <input type="hidden" id="BancoSeleccionado" name="BancoSeleccionado" value="" />
                    <button type="submit"
                            class="btn btn-primary w-100 py-3"
                            id="btnFinalizar"
                            @( (ViewBag.HasAddress == true && hayCuentas) ? null : "disabled" )>
                        <span class="btn-text"><i class="fas fa-lock me-2"></i> Finalizar Compra</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" aria-label="Procesando"></span>
                    </button>
                    @if (ViewBag.HasAddress != true)
                    {
                        <div class="form-text text-danger mt-2">Agrega una direcci√≥n para habilitar el bot√≥n.</div>
                    }
                    else if (!hayCuentas)
                    {
                        <div class="form-text text-danger mt-2">No hay cuentas disponibles para este pedido.</div>
                    }
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const esMultiVendedor = @(esMulti ? "true" : "false");
            const bankMap = @Html.Raw(bankItemsJson); // camelCase

            // M√©todos de pago (solo Dep√≥sito activo)
            const methods = document.querySelectorAll('.payment-method');
            const forms   = document.querySelectorAll('.payment-form');
            methods.forEach(m => {
                const handler = () => {
                    const name = m.dataset.method;
                    if (name !== 'deposit') {
                        Swal.fire({icon:'info', title:'¬°Pr√≥ximamente!', text:'Por favor elige Dep√≥sito.', confirmButtonColor:'#e8b4b8'});
                        return;
                    }
                    methods.forEach(x => x.classList.remove('active'));
                    m.classList.add('active');
                    forms.forEach(f => f.classList.add('d-none'));
                    document.getElementById(`form-${name}`).classList.remove('d-none');
                    document.getElementById('MetodoPagoInput').value = 'Deposito';
                };
                m.addEventListener('click', handler);
                m.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handler(); } });
            });

            // Disponibilidad / autoselecci√≥n
            const bankSelEl = document.getElementById('bank-selection');
            const hayCuentas = (bankSelEl?.dataset.hayCuentas === '1');
            const numCuentas = parseInt(bankSelEl?.dataset.numCuentas || '0', 10);

            // Selecci√≥n de banco
            const bankCards   = Array.from(document.querySelectorAll('.bank-card'));
            const bankDetails = document.getElementById('bank-details');
            const hiddenBank  = document.getElementById('BancoSeleccionado');

            function paintDetails(key){
                const b = bankMap[key];
                if (!b) return;
                bankDetails.classList.remove('d-none');
                document.getElementById('bank-name').textContent      = b.nombre || '-';
                document.getElementById('account-number').textContent = b.numero || '-';
                document.getElementById('account-type').textContent   = b.tipo   || '-';
                document.getElementById('account-owner').textContent  = b.titular|| '-';
                document.getElementById('account-ruc').textContent    = b.ruc    || '-';
                const logo = document.getElementById('bank-logo');
                if (logo && b.logo){ logo.src=b.logo; logo.alt=b.nombre||'logo'; }
            }

            function selectCard(card){
                bankCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const key = card.getAttribute('data-bank');
                if (esMultiVendedor && key.startsWith('tienda:')) {
                    Swal.fire({icon:'warning', title:'No permitido', text:'Para carritos con varias tiendas, paga a la cuenta del administrador.', confirmButtonColor:'#e8b4b8'});
                    card.classList.remove('selected');
                    return;
                }
                hiddenBank.value = key; // admin:{codigo} | tienda:{vId}:{codigo}
                paintDetails(key);
            }

            bankCards.forEach(card => {
                card.addEventListener('click', ()=>selectCard(card));
                card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectCard(card);} });
            });

            // Autoselecci√≥n si hay una sola opci√≥n visible
            if (hayCuentas && numCuentas === 1 && bankCards.length === 1) {
                selectCard(bankCards[0]);
            }

            // Copiar n√∫mero
            const copyBtn = document.getElementById('copy-account');
            copyBtn?.addEventListener('click', () => {
                const n = document.getElementById('account-number')?.textContent?.trim();
                if (!n || n === '-') return;
                navigator.clipboard.writeText(n).then(()=>{
                    const prev = copyBtn.textContent;
                    copyBtn.textContent='¬°Copiado!';
                    setTimeout(()=>copyBtn.textContent=prev,1500);
                });
            });

            // Validaci√≥n submit
            const finalizarForm = document.getElementById('form-finalizar');
            finalizarForm.addEventListener('submit', function(e){
                const metodo = (document.getElementById('MetodoPagoInput')?.value || '').toLowerCase();
                const btn = document.getElementById('btnFinalizar');
                if (btn?.disabled) { e.preventDefault(); return; }

                if (metodo === 'deposito') {
                    const nombre  = document.getElementById('depositName')?.value.trim();
                    const archivo = document.getElementById('depositReceipt')?.files[0];
                    const banco   = hiddenBank.value;

                    if (!banco){ e.preventDefault(); Swal.fire({icon:'warning',title:'Selecciona una cuenta bancaria',confirmButtonColor:'#e8b4b8'}); return; }
                    if (esMultiVendedor && banco.startsWith('tienda:')){ e.preventDefault(); Swal.fire({icon:'warning',title:'No permitido',text:'En pedidos multi-tienda, selecciona una cuenta del administrador.',confirmButtonColor:'#e8b4b8'}); return; }
                    if (!nombre){ e.preventDefault(); Swal.fire({icon:'warning',title:'Campo requerido',text:'Ingresa el nombre de quien deposita.',confirmButtonColor:'#e8b4b8'}); return; }
                    if (!archivo){ e.preventDefault(); Swal.fire({icon:'warning',title:'Campo requerido',text:'Adjunta el comprobante.',confirmButtonColor:'#e8b4b8'}); return; }

                    const exts=['jpg','jpeg','png','webp','pdf'];
                    const ext=(archivo.name.split('.').pop()||'').toLowerCase();
                    const max=5*1024*1024;
                    if (!exts.includes(ext)){ e.preventDefault(); Swal.fire({icon:'error',title:'Formato inv√°lido',text:'JPG, PNG, WEBP o PDF.',confirmButtonColor:'#e8b4b8'}); return; }
                    if (archivo.size>max){ e.preventDefault(); Swal.fire({icon:'error',title:'Archivo muy grande',text:'M√°ximo 5MB.',confirmButtonColor:'#e8b4b8'}); return; }
                }

                // UX: spinner
                btn.disabled = true;
                btn.querySelector('.btn-text')?.classList.add('d-none');
                btn.querySelector('.spinner-border')?.classList.remove('d-none');
            });
        });
    </script>
}
