@model IEnumerable<Simone.Models.CarritoDetalle>
@{
    ViewData["Title"] = "Carrito de Compras";
    var totalCarrito = Model.Sum(x => x.Total);
    decimal descuento = ViewBag.Descuento ?? 0m;
    string codigoCupon = ViewBag.CodigoCupon ?? "";
    var totalConDescuento = Math.Max(0m, totalCarrito - descuento);
}

<div class="ui container mt-5" id="cart-root"
     data-descuento="@descuento"
     data-cod="@codigoCupon"
     data-envio="0">
    <h2 class="ui header">
        <i class="shopping cart icon"></i>
        <div class="content">
            Carrito de Compras
            <div class="sub header">Revisa, modifica o elimina productos antes de confirmar tu compra</div>
        </div>
    </h2>

    <div class="ui divider"></div>

    @if (Model.Any())
    {
        <!-- token global para AJAX -->
        <form id="af-global" class="d-none" method="post">
            @Html.AntiForgeryToken()
        </form>

        <table class="ui celled striped table" id="cart-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th style="width: 160px;">Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-row data-id="@item.ProductoID">
                        <td>@item.Producto?.Nombre</td>
                        <td>
                            <div class="ui action input">
                                <input type="number" data-qty min="1" value="@item.Cantidad" style="width:80px" />
                                <button type="button" class="ui icon blue button" data-update title="Actualizar" aria-label="Actualizar cantidad">
                                    <i class="sync alternate icon"></i>
                                </button>
                            </div>
                        </td>
                        <td>$<span data-price>@item.Precio.ToString("F2")</span></td>
                        <td>$<span data-subtotal>@item.Total.ToString("F2")</span></td>
                        <td>
                            <button type="button" class="ui red icon button" data-remove title="Eliminar">
                                <i class="trash icon"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="right aligned">Subtotal:</th>
                    <th colspan="2">$<span id="ft-subtotal">@totalCarrito.ToString("F2")</span></th>
                </tr>

                <tr id="ft-cupon-row" class="@(descuento > 0 ? "" : "d-none")">
                    <th colspan="3" class="right aligned">
                        Cupón aplicado (<span id="ft-cupon-cod">@codigoCupon</span>):
                    </th>
                    <th colspan="2" class="negative">- $<span id="ft-desc">@descuento.ToString("F2")</span></th>
                </tr>
                <tr id="ft-cupon-actions" class="@(descuento > 0 ? "" : "d-none")">
                    <th colspan="5" class="right aligned">
                        <button type="button" class="ui tiny button red" id="btn-remove-coupon">
                            <i class="close icon"></i> Quitar Cupón
                        </button>
                    </th>
                </tr>

                <tr id="ft-envio-row">
                    <th colspan="3" class="right aligned">
                        Envío:
                        <span class="ui tiny label" id="envio-fuente-label" style="display:none;margin-left:6px;"></span>
                    </th>
                    <th colspan="2">$<span id="ft-envio">0.00</span></th>
                </tr>

                <tr>
                    <th colspan="3" class="right aligned">Total a Pagar:</th>
                    <th colspan="2"><strong>$<span id="ft-total">@totalConDescuento.ToString("F2")</span></strong></th>
                </tr>
            </tfoot>
        </table>

        <div class="ui divider"></div>

        <div class="ui two column stackable grid">
            <div class="column">
                <div class="ui form">
                    <div class="field">
                        <label>¿Tienes un código de cupón?</label>
                        <div class="ui action input">
                            <input type="text" id="coupon-input" placeholder="Ingresa tu cupón..." value="@(descuento > 0 ? codigoCupon : "")" />
                            <button type="button" class="ui teal button" id="btn-apply-coupon">Aplicar</button>
                        </div>
                    </div>
                </div>

                <div id="coupon-msg" class="ui hidden message"></div>

                <div class="ui segment">
                    <h4 class="ui header"><i class="truck icon"></i> Envío</h4>
                    <div class="ui form">
                        <div class="two fields">
                            <div class="field">
                                <label>Provincia</label>
                                <select id="ddl-provincia" class="ui dropdown">
                                    <option value="">Selecciona provincia…</option>
                                </select>
                            </div>
                            <div class="field">
                                <label>Ciudad</label>
                                <select id="ddl-ciudad" class="ui dropdown">
                                    <option value="">(toda la provincia)</option>
                                </select>
                                <div class="ui tiny grey text">Si eliges ciudad, tiene prioridad sobre la tarifa de provincia.</div>
                            </div>
                        </div>
                        <button type="button" class="ui button" id="btn-calc-envio">
                            <i class="calculator icon"></i> Calcular envío
                        </button>
                        <div id="envio-msg" class="ui tiny hidden message" style="margin-top:8px;"></div>
                    </div>
                </div>
            </div>

            <div class="right aligned column">
                <form asp-controller="Carrito" asp-action="ConfirmarCompra" method="post">
                    @Html.AntiForgeryToken()

                    <!-- NUEVO: envío elegido -->
                    <input type="hidden" name="EnvioProvincia" id="h-envio-prov" />
                    <input type="hidden" name="EnvioCiudad" id="h-envio-ciudad" />
                    <input type="hidden" name="EnvioPrecio" id="h-envio-precio" />

                    <button class="ui green huge button">
                        <i class="check icon"></i> Confirmar Compra
                    </button>
                </form>
                <div class="ui tiny grey text" style="margin-top:8px;">
                    * El costo de envío se confirmará al registrar la orden.
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="ui icon warning message">
            <i class="shopping basket icon"></i>
            <div class="content">
                <div class="header">Tu carrito está vacío</div>
                <p>Agrega productos desde el catálogo para comenzar tu compra.</p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        (() => {
          const $  = (s, root=document) => root.querySelector(s);
          const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
          const root = $('#cart-root'); if (!root) return;

          // ===== Helpers =====
          const fmt = (n) => (Number(n||0)).toFixed(2);
          const token = () => $('#af-global input[name="__RequestVerificationToken"]')?.value;
          const parseN = (s) => { const n = Number(String(s||'').replace(/[^0-9.-]/g,'')); return isNaN(n)?0:n; };

          async function refreshWidget(){
            try{
              const r = await fetch('/Carrito/CartInfo', { credentials:'same-origin' });
              if(!r.ok) return;
              const d = await r.json();
              const countEl = document.getElementById('cart-count');
              const totalEl = document.getElementById('cart-total');
              if (countEl) countEl.textContent = d.count ?? 0;
              if (totalEl) totalEl.textContent =
                new Intl.NumberFormat('es-EC',{style:'currency',currency:'USD'}).format(d.subtotal ?? 0);
            }catch{}
          }

          function recomputeFooterFromDom(){
            // Suma todos los subtotales visibles en la tabla
            const sum = $$('#cart-table [data-subtotal]').reduce((acc,el)=>acc + parseN(el.textContent), 0);
            $('#ft-subtotal').textContent = fmt(sum);

            const desc  = parseN(root.dataset.descuento);
            const envio = parseN($('#ft-envio')?.textContent);
            const total = Math.max(0, sum - desc) + envio;
            $('#ft-total').textContent = fmt(total);

            // Mostrar/ocultar filas de cupón
            const hasCoupon = desc > 0;
            $('#ft-cupon-row')?.classList.toggle('d-none', !hasCoupon);
            $('#ft-cupon-actions')?.classList.toggle('d-none', !hasCoupon);
          }

          function showMsg(el, ok, msg){
            if (!el) return;
            el.className = 'ui tiny message ' + (ok ? 'green' : 'red');
            el.innerHTML = `<i class="${ok?'check':'times'} icon"></i> ${msg}`;
            el.classList.remove('hidden');
          }

          // ===== actualizar cantidad =====
          document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-update]');
            if (!btn) return;

            const row = btn.closest('[data-row]');
            const id  = row?.dataset.id;
            const qty = Number($('[data-qty]', row).value || 1);
            if (!id || !qty) return;

            const fd = new FormData();
            fd.append('productoId', id);
            fd.append('cantidad', qty);
            const tk = token(); if (tk) fd.append('__RequestVerificationToken', tk);

            const r = await fetch('/Carrito/ActualizarCarrito', {
              method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin'
            });
            const data = r.ok ? await r.json() : null;

            if (data?.ok){
              $('[data-subtotal]', row).textContent = fmt(data.subtotal);
              recomputeFooterFromDom();
              refreshWidget();
            }else{
              alert(data?.error || 'No se pudo actualizar la cantidad.');
            }
          });

          // ===== eliminar artículo =====
          document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-remove]');
            if (!btn) return;

            const row = btn.closest('[data-row]');
            const id  = row?.dataset.id;
            if (!id) return;

            const fd = new FormData();
            fd.append('productoId', id);
            const tk = token(); if (tk) fd.append('__RequestVerificationToken', tk);

            const r = await fetch('/Carrito/EliminarDelCarrito', {
              method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin'
            });
            const data = r.ok ? await r.json() : null;

            if (data?.ok){
              row.remove();
              if ($$('#cart-table tbody tr').length === 0) {
                location.reload();
                return;
              }
              recomputeFooterFromDom();
              refreshWidget();
            }else{
              alert(data?.error || 'No se pudo eliminar el artículo.');
            }
          });

          // ===== aplicar cupón =====
          $('#btn-apply-coupon')?.addEventListener('click', async () => {
            const code = $('#coupon-input')?.value?.trim();
            if (!code) return;

            const fd = new FormData();
            fd.append('codigoCupon', code);
            const tk = token(); if (tk) fd.append('__RequestVerificationToken', tk);

            const r = await fetch('/Carrito/AplicarCupon', {
              method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin'
            });
            const data = r.ok ? await r.json() : null;

            if (data?.ok){
              root.dataset.descuento = data.descuento ?? 0;
              $('#ft-desc').textContent = fmt(data.descuento ?? 0);
              $('#ft-cupon-cod').textContent = data.codigo ?? '';
              showMsg($('#coupon-msg'), true, `Cupón aplicado: ${data.codigo}.`);
              recomputeFooterFromDom();
            }else{
              showMsg($('#coupon-msg'), false, data?.error || 'Cupón inválido o expirado.');
              root.dataset.descuento = 0;
              $('#ft-desc').textContent = fmt(0);
              $('#ft-cupon-cod').textContent = '';
              recomputeFooterFromDom();
            }
          });

          // ===== quitar cupón =====
          $('#btn-remove-coupon')?.addEventListener('click', async () => {
            const fd = new FormData();
            const tk = token(); if (tk) fd.append('__RequestVerificationToken', tk);

            const r = await fetch('/Carrito/QuitarCupon', {
              method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin'
            });
            await (r.ok ? r.json() : null);

            root.dataset.descuento = 0;
            $('#ft-desc').textContent = fmt(0);
            $('#ft-cupon-cod').textContent = '';
            showMsg($('#coupon-msg'), true, 'Cupón eliminado.');
            recomputeFooterFromDom();
          });

          // ======== ENVÍOS ========
          const CAT = {
            "Azuay": ["Cuenca","Gualaceo","Paute","Sígsig","Nabón","Girón","Santa Isabel"],
            "Bolívar": ["Guaranda","Chillanes","Echeandía"],
            "Cañar": ["Azogues","La Troncal","El Tambo","Cañar"],
            "Carchi": ["Tulcán","Montúfar","Mira"],
            "Chimborazo": ["Riobamba","Guano","Alausí","Colta","Chambo"],
            "Cotopaxi": ["Latacunga","Salcedo","Saquisilí","Pujilí"],
            "El Oro": ["Machala","Santa Rosa","Pasaje","Huaquillas","Arenillas"],
            "Esmeraldas": ["Esmeraldas","Atacames","Quinindé","Muisne"],
            "Galápagos": ["Puerto Ayora","Puerto Baquerizo Moreno","Puerto Villamil"],
            "Guayas": ["Guayaquil","Daule","Samborondón","Durán","Milagro","Playas","El Triunfo","Naranjal","Balao"],
            "Imbabura": ["Ibarra","Otavalo","Cotacachi","Atuntaqui"],
            "Loja": ["Loja","Catamayo","Macará","Cariamanga"],
            "Los Ríos": ["Babahoyo","Quevedo","Vinces","Puebloviejo","Buena Fe"],
            "Manabí": ["Portoviejo","Manta","Chone","Bahía de Caráquez","Jipijapa","El Carmen"],
            "Morona Santiago": ["Macas","Sucúa","Gualaquiza","Taisha"],
            "Napo": ["Tena","Archidona","El Chaco"],
            "Orellana": ["Coca","La Joya de los Sachas","Loreto"],
            "Pastaza": ["Puyo","Mera","Santa Clara"],
            "Pichincha": ["Quito","Sangolquí","Cayambe","Machachi","San Antonio de Pichincha"],
            "Santa Elena": ["La Libertad","Salinas","Santa Elena"],
            "Santo Domingo de los Tsáchilas": ["Santo Domingo","La Concordia"],
            "Sucumbíos": ["Lago Agrio","Shushufindi","Cuyabeno"],
            "Tungurahua": ["Ambato","Baños","Pelileo","Tisaleo","Cevallos"],
            "Zamora Chinchipe": ["Zamora","Yantzaza","Zumba"]
          };

          const ddlProv = $('#ddl-provincia');
          const ddlCity = $('#ddl-ciudad');
          const btnCalc = $('#btn-calc-envio');
          const lblEnv  = $('#ft-envio');
          const fuente  = $('#envio-fuente-label');
          const envioMsg = $('#envio-msg');

          const hProv = $('#h-envio-prov');
          const hCity = $('#h-envio-ciudad');
          const hPrecio = $('#h-envio-precio');

          function fillProvinces() {
            ddlProv.innerHTML = '<option value="">Selecciona provincia…</option>';
            Object.keys(CAT).sort().forEach(p => {
              const opt = document.createElement('option');
              opt.value = p; opt.textContent = p; ddlProv.appendChild(opt);
            });
          }
          function fillCities(prov, selected="") {
            ddlCity.innerHTML = '<option value="">(toda la provincia)</option>';
            (CAT[prov] || []).forEach(c => {
              const opt = document.createElement('option');
              opt.value = c; opt.textContent = c;
              if (selected && selected.toLowerCase() === c.toLowerCase()) opt.selected = true;
              ddlCity.appendChild(opt);
            });
          }

          ddlProv?.addEventListener('change', () => {
            fillCities(ddlProv.value, "");
            // reset envío cuando cambie el destino
            lblEnv.textContent = fmt(0);
            fuente.style.display = 'none';
            root.dataset.envio = "0";
            hProv.value = ddlProv.value || "";
            hCity.value = "";
            hPrecio.value = "0";
            recomputeFooterFromDom();
          });
          ddlCity?.addEventListener('change', () => {
            lblEnv.textContent = fmt(0);
            fuente.style.display = 'none';
            root.dataset.envio = "0";
            hCity.value = ddlCity.value || "";
            hPrecio.value = "0";
            recomputeFooterFromDom();
          });

          btnCalc?.addEventListener('click', async () => {
            const prov = (ddlProv.value || '').trim();
            const city = (ddlCity.value || '').trim();

            if (!prov){
              showMsg(envioMsg, false, 'Selecciona una provincia.');
              return;
            }

            try{
              const q = new URLSearchParams({ provincia: prov, ciudad: city || '' });
              const r = await fetch(`/api/envios/estimar?${q.toString()}`, { credentials:'same-origin' });
              const j = await r.json();

              if (!r.ok || j?.ok === false){
                lblEnv.textContent = fmt(0);
                root.dataset.envio = "0";
                fuente.style.display = 'none';
                hPrecio.value = "0";
                showMsg(envioMsg, false, j?.error || 'No hay tarifa para ese destino.');
                recomputeFooterFromDom();
                return;
              }

              const precio = Number(j?.precio ?? 0);
              lblEnv.textContent = fmt(precio);
              root.dataset.envio = String(precio);
              hProv.value = prov;
              hCity.value = city || "";
              hPrecio.value = fmt(precio);

              if (j?.fuente){
                fuente.textContent = j.fuente === 'vendedor' ? 'Tarifa vendedor' : 'Tarifa admin';
                fuente.className = 'ui tiny label ' + (j.fuente === 'vendedor' ? 'blue' : 'grey');
                fuente.style.display = '';
              } else {
                fuente.style.display = 'none';
              }

              showMsg(envioMsg, true, `Envío calculado: $${fmt(precio)} ${city ? `(${prov} / ${city})` : `(${prov})`}.`);
              recomputeFooterFromDom();
            }catch(e){
              lblEnv.textContent = fmt(0);
              root.dataset.envio = "0";
              fuente.style.display = 'none';
              hPrecio.value = "0";
              showMsg(envioMsg, false, 'No se pudo calcular el envío en este momento.');
              recomputeFooterFromDom();
            }
          });

          // ===== init =====
          fillProvinces();
          fillCities("", "");
          recomputeFooterFromDom();
        })();
    </script>
}
