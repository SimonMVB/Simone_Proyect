@model Simone.Models.Producto
@using System.Globalization
@using System.Text.Json
@{
    ViewData["Title"] = Model?.Nombre ?? "Detalles del Producto";
    var culture = CultureInfo.CreateSpecificCulture("es-EC");
    string Img(string? src) => string.IsNullOrWhiteSpace(src) ? Url.Content("~/images/Productos/default.jpg") : src!;

    // === GALERÍA (desde el controller) ===
    var portada = (ViewBag.Portada as string) ?? Model?.ImagenPath;
    var galeria = (ViewBag.Galeria as IEnumerable<string>)?
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList() ?? new List<string>();
    if (galeria.Count == 0 && !string.IsNullOrWhiteSpace(portada))
        galeria.Add(portada);

    // Variantes preparadas desde el controller (ViewBag.Variantes)
    var variantesList = (ViewBag.Variantes as IEnumerable<Simone.Models.ProductoVariante>)?.ToList()
                        ?? new List<Simone.Models.ProductoVariante>();
    var hasVar = variantesList.Any();

    // JSON compacto para JS (evitamos referencias cíclicas)
    var variantesJson = JsonSerializer.Serialize(
        variantesList.Select(v => new
        {
            id = v.ProductoVarianteID,
            color = v.Color,
            talla = v.Talla,
            precio = v.PrecioVenta, // puede ser null
            stock = v.Stock,
            img = v.ImagenPath
        })
    );
}

<style>
    :root {
        --primary-color: #e8b4b8;
        --primary-dark: #d99a9f;
        --secondary-color: #f7cadb;
        --accent-color: #e91e63;
        --dark-color: #2c3e50;
        --light-bg: #f8f9fa;
        --border-radius: 16px;
        --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-container {
        max-width: 1400px;
        margin: 0 auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .product-gallery {
        border: none;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: white;
        position: relative;
    }

    .gallery-main {
        position: relative;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--light-bg);
    }

    .gallery-image {
        width: 100%;
        height: 500px;
        object-fit: contain;
        transition: var(--transition);
    }

    .gallery-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .gallery-thumbs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
        padding: 0.5rem;
    }

    .thumb-item {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 4px;
        background: white;
        cursor: pointer;
        transition: var(--transition);
        aspect-ratio: 1;
    }

        .thumb-item:hover,
        .thumb-item.active {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 180, 184, 0.3);
        }

        .thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

    .product-info {
        background: white;
        border-radius: var(--border-radius);
        height: fit-content;
        position: sticky;
        top: 2rem;
    }

    .product-header {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .product-title {
        font-weight: 800;
        color: var(--dark-color);
        line-height: 1.2;
        margin-bottom: 0.5rem;
    }

    .product-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .rating-stars {
        color: #ffc107;
    }

    .rating-count {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .product-sku {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .price-section {
        background: linear-gradient(135deg, var(--light-bg), #ffffff);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 1px solid #e9ecef;
    }

    .current-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-color);
        line-height: 1;
    }

    .price-currency {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--accent-color);
    }

    .price-old {
        font-size: 1.25rem;
        color: #6c757d;
        text-decoration: line-through;
        margin-left: 0.5rem;
    }

    .discount-badge {
        background: linear-gradient(135deg, var(--accent-color), #d81b60);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .variants-section {
        margin: 2rem 0;
    }

    .variant-title {
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .variant-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .variant-option {
        position: relative;
    }

    .variant-input {
        position: absolute;
        opacity: 0;
    }

    .variant-label {
        display: block;
        padding: 0.75rem 1.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        font-weight: 600;
        color: var(--dark-color);
        transition: var(--transition);
        text-align: center;
        min-width: 80px;
    }

    .variant-input:checked + .variant-label {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(232, 180, 184, 0.3);
    }

    .variant-input:disabled + .variant-label {
        opacity: 0.5;
        cursor: not-allowed;
        text-decoration: line-through;
        background: #f8f9fa;
    }

    .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        border: 2px solid #e5e7eb;
    }

    .quantity-section {
        background: var(--light-bg);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin: 1.5rem 0;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        max-width: 200px;
    }

    .quantity-btn {
        width: 48px;
        height: 48px;
        border: 2px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1.25rem;
        font-weight: 600;
    }

        .quantity-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    .quantity-input {
        width: 80px;
        height: 48px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        text-align: center;
        font-size: 1.125rem;
        font-weight: 600;
        background: white;
    }

        .quantity-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(232, 180, 184, 0.1);
            outline: none;
        }

    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 2rem 0;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        border: none;
        color: white;
        padding: 1rem 2rem;
        font-size: 1.125rem;
        font-weight: 700;
        border-radius: 12px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(232, 180, 184, 0.4);
        }

        .btn-primary-custom:disabled {
            background: #6c757d;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

    .btn-secondary-custom {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        padding: 1rem 2rem;
        font-size: 1.125rem;
        font-weight: 700;
        border-radius: 12px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

        .btn-secondary-custom:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--light-bg);
        border-radius: 12px;
        transition: var(--transition);
    }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

    .feature-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .feature-text {
        font-weight: 600;
        color: var(--dark-color);
    }

    .feature-desc {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .accordion-custom .accordion-item {
        border: none;
        border-radius: 12px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .accordion-custom .accordion-button {
        background: white;
        border: none;
        border-radius: 12px;
        padding: 1.25rem;
        font-weight: 700;
        color: var(--dark-color);
        box-shadow: none;
    }

        .accordion-custom .accordion-button:not(.collapsed) {
            background: var(--primary-color);
            color: white;
        }

    .accordion-custom .accordion-body {
        padding: 1.25rem;
        background: var(--light-bg);
        border-radius: 0 0 12px 12px;
    }

    .related-products {
        margin-top: 4rem;
    }

    .section-title {
        font-weight: 800;
        color: var(--dark-color);
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
    }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 2px;
        }

    .product-card {
        border: none;
        border-radius: var(--border-radius);
        overflow: hidden;
        transition: var(--transition);
        background: white;
        height: 100%;
    }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--box-shadow);
        }

    .product-card-image {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }

    .product-card-body {
        padding: 1.5rem;
    }

    .product-card-title {
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-card-price {
        font-weight: 800;
        color: var(--accent-color);
        font-size: 1.25rem;
    }

    .stock-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
        padding: 0.75rem;
        border-radius: 8px;
        font-weight: 600;
    }

    .stock-available {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .stock-low {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .stock-out {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .social-share {
        display: flex;
        gap: 0.5rem;
        margin: 1.5rem 0;
    }

    .share-btn {
        width: 48px;
        height: 48px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        transition: var(--transition);
        text-decoration: none;
    }

        .share-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

    @@media (max-width: 768px) {
        .action-buttons

    {
        grid-template-columns: 1fr;
    }

    .gallery-image {
        height: 300px;
    }

    .current-price {
        font-size: 2rem;
    }

    .features-grid {
        grid-template-columns: 1fr;
    }

    }
</style>

@if (TempData["MensajeError"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="container mt-3">
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="fa-solid fa-circle-exclamation me-2"></i>
            <div>@err</div>
        </div>
    </div>
}

<!-- Breadcrumb Mejorado -->
<nav class="container mt-4" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none">Inicio</a></li>
        <li class="breadcrumb-item"><a asp-controller="Compras" asp-action="Catalogo" class="text-decoration-none">Catálogo</a></li>
        @if (!string.IsNullOrWhiteSpace(Model?.Categoria?.Nombre))
        {
            <li class="breadcrumb-item"><a asp-controller="Compras" asp-action="Catalogo" asp-route-categoriaID="@Model.CategoriaID" class="text-decoration-none">@Model.Categoria.Nombre</a></li>
        }
        <li class="breadcrumb-item active" aria-current="page">@Model?.Nombre</li>
    </ol>
</nav>

<div class="product-container">
    <div class="row g-5">
        <!-- Galería Mejorada -->
        <div class="col-lg-7">
            <div class="product-gallery">
                <div class="gallery-main">
                    <img id="mainImg"
                         src="@Img(portada)"
                         class="gallery-image"
                         alt="@Model.Nombre"
                         itemprop="image"
                         onerror="this.src='@Url.Content("~/images/Productos/default.jpg")';" />

                    <div class="gallery-badge" id="stockBadge">
                        @if (!hasVar)
                        {
                            if (Model?.Stock == 0)
                            {
                                <span class="badge text-bg-danger">Agotado</span>
                            }
                            else if (Model?.Stock <= 5)
                            {
                                <span class="badge text-bg-warning">¡Quedan pocas unidades!</span>
                            }
                            else
                            {
                                <span class="badge text-bg-success">En stock</span>
                            }
                        }
                        else
                        {
                            <span class="badge text-bg-secondary">Selecciona una combinación</span>
                        }
                    </div>
                </div>

                @if (galeria.Count > 1)
                {
                    <div class="gallery-thumbs">
                        @foreach (var src in galeria)
                        {
                            var isActive = string.Equals(src, portada, StringComparison.OrdinalIgnoreCase);
                            <div class="thumb-item @(isActive ? "active" : "")"
                                 data-src="@Img(src)"
                                 aria-label="Vista @Model.Nombre">
                                <img src="@Img(src)" alt="Miniatura"
                                     onerror="this.src='@Url.Content("~/images/Productos/default.jpg")';" />
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Información del Producto Mejorada -->
        <div class="col-lg-5">
            <div class="product-info shadow-lg">
                <div class="p-4">
                    <!-- Header -->
                    <div class="product-header">
                        <h1 class="product-title" itemprop="name">@Model.Nombre</h1>
                        <div class="product-meta">
                            <div class="product-rating">
                                <div class="rating-stars">
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-regular fa-star"></i>
                                </div>
                                <span class="rating-count">(42 reseñas)</span>
                            </div>
                            <div class="product-sku">
                                SKU: @Model.ProductoID
                            </div>
                        </div>
                    </div>

                    <!-- Precio -->
                    <div class="price-section">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="current-price" id="priceValue">@Model.PrecioVenta.ToString("0.00", CultureInfo.InvariantCulture)</span>
                            <span class="price-currency">USD</span>
                            <span class="price-old">$@((Model.PrecioVenta * 1.2m).ToString("0.00", CultureInfo.InvariantCulture))</span>
                            <span class="discount-badge">-20%</span>
                        </div>
                        <div class="mt-2 text-success small">
                            <i class="fa-solid fa-tag me-1"></i>Precio especial por tiempo limitado
                        </div>
                    </div>

                    <!-- Información de Stock -->
                    <div class="stock-info @(!hasVar ? (Model.Stock > 5 ? "stock-available" : Model.Stock > 0 ? "stock-low" : "stock-out") : "")" id="stockInfo">
                        @if (!hasVar)
                        {
                            if (Model.Stock > 5)
                            {
                                <i class="fa-solid fa-check-circle"></i>
                                <span>Disponible - Listo para enviar</span>
                            }
                            else if (Model.Stock > 0)
                            {
                                <i class="fa-solid fa-exclamation-triangle"></i>
                                <span>¡Últimas unidades! Solo quedan @Model.Stock</span>
                            }
                            else
                            {
                                <i class="fa-solid fa-times-circle"></i>
                                <span>Producto agotado temporalmente</span>
                            }
                        }
                        else
                        {
                            <i class="fa-solid fa-info-circle"></i>
                            <span>Selecciona color y talla para ver disponibilidad</span>
                        }
                    </div>

                    <!-- Variantes -->
                    @if (hasVar)
                    {
                        <div class="variants-section">
                            <!-- Colores -->
                            <div class="mb-4">
                                <h4 class="variant-title">
                                    <i class="fa-solid fa-palette"></i>
                                    Color: <span id="selectedColorText" class="text-primary">Selecciona un color</span>
                                </h4>
                                <div id="colorOptions" class="variant-options"></div>
                            </div>

                            <!-- Tallas -->
                            <div class="mb-4">
                                <h4 class="variant-title">
                                    <i class="fa-solid fa-ruler"></i>
                                    Talla: <span id="selectedTallaText" class="text-primary">Selecciona una talla</span>
                                </h4>
                                <div id="tallaOptions" class="variant-options"></div>
                            </div>
                        </div>
                    }

                    <!-- Cantidad -->
                    <div class="quantity-section">
                        <h5 class="variant-title mb-3">
                            <i class="fa-solid fa-calculator"></i>
                            Cantidad
                        </h5>
                        <div class="quantity-controls">
                            <button class="quantity-btn" id="btnMinus" aria-label="Disminuir cantidad">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <input id="Cantidad" name="CantidadInput" type="number" class="quantity-input"
                                   min="1" max="@(hasVar ? 1 : (Model.Stock > 0 ? Model.Stock : 1))" value="1" inputmode="numeric" />
                            <button class="quantity-btn" id="btnPlus" aria-label="Aumentar cantidad">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-muted small">
                            Máximo @(hasVar ? 1 : (Model.Stock > 0 ? Model.Stock : 1)) unidades por pedido
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="action-buttons">
                        <form id="formAdd" asp-controller="Compras" asp-action="AnadirAlCarrito" method="post" novalidate>
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="ProductoID" value="@Model.ProductoID" />
                            <input type="hidden" name="Cantidad" id="CantidadHidden" value="1" />
                            <input type="hidden" name="productoVarianteId" id="ProductoVarianteID" value="" />

                            @if (!hasVar && Model.Stock <= 0)
                            {
                                <button class="btn-primary-custom w-100" type="button" disabled>
                                    <i class="fa-solid fa-ban"></i>
                                    Sin stock
                                </button>
                            }
                            else
                            {
                                <button class="btn-primary-custom w-100" id="btnAdd" @(hasVar ? "disabled" : "")>
                                    <i class="fa-solid fa-bag-shopping"></i>
                                    <span id="btnAddText">Añadir al carrito</span>
                                </button>
                            }
                        </form>

                        <form method="post" action="/Favoritos/Toggle/@Model.ProductoID" id="favForm">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn-secondary-custom w-100" id="btnFav">
                                <i class="fa-regular fa-heart"></i>
                                Favorito
                            </button>
                        </form>
                    </div>

                    <!-- Compartir -->
                    <div class="social-share">
                        <a href="#" class="share-btn" title="Compartir en Facebook">
                            <i class="fa-brands fa-facebook-f"></i>
                        </a>
                        <a href="#" class="share-btn" title="Compartir en Instagram">
                            <i class="fa-brands fa-instagram"></i>
                        </a>
                        <a href="#" class="share-btn" title="Compartir en WhatsApp">
                            <i class="fa-brands fa-whatsapp"></i>
                        </a>
                        <a href="#" class="share-btn" title="Copiar enlace">
                            <i class="fa-solid fa-link"></i>
                        </a>
                    </div>

                    <!-- Características -->
                    <div class="features-grid">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fa-solid fa-truck-fast"></i>
                            </div>
                            <div>
                                <div class="feature-text">Envío Rápido</div>
                                <div class="feature-desc">24-48 horas hábiles</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fa-solid fa-arrows-rotate"></i>
                            </div>
                            <div>
                                <div class="feature-text">Devoluciones</div>
                                <div class="feature-desc">7 días para cambios</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fa-solid fa-shield-halved"></i>
                            </div>
                            <div>
                                <div class="feature-text">Pago Seguro</div>
                                <div class="feature-desc">Transferencias bancarias</div>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fa-solid fa-headset"></i>
                            </div>
                            <div>
                                <div class="feature-text">Soporte</div>
                                <div class="feature-desc">24/7 por WhatsApp</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información Detallada -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="accordion accordion-custom" id="productAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDescription">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDescription" aria-expanded="true" aria-controls="collapseDescription">
                            <i class="fa-solid fa-file-lines me-2"></i> Descripción Detallada
                        </button>
                    </h2>
                    <div id="collapseDescription" class="accordion-collapse collapse show" aria-labelledby="headingDescription" data-bs-parent="#productAccordion">
                        <div class="accordion-body">
                            @if (!string.IsNullOrWhiteSpace(Model.Descripcion))
                            {
                                <p class="mb-3">@Model.Descripcion</p>
                            }
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Características principales:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Material de alta calidad</li>
                                        <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Diseño exclusivo Neo Ágora</li>
                                        <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Comodidad garantizada</li>
                                        <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i> Lavable a máquina</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Especificaciones:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Marca:</strong> @(string.IsNullOrWhiteSpace(Model.Marca) ? "Neo Ágora" : Model.Marca)</li>
                                        <li class="mb-2"><strong>Categoría:</strong> @Model.Categoria?.Nombre</li>
                                        <li class="mb-2"><strong>Material:</strong> Algodón 100%</li>
                                        <li class="mb-2"><strong>Cuidados:</strong> Lavar a máquina en agua fría</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingShipping">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseShipping" aria-expanded="false" aria-controls="collapseShipping">
                            <i class="fa-solid fa-truck me-2"></i> Envío y Devoluciones
                        </button>
                    </h2>
                    <div id="collapseShipping" class="accordion-collapse collapse" aria-labelledby="headingShipping" data-bs-parent="#productAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Política de Envío:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fa-solid fa-shipping-fast text-primary me-2"></i> Envío gratuito en pedidos superiores a $50</li>
                                        <li class="mb-2"><i class="fa-solid fa-clock text-primary me-2"></i> Tiempo de entrega: 24-48 horas hábiles</li>
                                        <li class="mb-2"><i class="fa-solid fa-map-marker-alt text-primary me-2"></i> Envíos a todo Ecuador</li>
                                        <li class="mb-2"><i class="fa-solid fa-box text-primary me-2"></i> Empaquetado seguro y discreto</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-3">Política de Devoluciones:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fa-solid fa-rotate text-success me-2"></i> 7 días para cambios por talla</li>
                                        <li class="mb-2"><i class="fa-solid fa-rotate text-success me-2"></i> Devoluciones por defectos de fábrica</li>
                                        <li class="mb-2"><i class="fa-solid fa-tag text-success me-2"></i> Producto debe estar en perfecto estado</li>
                                        <li class="mb-2"><i class="fa-solid fa-receipt text-success me-2"></i> Conservar factura de compra</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Relacionados -->
    @if (ViewBag.Relacionados is IEnumerable<Simone.Models.Producto> rel && rel.Any())
    {
        <div class="related-products">
            <h2 class="section-title">Productos Relacionados</h2>
            <div class="row g-4">
                @foreach (var p in rel.Take(4))
                {
                    <div class="col-md-6 col-lg-3">
                        <div class="product-card shadow-sm">
                            <a asp-controller="Compras" asp-action="VerProducto" asp-route-productoID="@p.ProductoID" class="text-decoration-none text-reset">
                                <img src="@Img(p.ImagenPath)" class="product-card-image" alt="@p.Nombre"
                                     onerror="this.src='@Url.Content("~/images/Productos/default.jpg")';" />
                                <div class="product-card-body">
                                    <h5 class="product-card-title">@p.Nombre</h5>
                                    <div class="product-card-price">@p.PrecioVenta.ToString("C", culture)</div>
                                    <div class="mt-2">
                                        @if (p.Stock > 0)
                                        {
                                            <span class="badge bg-success">En stock</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Agotado</span>
                                        }
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Toasts Mejorados -->
<div class="position-fixed bottom-0 end-0 p-4" style="z-index:1080;">
    <div id="toastSuccess" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fa-solid fa-circle-check me-2"></i>
                <span id="toastSuccessMsg">Producto añadido al carrito</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <div id="toastError" class="toast align-items-center text-white bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>
                <span id="toastErrorMsg">Error al añadir el producto</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        async function refreshMiniCartHTML() {
            // Busca el contenedor del panel (usa cualquiera de estos selectores)
            const panel = document.querySelector('#offcanvasCart, #miniCart, [data-mini-cart]');
            if (!panel) return;

            // Necesitamos una URL que devuelva SOLO el parcial del carrito
            const url = panel.getAttribute('data-refresh-url');
            if (!url) return;

            try {
                const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!res.ok) return;

                const html = await res.text();
                panel.innerHTML = html;

                // Por si otros scripts necesitan saber que se re-renderizó
                window.dispatchEvent(new CustomEvent('miniCart:refreshed'));
            } catch { /* silencioso */ }
        }

        const HAS_VARIANTS = @((hasVar ? "true" : "false").ToLower());
        const VARIANTES = HAS_VARIANTS ? @Html.Raw(variantesJson) : [];

        document.addEventListener('DOMContentLoaded', function() {
            // =========================
            // Selectores unificados
            // =========================
            const CART_COUNT_SELECTORS = '#cartCount, #cart-count, [data-cart-count], .cart-count';
            const CART_TOTAL_SELECTORS = '#cartTotal, #cart-total, [data-cart-total], .cart-total';

            // Elementos principales
            const mainImg = document.getElementById('mainImg');
            const stockBadge = document.getElementById('stockBadge');
            const stockInfo = document.getElementById('stockInfo');
            const priceEl = document.getElementById('priceValue');
            const btnAdd = document.getElementById('btnAdd');
            const btnAddText = document.getElementById('btnAddText');
            const varHidden = document.getElementById('ProductoVarianteID');
            const colorOptions = document.getElementById('colorOptions');
            const tallaOptions = document.getElementById('tallaOptions');
            const selectedColorText = document.getElementById('selectedColorText');
            const selectedTallaText = document.getElementById('selectedTallaText');

            let selectedColor = null;
            let selectedTalla = null;

            // =========================
            // Galería
            // =========================
            document.querySelectorAll('.thumb-item').forEach(thumb => {
                thumb.addEventListener('click', function() {
                    document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const newSrc = this.getAttribute('data-src');
                    if (newSrc && mainImg) mainImg.src = newSrc;
                });
            });

            // =========================
            // Cantidad
            // =========================
            const quantityInput = document.getElementById('Cantidad');
            const quantityHidden = document.getElementById('CantidadHidden');
            const btnMinus = document.getElementById('btnMinus');
            const btnPlus = document.getElementById('btnPlus');

            function updateQuantity() {
                let current = parseInt(quantityInput.value) || 1;
                const max = parseInt(quantityInput.getAttribute('max')) || 1;
                if (current < 1) current = 1;
                if (current > max) current = max;
                quantityInput.value = current;
                quantityHidden.value = current;
                btnMinus.disabled = current <= 1;
                btnPlus.disabled = current >= max;
            }

            btnMinus?.addEventListener('click', () => { quantityInput.value = Math.max(1, (parseInt(quantityInput.value) || 1) - 1); updateQuantity(); });
            btnPlus?.addEventListener('click',  () => {
                const max = parseInt(quantityInput.getAttribute('max')) || 1;
                quantityInput.value = Math.min(max, (parseInt(quantityInput.value) || 1) + 1);
                updateQuantity();
            });
            quantityInput?.addEventListener('change', updateQuantity);
            updateQuantity();

            // =========================
            // Variantes
            // =========================
            function getUniqueColors() {
                return [...new Set(VARIANTES.map(v => v.color).filter(Boolean))];
            }
            function getTallasByColor(color) {
                return VARIANTES.filter(v => v.color === color && v.talla)
                                .map(v => v.talla)
                                .filter((t, i, a) => a.indexOf(t) === i);
            }
            function getVariantByColorAndTalla(color, talla) {
                return VARIANTES.find(v => v.color === color && v.talla === talla);
            }

            function renderColorOptions() {
                if (!HAS_VARIANTS || !colorOptions) return;
                colorOptions.innerHTML = '';
                const colors = getUniqueColors();

                colors.forEach(color => {
                    const optionId = `color_${color.replace(/\s+/g, '_').toLowerCase()}`;
                    const div = document.createElement('div');
                    div.className = 'variant-option';
                    div.innerHTML = `
                        <input type="radio" name="color" id="${optionId}" value="${color}" class="variant-input">
                        <label for="${optionId}" class="variant-label">
                            <span class="color-swatch" style="background-color: ${getColorValue(color)}"></span>
                            ${color}
                        </label>`;
                    colorOptions.appendChild(div);
                });

                colorOptions.querySelectorAll('.variant-input').forEach(input => {
                    input.addEventListener('change', function() {
                        selectedColor = this.value;
                        selectedColorText.textContent = selectedColor;
                        renderTallaOptions();
                        updateVariantSelection();
                    });
                });

                const firstColor = colorOptions.querySelector('.variant-input');
                if (firstColor) {
                    firstColor.checked = true;
                    selectedColor = firstColor.value;
                    selectedColorText.textContent = selectedColor;
                    renderTallaOptions();
                }
            }

            function renderTallaOptions() {
                if (!HAS_VARIANTS || !tallaOptions || !selectedColor) return;
                tallaOptions.innerHTML = '';
                const tallas = getTallasByColor(selectedColor);

                tallas.forEach(talla => {
                    const variant = getVariantByColorAndTalla(selectedColor, talla);
                    const optionId = `talla_${talla.replace(/\s+/g, '_').toLowerCase()}`;
                    const disabled = !variant || (parseInt(variant.stock) || 0) <= 0;

                    const div = document.createElement('div');
                    div.className = 'variant-option';
                    div.innerHTML = `
                        <input type="radio" name="talla" id="${optionId}" value="${talla}" ${disabled ? 'disabled' : ''} class="variant-input">
                        <label for="${optionId}" class="variant-label ${disabled ? 'text-muted' : ''}">
                            ${talla}
                            ${disabled ? '<br><small class="text-danger">Agotado</small>' : ''}
                        </label>`;
                    tallaOptions.appendChild(div);
                });

                tallaOptions.querySelectorAll('.variant-input:not(:disabled)').forEach(input => {
                    input.addEventListener('change', function() {
                        selectedTalla = this.value;
                        selectedTallaText.textContent = selectedTalla;
                        updateVariantSelection();
                    });
                });

                const firstAvailable = tallaOptions.querySelector('.variant-input:not(:disabled)');
                if (firstAvailable) {
                    firstAvailable.checked = true;
                    selectedTalla = firstAvailable.value;
                    selectedTallaText.textContent = selectedTalla;
                } else {
                    selectedTalla = null;
                    selectedTallaText.textContent = 'Selecciona una talla';
                }
                updateVariantSelection();
            }

            function updateVariantSelection() {
                if (!HAS_VARIANTS) return;
                const variant = getVariantByColorAndTalla(selectedColor, selectedTalla);

                if (!variant) {
                    stockBadge.innerHTML = '<span class="badge text-bg-secondary">Selecciona una combinación</span>';
                    stockInfo.innerHTML = '<i class="fa-solid fa-info-circle"></i><span>Selecciona color y talla para ver disponibilidad</span>';
                    stockInfo.className = 'stock-info';
                    btnAdd.disabled = true;
                    btnAddText.textContent = 'Selecciona una combinación';
                    varHidden.value = '';
                    return;
                }

                const stock = parseInt(variant.stock) || 0;
                const price = variant.precio != null ? parseFloat(variant.precio) : parseFloat('@Model.PrecioVenta');

                if (stock <= 0) {
                    stockBadge.innerHTML = '<span class="badge text-bg-danger">Agotado</span>';
                    stockInfo.innerHTML = '<i class="fa-solid fa-times-circle"></i><span>Producto agotado temporalmente</span>';
                    stockInfo.className = 'stock-info stock-out';
                } else if (stock <= 5) {
                    stockBadge.innerHTML = `<span class="badge text-bg-warning">¡Quedan ${stock} unidades!</span>`;
                    stockInfo.innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i><span>¡Últimas unidades! Solo quedan ${stock}</span>`;
                    stockInfo.className = 'stock-info stock-low';
                } else {
                    stockBadge.innerHTML = '<span class="badge text-bg-success">En stock</span>';
                    stockInfo.innerHTML = '<i class="fa-solid fa-check-circle"></i><span>Disponible - Listo para enviar</span>';
                    stockInfo.className = 'stock-info stock-available';
                }

                if (priceEl) priceEl.textContent = price.toFixed(2);
                if (variant.img && mainImg) mainImg.src = variant.img;

                quantityInput.setAttribute('max', stock > 0 ? stock : 1);
                updateQuantity();

                btnAdd.disabled = stock <= 0;
                btnAddText.textContent = stock > 0 ? 'Añadir al carrito' : 'Sin stock';
                varHidden.value = stock > 0 ? variant.id : '';
            }

            function getColorValue(colorName) {
                const colorMap = {
                    'rojo': '#dc2626','azul': '#2563eb','verde': '#16a34a','amarillo': '#eab308','negro': '#000000',
                    'blanco': '#ffffff','rosa': '#ec4899','morado': '#9333ea','gris': '#6b7280','naranja': '#ea580c',
                    'marron': '#92400e','beige': '#fef3c7'
                };
                return colorMap[colorName?.toLowerCase?.()] || '#6b7280';
            }

            // =========================
            // Favoritos (AJAX)
            // =========================
            const favForm = document.getElementById('favForm');
            const btnFav = document.getElementById('btnFav');

            favForm?.addEventListener('submit', async function(e) {
                e.preventDefault();
                const icon = btnFav.querySelector('i');
                const wasFavorite = icon.classList.contains('fa-solid');

                try {
                    const response = await fetch(favForm.action, {
                        method: 'POST',
                        body: new FormData(favForm),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    if (response.ok) {
                        if (wasFavorite) {
                            icon.classList.remove('fa-solid'); icon.classList.add('fa-regular');
                            btnFav.classList.remove('btn-primary-custom'); btnFav.classList.add('btn-secondary-custom');
                        } else {
                            icon.classList.remove('fa-regular'); icon.classList.add('fa-solid');
                            btnFav.classList.remove('btn-secondary-custom'); btnFav.classList.add('btn-primary-custom');
                        }
                        showToast('success', wasFavorite ? 'Eliminado de favoritos' : 'Agregado a favoritos');
                    }
                } catch { showToast('error', 'Error al actualizar favoritos'); }
            });

            // =========================
            // Compartir
            // =========================
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = window.location.href;
                    const title = document.title;

                    if (this.querySelector('.fa-link')) {
                        navigator.clipboard.writeText(url).then(() => showToast('success', 'Enlace copiado al portapapeles'));
                    } else if (this.querySelector('.fa-facebook-f')) {
                        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                    } else if (this.querySelector('.fa-instagram')) {
                        window.open(`https://www.instagram.com/`, '_blank');
                    } else if (this.querySelector('.fa-whatsapp')) {
                        window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
                    }
                });
            });

            // =========================
            // Carrito (AJAX)
            // =========================
            const formAdd = document.getElementById('formAdd');

            formAdd?.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (HAS_VARIANTS && !varHidden.value) {
                    showToast('error', 'Selecciona color y talla antes de añadir al carrito');
                    return;
                }

                const originalText = btnAddText.textContent;
                const originalHtml = btnAdd.innerHTML;

                btnAdd.disabled = true;
                btnAddText.textContent = 'Añadiendo...';
                btnAdd.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Añadiendo...';

                try {
                    const response = await fetch(formAdd.action, {
                        method: 'POST',
                        body: new FormData(formAdd),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();

                    if (data.ok) {
                        showToast('success', 'Producto añadido al carrito');
                        // Si el backend ya devuelve count/subtotal, úsalo; si no, refresca desde el endpoint
                        await updateCartBadge(data);
                    } else if (data.needLogin) {
                        window.location.href = '/Cuenta/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                    } else {
                        showToast('error', data.error || 'Error al añadir el producto');
                    }
                } catch {
                    showToast('error', 'Error de conexión');
                } finally {
                    btnAdd.disabled = HAS_VARIANTS ? !varHidden.value : false;
                    btnAddText.textContent = originalText;
                    btnAdd.innerHTML = originalHtml;
                }
            });

            function showToast(type, message) {
                const toastEl = type === 'success' ? document.getElementById('toastSuccess') : document.getElementById('toastError');
                const toastMsg = toastEl.querySelector('.toast-body span');
                toastMsg.textContent = message;
                new bootstrap.Toast(toastEl).show();
            }

            // --- NUEVO: función para pintar todos los badges de carrito ---
            function renderCartBadges(count, subtotal) {
                document.querySelectorAll(CART_COUNT_SELECTORS).forEach(el => { if (el) el.textContent = Number(count || 0); });
                const formatted = new Intl.NumberFormat('es-EC', { style: 'currency', currency: 'USD' })
                                     .format(Number(subtotal || 0));
                document.querySelectorAll(CART_TOTAL_SELECTORS).forEach(el => { if (el) el.textContent = formatted; });
            }

            // --- NUEVO: pedir info del carrito con fallback de endpoint ---
            async function fetchCartInfo() {
                try {
                    let res = await fetch('/Compras/CartInfo');
                    if (!res.ok) { // fallback si usas CarritoController
                        res = await fetch('/Carrito/CartInfo');
                    }
                    if (res.ok) return await res.json();
                } catch { /* ignore */ }
                return null;
            }

            // --- NUEVO: actualizar UI (acepta datos precalculados del add-to-cart) ---
                async function updateCartBadge(preData) {
        // Pintar contadores rápidamente si ya tenemos datos del POST
        const countQuick = Number(preData?.count ?? 0);
        const subtotalQuick = Number(preData?.subtotal ?? preData?.total ?? NaN);
        if (!Number.isNaN(subtotalQuick) || countQuick > 0) {
            renderCartBadges(countQuick, subtotalQuick);
            window.dispatchEvent(new CustomEvent('cart:updated', { detail: { count: countQuick, subtotal: subtotalQuick } }));
            // Refresca el mini-carrito en segundo plano
            refreshMiniCartHTML();
            return;
        }

                    const data = await fetchCartInfo();
        if (data) {
            const c = Number(data.count ?? 0);
            const s = Number(data.subtotal ?? data.total ?? 0);
            renderCartBadges(c, s);
            window.dispatchEvent(new CustomEvent('cart:updated', { detail: { count: c, subtotal: s } }));
            refreshMiniCartHTML();
        }
            }

            // Inicialización
            if (HAS_VARIANTS) { renderColorOptions(); }
            updateCartBadge(); // cargar estado del carrito al inicio
        });
    </script>
}
