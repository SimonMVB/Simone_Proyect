@using System.Globalization
@{
    ViewData["Title"] = "Gestión de Pedidos";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var pedidos = ViewBag.Pedidos as List<Simone.Models.Pedido> ?? new();
    var vendedores = ViewBag.Vendedores as IList<Simone.Models.Usuario> ?? new List<Simone.Models.Usuario>();
    var total = (int)(ViewBag.Total ?? 0);
    var pagina = (int)(ViewBag.Pagina ?? 1);
    var totalPaginas = (int)(ViewBag.TotalPaginas ?? 1);
    var filtroEstado = ViewBag.FiltroEstado as string ?? "";
    var filtroEstadoPago = ViewBag.FiltroEstadoPago as string ?? "";
    var filtroVendedor = ViewBag.FiltroVendedor as string ?? "";
    var filtroBusqueda = ViewBag.FiltroBusqueda as string ?? "";
    var culture = new CultureInfo("es-EC");
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 1.6rem;
        color: #4B0082;
        margin: 0;
    }

    .filters-bar {
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

        .filters-bar input, .filters-bar select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

            .filters-bar input[type="text"] {
                min-width: 200px;
            }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: #4B0082;
        color: #fff;
    }

    .btn-outline {
        background: #fff;
        border: 1px solid #ddd;
        color: #333;
    }

    .table-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: #4B0082;
        color: #fff;
        padding: 0.85rem 1rem;
        text-align: left;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    td {
        padding: 0.85rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }

    tr:hover td {
        background: #fafafa;
    }

    .order-id {
        font-weight: 600;
        color: #4B0082;
    }

    .order-date {
        font-size: 0.8rem;
        color: #888;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-size: 0.72rem;
        font-weight: 500;
    }

    .badge-success {
        background: rgba(40,167,69,0.1);
        color: #28a745;
    }

    .badge-warning {
        background: rgba(255,193,7,0.15);
        color: #856404;
    }

    .badge-info {
        background: rgba(23,162,184,0.1);
        color: #17a2b8;
    }

    .badge-danger {
        background: rgba(220,53,69,0.1);
        color: #dc3545;
    }

    .badge-primary {
        background: rgba(75,0,130,0.1);
        color: #4B0082;
    }

    .badge-secondary {
        background: #eee;
        color: #666;
    }

    .amount {
        font-weight: 600;
    }

    .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 4px;
    }

    .btn-view {
        background: rgba(23,162,184,0.1);
        color: #17a2b8;
        border: none;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.25rem;
        padding: 1rem;
    }

    .page-btn {
        padding: 0.4rem 0.8rem;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        color: #333;
    }

        .page-btn.active {
            background: #4B0082;
            color: #fff;
            border-color: #4B0082;
        }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #888;
    }
</style>

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-shopping-bag"></i> Gestión de Pedidos</h1>
        <a href="@Url.Action("Index")" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <form method="get" class="filters-bar">
        <input type="text" name="busqueda" placeholder="Buscar orden, cliente..." value="@filtroBusqueda" />
        <select name="estado">
            <option value="">Estado Pedido</option>
            @foreach (var e in Simone.Models.EstadosPedido.Todos)
            {
                if (filtroEstado == e)
                {
                    <option value="@e" selected>@e</option>
                }
                else
                {
                    <option value="@e">@e</option>
                }
            }
        </select>
        <select name="estadoPago">
            <option value="">Estado Pago</option>
            @foreach (var e in Simone.Models.EstadosPago.Todos)
            {
                if (filtroEstadoPago == e)
                {
                    <option value="@e" selected>@e</option>
                }
                else
                {
                    <option value="@e">@e</option>
                }
            }
        </select>
        <select name="vendedorId">
            <option value="">Todos los vendedores</option>
            @foreach (var v in vendedores)
            {
                if (filtroVendedor == v.Id)
                {
                    <option value="@v.Id" selected>@v.NombreCompleto</option>
                }
                else
                {
                    <option value="@v.Id">@v.NombreCompleto</option>
                }
            }
        </select>
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Filtrar</button>
        <a href="@Url.Action("Pedidos")" class="btn btn-outline"><i class="fas fa-times"></i> Limpiar</a>
    </form>

    <div class="table-card">
        <div style="padding: 0.75rem 1rem; background: #f8f9fa; border-bottom: 1px solid #eee; font-size: 0.85rem; color: #666;">
            Mostrando @pedidos.Count de @total pedidos
        </div>

        @if (pedidos.Any())
        {
            <table>
                <thead>
                    <tr><th>Orden</th><th>Cliente</th><th>Productos</th><th>Total</th><th>Estado</th><th>Pago</th><th>Acción</th></tr>
                </thead>
                <tbody>
                    @foreach (var p in pedidos)
                    {
                        <tr>
                            <td>
                                <div class="order-id">@(p.NumeroOrden ?? $"#{p.PedidoID}")</div>
                                <div class="order-date">@p.FechaPedido.ToString("dd/MM/yyyy HH:mm")</div>
                            </td>
                            <td>
                                <div>@(p.NombreCliente ?? p.Usuario?.NombreCompleto ?? "—")</div>
                                <div style="font-size: 0.8rem; color: #888;">@(p.EmailCliente ?? p.Usuario?.Email)</div>
                            </td>
                            <td><span class="badge badge-secondary">@p.CantidadItems items</span></td>
                            <td class="amount">@p.Total.ToString("C2", culture)</td>
                            <td><span class="badge badge-@p.EstadoPedidoClase"><i class="@p.EstadoPedidoIcono"></i> @p.EstadoPedido</span></td>
                            <td><span class="badge badge-@p.EstadoPagoClase">@p.EstadoPago</span></td>
                            <td><a href="@Url.Action("DetallePedido", new { id = p.PedidoID })" class="btn btn-sm btn-view"><i class="fas fa-eye"></i> Ver</a></td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (totalPaginas > 1)
            {
                <div class="pagination">
                    @for (int i = Math.Max(1, pagina - 2); i <= Math.Min(totalPaginas, pagina + 2); i++)
                    {
                        <a href="@Url.Action("Pedidos", new { pagina = i, busqueda = filtroBusqueda, estado = filtroEstado, estadoPago = filtroEstadoPago, vendedorId = filtroVendedor })"
                           class="page-btn @(i == pagina ? "active" : "")">@i</a>
                    }
                </div>
            }
        }
        else
        {
            <div class="empty-state"><i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3;"></i><h3>No hay pedidos</h3></div>
        }
    </div>
</div>
